{"version":3,"file":"auth.js","sources":["api/auth.js"],"sourcesContent":["/**\r\n * 认证相关API服务\r\n * @module api/auth\r\n */\r\n\r\nimport { post, get } from '../utils/request.js';\r\nimport { setToken, clearTokens, getToken, getRefreshToken } from '../utils/jwt.js';\r\nimport { Navigator, CommonRoutes } from '../utils/routes.js';\r\n\r\n/**\r\n * 使用手机验证码登录\r\n * @param {Object} params - 登录参数\r\n * @param {string} params.mobile - 手机号\r\n * @param {string} params.code - 验证码\r\n * @returns {Promise<Object>} 登录结果\r\n */\r\nexport async function loginWithMobile(params) {\r\n  try {\r\n    const response = await post('/api/auth/login/mobile', params, {\r\n      auth: false // 登录请求不需要认证头\r\n    });\r\n    \r\n    if (response && response.token) {\r\n      // 保存令牌\r\n      setToken(response.token, response.refreshToken);\r\n      return response;\r\n    }\r\n    throw new Error(response.message || '登录失败');\r\n  } catch (error) {\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * 使用微信授权登录\r\n * @param {Object} params - 登录参数\r\n * @param {string} params.code - 微信授权code\r\n * @param {string} [params.encryptedData] - 微信加密数据\r\n * @param {string} [params.iv] - 微信加密初始向量\r\n * @returns {Promise<Object>} 登录结果\r\n */\r\nexport async function loginWithWechat(params) {\r\n  try {\r\n    const response = await post('/api/auth/login/wechat', params, {\r\n      auth: false // 登录请求不需要认证头\r\n    });\r\n    \r\n    if (response && response.token) {\r\n      // 保存令牌\r\n      setToken(response.token, response.refreshToken);\r\n      return response;\r\n    }\r\n    throw new Error(response.message || '微信登录失败');\r\n  } catch (error) {\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * 用户退出登录\r\n * @returns {Promise<void>}\r\n */\r\nexport async function logout() {\r\n  try {\r\n    // 可选：调用后端注销接口\r\n    if (getToken()) {\r\n      await post('/api/auth/logout');\r\n    }\r\n  } catch (error) {\r\n    console.error('注销时出错:', error);\r\n  } finally {\r\n    // 清除本地存储的令牌\r\n    clearTokens();\r\n    \r\n    // 跳转到登录页\r\n    Navigator.reLaunch(CommonRoutes.LOGIN);\r\n  }\r\n}\r\n\r\n/**\r\n * 验证手机号\r\n * @param {string} mobile - 手机号\r\n * @returns {Promise<Object>} 验证结果\r\n */\r\nexport async function verifyMobile(mobile) {\r\n  return await post('/api/auth/verify-mobile', { mobile });\r\n}\r\n\r\n/**\r\n * 发送验证码\r\n * @param {string} mobile - 手机号\r\n * @returns {Promise<Object>} 发送结果\r\n */\r\nexport async function sendVerificationCode(mobile) {\r\n  return await post('/api/auth/send-code', { mobile }, {\r\n    auth: false\r\n  });\r\n}\r\n\r\n/**\r\n * 验证验证码\r\n * @param {string} mobile - 手机号\r\n * @param {string} code - 验证码\r\n * @returns {Promise<Object>} 验证结果\r\n */\r\nexport async function verifyCode(mobile, code) {\r\n  return await post('/api/auth/verify-code', { mobile, code }, {\r\n    auth: false\r\n  });\r\n}\r\n\r\n/**\r\n * 绑定手机号\r\n * @param {string} mobile - 手机号\r\n * @param {string} code - 验证码\r\n * @returns {Promise<Object>} 绑定结果\r\n */\r\nexport async function bindMobile(mobile, code) {\r\n  return await post('/api/user/bind-mobile', { \r\n    mobile, \r\n    code\r\n  });\r\n}\r\n\r\n/**\r\n * 获取当前用户信息\r\n * @returns {Promise<Object>} 用户信息\r\n */\r\nexport async function getCurrentUser() {\r\n  return await get('/api/user/current');\r\n}\r\n\r\n/**\r\n * 检查用户是否已登录\r\n * @returns {boolean} 是否已登录\r\n */\r\nexport function isLoggedIn() {\r\n  return !!getToken();\r\n}\r\n\r\n/**\r\n * 更新用户个人资料\r\n * @param {Object} profileData - 个人资料数据\r\n * @returns {Promise<Object>} 更新结果\r\n */\r\nexport async function updateProfile(profileData) {\r\n  return await post('/api/user/profile', profileData);\r\n}\r\n\r\nexport default {\r\n  loginWithMobile,\r\n  loginWithWechat,\r\n  logout,\r\n  verifyMobile,\r\n  sendVerificationCode,\r\n  verifyCode,\r\n  bindMobile,\r\n  getCurrentUser,\r\n  isLoggedIn,\r\n  updateProfile\r\n}; "],"names":["async","params","response","post","auth","token","setToken","refreshToken","Error","message","error","mobile"],"mappings":"wIAgBOA,eAA+BC,GAChC,IACF,MAAMC,QAAiBC,OAAK,yBAA0BF,EAAQ,CAC5DG,MAAM,IAGJ,GAAAF,GAAYA,EAASG,MAGhB,OADPC,EAAAA,SAASJ,EAASG,MAAOH,EAASK,cAC3BL,EAET,MAAM,IAAIM,MAAMN,EAASO,SAAW,OAGrC,OAFQC,GACD,MAAAA,CACP,CACH,0BAUOV,eAA+BC,GAChC,IACF,MAAMC,QAAiBC,OAAK,yBAA0BF,EAAQ,CAC5DG,MAAM,IAGJ,GAAAF,GAAYA,EAASG,MAGhB,OADPC,EAAAA,SAASJ,EAASG,MAAOH,EAASK,cAC3BL,EAET,MAAM,IAAIM,MAAMN,EAASO,SAAW,SAGrC,OAFQC,GACD,MAAAA,CACP,CACH,+BAqCOV,eAAoCW,GACzC,aAAaR,EAAIA,KAAC,sBAAuB,CAAEQ,UAAU,CACnDP,MAAM,GAEV"}