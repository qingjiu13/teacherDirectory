{"version":3,"file":"login.js","sources":["pages/login/login.uvue","../../HBuilderX/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvbG9naW4vbG9naW4udXZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"login-container\">\n    <!-- 欢迎信息 -->\n    <view class=\"welcome-section\">\n      <text class=\"welcome-text\">您好，</text>\n      <text class=\"welcome-subtext\">欢迎使用研师录~</text>\n    </view>\n    \n    <!-- 登录表单卡片 -->\n    <view class=\"login-card\">\n      <!-- 手机号 -->\n      <view class=\"form-item\">\n        <text class=\"form-label\">手机号</text>\n        <view class=\"input-container\">\n          <input class=\"form-input\" type=\"number\" v-model=\"mobile\" placeholder=\"请输入手机号\" />\n        </view>\n      </view>\n      \n      <!-- 验证码 -->\n      <view class=\"form-item verification-code-item\">\n        <text class=\"form-label\">验证码</text>\n        <view class=\"code-input-area\">\n          <input class=\"form-input\" type=\"number\" v-model=\"code\" placeholder=\"请输入验证码\" maxlength=\"6\" />\n          <button class=\"get-code-btn\" @click=\"sendCode\" v-if=\"countdown <= 0\">获取验证码</button>\n          <view class=\"code-sent-tip\" v-else>验证码已发送~</view>\n        </view>\n      </view>\n      \n      <!-- 登录按钮 -->\n      <button class=\"login-btn\" @click=\"handleMobileLogin\" :loading=\"loading\">登录</button>\n      \n      <!-- 协议勾选 -->\n      <view class=\"agreement-wrapper\">\n        <label class=\"agreement-label\">\n          <checkbox value=\"agreed\" :checked=\"isAgreed\" color=\"#007AFF\" style=\"transform:scale(0.7)\" @change=\"customAgreementChange\" />\n          <text class=\"agreement-text\">我已阅读并同意</text>\n          <text class=\"agreement-link\" @click.stop=\"goToTerms\">《服务条款》</text>\n          <text class=\"agreement-text\">和</text>\n          <text class=\"agreement-link\" @click.stop=\"goToPrivacy\">《隐私协议》</text>\n        </label>\n      </view>\n      \n      <!-- 微信登录 -->\n      <view class=\"wechat-login\">\n\n        <button open-type=\"getUserInfo\" @getuserinfo=\"onGetUserInfo\" class=\"wechat-btn\">\n          <image class=\"wechat-icon\" src=\"/static/image/wechat.png\" mode=\"aspectFit\"></image>\n          <text class=\"wechat-text\">微信登录</text>\n        </button>\n\n        \n\n\n\n\n\n\n      </view>\n    </view>\n  </view>\n</template>\n\n<script lang=\"uts\">\n  /**\n   * 登录页面\n   * @description 处理用户登录相关逻辑，支持微信授权登录和手机验证码登录\n   */\n  import { loginWithMobile, loginWithWechat, sendVerificationCode } from '../../api/auth.js';\n  import { Navigator, CommonRoutes, MainRoutes } from '../../utils/routes.js';\n  import { wxLogin } from '../../utils/wechat.js';\n  \n  export default {\n    data() {\n      return {\n        mobile: '',\n        code: '',\n        countdown: 0,\n        loading: false,\n        timer: null,\n        redirectUrl: '',\n        isAgreed: false,\n        authSetting: {}, // 授权设置信息\n        showPhoneButton: false // 是否显示获取手机号按钮\n      }\n    },\n    \n    /**\n     * 生命周期函数--监听页面加载\n     */\n    onLoad(options) {\n      // 保存重定向页面，登录成功后跳转\n      if (options.redirect) {\n        this.redirectUrl = decodeURIComponent(options.redirect);\n      }\n      \n      // 检查授权设置\n      this.checkAuthSetting();\n    },\n    \n    /**\n     * 页面卸载时清除计时器\n     */\n    onUnload() {\n      if (this.timer) {\n        clearInterval(this.timer);\n        this.timer = null;\n      }\n    },\n    \n    methods: {\n      /**\n       * 检查授权设置\n       */\n      checkAuthSetting() {\n        // 判断 API 是否可用\n        if (wx.getAppAuthorizeSetting) {\n          const authSetting = wx.getAppAuthorizeSetting();\n          uni.__f__('log','at pages/login/login.uvue:118','授权设置信息：', authSetting);\n          this.authSetting = authSetting;\n          \n          // 可以根据授权情况进行后续处理\n          // 例如：如果已经授权了用户信息，可以直接使用微信登录而不是手机号登录\n          if (authSetting['scope.userInfo'] === 'authorized') {\n            uni.__f__('log','at pages/login/login.uvue:124','用户已授权获取用户信息');\n          }\n          \n          // 检查是否授权了用户手机号\n          if (authSetting['scope.phoneNumber'] === 'authorized') {\n            uni.__f__('log','at pages/login/login.uvue:129','用户已授权获取手机号');\n            this.showPhoneButton = true;\n          }\n        } else {\n          uni.__f__('log','at pages/login/login.uvue:133','wx.getAppAuthorizeSetting API 不可用，请更新基础库版本');\n        }\n      },\n      \n      /**\n       * 自定义协议勾选状态变更\n       * @param {Object} e - 事件对象\n       */\n      customAgreementChange(e) {\n        this.isAgreed = e.detail.value === 'agreed';\n      },\n      \n      /**\n       * 处理手机验证码登录\n       */\n      async handleMobileLogin() {\n        // 检查是否同意协议\n        if (!this.isAgreed) {\n          uni.showToast({\n            title: '请先同意用户协议和隐私政策',\n            icon: 'none'\n          });\n          return;\n        }\n        \n        // 输入验证\n        if (!this.mobile || !/^1\\d{10}$/.test(this.mobile)) {\n          uni.showToast({\n            title: '请输入有效的手机号',\n            icon: 'none'\n          });\n          return;\n        }\n        \n        if (!this.code || this.code.length !== 6) {\n          uni.showToast({\n            title: '请输入6位验证码',\n            icon: 'none'\n          });\n          return;\n        }\n        \n        this.loading = true;\n        \n        try {\n          // 调用验证码登录API\n          const result = await loginWithMobile({\n            mobile: this.mobile,\n            code: this.code\n          });\n          \n          this.loginSuccess();\n        } catch (error) {\n          uni.showToast({\n            title: error.message || '登录失败，请重试',\n            icon: 'none'\n          });\n        } finally {\n          this.loading = false;\n        }\n      },\n      \n      /**\n       * 发送验证码\n       */\n      async sendCode() {\n        if (this.countdown > 0 || !this.mobile) {\n          return;\n        }\n        \n        if (!/^1\\d{10}$/.test(this.mobile)) {\n          uni.showToast({\n            title: '请输入有效的手机号',\n            icon: 'none'\n          });\n          return;\n        }\n        \n        try {\n          // 发送验证码\n          await sendVerificationCode(this.mobile);\n          \n          // 开始倒计时\n          this.startCountdown();\n        } catch (error) {\n          uni.showToast({\n            title: error.message || '发送验证码失败',\n            icon: 'none'\n          });\n        }\n      },\n      \n      /**\n       * 开始倒计时\n       */\n      startCountdown() {\n        this.countdown = 60;\n        \n        if (this.timer) {\n          clearInterval(this.timer);\n        }\n        \n        this.timer = setInterval(() => {\n          if (this.countdown > 0) {\n            this.countdown--;\n          } else {\n            clearInterval(this.timer);\n            this.timer = null;\n          }\n        }, 1000);\n      },\n      \n      /**\n       * 处理微信登录\n       */\n      async handleWechatLogin() {\n        // 检查是否同意协议\n        if (!this.isAgreed) {\n          uni.showToast({\n            title: '请先同意用户协议和隐私政策',\n            icon: 'none'\n          });\n          return;\n        }\n        \n        this.loading = true;\n        \n        try {\n          // 检查授权状态\n          if (wx.getAppAuthorizeSetting) {\n            const authSetting = wx.getAppAuthorizeSetting();\n            \n            // 如果未授权用户信息，先请求授权\n            if (authSetting['scope.userInfo'] !== 'authorized') {\n              // 提示用户授权\n              uni.showModal({\n                title: '提示',\n                content: '需要获取您的用户信息才能登录，请在稍后的弹窗中点击\"允许\"',\n                success: (res) => {\n                  if (res.confirm) {\n                    // 继续登录流程\n                    this.processWechatLogin();\n                  } else {\n                    this.loading = false;\n                  }\n                }\n              });\n            } else {\n              // 已授权，直接登录\n              this.processWechatLogin();\n            }\n          } else {\n            // 基础库版本过低，使用旧方式登录\n            this.processWechatLogin();\n          }\n        } catch (error) {\n          uni.__f__('error','at pages/login/login.uvue:289','微信登录前检查授权失败：', error);\n          // 出错时继续尝试登录\n          this.processWechatLogin();\n        }\n      },\n      \n      /**\n       * 处理微信登录流程\n       */\n      async processWechatLogin() {\n        try {\n          // 获取登录code\n          const { code } = await wxLogin();\n          \n          if (!code) {\n            throw new Error('获取微信授权失败');\n          }\n          \n          // 调用微信登录API\n          const result = await loginWithWechat({ code });\n          \n          this.loginSuccess();\n        } catch (error) {\n          uni.showToast({\n            title: error.message || '微信登录失败，请重试',\n            icon: 'none'\n          });\n        } finally {\n          this.loading = false;\n        }\n      },\n      \n      /**\n       * 获取用户信息回调\n       */\n      async onGetUserInfo(e) {\n        if (e.detail.errMsg !== 'getUserInfo:ok') {\n          uni.showToast({\n            title: '请授权获取用户信息',\n            icon: 'none'\n          });\n          return;\n        }\n        \n        // 检查是否同意协议\n        if (!this.isAgreed) {\n          uni.showToast({\n            title: '请先同意用户协议和隐私政策',\n            icon: 'none'\n          });\n          return;\n        }\n        \n        this.loading = true;\n        \n        try {\n          // 获取登录code\n          const { code } = await wxLogin();\n          \n          if (!code) {\n            throw new Error('获取微信授权失败');\n          }\n          \n          // 调用微信登录API\n          const result = await loginWithWechat({ \n            code,\n            userInfo: e.detail.userInfo\n          });\n          \n          this.loginSuccess();\n        } catch (error) {\n          uni.showToast({\n            title: error.message || '微信登录失败，请重试',\n            icon: 'none'\n          });\n        } finally {\n          this.loading = false;\n        }\n      },\n      \n      /**\n       * 登录成功处理\n       */\n      loginSuccess() {\n        uni.showToast({\n          title: '登录成功',\n          icon: 'success'\n        });\n        \n        // 登录成功后跳转\n        setTimeout(() => {\n          if (this.redirectUrl) {\n            Navigator.reLaunch(this.redirectUrl);\n          } else {\n            Navigator.reLaunch(MainRoutes.INDEX);\n          }\n        }, 1500);\n      },\n      \n      /**\n       * 跳转到用户协议页面\n       */\n      goToTerms() {\n        Navigator.navigateTo(CommonRoutes.TERMS);\n      },\n      \n      /**\n       * 跳转到隐私政策页面\n       */\n      goToPrivacy() {\n        Navigator.navigateTo(CommonRoutes.PRIVACY);\n      }\n    }\n  }\n</script>\n\n<style>\n  .login-container {\n    display: flex;\n    flex-direction: column;\n    background-color: #f8f8f8;\n    min-height: 100vh;\n    padding: 0 0 40rpx 0;\n  }\n  \n  .welcome-section {\n    padding: 10rpx 40rpx 40rpx;\n  }\n  \n  .welcome-text {\n    font-size: 40rpx;\n    font-weight: bold;\n    color: #333;\n    display: block;\n    margin-bottom: 10rpx;\n  }\n  \n  .welcome-subtext {\n    font-size: 40rpx;\n    font-weight: bold;\n    color: #333;\n  }\n  \n  /* 登录表单卡片 */\n  .login-card {\n    margin: 0 20rpx;\n    padding: 40rpx 30rpx;\n    background-color: #ffffff;\n    border-radius: 30rpx;\n    box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.05);\n    display: flex;\n    flex-direction: column;\n  }\n  \n  .form-item {\n    margin-bottom: 40rpx;\n  }\n  \n  .form-label {\n    font-size: 28rpx;\n    color: #333;\n    font-weight: 500;\n    margin-bottom: 15rpx;\n    display: block;\n  }\n  \n  .input-container {\n    position: relative;\n    margin-top: 10rpx;\n  }\n  \n  .form-input {\n    width: 100%;\n    height: 80rpx;\n    font-size: 28rpx;\n    border: none;\n    border-bottom: 1px solid #e0e0e0;\n    padding: 10rpx 0;\n    background-color: transparent;\n  }\n  \n  /* 验证码区域 */\n  .verification-code-item {\n    position: relative;\n  }\n  \n  .code-input-area {\n    position: relative;\n    margin-top: 10rpx;\n  }\n  \n  .get-code-btn {\n    position: absolute;\n    right: 0;\n    top: 20rpx;\n    background: none;\n    border: none;\n    font-size: 28rpx;\n    color: #4183ff;\n    padding: 0;\n    margin: 0;\n    line-height: 1;\n    z-index: 2;\n  }\n  \n  .code-sent-tip {\n    position: absolute;\n    right: 0;\n    top: 20rpx;\n    font-size: 28rpx;\n    color: #999;\n  }\n  \n  /* 登录按钮 */\n  .login-btn {\n    width: 100%;\n    height: 90rpx;\n    background: linear-gradient(to right, #4183ff, #42a8ff);\n    color: white;\n    border-radius: 45rpx;\n    margin: 60rpx 0 30rpx;\n    font-size: 32rpx;\n    font-weight: 500;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    box-shadow: 0 6rpx 16rpx rgba(65, 131, 255, 0.3);\n  }\n  \n  /* 协议勾选 */\n  .agreement-wrapper {\n    text-align: center;\n    padding: 20rpx 0;\n    margin-bottom: 30rpx;\n  }\n  \n  .agreement-label {\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    justify-content: center;\n    font-size: 24rpx;\n    white-space: nowrap;\n    flex-wrap: nowrap;\n  }\n  \n  .agreement-text {\n    color: #999;\n    white-space: nowrap;\n  }\n  \n  .agreement-link {\n    color: #4183ff;\n    white-space: nowrap;\n  }\n  \n  /* 微信登录 */\n  .wechat-login {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    padding: 30rpx 0;\n    margin-top: 20rpx;\n  }\n  \n  .wechat-btn {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    background: transparent;\n    border: none;\n    padding: 0;\n    margin: 0;\n    box-shadow: none;\n    line-height: normal;\n    width: auto;\n  }\n  \n  .wechat-btn::after {\n    border: none;\n  }\n  \n  .wechat-icon {\n    width: 70rpx;\n    height: 70rpx;\n    margin-bottom: 15rpx;\n  }\n  \n  .wechat-text {\n    font-size: 28rpx;\n    color: #666;\n  }\n</style> ","import MiniProgramPage from 'E:/yanshilu小程序前端/前端yanshilu/pages/login/login.uvue'\nwx.createPage(MiniProgramPage)"],"names":["_sfc_main","defineComponent","data","mobile","code","countdown","loading","timer","redirectUrl","isAgreed","authSetting","UTSJSONObject","showPhoneButton","onLoad","options","redirect","this","decodeURIComponent","checkAuthSetting","onUnload","clearInterval","methods","wx","getAppAuthorizeSetting","uni","index","__f__","customAgreementChange","e","detail","value","handleMobileLogin","showToast","title","icon","Promise","resolve","test","length","loginWithMobile","loginSuccess","error","message","sendCode","sendVerificationCode","startCountdown","setInterval","handleWechatLogin","showModal","content","success","res","confirm","processWechatLogin","wxLogin","Error","loginWithWechat","onGetUserInfo","errMsg","userInfo","setTimeout","Navigator","reLaunch","MainRoutes","INDEX","goToTerms","navigateTo","CommonRoutes","TERMS","goToPrivacy","PRIVACY","createPage","MiniProgramPage"],"mappings":"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"}