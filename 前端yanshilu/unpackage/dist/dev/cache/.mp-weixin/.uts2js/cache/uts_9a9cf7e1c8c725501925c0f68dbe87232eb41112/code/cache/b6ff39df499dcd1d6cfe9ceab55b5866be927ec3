{"code":"import { __awaiter } from \"tslib\";\nimport { defineComponent } from \"vue\";\n/**\n * 登录页面\n * @description 处理用户登录相关逻辑，支持微信授权登录和手机验证码登录\n */\nimport { loginWithMobile, loginWithWechat, sendVerificationCode } from '../../api/auth.js';\nimport { Navigator, CommonRoutes, MainRoutes } from '../../utils/routes.js';\nimport { wxLogin } from '../../utils/wechat.js';\nexport default defineComponent({\n    data() {\n        return {\n            mobile: '',\n            code: '',\n            countdown: 0,\n            loading: false,\n            timer: null,\n            redirectUrl: '',\n            isAgreed: false,\n            showPhoneButton: false // 是否显示获取手机号按钮\n        };\n    },\n    /**\n     * 生命周期函数--监听页面加载\n     */\n    onLoad(options) {\n        // 保存重定向页面，登录成功后跳转\n        if (options.redirect) {\n            this.redirectUrl = decodeURIComponent(options.redirect);\n        }\n    },\n    /**\n     * 页面卸载时清除计时器\n     */\n    onUnload() {\n        if (this.timer) {\n            clearInterval(this.timer);\n            this.timer = null;\n        }\n    },\n    methods: {\n        /**\n         * 自定义协议勾选状态变更\n         * @param {Object} e - 事件对象\n         */\n        customAgreementChange(e = null) {\n            this.isAgreed = e.detail.value === 'agreed';\n        },\n        /**\n         * 处理手机验证码登录\n         */\n        handleMobileLogin() {\n            return __awaiter(this, void 0, void 0, function* () {\n                // 检查是否同意协议\n                if (!this.isAgreed) {\n                    uni.showToast({\n                        title: '请先同意用户协议和隐私政策',\n                        icon: 'none'\n                    });\n                    return Promise.resolve(null);\n                }\n                // 输入验证\n                if (!this.mobile || !/^1\\d{10}$/.test(this.mobile)) {\n                    uni.showToast({\n                        title: '请输入有效的手机号',\n                        icon: 'none'\n                    });\n                    return Promise.resolve(null);\n                }\n                if (!this.code || this.code.length !== 6) {\n                    uni.showToast({\n                        title: '请输入6位验证码',\n                        icon: 'none'\n                    });\n                    return Promise.resolve(null);\n                }\n                this.loading = true;\n                try {\n                    // 调用验证码登录API\n                    const result = yield loginWithMobile(new UTSJSONObject({\n                        mobile: this.mobile,\n                        code: this.code\n                    }));\n                    this.loginSuccess();\n                }\n                catch (error) {\n                    uni.showToast({\n                        title: error.message || '登录失败，请重试',\n                        icon: 'none'\n                    });\n                }\n                finally {\n                    this.loading = false;\n                }\n            });\n        },\n        /**\n         * 发送验证码\n         */\n        sendCode() {\n            return __awaiter(this, void 0, void 0, function* () {\n                if (this.countdown > 0 || !this.mobile) {\n                    return Promise.resolve(null);\n                }\n                if (!/^1\\d{10}$/.test(this.mobile)) {\n                    uni.showToast({\n                        title: '请输入有效的手机号',\n                        icon: 'none'\n                    });\n                    return Promise.resolve(null);\n                }\n                try {\n                    // 发送验证码\n                    yield sendVerificationCode(this.mobile);\n                    // 开始倒计时\n                    this.startCountdown();\n                }\n                catch (error) {\n                    uni.showToast({\n                        title: error.message || '发送验证码失败',\n                        icon: 'none'\n                    });\n                }\n            });\n        },\n        /**\n         * 开始倒计时\n         */\n        startCountdown() {\n            this.countdown = 60;\n            if (this.timer) {\n                clearInterval(this.timer);\n            }\n            this.timer = setInterval(() => {\n                if (this.countdown > 0) {\n                    this.countdown--;\n                }\n                else {\n                    clearInterval(this.timer);\n                    this.timer = null;\n                }\n            }, 1000);\n        },\n        /**\n         * 处理微信登录\n         */\n        handleWechatLogin() {\n            return __awaiter(this, void 0, void 0, function* () {\n                // 检查是否同意协议\n                if (!this.isAgreed) {\n                    uni.showToast({\n                        title: '请先同意用户协议和隐私政策',\n                        icon: 'none'\n                    });\n                    return Promise.resolve(null);\n                }\n                this.loading = true;\n                try {\n                    // 获取登录code\n                    const code = (yield wxLogin()).code;\n                    if (!code) {\n                        throw new Error('获取微信授权失败');\n                    }\n                    // 调用微信登录API\n                    const result = yield loginWithWechat(new UTSJSONObject({ code }));\n                    this.loginSuccess();\n                }\n                catch (error) {\n                    uni.showToast({\n                        title: error.message || '微信登录失败，请重试',\n                        icon: 'none'\n                    });\n                }\n                finally {\n                    this.loading = false;\n                }\n            });\n        },\n        /**\n         * 获取用户信息回调\n         */\n        onGetUserInfo(e = null) {\n            return __awaiter(this, void 0, void 0, function* () {\n                if (e.detail.errMsg !== 'getUserInfo:ok') {\n                    uni.showToast({\n                        title: '请授权获取用户信息',\n                        icon: 'none'\n                    });\n                    return Promise.resolve(null);\n                }\n                // 检查是否同意协议\n                if (!this.isAgreed) {\n                    uni.showToast({\n                        title: '请先同意用户协议和隐私政策',\n                        icon: 'none'\n                    });\n                    return Promise.resolve(null);\n                }\n                this.loading = true;\n                try {\n                    // 获取登录code\n                    const code = (yield wxLogin()).code;\n                    if (!code) {\n                        throw new Error('获取微信授权失败');\n                    }\n                    // 调用微信登录API\n                    const result = yield loginWithWechat(new UTSJSONObject({\n                        code,\n                        userInfo: e.detail.userInfo\n                    }));\n                    this.loginSuccess();\n                }\n                catch (error) {\n                    uni.showToast({\n                        title: error.message || '微信登录失败，请重试',\n                        icon: 'none'\n                    });\n                }\n                finally {\n                    this.loading = false;\n                }\n            });\n        },\n        /**\n         * 登录成功处理\n         */\n        loginSuccess() {\n            uni.showToast({\n                title: '登录成功',\n                icon: 'success'\n            });\n            // 登录成功后跳转\n            setTimeout(() => {\n                if (this.redirectUrl) {\n                    Navigator.reLaunch(this.redirectUrl);\n                }\n                else {\n                    Navigator.reLaunch(MainRoutes.INDEX);\n                }\n            }, 1500);\n        },\n        /**\n         * 跳转到用户协议页面\n         */\n        goToTerms() {\n            Navigator.navigateTo(CommonRoutes.TERMS);\n        },\n        /**\n         * 跳转到隐私政策页面\n         */\n        goToPrivacy() {\n            Navigator.navigateTo(CommonRoutes.PRIVACY);\n        }\n    }\n});\n//# sourceMappingURL=E:/yanshilu%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AFyanshilu/pages/login/login.uvue?vue&type=script&lang.uts.js.map","references":["E:/yanshilu小程序前端/前端yanshilu/api/auth.js","E:/yanshilu小程序前端/前端yanshilu/utils/routes.js","E:/yanshilu小程序前端/前端yanshilu/utils/wechat.js"],"uniExtApis":["uni.showToast"],"map":"{\"version\":3,\"file\":\"login.uvue?vue&type=script&lang.uts.js\",\"sourceRoot\":\"\",\"sources\":[\"login.uvue?vue&type=script&lang.uts\"],\"names\":[],\"mappings\":\"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\"}"}
