"use strict";const e=require("../../common/vendor.js"),o=require("../../api/auth.js"),i=require("../../utils/routes.js"),t=require("../../utils/wechat.js"),n=require("../../common/assets.js"),s=e.defineComponent({data:()=>({mobile:"",code:"",countdown:0,loading:!1,timer:null,redirectUrl:"",isAgreed:!1,showPhoneButton:!1}),onLoad(e){e.redirect&&(this.redirectUrl=decodeURIComponent(e.redirect))},onUnload(){this.timer&&(clearInterval(this.timer),this.timer=null)},methods:{customAgreementChange(e=null){this.isAgreed="agreed"===e.detail.value},handleMobileLogin(){return e.__awaiter(this,void 0,void 0,(function*(){if(!this.isAgreed)return e.index.showToast({title:"请先同意用户协议和隐私政策",icon:"none"}),Promise.resolve(null);if(!this.mobile||!/^1\d{10}$/.test(this.mobile))return e.index.showToast({title:"请输入有效的手机号",icon:"none"}),Promise.resolve(null);if(!this.code||6!==this.code.length)return e.index.showToast({title:"请输入6位验证码",icon:"none"}),Promise.resolve(null);this.loading=!0;try{yield o.loginWithMobile(new UTSJSONObject({mobile:this.mobile,code:this.code}));this.loginSuccess()}catch(i){e.index.showToast({title:i.message||"登录失败，请重试",icon:"none"})}finally{this.loading=!1}}))},sendCode(){return e.__awaiter(this,void 0,void 0,(function*(){if(this.countdown>0||!this.mobile)return Promise.resolve(null);if(!/^1\d{10}$/.test(this.mobile))return e.index.showToast({title:"请输入有效的手机号",icon:"none"}),Promise.resolve(null);try{yield o.sendVerificationCode(this.mobile),this.startCountdown()}catch(i){e.index.showToast({title:i.message||"发送验证码失败",icon:"none"})}}))},startCountdown(){this.countdown=60,this.timer&&clearInterval(this.timer),this.timer=setInterval((()=>{this.countdown>0?this.countdown--:(clearInterval(this.timer),this.timer=null)}),1e3)},handleWechatLogin(){return e.__awaiter(this,void 0,void 0,(function*(){if(!this.isAgreed)return e.index.showToast({title:"请先同意用户协议和隐私政策",icon:"none"}),Promise.resolve(null);this.loading=!0;try{const e=(yield t.wxLogin()).code;if(!e)throw new Error("获取微信授权失败");yield o.loginWithWechat(new UTSJSONObject({code:e}));this.loginSuccess()}catch(i){e.index.showToast({title:i.message||"微信登录失败，请重试",icon:"none"})}finally{this.loading=!1}}))},onGetUserInfo(i=null){return e.__awaiter(this,void 0,void 0,(function*(){if("getUserInfo:ok"!==i.detail.errMsg)return e.index.showToast({title:"请授权获取用户信息",icon:"none"}),Promise.resolve(null);if(!this.isAgreed)return e.index.showToast({title:"请先同意用户协议和隐私政策",icon:"none"}),Promise.resolve(null);this.loading=!0;try{const e=(yield t.wxLogin()).code;if(!e)throw new Error("获取微信授权失败");yield o.loginWithWechat(new UTSJSONObject({code:e,userInfo:i.detail.userInfo}));this.loginSuccess()}catch(n){e.index.showToast({title:n.message||"微信登录失败，请重试",icon:"none"})}finally{this.loading=!1}}))},loginSuccess(){e.index.showToast({title:"登录成功",icon:"success"}),setTimeout((()=>{this.redirectUrl?i.Navigator.reLaunch(this.redirectUrl):i.Navigator.reLaunch(i.MainRoutes.INDEX)}),1500)},goToTerms(){i.Navigator.navigateTo(i.CommonRoutes.TERMS)},goToPrivacy(){i.Navigator.navigateTo(i.CommonRoutes.PRIVACY)}}});const r=e._export_sfc(s,[["render",function(o,i,t,s,r,l){return e.e({a:r.mobile,b:e.o((e=>r.mobile=e.detail.value)),c:r.code,d:e.o((e=>r.code=e.detail.value)),e:r.countdown<=0},r.countdown<=0?{f:e.o(((...e)=>l.sendCode&&l.sendCode(...e)))}:{},{g:e.o(((...e)=>l.handleMobileLogin&&l.handleMobileLogin(...e))),h:r.loading,i:r.isAgreed,j:e.o(((...e)=>l.customAgreementChange&&l.customAgreementChange(...e))),k:e.o(((...e)=>l.goToTerms&&l.goToTerms(...e))),l:e.o(((...e)=>l.goToPrivacy&&l.goToPrivacy(...e))),m:n._imports_0$4,n:e.o(((...e)=>l.onGetUserInfo&&l.onGetUserInfo(...e))),o:e.sei(o.virtualHostId,"view")})}]]);wx.createPage(r);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/login/login.js.map
