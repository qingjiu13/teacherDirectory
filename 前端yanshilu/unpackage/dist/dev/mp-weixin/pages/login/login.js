"use strict";const e=require("../../common/vendor.js"),o=require("../../api/auth.js"),t=require("../../utils/routes.js"),i=require("../../utils/wechat.js"),n=require("../../common/assets.js"),s=e.defineComponent({data:()=>({mobile:"",code:"",countdown:0,loading:!1,timer:null,redirectUrl:"",isAgreed:!1,authSetting:new UTSJSONObject({}),showPhoneButton:!1}),onLoad(e){e.redirect&&(this.redirectUrl=decodeURIComponent(e.redirect)),this.checkAuthSetting()},onUnload(){this.timer&&(clearInterval(this.timer),this.timer=null)},methods:{checkAuthSetting(){if(e.wx$1.getAppAuthorizeSetting){const o=e.wx$1.getAppAuthorizeSetting();e.index.__f__("log","at pages/login/login.uvue:118","授权设置信息：",o),this.authSetting=o,"authorized"===o["scope.userInfo"]&&e.index.__f__("log","at pages/login/login.uvue:124","用户已授权获取用户信息"),"authorized"===o["scope.phoneNumber"]&&(e.index.__f__("log","at pages/login/login.uvue:129","用户已授权获取手机号"),this.showPhoneButton=!0)}else e.index.__f__("log","at pages/login/login.uvue:133","wx.getAppAuthorizeSetting API 不可用，请更新基础库版本")},customAgreementChange(e=null){this.isAgreed="agreed"===e.detail.value},handleMobileLogin(){return e.__awaiter(this,void 0,void 0,(function*(){if(!this.isAgreed)return e.index.showToast({title:"请先同意用户协议和隐私政策",icon:"none"}),Promise.resolve(null);if(!this.mobile||!/^1\d{10}$/.test(this.mobile))return e.index.showToast({title:"请输入有效的手机号",icon:"none"}),Promise.resolve(null);if(!this.code||6!==this.code.length)return e.index.showToast({title:"请输入6位验证码",icon:"none"}),Promise.resolve(null);this.loading=!0;try{yield o.loginWithMobile(new UTSJSONObject({mobile:this.mobile,code:this.code}));this.loginSuccess()}catch(t){e.index.showToast({title:t.message||"登录失败，请重试",icon:"none"})}finally{this.loading=!1}}))},sendCode(){return e.__awaiter(this,void 0,void 0,(function*(){if(this.countdown>0||!this.mobile)return Promise.resolve(null);if(!/^1\d{10}$/.test(this.mobile))return e.index.showToast({title:"请输入有效的手机号",icon:"none"}),Promise.resolve(null);try{yield o.sendVerificationCode(this.mobile),this.startCountdown()}catch(t){e.index.showToast({title:t.message||"发送验证码失败",icon:"none"})}}))},startCountdown(){this.countdown=60,this.timer&&clearInterval(this.timer),this.timer=setInterval((()=>{this.countdown>0?this.countdown--:(clearInterval(this.timer),this.timer=null)}),1e3)},handleWechatLogin(){return e.__awaiter(this,void 0,void 0,(function*(){if(!this.isAgreed)return e.index.showToast({title:"请先同意用户协议和隐私政策",icon:"none"}),Promise.resolve(null);this.loading=!0;try{if(e.wx$1.getAppAuthorizeSetting){"authorized"!==e.wx$1.getAppAuthorizeSetting()["scope.userInfo"]?e.index.showModal({title:"提示",content:'需要获取您的用户信息才能登录，请在稍后的弹窗中点击"允许"',success:e=>{e.confirm?this.processWechatLogin():this.loading=!1}}):this.processWechatLogin()}else this.processWechatLogin()}catch(o){e.index.__f__("error","at pages/login/login.uvue:289","微信登录前检查授权失败：",o),this.processWechatLogin()}}))},processWechatLogin(){return e.__awaiter(this,void 0,void 0,(function*(){try{const e=(yield i.wxLogin()).code;if(!e)throw new Error("获取微信授权失败");yield o.loginWithWechat(new UTSJSONObject({code:e}));this.loginSuccess()}catch(t){e.index.showToast({title:t.message||"微信登录失败，请重试",icon:"none"})}finally{this.loading=!1}}))},onGetUserInfo(t=null){return e.__awaiter(this,void 0,void 0,(function*(){if("getUserInfo:ok"!==t.detail.errMsg)return e.index.showToast({title:"请授权获取用户信息",icon:"none"}),Promise.resolve(null);if(!this.isAgreed)return e.index.showToast({title:"请先同意用户协议和隐私政策",icon:"none"}),Promise.resolve(null);this.loading=!0;try{const e=(yield i.wxLogin()).code;if(!e)throw new Error("获取微信授权失败");yield o.loginWithWechat(new UTSJSONObject({code:e,userInfo:t.detail.userInfo}));this.loginSuccess()}catch(n){e.index.showToast({title:n.message||"微信登录失败，请重试",icon:"none"})}finally{this.loading=!1}}))},loginSuccess(){e.index.showToast({title:"登录成功",icon:"success"}),setTimeout((()=>{this.redirectUrl?t.Navigator.reLaunch(this.redirectUrl):t.Navigator.reLaunch(t.MainRoutes.INDEX)}),1500)},goToTerms(){t.Navigator.navigateTo(t.CommonRoutes.TERMS)},goToPrivacy(){t.Navigator.navigateTo(t.CommonRoutes.PRIVACY)}}});const r=e._export_sfc(s,[["render",function(o,t,i,s,r,l){return e.e({a:r.mobile,b:e.o((e=>r.mobile=e.detail.value)),c:r.code,d:e.o((e=>r.code=e.detail.value)),e:r.countdown<=0},r.countdown<=0?{f:e.o(((...e)=>l.sendCode&&l.sendCode(...e)))}:{},{g:e.o(((...e)=>l.handleMobileLogin&&l.handleMobileLogin(...e))),h:r.loading,i:r.isAgreed,j:e.o(((...e)=>l.customAgreementChange&&l.customAgreementChange(...e))),k:e.o(((...e)=>l.goToTerms&&l.goToTerms(...e))),l:e.o(((...e)=>l.goToPrivacy&&l.goToPrivacy(...e))),m:n._imports_0$4,n:e.o(((...e)=>l.onGetUserInfo&&l.onGetUserInfo(...e))),o:e.sei(o.virtualHostId,"view")})}]]);wx.createPage(r);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/login/login.js.map
