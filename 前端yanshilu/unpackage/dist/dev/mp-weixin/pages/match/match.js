"use strict";const e=require("../../common/vendor.js"),t=e.defineComponent({components:{TabBar:()=>"../../components/tab-bar/tab-bar.js"},data:()=>({activeDropdown:"",selectedSchool:"",selectedMajor:"",selectedSort:"综合排序",schools:["北京大学","清华大学","复旦大学","浙江大学","南京大学"],majors:["计算机科学","软件工程","数学","物理","化学","生物"],isWebEnv:!0,isLoading:!1,teachers:[new UTSJSONObject({id:1,nickname:"王教授",avatar:"/static/image/default_avatar.png",school:"北京大学",major:"计算机科学",title:"教授",score:"考研400分",tags:["认证学校","经验丰富"]}),new UTSJSONObject({id:2,nickname:"李博士",avatar:"/static/image/default_avatar.png",school:"清华大学",major:"软件工程",title:"副教授",score:"考研390分",tags:["认证学校","教学认真"]}),new UTSJSONObject({id:3,nickname:"张老师",avatar:"/static/image/default_avatar.png",school:"复旦大学",major:"数学",title:"讲师",score:"考研380分",tags:["认证学校","耐心细致"]}),new UTSJSONObject({id:4,nickname:"刘教授",avatar:"/static/image/default_avatar.png",school:"浙江大学",major:"物理",title:"教授",score:"考研410分",tags:["认证学校","通俗易懂"]}),new UTSJSONObject({id:5,nickname:"陈老师",avatar:"/static/image/default_avatar.png",school:"南京大学",major:"化学",title:"副教授",score:"考研385分",tags:["认证学校","答疑及时"]})],showTeacherDetail:!1,currentTeacher:null,activeTab:"chat",isMatching:!1,matchingTime:60,showCancelButton:!0,matchingTimer:null}),computed:{filteredTeachers(){let t=[...this.teachers];try{this.selectedSchool&&(t=t.filter((e=>e.school===this.selectedSchool))),this.selectedMajor&&(t=t.filter((e=>e.major===this.selectedMajor))),"评分排序"===this.selectedSort?t.sort(((t,a)=>{try{const e=parseInt(t.score.match(/\d+/)[0]);return parseInt(a.score.match(/\d+/)[0])-e}catch(o){return e.index.__f__("error","at pages/match/match.uvue:263","分数排序异常:",o),0}})):t.sort(((e,t)=>e.id-t.id))}catch(a){return e.index.__f__("error","at pages/match/match.uvue:273","筛选处理异常:",a),this.teachers}return t}},onReady(){e.index.__f__("log","at pages/match/match.uvue:283","Match page ready"),this.initFilterData(),this.detectEnvironment(),e.index.__f__("log","at pages/match/match.uvue:290","初始下拉菜单状态:",this.activeDropdown)},onShow(){setTimeout((()=>{this.isWebEnv&&(document.removeEventListener("click",this.handleGlobalClick),document.addEventListener("click",this.handleGlobalClick),e.index.__f__("log","at pages/match/match.uvue:302","全局点击事件监听已添加"))}),200)},onHide(){this.isWebEnv&&(document.removeEventListener("click",this.handleGlobalClick),e.index.__f__("log","at pages/match/match.uvue:311","全局点击事件监听已移除"))},onUnload(){this.isWebEnv&&document.removeEventListener("click",this.handleGlobalClick)},watch:{selectedSchool(){e.index.__f__("log","at pages/match/match.uvue:326","学校变更为:",this.selectedSchool)},selectedMajor(){e.index.__f__("log","at pages/match/match.uvue:330","专业变更为:",this.selectedMajor)},selectedSort(){e.index.__f__("log","at pages/match/match.uvue:333","排序方式变更为:",this.selectedSort)}},methods:{detectEnvironment(){try{this.isWebEnv="undefined"!=typeof document&&!!document.body;const t=e.index.getSystemInfoSync();e.index.__f__("log","at pages/match/match.uvue:348","当前环境:",t),"app"===t.uniPlatform&&(this.isWebEnv=!1)}catch(t){e.index.__f__("error","at pages/match/match.uvue:355","环境检测失败:",t),this.isWebEnv=!1}},initFilterData(){const t=e.index.getStorageSync("selectedSchool"),a=e.index.getStorageSync("selectedMajor"),o=e.index.getStorageSync("selectedSort");t&&(this.selectedSchool=t),a&&(this.selectedMajor=a),o&&(this.selectedSort=o),e.index.__f__("log","at pages/match/match.uvue:378","初始化筛选数据完成:",new UTSJSONObject({schools:this.schools,majors:this.majors,selectedSchool:this.selectedSchool,selectedMajor:this.selectedMajor}))},handleGlobalClick(t=null){if(!this.activeDropdown)return null;try{const a=t.target;let o=!1,c=a;for(;c&&c!==document.body;){if(c.classList&&(c.classList.contains("filter-item")||c.classList.contains("dropdown-menu")||c.classList.contains("dropdown-item"))){o=!0;break}c=c.parentElement}o?e.index.__f__("log","at pages/match/match.uvue:420","点击了筛选或下拉菜单区域，保持菜单状态"):(e.index.__f__("log","at pages/match/match.uvue:417","点击了筛选区域外部，关闭所有下拉菜单"),this.closeAllDropdowns())}catch(a){e.index.__f__("error","at pages/match/match.uvue:423","处理全局点击事件失败:",a),this.closeAllDropdowns()}},goBack(){e.index.navigateBack()},toggleDropdown(t=null){e.index.__f__("log","at pages/match/match.uvue:441","切换下拉菜单:",t,"当前状态:",this.activeDropdown),this.activeDropdown===t?(this.activeDropdown="",e.index.__f__("log","at pages/match/match.uvue:447","关闭下拉菜单:",t)):(this.activeDropdown=t,e.index.__f__("log","at pages/match/match.uvue:451","打开下拉菜单:",t))},closeAllDropdowns(){this.activeDropdown=""},selectFromDropdown(t=null,a=null){if(e.index.__f__("log","at pages/match/match.uvue:468",`选择${t}:`,a),"school"===t){this.selectedSchool=a;try{e.index.setStorageSync("selectedSchool",a)}catch(o){e.index.__f__("error","at pages/match/match.uvue:478","保存学校选择失败",o)}e.index.__f__("log","at pages/match/match.uvue:481","已选择学校:",a)}else if("major"===t){this.selectedMajor=a;try{e.index.setStorageSync("selectedMajor",a)}catch(o){e.index.__f__("error","at pages/match/match.uvue:489","保存专业选择失败",o)}e.index.__f__("log","at pages/match/match.uvue:492","已选择专业:",a)}else if("sort"===t){this.selectedSort=a;try{e.index.setStorageSync("selectedSort",a)}catch(o){e.index.__f__("error","at pages/match/match.uvue:500","保存排序选择失败",o)}e.index.__f__("log","at pages/match/match.uvue:503","已选择排序方式:",a)}this.closeAllDropdowns()},handleCommunicate(t=null){this.isLoading=!0,setTimeout((()=>{this.isLoading=!1;try{e.index.__f__("log","at pages/match/match.uvue:524",`打开与老师${t}的聊天窗口`),window.boxIM&&"function"==typeof window.boxIM.openChat?window.boxIM.openChat(t):e.index.showToast({title:"正在打开聊天窗口",icon:"none"})}catch(a){e.index.__f__("error","at pages/match/match.uvue:542","打开聊天窗口失败:",a),e.index.showToast({title:"老师当前不在线，请稍后再试",icon:"none"})}}),1e3)},showPickerPopup(t=null){e.index.__f__("log","at pages/match/match.uvue:556","显示选择弹出框:",t),this.$refs[`${t}Popup`].open()},closePopup(t=null){e.index.__f__("log","at pages/match/match.uvue:567","关闭弹出框:",t),this.$refs[`${t}Popup`].close()},handleNoMatchResult(){e.index.showModal({title:"暂无精确匹配",content:"是否查看相关推荐？（同专业其他学校或相关专业）",confirmText:"查看推荐",cancelText:"取消",success:t=>{t.confirm?this.getRelatedTeachers():e.index.__f__("log","at pages/match/match.uvue:589","用户取消查看推荐")}})},getRelatedTeachers(){this.isLoading=!0;const t=new UTSJSONObject({major:this.selectedMajor||"",isRelated:!0});e.index.request({url:"您的API地址/api/related-teachers",method:"GET",data:t,success:t=>{200===t.statusCode&&t.data&&(this.teachers=t.data.teachers||[],this.teachers.length>0?e.index.showToast({title:"已显示相关推荐",icon:"none"}):this.startMatchingTimer())},complete:()=>{this.isLoading=!1}})},startMatchingTimer(){this.isMatching=!0,this.matchingTime=60,this.showCancelButton=!0,this.matchingTimer=setInterval((()=>{this.matchingTime--,this.matchingTime<=0&&(clearInterval(this.matchingTimer),this.showLongTermMatchingTip())}),1e3)},cancelMatching(){this.matchingTimer&&(clearInterval(this.matchingTimer),this.matchingTimer=null),this.isMatching=!1,this.showCancelButton=!1,e.index.showToast({title:"已取消匹配",icon:"none"})},showLongTermMatchingTip(){this.isMatching=!1,e.index.showModal({title:"匹配超时",content:"我们将在后台继续为您匹配合适的老师，并提供优惠。是否继续等待？",confirmText:"继续等待",cancelText:"取消",success:t=>{t.confirm?this.startLongTermMatching():e.index.showToast({title:"已取消匹配",icon:"none"})}})},startLongTermMatching(){e.index.request({url:"您的API地址/api/long-term-matching",method:"POST",data:new UTSJSONObject({school:this.selectedSchool,major:this.selectedMajor,userId:"当前用户ID"}),success:t=>{200===t.statusCode&&e.index.showToast({title:"已启动后台匹配",icon:"none"})}})},showTeacherDetailPopup(e=null){this.currentTeacher=e,this.showTeacherDetail=!0,this.activeTab="chat"},closeTeacherDetail(){this.showTeacherDetail=!1},switchTab(e=null){this.activeTab=e},startChat(){this.closeTeacherDetail(),this.currentTeacher&&this.handleCommunicate(this.currentTeacher.id)},viewTeacherProfile(){this.currentTeacher&&e.index.navigateTo({url:`/pages/teacher/profile?id=${this.currentTeacher.id}`})},onReachBottom(){!this.isMatching&&this.filteredTeachers.length>0&&(this.isAllLoaded?e.index.showToast({title:"已经到底啦~",icon:"none"}):this.loadMoreTeachers())},loadMoreTeachers(){if(this.isLoadingMore)return null;this.isLoadingMore=!0,this.page++;const t=new UTSJSONObject({page:this.page,pageSize:this.pageSize,school:this.selectedSchool||"",major:this.selectedMajor||"",sortType:this.selectedSort||"综合排序"});e.index.request({url:"您的API地址/api/teachers",method:"GET",data:t,success:e=>{if(200===e.statusCode&&e.data){const t=e.data.teachers||[];t.length>0?this.teachers=[...this.teachers,...t]:this.isAllLoaded=!0}},complete:()=>{this.isLoadingMore=!1}})},viewTeacherDetail(t=null){e.index.navigateTo({url:`/pages/teacher/profile?id=${t}`})}}});if(!Array){e.resolveComponent("tab-bar")()}Math;const a=e._export_sfc(t,[["render",function(t,a,o,c,i,s){return e.e({a:e.sei("step1","view"),b:e.o(((...e)=>s.goBack&&s.goBack(...e))),c:e.t(i.selectedSchool||"请选择学校"),d:"school"===i.activeDropdown},"school"===i.activeDropdown?{e:e.f(i.schools,((t,a,o)=>({a:e.t(t),b:i.selectedSchool===t?1:"",c:a,d:e.o((e=>s.selectFromDropdown("school",t)),a)})))}:{},{f:"school"===i.activeDropdown?1:"",g:e.o((e=>s.toggleDropdown("school"))),h:e.t(i.selectedMajor||"请选择专业"),i:"major"===i.activeDropdown},"major"===i.activeDropdown?{j:e.f(i.majors,((t,a,o)=>({a:e.t(t),b:i.selectedMajor===t?1:"",c:a,d:e.o((e=>s.selectFromDropdown("major",t)),a)})))}:{},{k:"major"===i.activeDropdown?1:"",l:e.o((e=>s.toggleDropdown("major"))),m:e.t(i.selectedSort||"排序筛选"),n:"sort"===i.activeDropdown},"sort"===i.activeDropdown?{o:e.f(["综合排序","评分排序"],((t,a,o)=>({a:e.t(t),b:i.selectedSort===t?1:"",c:a,d:e.o((e=>s.selectFromDropdown("sort",t)),a)})))}:{},{p:"sort"===i.activeDropdown?1:"",q:e.o((e=>s.toggleDropdown("sort"))),r:e.f(s.filteredTeachers,((t,a,o)=>({a:t.avatar||"/static/image/default_avatar.svg",b:e.o((e=>s.viewTeacherDetail(t.id)),a),c:e.t(t.nickname),d:e.t(t.title||"教授"),e:e.t(t.major),f:e.t(t.score),g:e.f(t.tags,((t,a,o)=>({a:e.t(t),b:a}))),h:e.o((e=>s.handleCommunicate(t.id)),a),i:a}))),s:0===s.filteredTeachers.length},(s.filteredTeachers.length,{}),{t:e.sei("step2","scroll-view"),v:i.isLoading},(i.isLoading,{}),{w:i.showTeacherDetail},i.showTeacherDetail?e.e({x:e.o(((...e)=>s.closeTeacherDetail&&s.closeTeacherDetail(...e))),y:i.currentTeacher.avatar||"/static/image/default_avatar.png",z:e.t(i.currentTeacher.nickname),A:e.t(i.currentTeacher.title),B:e.t(i.currentTeacher.school),C:"chat"===i.activeTab?1:"",D:e.o((e=>s.switchTab("chat"))),E:"profile"===i.activeTab?1:"",F:e.o((e=>s.switchTab("profile"))),G:"chat"===i.activeTab},"chat"===i.activeTab?{H:e.o(((...e)=>s.startChat&&s.startChat(...e)))}:{},{I:"profile"===i.activeTab},"profile"===i.activeTab?{J:e.t(i.currentTeacher.background||"暂无介绍"),K:e.t(i.currentTeacher.experience||"暂无介绍"),L:e.f(i.currentTeacher.expertise||[],((t,a,o)=>({a:e.t(t),b:a}))),M:e.o(((...e)=>s.viewTeacherProfile&&s.viewTeacherProfile(...e)))}:{}):{},{N:i.isMatching},i.isMatching?{O:e.t(i.matchingTime),P:e.o(((...e)=>s.cancelMatching&&s.cancelMatching(...e)))}:{},{Q:e.p({pageName:"none"}),R:e.sei(t.virtualHostId,"view")})}]]);wx.createPage(a);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/match/match.js.map
