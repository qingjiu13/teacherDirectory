"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),s=e.defineComponent({data:()=>({postTitle:"",postContent:"",selectedCategory:"专业课",selectedTags:[],images:[],userInfo:null,isDraft:!1,draftId:null}),onLoad(e){e.draftId&&(this.draftId=e.draftId,this.loadDraft(e.draftId)),this.getUserInfo()},onShow(){this.isDraft||this.draftId||this.checkAutoSaveDraft()},onHide(){this.autoSaveDraft()},methods:{getUserInfo(){this.userInfo={id:100,nickname:"考研学生",avatar:"/static/image/default_avatar.png",school:"清华大学",major:"计算机科学"}},goBack(){this.postContent||this.images.length>0?e.index.showModal({title:"提示",content:"是否保存为草稿？",cancelText:"不保存",confirmText:"保存",success:t=>{t.confirm?this.saveAsDraft():e.index.navigateBack({delta:1,fail:()=>{e.index.reLaunch({url:"/pages/publish/publish"})}})}}):e.index.navigateBack({delta:1,fail:()=>{e.index.reLaunch({url:"/pages/publish/publish"})}})},showTagSelector(){e.index.showActionSheet({itemList:["专业课","数学","英语","政治","历史","地理","物理","化学","生物"],success:e=>{const t=e.tapIndex;this.selectedCategory=["专业课","数学","英语","政治","历史","地理","物理","化学","生物"][t]}})},showTagPrompt(){e.index.showModal({title:"添加标签",content:"添加一个标签，方便他人查找（15字以内）",editable:!0,placeholderText:"如：复习方法",success:t=>{if(t.confirm&&t.content){if(t.content.length>15)return e.index.showToast({title:"标签过长",icon:"none"}),null;if(this.selectedTags.length>=3)return e.index.showToast({title:"最多添加3个标签",icon:"none"}),null;if(this.selectedTags.includes(t.content))return e.index.showToast({title:"标签已存在",icon:"none"}),null;this.selectedTags.push(t.content)}}})},removeTag(e=null){this.selectedTags.splice(e,1)},chooseImage(){e.index.chooseImage({count:9-this.images.length,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{this.checkImageContent(e.tempFilePaths)}})},checkImageContent(e=null){setTimeout((()=>{this.images=[...this.images,...e],this.images.length>9&&(this.images=this.images.slice(0,9))}),500)},deleteImage(e=null){this.images.splice(e,1)},saveAsDraft(){if(!this.postContent&&0===this.images.length)return e.index.showToast({title:"请先输入内容",icon:"none"}),null;new UTSJSONObject({id:this.draftId||null,title:this.postTitle,content:this.postContent,category:this.selectedCategory,tags:this.selectedTags,images:this.images,updateTime:(new Date).getTime()}),e.index.showLoading({title:"保存中..."}),setTimeout((()=>{e.index.hideLoading(),e.index.showToast({title:"草稿保存成功",icon:"success"}),this.draftId||(this.draftId=(new Date).getTime().toString()),setTimeout((()=>{e.index.navigateBack({delta:1,fail:()=>{e.index.reLaunch({url:"/pages/publish/publish"})}})}),1e3)}),800)},autoSaveDraft(){if(this.postContent||this.images.length>0)try{e.index.setStorageSync("post_draft_auto",new UTSJSONObject({content:this.postContent,category:this.selectedCategory,tags:this.selectedTags,images:this.images,updateTime:(new Date).getTime()}))}catch(t){e.index.__f__("error","at pages/publish/editor.uvue:391","自动保存草稿失败",t)}},checkAutoSaveDraft(){try{const t=e.index.getStorageSync("post_draft_auto");if(t&&t.updateTime){const s=Math.floor(((new Date).getTime()-t.updateTime)/6e4);s<60?e.index.showModal({title:"发现未发布的内容",content:`您有${s}分钟前编辑的内容未发布，是否继续编辑？`,success:s=>{s.confirm?(this.postContent=t.content||"",this.selectedCategory=t.category||"专业课",this.selectedTags=t.tags||[],this.images=t.images||[]):e.index.removeStorageSync("post_draft_auto")}}):e.index.removeStorageSync("post_draft_auto")}}catch(t){e.index.__f__("error","at pages/publish/editor.uvue:427","检查自动草稿失败",t)}},loadDraft(e=null){setTimeout((()=>{const e=new UTSJSONObject({title:"考研复习经验分享",content:"分享一下我的考研经验，希望对大家有所帮助...",category:"专业课",tags:["复习方法","时间规划"],images:[]});this.postTitle=e.title,this.postContent=e.content,this.selectedCategory=e.category,this.selectedTags=e.tags,this.images=e.images,this.isDraft=!0}),500)},publishPost(){if(!this.postContent)return e.index.showToast({title:"请输入内容",icon:"none"}),null;e.index.showLoading({title:"发布中..."}),setTimeout((()=>{e.index.hideLoading(),e.index.showToast({title:"发布成功",icon:"success"}),e.index.removeStorageSync("post_draft_auto"),setTimeout((()=>{e.index.navigateBack({delta:1,fail:()=>{e.index.reLaunch({url:"/pages/publish/publish"})}})}),1e3)}),1500)},checkContent(t=null){if(/1[3-9]\d{9}/g.test(this.postContent)||/(微信|wx|weixin)[: ]*([a-zA-Z0-9_-]{6,20})/gi.test(this.postContent))return e.index.showToast({title:"内容含有联系方式，请修改后重试",icon:"none"}),null;e.index.request({url:"YOUR_API_URL/content/check",method:"POST",data:new UTSJSONObject({content:this.postContent}),success:s=>{200===s.statusCode&&s.data.valid?t&&t():e.index.showToast({title:s.data.message||"内容不合规，请修改后重试",icon:"none"})},fail:()=>{e.index.showToast({title:"网络异常，请稍后再试",icon:"none"})}})},uploadImages(t=null){if(0===this.images.length)return t&&t([]),null;const s=[];let i=0;e.index.showLoading({title:`上传图片 0/${this.images.length}`}),this.images.forEach((a=>{e.index.uploadFile({url:"YOUR_API_URL/upload/image",filePath:a,name:"file",success:a=>{if(i++,e.index.showLoading({title:`上传图片 ${i}/${this.images.length}`}),200===a.statusCode)try{const e=UTS.JSON.parse(a.data);e.url&&s.push(e.url)}catch(o){e.index.__f__("error","at pages/publish/editor.uvue:668","解析上传响应失败",o)}i===this.images.length&&(e.index.hideLoading(),t&&t(s))},fail:()=>{i++,e.index.showLoading({title:`上传图片 ${i}/${this.images.length}`}),i===this.images.length&&(e.index.hideLoading(),t&&t(s))}})}))}}});const i=e._export_sfc(s,[["render",function(s,i,a,o,n,l){return e.e({a:e.o(((...e)=>l.goBack&&l.goBack(...e))),b:e.t(n.isDraft?"编辑草稿":"发布新动态"),c:e.t(n.selectedCategory),d:t._imports_0$2,e:e.o(((...e)=>l.showTagSelector&&l.showTagSelector(...e))),f:e.f(n.selectedTags,((t,s,i)=>({a:e.t(t),b:e.o((e=>l.removeTag(s)),s),c:s}))),g:n.selectedTags.length<3},n.selectedTags.length<3?{h:e.o(((...e)=>l.showTagPrompt&&l.showTagPrompt(...e)))}:{},{i:n.postContent,j:e.o((e=>n.postContent=e.detail.value)),k:e.t(n.postContent.length),l:e.f(n.images,((t,s,i)=>({a:t,b:e.o((e=>l.deleteImage(s)),s),c:s}))),m:n.images.length<9},n.images.length<9?{n:e.o(((...e)=>l.chooseImage&&l.chooseImage(...e)))}:{},{o:e.o(((...e)=>l.saveAsDraft&&l.saveAsDraft(...e))),p:e.o(((...e)=>l.publishPost&&l.publishPost(...e))),q:!n.postContent.trim(),r:e.sei(s.virtualHostId,"view")})}]]);wx.createPage(i);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/publish/editor.js.map
