"use strict";const e=require("../common/vendor.js");function t(t,r){try{e.index.setStorageSync("jwtToken",t),r&&e.index.setStorageSync("refreshToken",r)}catch(n){e.index.__f__("error","at utils/jwt.js:18","存储JWT令牌失败:",n)}}function r(){try{return e.index.getStorageSync("jwtToken")}catch(t){return e.index.__f__("error","at utils/jwt.js:30","获取JWT令牌失败:",t),null}}function n(){try{e.index.removeStorageSync("jwtToken"),e.index.removeStorageSync("refreshToken")}catch(t){e.index.__f__("error","at utils/jwt.js:56","清除令牌失败:",t)}}function o(t){const r=function(t){try{if(!t)return null;const e=t.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(e).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""));return JSON.parse(r)}catch(r){return e.index.__f__("error","at utils/jwt.js:85","解析JWT令牌失败:",r),null}}(t);if(!r||!r.exp)return!0;return new Date(1e3*r.exp)<=new Date}exports.checkAndRefreshToken=async function(){const c=r();if(!c)return null;if(o(c))try{return await async function(){const r=function(){try{return e.index.getStorageSync("refreshToken")}catch(t){return e.index.__f__("error","at utils/jwt.js:43","获取刷新令牌失败:",t),null}}();if(!r)throw new Error("没有可用的刷新令牌");try{const n=await e.index.request({url:"/api/auth/refresh",method:"POST",data:{refreshToken:r},header:{"Content-Type":"application/json"}}),{data:o}=n;if(o.token)return t(o.token,o.refreshToken||r),o.token;throw new Error(o.message||"刷新令牌失败")}catch(o){throw n(),o}}()}catch(i){return e.index.__f__("error","at utils/jwt.js:116","刷新令牌失败:",i),n(),e.index.reLaunch({url:"/pages/login/login"}),null}return c},exports.clearTokens=n,exports.getToken=r,exports.setToken=t;
//# sourceMappingURL=../../.sourcemap/mp-weixin/utils/jwt.js.map
