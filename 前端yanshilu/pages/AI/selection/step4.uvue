<template>
	<view class="container">
		<view class="progress-bar">
			<text class="progress-text">4/6</text>
		</view>

		<view class="question-container">
			<view class="emoji">ğŸ˜„</view>
			<text class="question">æ‚¨æƒ³æŠ¥è€ƒçš„ç ”ç©¶ç”Ÿä¸“ä¸šæ˜¯ï¼Ÿ</text>
			
			<view class="search-box">
				<input class="search-input" 
					v-model="searchText" 
					placeholder="è¯·é€‰æ‹©ä¸“ä¸š" 
					@focus="showMajorList = true"
				/>
			</view>
			
			<!-- ä¸“ä¸šåˆ—è¡¨ -->
			<scroll-view 
				v-if="showMajorList" 
				class="major-list"
				scroll-y="true"
			>
				<view 
					v-for="(major, index) in filteredMajors" 
					:key="index"
					class="major-item"
					@click="selectMajor(major)"
				>
					<view class="major-name">{{major.name}}</view>
					<view class="major-code">{{major.code}} | {{major.category}}</view>
				</view>
			</scroll-view>
			
			<view v-if="selectedMajor" class="selected-info">
				<view class="selected-title">å·²é€‰æ‹©:</view>
				<view class="selected-major">
					<text class="major-name">{{selectedMajor.name}}</text>
					<text class="major-code">{{selectedMajor.code}} | {{selectedMajor.category}}</text>
				</view>
			</view>
			
			<text class="question second-question">å¸Œæœ›å°±è¯»çš„å­¦ä¹ æ–¹å¼æ˜¯ï¼Ÿ</text>
			<view class="options-container">
				<view 
					v-for="(option, index) in studyModes" 
					:key="index"
					:class="['option-item', selectedMode === option ? 'active' : '']"
					@click="selectMode(option)"
				>
					{{option}}
				</view>
			</view>
		</view>

		<view class="button-group">
			<button class="prev-btn" @click="prevPage">ä¸Šä¸€æ­¥</button>
			<button class="next-btn" @click="nextPage">ä¸‹ä¸€æ­¥</button>
		</view>
	</view>
</template>

<script>
	/**
	 * @description AIæ‹©æ ¡ç¬¬å››æ­¥é¡µé¢
	 */
	import { aiSelectionApis } from '../../../config.js';
	import callCloudFunction from '../../../utils/cloudFunction.js';
	
	export default {
		name: 'AISelectionStep4',
		data() {
			return {
				searchText: '',
				showMajorList: false,
				majors: [],
				studyModes: ['å…¨æ—¥åˆ¶', 'éå…¨æ—¥åˆ¶'],
				selectedMajor: null,
				selectedMode: '',
				loading: false,
				// æ·»åŠ æœ¬åœ°å¤‡ç”¨æ•°æ®ï¼Œé˜²æ­¢äº‘å‡½æ•°å¤±è´¥ - åŒ…å«è€ƒç ”ä¸“ä¸šçš„åç§°ã€ç¼–å·å’Œç±»åˆ«
				localMajors: [
					{ code: '0801', name: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯', category: 'å­¦æœ¯å­¦ä½' },
					{ code: '0835', name: 'è½¯ä»¶å·¥ç¨‹', category: 'å­¦æœ¯å­¦ä½' },
					{ code: '0854', name: 'ç”µå­ä¿¡æ¯', category: 'ä¸“ä¸šå­¦ä½' },
					{ code: '0812', name: 'è®¡ç®—æœºæŠ€æœ¯', category: 'ä¸“ä¸šå­¦ä½' },
					{ code: '0251', name: 'é‡‘è', category: 'ä¸“ä¸šå­¦ä½' },
					{ code: '0351', name: 'æ³•å¾‹', category: 'ä¸“ä¸šå­¦ä½' },
					{ code: '0452', name: 'ä½“è‚²', category: 'ä¸“ä¸šå­¦ä½' },
					{ code: '0451', name: 'æ•™è‚²', category: 'ä¸“ä¸šå­¦ä½' },
					{ code: '0551', name: 'ç¿»è¯‘', category: 'ä¸“ä¸šå­¦ä½' },
					{ code: '0501', name: 'ä¸­å›½è¯­è¨€æ–‡å­¦', category: 'å­¦æœ¯å­¦ä½' },
					{ code: '0701', name: 'æ•°å­¦', category: 'å­¦æœ¯å­¦ä½' },
					{ code: '0702', name: 'ç‰©ç†å­¦', category: 'å­¦æœ¯å­¦ä½' },
					{ code: '0703', name: 'åŒ–å­¦', category: 'å­¦æœ¯å­¦ä½' },
					{ code: '0710', name: 'ç”Ÿç‰©å­¦', category: 'å­¦æœ¯å­¦ä½' },
					{ code: '1002', name: 'ä¸´åºŠåŒ»å­¦', category: 'å­¦æœ¯å­¦ä½' },
					{ code: '1001', name: 'åŸºç¡€åŒ»å­¦', category: 'å­¦æœ¯å­¦ä½' },
					{ code: '0202', name: 'åº”ç”¨ç»æµå­¦', category: 'å­¦æœ¯å­¦ä½' },
					{ code: '0201', name: 'ç†è®ºç»æµå­¦', category: 'å­¦æœ¯å­¦ä½' },
					{ code: '0303', name: 'ç¤¾ä¼šå­¦', category: 'å­¦æœ¯å­¦ä½' },
					{ code: '0304', name: 'æ°‘æ—å­¦', category: 'å­¦æœ¯å­¦ä½' }
				]
			}
		},
		computed: {
			/**
			 * @description è¿‡æ»¤åçš„ä¸“ä¸šåˆ—è¡¨
			 * @returns {Array} è¿‡æ»¤åçš„ä¸“ä¸šåˆ—è¡¨
			 */
			filteredMajors() {
				const majorsToFilter = this.majors.length > 0 ? this.majors : this.localMajors;
				if (!this.searchText) return majorsToFilter;
				
				const keyword = this.searchText.toLowerCase();
				return majorsToFilter.filter(major => 
					major.name.toLowerCase().includes(keyword) || 
					major.code.includes(keyword) ||
					major.category.toLowerCase().includes(keyword)
				);
			}
		},
		onLoad() {
			// åŠ è½½ä¸“ä¸šæ•°æ®
			this.getMajorData();
			
			// æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æ•°æ®ï¼Œå¦‚æœæœ‰åˆ™å›æ˜¾
			const savedMajorJSON = uni.getStorageSync('step4_major');
			const savedMode = uni.getStorageSync('step4_mode');
			
			if (savedMajorJSON) {
				try {
					this.selectedMajor = JSON.parse(savedMajorJSON);
					this.searchText = this.selectedMajor.name;
				} catch (e) {
					console.error('è§£æå·²ä¿å­˜ä¸“ä¸šæ•°æ®å¤±è´¥:', e);
				}
			}
			
			if (savedMode) {
				this.selectedMode = savedMode;
			}
		},
		methods: {
			/**
			 * @description è·å–æŠ¥è€ƒä¸“ä¸šæ•°æ®
			 */
			async getMajorData() {
				this.loading = true;
				try {
					const result = await callCloudFunction({
						name: aiSelectionApis.getGraduateMajors, // ä½¿ç”¨è·å–ç ”ç©¶ç”Ÿä¸“ä¸šçš„æ¥å£
						data: {}
					});
					if (result.result && result.result.code === 0) {
						this.majors = result.result.data || [];
						console.log('è·å–åˆ°ä¸“ä¸šæ•°æ®:', this.majors);
					} else {
						console.warn('ä½¿ç”¨æœ¬åœ°ä¸“ä¸šåˆ—è¡¨');
						this.majors = this.localMajors;
					}
				} catch (e) {
					console.error('è·å–ä¸“ä¸šæ•°æ®å¤±è´¥:', e);
					this.majors = this.localMajors;
					uni.showToast({
						title: 'è·å–ä¸“ä¸šæ•°æ®å¤±è´¥',
						icon: 'none'
					});
				} finally {
					this.loading = false;
				}
			},
			
			/**
			 * @description æ ¹æ®å…³é”®è¯æœç´¢ä¸“ä¸š
			 * @param {String} keyword - æœç´¢å…³é”®è¯
			 */
			async searchMajors(keyword) {
				if (!keyword) return;
				this.loading = true;
				try {
					const result = await callCloudFunction({
						name: aiSelectionApis.getGraduateMajors, // ä½¿ç”¨è·å–ç ”ç©¶ç”Ÿä¸“ä¸šçš„æ¥å£
						data: { keyword }
					});
					if (result.result && result.result.code === 0) {
						// åªåœ¨æœ‰ç»“æœæ—¶æ›´æ–°åˆ—è¡¨ï¼Œé¿å…æ¸…ç©º
						if (result.result.data && result.result.data.length > 0) {
							this.majors = result.result.data;
						}
					}
				} catch (e) {
					console.error('æœç´¢ä¸“ä¸šå¤±è´¥:', e);
				} finally {
					this.loading = false;
				}
			},
			
			/**
			 * @description é€‰æ‹©ä¸“ä¸š
			 * @param {Object} major - é€‰æ‹©çš„ä¸“ä¸šå¯¹è±¡ï¼ŒåŒ…å«ç¼–å·ã€åç§°å’Œç±»åˆ«
			 */
			selectMajor(major) {
				this.searchText = major.name;
				this.selectedMajor = major;
				this.showMajorList = false;
				// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ - å°†å¯¹è±¡è½¬ä¸ºJSONå­—ç¬¦ä¸²
				uni.setStorageSync('step4_major', JSON.stringify(major));
			},
			
			/**
			 * @description é€‰æ‹©å­¦ä¹ æ–¹å¼
			 * @param {String} mode - é€‰æ‹©çš„å­¦ä¹ æ–¹å¼
			 */
			selectMode(mode) {
				this.selectedMode = mode;
				// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
				uni.setStorageSync('step4_mode', mode);
			},
			
			/**
			 * @description è¿”å›ä¸Šä¸€æ­¥
			 */
			prevPage() {
				uni.navigateBack();
			},
			
			/**
			 * @description è¿›å…¥ä¸‹ä¸€æ­¥
			 */
			nextPage() {
				if (!this.selectedMajor || !this.selectedMode) {
					uni.showToast({
						title: 'è¯·é€‰æ‹©å®Œæ•´ä¿¡æ¯',
						icon: 'none'
					});
					return;
				}
				uni.navigateTo({
					url: '/pages/AI/selection/step5'
				});
			}
		}
	}
</script>

<style>
	.container {
		padding: 30rpx;
	}
	
	.progress-bar {
		text-align: center;
		margin-bottom: 40rpx;
	}
	
	.progress-text {
		font-size: 32rpx;
		color: #FF9853;
		background: #FFF;
		padding: 10rpx 30rpx;
		border-radius: 30rpx;
	}
	
	.question-container {
		margin-top: 40rpx;
	}
	
	.emoji {
		font-size: 48rpx;
		margin-bottom: 20rpx;
	}
	
	.question {
		font-size: 36rpx;
		font-weight: bold;
		color: #333;
		margin-bottom: 40rpx;
		display: block;
	}
	
	.second-question {
		margin-top: 60rpx;
	}
	
	.search-box {
		margin: 20rpx 0;
	}
	
	.search-input {
		width: 100%;
		height: 80rpx;
		background: #F5F5F5;
		border-radius: 40rpx;
		padding: 0 30rpx;
		font-size: 28rpx;
	}
	
	.major-list {
		max-height: 400rpx;
		background: #FFFFFF;
		border-radius: 20rpx;
		box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.1);
	}
	
	.major-item {
		padding: 20rpx 30rpx;
		font-size: 28rpx;
		border-bottom: 1rpx solid #EEEEEE;
	}
	
	.major-item:active {
		background: #F5F5F5;
	}
	
	.major-name {
		font-weight: bold;
		font-size: 28rpx;
	}
	
	.major-code {
		font-size: 24rpx;
		color: #666;
		margin-top: 6rpx;
	}
	
	.selected-info {
		margin: 30rpx 0;
		background: #F8F8F8;
		border-radius: 16rpx;
		padding: 20rpx;
	}
	
	.selected-title {
		font-size: 26rpx;
		color: #666;
		margin-bottom: 10rpx;
	}
	
	.selected-major {
		display: flex;
		flex-direction: column;
	}
	
	.options-container {
		display: flex;
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: space-around;
		align-items: center;
		gap: 20rpx;
		margin-top: 30rpx;
		width: 100%;
	}
	
	.option-item {
		width: 45%;
		height: 80rpx;
		line-height: 80rpx;
		text-align: center;
		background: #F5F5F5;
		border-radius: 40rpx;
		font-size: 28rpx;
		color: #333;
		margin-bottom: 20rpx;
	}
	
	.active {
		background: #007AFF;
		color: #FFFFFF;
	}
	
	.button-group {
		position: fixed;
		bottom: 40rpx;
		left: 0;
		right: 0;
		padding: 0 30rpx;
		display: flex;
		flex-direction: row;
		justify-content: center;
		gap: 20rpx;
	}
	
	.prev-btn, .next-btn {
		width: 45%;
		height: 90rpx;
		line-height: 90rpx;
		border-radius: 45rpx;
		font-size: 32rpx;
	}
	
	.prev-btn {
		background: #FFFFFF;
		color: #007AFF;
		border: 1rpx solid #007AFF;
	}
	
	.next-btn {
		background: #007AFF;
		color: #FFFFFF;
	}
</style> 