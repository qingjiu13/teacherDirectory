<template>
	<view class="container">
		<view class="progress-bar">
			<text class="progress-text">6/6</text>
		</view>

		<view class="question-container">
			<view class="emoji">ğŸ“</view>
			<text class="question">æ‚¨çš„ç›®æ ‡çœä»½æ˜¯ï¼Ÿ</text>
			
			<view class="area-section">
				<text class="area-title">AåŒº</text>
				<view class="options-container">
					<view 
						v-for="(area, index) in areaA" 
						:key="index"
						:class="['option-item', selectedAreas.includes(area) ? 'active' : '']"
						@click="toggleArea(area)"
					>
						{{area}}
					</view>
				</view>
			</view>
			
			<view class="area-section">
				<text class="area-title">BåŒº</text>
				<view class="options-container">
					<view 
						v-for="(area, index) in areaB" 
						:key="index"
						:class="['option-item', selectedAreas.includes(area) ? 'active' : '']"
						@click="toggleArea(area)"
					>
						{{area}}
					</view>
				</view>
			</view>
		</view>

		<view class="button-group">
			<button class="prev-btn" @click="prevPage">ä¸Šä¸€æ­¥</button>
			<button class="complete-btn" @click="submitData">å®Œæˆ</button>
		</view>
	</view>
</template>

<script>
	/**
	 * @description AIæ‹©æ ¡ç¬¬å…­æ­¥é¡µé¢
	 */
	import { aiSelectionApis } from '../../../config.js';
	
	export default {
		name: 'AISelectionStep6',
		data() {
			return {
				areaA: ['åŒ—äº¬å¸‚', 'ä¸Šæµ·å¸‚', 'æµ™æ±Ÿçœ', 'æ±Ÿè‹çœ', 'æ¹–åŒ—çœ', 'å¹¿ä¸œçœ', 'å‰æ—çœ', 'å¤©æ´¥å¸‚'],
				areaB: ['å››å·çœ', 'å®‰å¾½çœ', 'é™•è¥¿çœ', 'é»‘é¾™æ±Ÿçœ', 'æ¹–å—çœ', 'å±±ä¸œçœ', 'ç¦å»ºçœ', 'è¾½å®çœ', 
					'é‡åº†å¸‚', 'æ²³å—çœ', 'æ±Ÿè¥¿çœ', 'å±±è¥¿çœ'],
				selectedAreas: []
			}
		},
		onLoad() {
			// æ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„æ•°æ®
			const savedAreas = uni.getStorageSync('step6_areas');
			if (savedAreas && Array.isArray(savedAreas)) {
				this.selectedAreas = savedAreas;
			}
		},
		methods: {
			/**
			 * @description åˆ‡æ¢é€‰æ‹©åŒºåŸŸ
			 * @param {String} area - åŒºåŸŸåç§°
			 */
			toggleArea(area) {
				const index = this.selectedAreas.indexOf(area);
				if (index === -1) {
					this.selectedAreas.push(area);
				} else {
					this.selectedAreas.splice(index, 1);
				}
				// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
				uni.setStorageSync('step6_areas', this.selectedAreas);
			},
			
			/**
			 * @description è¿”å›ä¸Šä¸€æ­¥
			 */
			prevPage() {
				uni.navigateBack();
			},
			
			/**
			 * @description æäº¤æ•°æ®ï¼Œå¼€å§‹åˆ†æ
			 */
			async submitData() {
				if (this.selectedAreas.length === 0) {
					uni.showToast({
						title: 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç›®æ ‡çœä»½',
						icon: 'none'
					});
					return;
				}

				try {
					uni.showLoading({
						title: 'å‡†å¤‡åˆ†æ...'
					});
					
					// ä»æœ¬åœ°å­˜å‚¨è·å–ä¹‹å‰æ­¥éª¤çš„æ•°æ®
					const formData = {
						identity: uni.getStorageSync('step1_data') || '',
						university: uni.getStorageSync('step2_school') || '',
						major: uni.getStorageSync('step2_major') || '',
						englishLevel: uni.getStorageSync('step3_english') || '',
						ranking: uni.getStorageSync('step3_ranking') || '',
						targetMajor: uni.getStorageSync('step4_major') || '',
						studyMode: uni.getStorageSync('step4_mode') || '',
						targetType: uni.getStorageSync('step5_target') || '',
						considerResearch: uni.getStorageSync('step5_research') || '',
						targetAreas: this.selectedAreas
					};
					
					console.log('æäº¤æ•°æ®:', formData);
					
					// å…ˆä¿å­˜åˆ†æè¯·æ±‚
					const saveResult = await uniCloud.callFunction({
						name: aiSelectionApis.saveAnalysisRequest,
						data: {
							formData: formData
						},
						timeout: 10000 // å¢åŠ è¶…æ—¶æ—¶é—´åˆ°10ç§’
					});
					
					uni.hideLoading();
					
					if (saveResult.result && saveResult.result.code === 0) {
						const analysisId = saveResult.result.data.id;
						
						// ç›´æ¥è·³è½¬åˆ°åˆ†æä¸­é¡µé¢ï¼Œä¸ç­‰å¾…åˆ†æå®Œæˆ
						uni.navigateTo({
							url: '/pages/AI/selection/analyzing?id=' + analysisId
						});
						
						// åå°å¼€å§‹å®é™…çš„AIåˆ†æè¿‡ç¨‹
						uniCloud.callFunction({
							name: aiSelectionApis.startAnalysis,
							data: { id: analysisId },
							success: (res) => {
								console.log('åˆ†æå¼€å§‹:', res);
							},
							fail: (err) => {
								console.error('å¯åŠ¨åˆ†æå¤±è´¥:', err);
							}
						});
					} else {
						throw new Error(saveResult.result?.msg || 'å‡†å¤‡åˆ†æå¤±è´¥');
					}
				} catch (e) {
					uni.hideLoading();
					uni.showModal({
						title: 'æç¤º',
						content: e.message || 'å‡†å¤‡åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•',
						showCancel: false
					});
				}
			}
		}
	}
</script>

<style>
	.container {
		padding: 30rpx;
	}
	
	.progress-bar {
		text-align: center;
		margin-bottom: 40rpx;
	}
	
	.progress-text {
		font-size: 32rpx;
		color: #FF9853;
		background: #FFF;
		padding: 10rpx 30rpx;
		border-radius: 30rpx;
	}
	
	.question-container {
		margin-top: 40rpx;
	}
	
	.emoji {
		font-size: 48rpx;
		margin-bottom: 20rpx;
	}
	
	.question {
		font-size: 36rpx;
		font-weight: bold;
		color: #333;
		margin-bottom: 40rpx;
		display: block;
	}
	
	.area-section {
		margin-top: 40rpx;
	}
	
	.area-title {
		font-size: 32rpx;
		font-weight: bold;
		color: #666;
		margin-bottom: 20rpx;
		display: block;
	}
	
	.options-container {
		display: flex;
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: space-around;
		align-items: center;
		gap: 20rpx;
		margin-top: 20rpx;
		width: 100%;
	}
	
	.option-item {
		width: 30%;
		height: 80rpx;
		line-height: 80rpx;
		text-align: center;
		background: #F5F5F5;
		border-radius: 40rpx;
		font-size: 28rpx;
		color: #333;
		margin-bottom: 20rpx;
	}
	
	.active {
		background: #007AFF;
		color: #FFFFFF;
	}
	
	.button-group {
		position: fixed;
		bottom: 40rpx;
		left: 0;
		right: 0;
		padding: 0 30rpx;
		display: flex;
		flex-direction: row;
		justify-content: center;
		gap: 20rpx;
	}
	
	.prev-btn {
		width: 48%;
		height: 90rpx;
		line-height: 90rpx;
		border-radius: 45rpx;
		font-size: 32rpx;
		background: #FFFFFF;
		color: #007AFF;
		border: 1rpx solid #007AFF;
	}
	
	.complete-btn {
		width: 48%;
		height: 90rpx;
		line-height: 90rpx;
		border-radius: 45rpx;
		font-size: 32rpx;
		background: #007AFF;
		color: #FFFFFF;
	}
</style> 