<template>
	<view class="container">
		<view class="progress-bar">
			<text class="progress-text">2/6</text>
		</view>

		<view class="question-container">
			<view class="emoji">ğŸ˜Š</view>
			<text class="question">æ‚¨çš„æœ¬ç§‘å­¦æ ¡æ˜¯ï¼Ÿ</text>
			
			<view class="search-box">
				<input class="search-input" 
					v-model="searchText" 
					placeholder="è¯·é€‰æ‹©ä½ çš„æœ¬ç§‘é™¢æ ¡" 
					@focus="showSchoolList = true"
				/>
			</view>
			
			<!-- å­¦æ ¡åˆ—è¡¨ -->
			<scroll-view 
				v-if="showSchoolList" 
				class="school-list"
				scroll-y="true"
			>
				<view 
					v-for="(school, index) in filteredSchools" 
					:key="index"
					class="school-item"
					@click="selectSchool(school)"
				>
					{{school}}
				</view>
			</scroll-view>
			
			<text class="question second-question">æ‚¨çš„æœ¬ç§‘ä¸“ä¸šæ˜¯ï¼Ÿ</text>
			<view class="search-box">
				<input class="search-input" 
					v-model="searchMajorText" 
					placeholder="è¯·è¾“å…¥ä½ çš„æœ¬ç§‘ä¸“ä¸š" 
					@focus="showMajorList = true"
				/>
			</view>
			
			<!-- ä¸“ä¸šåˆ—è¡¨ -->
			<scroll-view 
				v-if="showMajorList" 
				class="school-list"
				scroll-y="true"
			>
				<view 
					v-for="(major, index) in filteredMajors" 
					:key="index"
					class="school-item"
					@click="selectMajor(major)"
				>
					{{major}}
				</view>
			</scroll-view>
		</view>

		<view class="button-group">
			<button class="prev-btn" @click="prevPage">ä¸Šä¸€æ­¥</button>
			<button class="next-btn" @click="nextPage">ä¸‹ä¸€æ­¥</button>
		</view>
	</view>
</template>

<script>
	/**
	 * @description AIæ‹©æ ¡ç¬¬äºŒæ­¥é¡µé¢
	 */
	import { aiSelectionApis } from '../../../config.js';
	import callCloudFunction from '../../../utils/cloudFunction.js';
	import Routes from '../../../utils/routes.js';
	
	export default {
		name: 'AISelectionStep2',
		data() {
			return {
				selectedSchool: '',
				selectedMajor: '',
				showSchoolList: false,
				showMajorList: false,
				searchText: '',
				searchMajorText: '',
				schools: [], // å­¦æ ¡åˆ—è¡¨
				majors: [], // ä¸“ä¸šåˆ—è¡¨
				// æ·»åŠ æœ¬åœ°å¤‡ç”¨æ•°æ®ï¼Œé˜²æ­¢äº‘å‡½æ•°å¤±è´¥
				localSchools: [
					'åŒ—äº¬å¤§å­¦', 'æ¸…åå¤§å­¦', 'å¤æ—¦å¤§å­¦', 'ä¸Šæµ·äº¤é€šå¤§å­¦', 'æµ™æ±Ÿå¤§å­¦',
					'å—äº¬å¤§å­¦', 'ä¸­å›½äººæ°‘å¤§å­¦', 'æ­¦æ±‰å¤§å­¦', 'ä¸­å±±å¤§å­¦', 'åä¸­ç§‘æŠ€å¤§å­¦',
					'åŒ—äº¬å¸ˆèŒƒå¤§å­¦', 'å¦é—¨å¤§å­¦', 'å—å¼€å¤§å­¦', 'å‰æ—å¤§å­¦', 'è¥¿å®‰äº¤é€šå¤§å­¦',
					'å“ˆå°”æ»¨å·¥ä¸šå¤§å­¦', 'ç”µå­ç§‘æŠ€å¤§å­¦', 'ä¸œå—å¤§å­¦', 'å››å·å¤§å­¦', 'ä¸­å—å¤§å­¦'
				],
				localMajors: [
					'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯', 'è½¯ä»¶å·¥ç¨‹', 'äººå·¥æ™ºèƒ½', 'æ•°æ®ç§‘å­¦ä¸å¤§æ•°æ®æŠ€æœ¯',
					'ç½‘ç»œç©ºé—´å®‰å…¨', 'ç”µå­ä¿¡æ¯å·¥ç¨‹', 'é€šä¿¡å·¥ç¨‹', 'è‡ªåŠ¨åŒ–', 'æœºæ¢°å·¥ç¨‹',
					'åœŸæœ¨å·¥ç¨‹', 'å»ºç­‘å­¦', 'å·¥å•†ç®¡ç†', 'ä¼šè®¡å­¦', 'é‡‘èå­¦', 'ç»æµå­¦',
					'æ³•å­¦', 'åŒ»å­¦', 'ç”Ÿç‰©ç§‘å­¦', 'åŒ–å­¦', 'ç‰©ç†å­¦', 'æ•°å­¦', 'è‹±è¯­',
					'æ±‰è¯­è¨€æ–‡å­¦', 'æ–°é—»å­¦', 'å¿ƒç†å­¦', 'æ•™è‚²å­¦'
				]
			}
		},
		computed: {
			/**
			 * @description è¿‡æ»¤åçš„å­¦æ ¡åˆ—è¡¨
			 * @returns {Array} è¿‡æ»¤åçš„å­¦æ ¡åˆ—è¡¨
			 */
			filteredSchools() {
				if (!this.searchText) return this.schools.length > 0 ? this.schools : this.localSchools;
				const keyword = this.searchText.toLowerCase();
				return (this.schools.length > 0 ? this.schools : this.localSchools).filter(
					school => school.toLowerCase().includes(keyword)
				);
			},
			
			/**
			 * @description è¿‡æ»¤åçš„ä¸“ä¸šåˆ—è¡¨
			 * @returns {Array} è¿‡æ»¤åçš„ä¸“ä¸šåˆ—è¡¨
			 */
			filteredMajors() {
				if (!this.searchMajorText) return this.majors.length > 0 ? this.majors : this.localMajors;
				const keyword = this.searchMajorText.toLowerCase();
				return (this.majors.length > 0 ? this.majors : this.localMajors).filter(
					major => major.toLowerCase().includes(keyword)
				);
			}
		},
		onLoad() {
			this.loadSchools();
			
			// æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æ•°æ®ï¼Œå¦‚æœæœ‰åˆ™å›æ˜¾
			const savedSchool = uni.getStorageSync('step2_school');
			const savedMajor = uni.getStorageSync('step2_major');
			
			if (savedSchool) {
				this.selectedSchool = savedSchool;
				this.searchText = savedSchool;
			}
			
			if (savedMajor) {
				this.selectedMajor = savedMajor;
				this.searchMajorText = savedMajor;
			}
		},
		methods: {
			/**
			 * @description åŠ è½½å­¦æ ¡åˆ—è¡¨
			 */
			async loadSchools() {
				try {
					uni.showLoading({
						title: 'åŠ è½½ä¸­...'
					});
					
					const result = await callCloudFunction({
						name: aiSelectionApis.getSchools,
						data: {},
						timeout: 10000 // å¢åŠ è¶…æ—¶æ—¶é—´
					}).catch(err => {
						console.error('è·å–å­¦æ ¡åˆ—è¡¨å¤±è´¥:', err);
						return { result: { code: -1, msg: err.message } };
					});
					
					uni.hideLoading();
					
					if (result.result && result.result.code === 0) {
						this.schools = result.result.data || [];
						console.log('è·å–åˆ°å­¦æ ¡åˆ—è¡¨:', this.schools);
					} else {
						console.warn('ä½¿ç”¨æœ¬åœ°å­¦æ ¡åˆ—è¡¨');
						this.schools = this.localSchools;
					}
				} catch (e) {
					uni.hideLoading();
					console.error('åŠ è½½å­¦æ ¡åˆ—è¡¨å¼‚å¸¸:', e);
					// ä½¿ç”¨æœ¬åœ°å¤‡ç”¨æ•°æ®
					this.schools = this.localSchools;
				}
			},
			
			/**
			 * @description é€‰æ‹©å­¦æ ¡
			 * @param {String} school - é€‰æ‹©çš„å­¦æ ¡
			 */
			selectSchool(school) {
				this.selectedSchool = school;
				this.searchText = school;
				this.showSchoolList = false;
				uni.setStorageSync('step2_school', school);
			},
			
			/**
			 * @description åŠ è½½ä¸“ä¸šåˆ—è¡¨
			 */
			async loadMajors() {
				try {
					if (!this.selectedSchool) {
						return;
					}
					
					uni.showLoading({
						title: 'åŠ è½½ä¸­...'
					});
					
					const result = await callCloudFunction({
						name: aiSelectionApis.getUndergraduateMajors, // ä½¿ç”¨è·å–æœ¬ç§‘ä¸“ä¸šçš„æ¥å£
						data: {
							school: this.selectedSchool // ä¼ å…¥å­¦æ ¡å‚æ•°
						},
						timeout: 10000 // å¢åŠ è¶…æ—¶æ—¶é—´
					}).catch(err => {
						console.error('è·å–ä¸“ä¸šåˆ—è¡¨å¤±è´¥:', err);
						return { result: { code: -1, msg: err.message } };
					});
					
					uni.hideLoading();
					
					if (result.result && result.result.code === 0) {
						// æœ¬ç§‘ä¸“ä¸šåˆ—è¡¨æ˜¯ç®€å•çš„å­—ç¬¦ä¸²æ•°ç»„
						this.majors = result.result.data || [];
						console.log('è·å–åˆ°ä¸“ä¸šåˆ—è¡¨:', this.majors);
					} else {
						console.warn('ä½¿ç”¨æœ¬åœ°ä¸“ä¸šåˆ—è¡¨');
						this.majors = this.localMajors;
					}
				} catch (e) {
					uni.hideLoading();
					console.error('åŠ è½½ä¸“ä¸šåˆ—è¡¨å¼‚å¸¸:', e);
					// ä½¿ç”¨æœ¬åœ°å¤‡ç”¨æ•°æ®
					this.majors = this.localMajors;
				}
			},
			
			/**
			 * @description é€‰æ‹©ä¸“ä¸š
			 * @param {String} major - é€‰æ‹©çš„ä¸“ä¸š
			 */
			selectMajor(major) {
				this.selectedMajor = major;
				this.searchMajorText = major;
				this.showMajorList = false;
				uni.setStorageSync('step2_major', major);
			},
			
			/**
			 * @description è¿”å›ä¸Šä¸€é¡µ
			 */
			prevPage() {
				uni.navigateBack();
			},
			
			/**
			 * @description è¿›å…¥ä¸‹ä¸€æ­¥
			 */
			nextPage() {
				if (!this.selectedSchool) {
					uni.showToast({
						title: 'è¯·é€‰æ‹©æ‚¨çš„æœ¬ç§‘é™¢æ ¡',
						icon: 'none'
					});
					return;
				}
				
				if (!this.selectedMajor) {
					uni.showToast({
						title: 'è¯·é€‰æ‹©æ‚¨çš„æœ¬ç§‘ä¸“ä¸š',
						icon: 'none'
					});
					return;
				}
				
				// ä¿å­˜æ•°æ®
				this.formData.university = this.selectedSchool;
				this.formData.major = this.selectedMajor;
				uni.setStorageSync('step2_data', {
					university: this.selectedSchool,
					major: this.selectedMajor
				});
				
				// å¯¼èˆªåˆ°ä¸‹ä¸€æ­¥
				Routes.navigator.navigateTo(Routes.ai.step3);
			}
		}
	}
</script>

<style>
	.container {
		padding: 30rpx;
	}
	
	.progress-bar {
		text-align: center;
		margin-bottom: 40rpx;
	}
	
	.progress-text {
		font-size: 32rpx;
		color: #FF9853;
		background: #FFF;
		padding: 10rpx 30rpx;
		border-radius: 30rpx;
	}
	
	.question-container {
		margin-top: 40rpx;
	}
	
	.emoji {
		font-size: 48rpx;
		margin-bottom: 20rpx;
	}
	
	.question {
		font-size: 36rpx;
		font-weight: bold;
		color: #333;
		margin-bottom: 40rpx;
		display: block;
	}
	
	.second-question {
		margin-top: 40rpx;
	}
	
	.search-box {
		margin: 20rpx 0;
	}
	
	.search-input {
		width: 100%;
		height: 80rpx;
		background: #F5F5F5;
		border-radius: 40rpx;
		padding: 0 30rpx;
		font-size: 28rpx;
	}
	
	.school-list {
		max-height: 300rpx;
		background: #FFFFFF;
		border-radius: 20rpx;
		box-shadow: 0 2rpx 12rpx rgba(0, 0, 0, 0.1);
	}
	
	.school-item {
		padding: 20rpx 30rpx;
		font-size: 28rpx;
		border-bottom: 1rpx solid #EEEEEE;
	}
	
	.school-item:active {
		background: #F5F5F5;
	}
	
	.button-group {
		position: fixed;
		bottom: 40rpx;
		left: 0;
		right: 0;
		padding: 0 30rpx;
		display: flex;
		flex-direction: row;
		justify-content: center;
		gap: 20rpx;
	}
	
	.prev-btn, .next-btn {
		width: 45%;
		height: 90rpx;
		line-height: 90rpx;
		border-radius: 45rpx;
		font-size: 32rpx;
	}
	
	.prev-btn {
		background: #FFFFFF;
		color: #007AFF;
		border: 1rpx solid #007AFF;
	}
	
	.next-btn {
		background: #007AFF;
		color: #FFFFFF;
	}
</style> 