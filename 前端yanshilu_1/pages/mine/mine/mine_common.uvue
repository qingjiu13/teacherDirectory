<template>
  <view class="container">
    <!-- ç”¨æˆ·ä¿¡æ¯åŒº -->
    <view class="user-info">
      <view class="user-info-row">
        <image class="avatar" :src="userData.avatarUrl || '/static/image/tab-bar/default_avatar.png'" mode="aspectFill" @click="handleAvatarClick"></image>
        <view class="login-tag-container">
          <text class="login-text" @click="handleLoginClick">{{ userData.nickname || userName || 'ç™»å½•' }}</text>
          <view class="tag-btn" v-if="userData.tag">
            <text>{{ userData.tag }}</text>
          </view>
          <view class="tag-btn" v-else>
            <text>æ ‡ç­¾</text>
          </view>
        </view>
      </view>
      
      <!-- ä¿®æ”¹ä¸ªäººä¿¡æ¯æŒ‰é’® -->
      <view class="edit-profile-btn" @click="handleEditProfile">
        <text>ä¿®æ”¹ä¸ªäººä¿¡æ¯</text>
      </view>
      
      <!-- è°ƒè¯•ç”¨ï¼šè§’è‰²åˆ‡æ¢æŒ‰é’® -->
      <view class="debug-section">
        <view class="role-switch-container">
          <view class="role-btn" :class="{ active: userRole === 'student' }" @click="switchRole('student')">
            <text>å­¦ç”Ÿæ¨¡å¼</text>
          </view>
          <view class="role-btn" :class="{ active: userRole === 'teacher' }" @click="switchRole('teacher')">
            <text>è€å¸ˆæ¨¡å¼</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- èœå•åˆ—è¡¨ -->
    <view class="menu-list">
      <!-- è€å¸ˆç‰¹æœ‰åŠŸèƒ½èœå• -->
      <view v-if="userRole === 'teacher'" class="menu-item" @click="navigateTo(MineRoutes.SERVICE)">
        <view class="icon-circle info">
          <text class="icon-text">â±</text>
        </view>
        <text class="menu-text">æˆ‘çš„æœåŠ¡</text>
      </view>
      
      <!-- å…±æœ‰èœå•é¡¹ï¼šæˆ‘çš„è®¢å• -->
      <view class="menu-item" @click="navigateTo(MineRoutes.ORDER)">
        <view class="icon-circle success">
          <text class="icon-text">âœ“</text>
        </view>
        <text class="menu-text">æˆ‘çš„è®¢å•</text>
      </view>
      
      <!-- å…±æœ‰èœå•é¡¹ï¼šæˆ‘çš„è¯¾ç¨‹ -->
      <view class="menu-item" @click="navigateTo(MineRoutes.COURSE)">
        <view class="icon-circle info">
          <text class="icon-text">ğŸ“š</text>
        </view>
        <text class="menu-text">æˆ‘çš„è¯¾ç¨‹</text>
      </view>
      
      <!-- è€å¸ˆç‰¹æœ‰èœå•é¡¹ï¼šèµ„è´¨è®¤è¯ -->
      <view v-if="userRole === 'teacher'" class="menu-item" @click="navigateTo(MineRoutes.QUALIFICATION)">
        <view class="icon-circle info">
          <text class="icon-text">ğŸ“ƒ</text>
        </view>
        <text class="menu-text">èµ„è´¨è®¤è¯</text>
      </view>
      
      <!-- è€å¸ˆç‰¹æœ‰èœå•é¡¹ï¼šæˆ‘çš„é’±åŒ… -->
      <view v-if="userRole === 'teacher'" class="menu-item" @click="navigateTo(MineRoutes.WALLET)">
        <view class="icon-circle warning">
          <text class="icon-text">ğŸ’°</text>
        </view>
        <text class="menu-text">æˆ‘çš„é’±åŒ…</text>
      </view>
      
      <!-- å…±æœ‰èœå•é¡¹ï¼šå…³æ³¨å…¬ä¼—å· -->
      <view class="menu-item" @click="navigateTo('/pages/subscribe/subscribe')">
        <view class="icon-circle info">
          <text class="icon-text">ğŸ“¢</text>
        </view>
        <text class="menu-text">å…³æ³¨å…¬ä¼—å·</text>
      </view>
      
      <!-- å…±æœ‰èœå•é¡¹ï¼šè®¾ç½® -->
      <view class="menu-item" @click="navigateTo(MineRoutes.SETTINGS)">
        <view class="icon-circle info">
          <text class="icon-text">âš™ï¸</text>
        </view>
        <text class="menu-text">è®¾ç½®</text>
      </view>
    </view>
    
    <!-- é€€å‡ºç™»å½•æŒ‰é’® - å¯¹æ‰€æœ‰è§’è‰²éƒ½æ˜¾ç¤º -->
    <view class="menu-item" @click="handleLogout()" v-if="isLoggedIn">
      <view class="icon-circle warning">
        <text class="icon-text">âš </text>
      </view>
      <text class="menu-text">é€€å‡ºç™»å½•</text>
    </view>
    
    <!-- æ·»åŠ è‡ªå®šä¹‰åº•éƒ¨å¯¼èˆªæ  -->
    <TabBar pageName="mine" />
  </view>
</template>

<script>
/**
 * @description æˆ‘çš„é¡µé¢ï¼ˆé€šç”¨ï¼‰
 */
import { Navigator, MineRoutes } from '@/router/Router.js';
import TabBar from '../../../components/tab-bar/tab-bar.uvue';
import store, { loadTeacherData, loadStudentData } from '@/store/index.js';

export default {
  components: {
    TabBar
  },
  data() {
    return {
      userRole: 'student', // é»˜è®¤ä¸ºå­¦ç”Ÿè§’è‰²
      userName: '',
      userData: {},
      isLoggedIn: true, // é»˜è®¤è®¾ä¸ºtrueæ–¹ä¾¿è°ƒè¯•
      MineRoutes, // å¼•å…¥è·¯ç”±å¯¹è±¡æ–¹ä¾¿æ¨¡æ¿ä½¿ç”¨
      isLoading: false, // åŠ è½½çŠ¶æ€
      // æ¨¡æ‹Ÿæ•°æ®
      mockTeacherData: {
        id: 'teacher123',
        nickname: 'ç‹æ•™æˆ',
        avatarUrl: '/static/image/tab-bar/default_avatar.png',
        tag: 'å·²è®¤è¯',
        role: 'teacher',
        school: 'åŒ—äº¬å¤§å­¦',
        major: 'è®¡ç®—æœºç§‘å­¦',
        score: 4.9,
        wallet: {
          balance: 2580.50,
          income: 5000.00
        },
        qualifications: {
          isVerified: true,
          certificates: ['æ•™å¸ˆèµ„æ ¼è¯', 'å¿ƒç†å’¨è¯¢å¸ˆè¯']
        },
        services: [
          { id: 1, title: 'é«˜æ•°ä¸€å¯¹ä¸€', price: 300 },
          { id: 2, title: 'ç¼–ç¨‹è¾…å¯¼', price: 250 }
        ]
      },
      mockStudentData: {
        id: 'student456',
        nickname: 'å°æ˜åŒå­¦',
        avatarUrl: '/static/image/tab-bar/default_avatar.png',
        tag: 'å­¦ç”Ÿ',
        role: 'student',
        school: 'æ¸…åå¤§å­¦',
        major: 'æœºæ¢°å·¥ç¨‹',
        grade: 'å¤§äºŒ',
        courses: [
          { id: 101, title: 'é«˜ç­‰æ•°å­¦', progress: 60 },
          { id: 102, title: 'C++ç¼–ç¨‹åŸºç¡€', progress: 85 }
        ]
      }
    }
  },
  async onLoad() {
    // è®¾ç½®åŠ è½½çŠ¶æ€
    this.isLoading = true;
    
    try {
      // è·å–ç”¨æˆ·è§’è‰²ä¿¡æ¯æˆ–ä½¿ç”¨é»˜è®¤å€¼
      const storedUserRole = uni.getStorageSync('userRole') || 'student';
      this.userRole = storedUserRole;
      
      // æ ¹æ®è§’è‰²åŠ è½½æ•°æ®
      if (this.userRole === 'teacher') {
        // åŠ è½½æ•™å¸ˆç‰¹æœ‰æ•°æ®
        await loadTeacherData();
        console.log('æ•™å¸ˆæ•°æ®å·²åŠ è½½');
      } else {
        // åŠ è½½å­¦ç”Ÿç‰¹æœ‰æ•°æ®
        await loadStudentData();
        console.log('å­¦ç”Ÿæ•°æ®å·²åŠ è½½');
      }
      
      // åŠ è½½æµ‹è¯•æ•°æ®
      this.loadMockData();
      console.log("å½“å‰ç”¨æˆ·è§’è‰²:", this.userRole);
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  },
  async onShow() {
    // æ¯æ¬¡æ˜¾ç¤ºé¡µé¢æ—¶æ£€æŸ¥è§’è‰²çŠ¶æ€
    const storedUserRole = uni.getStorageSync('userRole');
    
    if (storedUserRole && storedUserRole !== this.userRole) {
      this.isLoading = true;
      
      try {
        this.userRole = storedUserRole;
        
        // è§’è‰²å˜æ›´æ—¶é‡æ–°åŠ è½½ç›¸åº”æ•°æ®
        if (this.userRole === 'teacher') {
          await loadTeacherData();
          console.log('æ•™å¸ˆæ•°æ®å·²é‡æ–°åŠ è½½');
        } else {
          await loadStudentData();
          console.log('å­¦ç”Ÿæ•°æ®å·²é‡æ–°åŠ è½½');
        }
        
        // é‡æ–°åŠ è½½å¯¹åº”çš„æµ‹è¯•æ•°æ®
        this.loadMockData();
        console.log("onShow æ›´æ–°ç”¨æˆ·è§’è‰²:", this.userRole);
      } catch (error) {
        console.error('è§’è‰²åˆ‡æ¢æ—¶åŠ è½½æ•°æ®å¤±è´¥:', error);
      } finally {
        this.isLoading = false;
      }
    }
  },
  methods: {
    /**
     * @description åŠ è½½æ¨¡æ‹Ÿæ•°æ®
     */
    loadMockData() {
      // æ ¹æ®å½“å‰è§’è‰²åŠ è½½å¯¹åº”çš„æ¨¡æ‹Ÿæ•°æ®
      if (this.userRole === 'teacher') {
        this.userData = this.mockTeacherData;
      } else {
        this.userData = this.mockStudentData;
      }
      
      this.userName = this.userData.nickname;
      
      // ä¿å­˜å½“å‰è§’è‰²åˆ°storage
      uni.setStorageSync('userRole', this.userRole);
      uni.setStorageSync('userInfo', JSON.stringify(this.userData));
      uni.setStorageSync('token', 'mock_token_for_testing'); // æ¨¡æ‹Ÿtoken
      
      this.isLoggedIn = true; // æµ‹è¯•æ¨¡å¼ä¸‹å§‹ç»ˆä¸ºç™»å½•çŠ¶æ€
      console.log("åŠ è½½æ¨¡æ‹Ÿæ•°æ®:", this.userData);
    },
    
    /**
     * @description åˆ‡æ¢ç”¨æˆ·è§’è‰²ï¼ˆç”¨äºè°ƒè¯•ï¼‰
     * @param {String} role - ç›®æ ‡è§’è‰²
     */
    switchRole(role) {
      if (this.userRole !== role) {
        this.userRole = role;
        this.loadMockData();
        uni.showToast({
          title: role === 'teacher' ? 'å·²åˆ‡æ¢ä¸ºè€å¸ˆæ¨¡å¼' : 'å·²åˆ‡æ¢ä¸ºå­¦ç”Ÿæ¨¡å¼',
          icon: 'none'
        });
      }
    },
    
    /**
     * @description åŠ è½½ç”¨æˆ·æ•°æ®ï¼ˆä¿ç•™åŸæ–¹æ³•ï¼Œä½†åœ¨è°ƒè¯•æ¨¡å¼ä¸ä½¿ç”¨ï¼‰
     */
    loadUserData() {
      // åœ¨æµ‹è¯•æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è€Œä¸æ˜¯ä»storageåŠ è½½
      if (uni.getStorageSync('debug_mode') === 'true') {
        this.loadMockData();
        return;
      }
      
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      const token = uni.getStorageSync('token');
      this.isLoggedIn = !!token;
      
      if (this.isLoggedIn) {
        // è·å–ç”¨æˆ·ä¿¡æ¯
        const userInfo = uni.getStorageSync('userInfo');
        if (userInfo) {
          try {
            this.userData = typeof userInfo === 'string' ? JSON.parse(userInfo) : userInfo;
            this.userName = this.userData.nickname || 'ç”¨æˆ·';
            
            // å¦‚æœå­˜å‚¨ä¸­æœ‰ç”¨æˆ·è§’è‰²ï¼Œä½¿ç”¨å­˜å‚¨çš„è§’è‰²
            if (this.userData.role) {
              this.userRole = this.userData.role;
              // åŒæ­¥æ›´æ–°åˆ°storage
              uni.setStorageSync('userRole', this.userData.role);
            }
          } catch (e) {
            console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
          }
        }
      } else {
        this.userData = {};
        this.userName = '';
        // æœªç™»å½•æ—¶é»˜è®¤æ˜¾ç¤ºå­¦ç”Ÿç•Œé¢
        this.userRole = 'student';
      }
      
      console.log("åŠ è½½ç”¨æˆ·æ•°æ®åçš„è§’è‰²:", this.userRole); // è°ƒè¯•è¾“å‡º
    },
    
    /**
     * @description å¤„ç†å¤´åƒç‚¹å‡»
     */
    handleAvatarClick() {
      // ç®€åŒ–å¤„ç†ï¼Œä¸æ£€æŸ¥ç™»å½•çŠ¶æ€
      this.handleEditProfile();
    },
    
    /**
     * @description å¤„ç†ç™»å½•æ–‡æœ¬ç‚¹å‡»
     */
    handleLoginClick() {
      // ç®€åŒ–å¤„ç†ï¼Œä¸æ£€æŸ¥ç™»å½•çŠ¶æ€
      this.handleEditProfile();
    },
    
    /**
     * @description è·³è½¬åˆ°ä¿®æ”¹ä¸ªäººä¿¡æ¯é¡µé¢
     */
    handleEditProfile() {
      // ç®€åŒ–å¤„ç†ï¼Œä¸æ£€æŸ¥ç™»å½•çŠ¶æ€
      Navigator.toModify();
    },
    
    /**
     * @description é¡µé¢è·³è½¬æ–¹æ³•
     * @param {string} url - ç›®æ ‡é¡µé¢è·¯å¾„
     */
    navigateTo(url) {
      // ç®€åŒ–å¤„ç†ï¼Œä¸æ£€æŸ¥ç™»å½•çŠ¶æ€
      Navigator.navigateTo(url);
    },
    
    /**
     * @description å¤„ç†é€€å‡ºç™»å½•
     */
    handleLogout() {
      uni.showModal({
        title: 'æç¤º',
        content: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
        success: (res) => {
          if (res.confirm) {
            // æ¸…é™¤ç™»å½•ä¿¡æ¯
            uni.removeStorageSync('token');
            uni.removeStorageSync('userInfo');
            uni.removeStorageSync('userRole');
            
            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            this.isLoggedIn = false;
            this.userData = {};
            this.userName = '';
            this.userRole = 'student'; // é€€å‡ºåé»˜è®¤æ˜¾ç¤ºå­¦ç”Ÿç•Œé¢
            
            uni.showToast({
              title: 'å·²é€€å‡ºç™»å½•',
              icon: 'success'
            });
          }
        }
      });
    }
  }
}
</script>

<style>
.container {
  display: flex;
  flex-direction: column;
  min-height: 100%;
  padding-bottom: 55px; /* ä¸ºè‡ªå®šä¹‰tabBarç•™å‡ºç©ºé—´ */
  background-color: #ffffff;
}

/* ç”¨æˆ·ä¿¡æ¯åŒºæ ·å¼ */
.user-info {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  padding: 30rpx;
  border-bottom: 1px solid #f0f0f0;
}

.user-info-row {
  display: flex;
  flex-direction: row;
  align-items: center;
  width: 100%;
  margin-bottom: 20rpx;
}

.avatar {
  width: 120rpx;
  height: 120rpx;
  border-radius: 50%;
  margin-right: 20rpx;
}

.login-tag-container {
  display: flex;
  flex-direction: row;
  align-items: center;
}

.login-text {
  font-size: 32rpx;
  font-weight: bold;
  margin-right: 20rpx;
}

.tag-btn {
  background-color: #f5f5f5;
  border-radius: 30rpx;
  padding: 8rpx 30rpx;
}

.tag-btn text {
  font-size: 26rpx;
  color: #666;
}

/* ä¿®æ”¹ä¸ªäººä¿¡æ¯æŒ‰é’® */
.edit-profile-btn {
  background-color: #f5f5f5;
  border-radius: 10rpx;
  padding: 15rpx 30rpx;
  margin-top: 10rpx;
  align-self: flex-start;
}

.edit-profile-btn text {
  font-size: 28rpx;
  color: #333;
}

/* è°ƒè¯•å·¥å…·æ ·å¼ */
.debug-section {
  width: 100%;
  margin-top: 20rpx;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.role-switch-container {
  display: flex;
  flex-direction: row;
  background-color: #f0f0f0;
  border-radius: 40rpx;
  padding: 6rpx;
  margin: 10rpx 0;
}

.role-btn {
  padding: 10rpx 30rpx;
  border-radius: 30rpx;
  margin: 0 5rpx;
}

.role-btn text {
  font-size: 26rpx;
  color: #666;
}

.role-btn.active {
  background-color: #2196F3;
}

.role-btn.active text {
  color: #ffffff;
}

/* èœå•åˆ—è¡¨ */
.menu-list {
  width: 100%;
}

.menu-item {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-start;
  padding: 30rpx 0;
  border-bottom: 1px solid #f0f0f0;
}

.icon-circle {
  width: 60rpx;
  height: 60rpx;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0 30rpx;
  flex-shrink: 0;
}

.success {
  background-color: rgba(76, 175, 80, 0.1);
}

.warning {
  background-color: rgba(255, 82, 82, 0.1);
}

.info {
  background-color: rgba(33, 150, 243, 0.1);
}

.icon-text {
  font-size: 30rpx;
  font-weight: bold;
}

.success .icon-text {
  color: #4CAF50;
}

.warning .icon-text {
  color: #FF5252;
}

.info .icon-text {
  color: #2196F3;
}

.menu-text {
  font-size: 30rpx;
  color: #333;
  text-align: left;
}
</style>