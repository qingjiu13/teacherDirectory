<template>
  <view class="ai-page">
    <view class="header">
      <text class="title">AIåŠ©æ‰‹</text>
    </view>
    <view class="content">
      <text class="welcome-text">æ¬¢è¿ä½¿ç”¨AIåŠ©æ‰‹ï¼Œæˆ‘èƒ½å¸®æ‚¨è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ</text>
      
      <!-- æ·»åŠ ç­›é€‰æ¡† -->
      <view class="filter-container">
        <text class="filter-title">è¯·é€‰æ‹©é—®é¢˜ç±»å‹ï¼š</text>
        <enhanced-dropdown
          ref="typeDropdown"
          :options="problemTypes"
          v-model="selectedType"
          placeholder="è¯·é€‰æ‹©é—®é¢˜ç±»å‹"
          searchable
          grouped
          :collect-full-data="true"
          @change="handleTypeChange"
          class="problem-filter"
        />
      </view>
      
      <!-- å¤šé€‰ç­›é€‰æ¡†ç¤ºä¾‹ -->
      <view class="filter-container" v-if="selectedType">
        <text class="filter-title">ç›¸å…³æ ‡ç­¾ï¼ˆå¯å¤šé€‰ï¼‰ï¼š</text>
        <enhanced-dropdown
          ref="tagDropdown"
          :options="relatedTags"
          v-model="selectedTags"
          placeholder="è¯·é€‰æ‹©ç›¸å…³æ ‡ç­¾"
          searchable
          multiple
          :max-selections="3"
          @change="handleTagsChange"
          class="problem-filter"
        />
      </view>
      
      <!-- ç®€å•çš„å¯¹è¯ç•Œé¢ -->
      <view class="chat-container">
        <view class="chat-messages">
          <view 
            v-for="(message, index) in messages" 
            :key="index"
            :class="['message', message.type === 'ai' ? 'ai-message' : 'user-message']"
          >
            <text class="message-text">{{ message.content }}</text>
          </view>
        </view>
        
        <view class="input-area">
          <input class="message-input" type="text" v-model="inputMessage" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." />
          <button class="send-button" @click="sendMessage">å‘é€</button>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
/**
 * @description AIåŠ©æ‰‹é¡µé¢
 */
import EnhancedDropdown from '../../components/combobox/combobox.uvue';

export default {
  components: {
    EnhancedDropdown
  },
  data() {
    return {
      // é¡µé¢æ•°æ®
      inputMessage: '',
      messages: [
        {
          type: 'ai',
          content: 'ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ'
        }
      ],
      
      // ç­›é€‰ç›¸å…³æ•°æ®
      selectedType: null,
      selectedTags: [],
      
      // æ¨¡æ‹Ÿé—®é¢˜ç±»å‹æ•°æ®
      problemTypes: [
        {
          value: 'technical',
          label: 'æŠ€æœ¯é—®é¢˜',
          icon: 'ğŸ”§',
          tags: ['å¸¸è§'],
          group: 'å¸¸ç”¨é—®é¢˜',
          metadata: {
            priority: 'high',
            responseTime: 'fast'
          }
        },
        {
          value: 'product',
          label: 'äº§å“å’¨è¯¢',
          icon: 'ğŸ“±',
          tags: ['çƒ­é—¨'],
          group: 'å¸¸ç”¨é—®é¢˜',
          metadata: {
            priority: 'medium',
            responseTime: 'normal'
          }
        },
        {
          value: 'account',
          label: 'è´¦æˆ·é—®é¢˜',
          icon: 'ğŸ‘¤',
          tags: ['ç´§æ€¥'],
          group: 'å¸¸ç”¨é—®é¢˜',
          metadata: {
            priority: 'high',
            responseTime: 'fast'
          }
        },
        {
          value: 'billing',
          label: 'è®¡è´¹é—®é¢˜',
          icon: 'ğŸ’°',
          tags: ['å¤æ‚'],
          group: 'å…¶ä»–é—®é¢˜',
          metadata: {
            priority: 'medium',
            responseTime: 'slow'
          }
        },
        {
          value: 'feedback',
          label: 'æ„è§åé¦ˆ',
          icon: 'ğŸ’¡',
          tags: ['éç´§æ€¥'],
          group: 'å…¶ä»–é—®é¢˜',
          metadata: {
            priority: 'low',
            responseTime: 'normal'
          }
        },
        {
          value: 'bug',
          label: 'è½¯ä»¶ç¼ºé™·',
          icon: 'ğŸ',
          tags: ['ç´§æ€¥'],
          group: 'æŠ€æœ¯æ”¯æŒ',
          metadata: {
            priority: 'high',
            responseTime: 'fast'
          }
        },
        {
          value: 'feature',
          label: 'åŠŸèƒ½å»ºè®®',
          icon: 'âœ¨',
          tags: ['éç´§æ€¥'],
          group: 'æŠ€æœ¯æ”¯æŒ',
          metadata: {
            priority: 'low',
            responseTime: 'slow'
          }
        }
      ],
      
      // æ ‡ç­¾ç­›é€‰å™¨é€‰é¡¹ï¼ˆåˆå§‹ä¸ºç©ºï¼Œä¼šæ ¹æ®é€‰æ‹©çš„é—®é¢˜ç±»å‹åŠ¨æ€å˜åŒ–ï¼‰
      relatedTags: []
    }
  },
  methods: {
    /**
     * @description å‘é€æ¶ˆæ¯
     */
    sendMessage() {
      if (this.inputMessage.trim()) {
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        this.messages.push({
          type: 'user',
          content: this.inputMessage
        });
        
        // æ¨¡æ‹ŸAIå›å¤
        const selectedTypeInfo = this.selectedType ? `é—®é¢˜ç±»å‹ï¼š${this.selectedType.label}` : '';
        const selectedTagsInfo = this.selectedTags.length > 0 ? 
          `ï¼Œæ ‡ç­¾ï¼š${this.selectedTags.map(tag => tag.label).join(', ')}` : '';
        
        setTimeout(() => {
          this.messages.push({
            type: 'ai',
            content: `æˆ‘å·²æ”¶åˆ°æ‚¨çš„é—®é¢˜"${this.inputMessage}"ã€‚${selectedTypeInfo}${selectedTagsInfo}ã€‚æˆ‘ä»¬å°†å°½å¿«ä¸ºæ‚¨è§£ç­”ï¼`
          });
        }, 500);
        
        this.inputMessage = '';
      }
    },
    
    /**
     * @description å¤„ç†é—®é¢˜ç±»å‹å˜æ›´
     * @param {Object} selectedType - é€‰ä¸­çš„é—®é¢˜ç±»å‹
     */
    handleTypeChange(selectedType) {
      if (selectedType) {
        console.log('é€‰æ‹©çš„é—®é¢˜ç±»å‹:', selectedType);
        
        // æ ¹æ®é€‰æ‹©çš„é—®é¢˜ç±»å‹åŠ¨æ€ç”Ÿæˆç›¸å…³æ ‡ç­¾
        this.generateRelatedTags(selectedType.value);
        
        // é‡ç½®å·²é€‰æ ‡ç­¾
        this.selectedTags = [];
      } else {
        this.relatedTags = [];
      }
    },
    
    /**
     * @description å¤„ç†æ ‡ç­¾å˜æ›´
     * @param {Array} selectedTags - é€‰ä¸­çš„æ ‡ç­¾åˆ—è¡¨
     */
    handleTagsChange(selectedTags) {
      console.log('é€‰æ‹©çš„æ ‡ç­¾:', selectedTags);
      
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ åŸºäºæ ‡ç­¾çš„å¤„ç†é€»è¾‘
    },
    
    /**
     * @description ç”Ÿæˆç›¸å…³æ ‡ç­¾
     * @param {String} problemType - é—®é¢˜ç±»å‹å€¼
     */
    generateRelatedTags(problemType) {
      // æ ¹æ®é—®é¢˜ç±»å‹ç”Ÿæˆä¸åŒçš„æ ‡ç­¾é€‰é¡¹
      const tagMappings = {
        'technical': [
          { value: 'framework', label: 'æ¡†æ¶é—®é¢˜', icon: 'ğŸ”¨' },
          { value: 'api', label: 'APIè°ƒç”¨', icon: 'ğŸ”„' },
          { value: 'performance', label: 'æ€§èƒ½é—®é¢˜', icon: 'âš¡' },
          { value: 'compatibility', label: 'å…¼å®¹æ€§', icon: 'ğŸ”—' }
        ],
        'product': [
          { value: 'usage', label: 'ä½¿ç”¨æ–¹æ³•', icon: 'ğŸ“' },
          { value: 'feature', label: 'åŠŸèƒ½å’¨è¯¢', icon: 'âœ¨' },
          { value: 'comparison', label: 'äº§å“å¯¹æ¯”', icon: 'âš–ï¸' }
        ],
        'account': [
          { value: 'login', label: 'ç™»å½•é—®é¢˜', icon: 'ğŸ”‘' },
          { value: 'security', label: 'å®‰å…¨ç›¸å…³', icon: 'ğŸ”’' },
          { value: 'profile', label: 'ä¸ªäººèµ„æ–™', icon: 'ğŸ“‹' }
        ],
        'billing': [
          { value: 'invoice', label: 'å‘ç¥¨é—®é¢˜', icon: 'ğŸ“„' },
          { value: 'payment', label: 'æ”¯ä»˜æ–¹å¼', icon: 'ğŸ’³' },
          { value: 'pricing', label: 'ä»·æ ¼å’¨è¯¢', icon: 'ğŸ’²' }
        ],
        'feedback': [
          { value: 'suggestion', label: 'å»ºè®®', icon: 'ğŸ’¬' },
          { value: 'complaint', label: 'æŠ•è¯‰', icon: 'âš ï¸' },
          { value: 'praise', label: 'è¡¨æ‰¬', icon: 'ğŸ‘' }
        ],
        'bug': [
          { value: 'crash', label: 'å´©æºƒ', icon: 'ğŸ’¥' },
          { value: 'ui', label: 'UIé—®é¢˜', icon: 'ğŸ–¼ï¸' },
          { value: 'logic', label: 'é€»è¾‘é”™è¯¯', icon: 'ğŸ§©' }
        ],
        'feature': [
          { value: 'enhancement', label: 'åŠŸèƒ½å¢å¼º', icon: 'ğŸš€' },
          { value: 'new', label: 'æ–°åŠŸèƒ½', icon: 'ğŸ†•' },
          { value: 'integration', label: 'é›†æˆéœ€æ±‚', icon: 'ğŸ”„' }
        ]
      };
      
      this.relatedTags = tagMappings[problemType] || [];
    },
    
    /**
     * @description è·å–æäº¤ç»™åç«¯çš„æ•°æ®
     * @returns {Object} ç”¨äºæäº¤ç»™åç«¯çš„æ•°æ®
     */
    getSubmitData() {
      return {
        problemType: this.$refs.typeDropdown.getPayloadData(),
        tags: this.$refs.tagDropdown.getPayloadData(),
        message: this.inputMessage
      };
    }
  }
}
</script>

<style>
.ai-page {
  padding: 20px;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
}

.title {
  font-size: 24px;
  font-weight: bold;
}

.content {
  display: flex;
  flex-direction: column;
  flex: 1;
}

.welcome-text {
  font-size: 16px;
  color: #666;
  text-align: center;
  margin-bottom: 20px;
}

/* ç­›é€‰æ¡†æ ·å¼ */
.filter-container {
  margin-bottom: 15px;
}

.filter-title {
  font-size: 14px;
  color: #333;
  margin-bottom: 8px;
  display: block;
}

.problem-filter {
  width: 100%;
}

.chat-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  border: 1px solid #eee;
  border-radius: 10px;
  background-color: #f9f9f9;
  padding: 10px;
  margin-top: 20px;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.message {
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 10px;
  max-width: 80%;
}

.ai-message {
  background-color: #e1f5fe;
  align-self: flex-start;
}

.user-message {
  background-color: #e8f5e9;
  align-self: flex-end;
  margin-left: auto;
}

.message-text {
  font-size: 14px;
}

.input-area {
  display: flex;
  margin-top: 10px;
}

.message-input {
  flex: 1;
  border: 1px solid #ddd;
  border-radius: 20px;
  padding: 10px 15px;
  font-size: 14px;
}

.send-button {
  margin-left: 10px;
  background-color: #2196f3;
  color: white;
  border-radius: 20px;
  padding: 0 20px;
  font-size: 14px;
}
</style>