{"version":3,"names":["choiceSelected","MESSAGE_TYPE","UTSJSONObject","USER","AI","SYSTEM","MESSAGE_STATUS","SENDING","SENT","ERROR","CHAT_MODE","GENERAL","SCHOOL","CAREER","_sfc_main","common_vendor","defineComponent","components","data","userInfo","school","major","inputValue","messages","isProcessing","isFullLoading","loadingText","autoScrollId","currentMode","schoolIndex","majorIndex","schoolList","choiceItemId","choiceItemContent","majorList","isAutoScrollEnabled","currentController","contextInfo","onLoad","getUserInfo","addSystemMessage","onUnload","abortCurrentRequest","methods","_this","index","getStorageSync","parsedInfo","UTS","JSON","parse","findIndex","item","e","__f__","saveUserInfo","setStorageSync","stringify","showToast","onPageClick","onSchoolClick","position","arguments","length","undefined","updateContextInfo","onMajorClick","onSchoolSearch","keyword","switchMode","mode","modeName","concat","userSchool","userMajor","content","push","type","status","scrollToBottom","sendMessage","trim","_context","next","abrupt","Promise","resolve","messageContent","aiMessageIndex","streaming","prev","params","message","context","history","getMessageHistory","controller","AbortController","sendStreamRequest","signal","updateMessageStatus","t0","name","splice","finish","stop","_callee","messageIndex","api_API","sendChatMessage","chunk","_this2","_context2","_callee2","retryMessage","_this3","userMessage","then","catch","error","finally","abort","limit","filter","msg","slice","map","role","onScrollToUpper","onScroll","title","icon","duration","showLoading","text","hideLoading","wx","createPage","MiniProgramPage"],"sources":["AI.uvue","cGFnZXMvQUkvQUkudXZ1ZQ"],"sourcesContent":["<template>\n\t<view class=\"page-container\" @click=\"onPageClick\">\n\t\t<!-- 筛选区域 -->\n\t\t<view class=\"filter-section\" @click.stop>\n\t\t\t<!-- 第一行：学校和专业 -->\n\t\t\t<view class=\"filter-row\">\n\t\t\t\t<view class=\"filter-item flex-1\">\n\t\t\t\t\t<text class=\"filter-label\">所在学校：</text>\n\t\t\t\t\t<view class=\"choice-wrapper\">\n\t\t\t\t\t\t<choice-selected \n\t\t\t\t\t\t\t:defaultText=\"'请选择学校'\" \n\t\t\t\t\t\t\t:choiceIndex=\"schoolIndex\" \n\t\t\t\t\t\t\t:choiceList=\"schoolList\"\n\t\t\t\t\t\t\tmode=\"search\"\n\t\t\t\t\t\t\t:searchPlaceholder=\"'搜索学校'\"\n\t\t\t\t\t\t\t@onChoiceClick=\"onSchoolClick\"\n\t\t\t\t\t\t\t@search-input=\"onSchoolSearch\">\n\t\t\t\t\t\t</choice-selected>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t\t\n\t\t\t\t<view class=\"filter-item flex-1\">\n\t\t\t\t\t<text class=\"filter-label\">专业：</text>\n\t\t\t\t\t<view class=\"choice-wrapper\">\n\t\t\t\t\t\t<choice-selected \n\t\t\t\t\t\t\t:defaultText=\"'请选择专业'\" \n\t\t\t\t\t\t\t:choiceIndex=\"majorIndex\" \n\t\t\t\t\t\t\t:choiceList=\"majorList\"\n\t\t\t\t\t\t\t@onChoiceClick=\"onMajorClick\">\n\t\t\t\t\t\t</choice-selected>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\t\t\n\t\t<!-- 功能模式区域 -->\n\t\t<view class=\"function-section\">\n\t\t\t<view class=\"function-list\">\n\t\t\t\t<view class=\"function-item\" \n\t\t\t\t\t:class=\"{active: currentMode === 'general'}\" \n\t\t\t\t\t@click=\"switchMode('general')\">\n\t\t\t\t\t<text class=\"function-item-text\">通用</text>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"function-item\" \n\t\t\t\t\t:class=\"{active: currentMode === 'school'}\" \n\t\t\t\t\t@click=\"switchMode('school')\">\n\t\t\t\t\t<text class=\"function-item-text\">择校</text>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"function-item\" \n\t\t\t\t\t:class=\"{active: currentMode === 'career'}\" \n\t\t\t\t\t@click=\"switchMode('career')\">\n\t\t\t\t\t<text class=\"function-item-text\">职业规划</text>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\t\t\n\t\t<!-- 消息区域 -->\n\t\t<view class=\"message-section\">\n\t\t\t<scroll-view \n\t\t\t\tscroll-y=\"true\" \n\t\t\t\tclass=\"message-scroll\" \n\t\t\t\t:scroll-into-view=\"autoScrollId\"\n\t\t\t\t@scrolltoupper=\"onScrollToUpper\"\n\t\t\t\t@scroll=\"onScroll\"\n\t\t\t\tref=\"messageScroll\">\n\t\t\t\t\n\t\t\t\t<view v-if=\"messages.length === 0\" class=\"empty-message\">\n\t\t\t\t\t<text>您可以开始提问了...</text>\n\t\t\t\t</view>\n\t\t\t\t\n\t\t\t\t<view v-else class=\"message-list\">\n\t\t\t\t\t<view v-for=\"(msg, index) in messages\" \n\t\t\t\t\t\t:key=\"index\" \n\t\t\t\t\t\t:id=\"'msg-' + index\"\n\t\t\t\t\t\tclass=\"message-item\" \n\t\t\t\t\t\t:class=\"[msg.type, {'streaming': msg.streaming}]\">\n\t\t\t\t\t\t<view class=\"message-header\" v-if=\"msg.type === 'ai'\">\n\t\t\t\t\t\t\t<text class=\"ai-title\">研师录AI</text>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t\t<view class=\"message-content\">\n\t\t\t\t\t\t\t<text>{{msg.content}}</text>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t\t<view class=\"message-status\" v-if=\"msg.status === 'sending'\">\n\t\t\t\t\t\t\t<text class=\"sending-dots\">...</text>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t\t<view class=\"message-status\" v-if=\"msg.status === 'error'\">\n\t\t\t\t\t\t\t<text class=\"error-text\">发送失败</text>\n\t\t\t\t\t\t\t<view class=\"retry-btn\" @click=\"retryMessage(index)\">\n\t\t\t\t\t\t\t\t<text>重试</text>\n\t\t\t\t\t\t\t</view>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t</scroll-view>\n\t\t</view>\n\t\t\n\t\t<!-- 输入区域 -->\n\t\t<view class=\"input-section\">\n\t\t\t<input class=\"message-input\" \n\t\t\t\tv-model=\"inputValue\" \n\t\t\t\tplaceholder=\"请输入您的问题...\" \n\t\t\t\t:disabled=\"isProcessing\"\n\t\t\t\t@confirm=\"sendMessage\" />\n\t\t\t<button class=\"send-button\" @click=\"sendMessage\" :disabled=\"isProcessing || !inputValue.trim()\">\n\t\t\t\t<text>{{isProcessing ? '请稍候' : '发送'}}</text>\n\t\t\t</button>\n\t\t</view>\n\t\t\n\t\t<!-- 加载提示 -->\n\t\t<view class=\"loading-mask\" v-if=\"isFullLoading\">\n\t\t\t<view class=\"loading-content\">\n\t\t\t\t<text>{{loadingText}}</text>\n\t\t\t</view>\n\t\t</view>\n\t</view>\n</template>\n\n<script lang=\"uts\">\n\timport choiceSelected from '../../components/combobox/combobox'\n\timport { sendChatMessage, abortRequest } from '../../api/API.js'\n\t\n\t// 消息类型常量\n\tconst MESSAGE_TYPE = {\n\t\tUSER: 'user',\n\t\tAI: 'ai',\n\t\tSYSTEM: 'system'\n\t}\n\t\n\t// 消息状态常量\n\tconst MESSAGE_STATUS = {\n\t\tSENDING: 'sending',\n\t\tSENT: 'sent',\n\t\tERROR: 'error'\n\t}\n\t\n\t// 对话模式常量\n\tconst CHAT_MODE = {\n\t\tGENERAL: 'general',\n\t\tSCHOOL: 'school',\n\t\tCAREER: 'career'\n\t}\n\t\n\texport default {\n\t\tcomponents: {\n\t\t\tchoiceSelected\n\t\t},\n\t\tdata() {\n\t\t\treturn {\n\t\t\t\t// 用户基本信息\n\t\t\t\tuserInfo: {\n\t\t\t\t\tschool: '',\n\t\t\t\t\tmajor: ''\n\t\t\t\t},\n\t\t\t\t\n\t\t\t\t// 消息相关\n\t\t\t\tinputValue: '',\n\t\t\t\tmessages: [],\n\t\t\t\tisProcessing: false, // 是否正在处理消息\n\t\t\t\tisFullLoading: false, // 是否显示全屏加载\n\t\t\t\tloadingText: '正在加载...',\n\t\t\t\tautoScrollId: '', // 用于自动滚动的ID\n\t\t\t\t\n\t\t\t\t// 对话模式\n\t\t\t\tcurrentMode: CHAT_MODE.GENERAL,\n\t\t\t\t\n\t\t\t\t// 学校和专业选择相关\n\t\t\t\tschoolIndex: -1,\n\t\t\t\tmajorIndex: -1,\n\t\t\t\tschoolList: [\n\t\t\t\t\t{ choiceItemId: \"bjdx\", choiceItemContent: \"北京大学\" },\n\t\t\t\t\t{ choiceItemId: \"qhdx\", choiceItemContent: \"清华大学\" },\n\t\t\t\t\t{ choiceItemId: \"fddx\", choiceItemContent: \"复旦大学\" },\n\t\t\t\t\t{ choiceItemId: \"zjdx\", choiceItemContent: \"浙江大学\" },\n\t\t\t\t\t{ choiceItemId: \"njdx\", choiceItemContent: \"南京大学\" },\n\t\t\t\t\t{ choiceItemId: \"scdx\", choiceItemContent: \"四川大学\" },\n\t\t\t\t\t{ choiceItemId: \"whdx\", choiceItemContent: \"武汉大学\" },\n\t\t\t\t\t{ choiceItemId: \"zsdx\", choiceItemContent: \"中山大学\" },\n\t\t\t\t\t{ choiceItemId: \"xjtu\", choiceItemContent: \"西安交通大学\" },\n\t\t\t\t\t{ choiceItemId: \"hust\", choiceItemContent: \"华中科技大学\" },\n\t\t\t\t\t{ choiceItemId: \"hit\", choiceItemContent: \"哈尔滨工业大学\" },\n\t\t\t\t\t{ choiceItemId: \"sjtu\", choiceItemContent: \"上海交通大学\" }\n\t\t\t\t],\n\t\t\t\tmajorList: [\n\t\t\t\t\t{ choiceItemId: \"jsjkx\", choiceItemContent: \"计算机科学\" },\n\t\t\t\t\t{ choiceItemId: \"rjgc\", choiceItemContent: \"软件工程\" },\n\t\t\t\t\t{ choiceItemId: \"sx\", choiceItemContent: \"数学\" },\n\t\t\t\t\t{ choiceItemId: \"wl\", choiceItemContent: \"物理\" },\n\t\t\t\t\t{ choiceItemId: \"hx\", choiceItemContent: \"化学\" },\n\t\t\t\t\t{ choiceItemId: \"sw\", choiceItemContent: \"生物\" },\n\t\t\t\t\t{ choiceItemId: \"jdxy\", choiceItemContent: \"机电工程\" },\n\t\t\t\t\t{ choiceItemId: \"dqxy\", choiceItemContent: \"电气工程\" },\n\t\t\t\t\t{ choiceItemId: \"jzxy\", choiceItemContent: \"建筑学\" },\n\t\t\t\t\t{ choiceItemId: \"lyxy\", choiceItemContent: \"临床医学\" },\n\t\t\t\t\t{ choiceItemId: \"yyxy\", choiceItemContent: \"药学\" },\n\t\t\t\t\t{ choiceItemId: \"glxy\", choiceItemContent: \"管理学\" },\n\t\t\t\t\t{ choiceItemId: \"jjxy\", choiceItemContent: \"经济学\" },\n\t\t\t\t\t{ choiceItemId: \"flxy\", choiceItemContent: \"法学\" }\n\t\t\t\t],\n\t\t\t\t\n\t\t\t\t// 滚动相关\n\t\t\t\tisAutoScrollEnabled: true,\n\t\t\t\t\n\t\t\t\t// 当前会话的请求控制器\n\t\t\t\tcurrentController: null,\n\t\t\t\t\n\t\t\t\t// 自定义的上下文信息\n\t\t\t\tcontextInfo: {}\n\t\t\t}\n\t\t},\n\t\tonLoad() {\n\t\t\t/**\n\t\t\t * @description 页面加载时的处理逻辑\n\t\t\t */\n\t\t\t// 尝试获取用户信息并初始化\n\t\t\tthis.getUserInfo();\n\t\t\t\n\t\t\t// 添加欢迎消息\n\t\t\tthis.addSystemMessage('欢迎使用研师录AI助手，请选择您的所在学校和专业，然后开始提问');\n\t\t},\n\t\tonUnload() {\n\t\t\t// 页面卸载时中断所有未完成的请求\n\t\t\tthis.abortCurrentRequest();\n\t\t},\n\t\tmethods: {\n\t\t\t/**\n\t\t\t * @description 获取用户信息\n\t\t\t */\n\t\t\tgetUserInfo() {\n\t\t\t\ttry {\n\t\t\t\t\tconst userInfo = uni.getStorageSync('userInfo');\n\t\t\t\t\tif (userInfo) {\n\t\t\t\t\t\tconst parsedInfo = JSON.parse(userInfo);\n\t\t\t\t\t\tthis.userInfo = parsedInfo;\n\t\t\t\t\t\t\n\t\t\t\t\t\t// 根据保存的用户信息设置选择框的索引\n\t\t\t\t\t\tif (this.userInfo.school) {\n\t\t\t\t\t\t\tconst schoolIndex = this.schoolList.findIndex(\n\t\t\t\t\t\t\t\titem => item.choiceItemContent === this.userInfo.school\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tif (schoolIndex !== -1) {\n\t\t\t\t\t\t\t\tthis.schoolIndex = schoolIndex;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (this.userInfo.major) {\n\t\t\t\t\t\t\tconst majorIndex = this.majorList.findIndex(\n\t\t\t\t\t\t\t\titem => item.choiceItemContent === this.userInfo.major\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tif (majorIndex !== -1) {\n\t\t\t\t\t\t\t\tthis.majorIndex = majorIndex;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tuni.__f__('error','at pages/AI/AI.uvue:255','获取用户信息失败:', e);\n\t\t\t\t}\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 保存用户信息\n\t\t\t */\n\t\t\tsaveUserInfo() {\n\t\t\t\ttry {\n\t\t\t\t\tuni.setStorageSync('userInfo', JSON.stringify(this.userInfo));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tuni.__f__('error','at pages/AI/AI.uvue:266','保存用户信息失败:', e);\n\t\t\t\t\tthis.showToast('保存用户信息失败，可能影响后续对话');\n\t\t\t\t}\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 页面点击事件，用于关闭下拉框\n\t\t\t */\n\t\t\tonPageClick() {\n\t\t\t\t// 这里不需要做额外操作，combobox组件会处理自己的关闭逻辑\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 学校选择事件处理\n\t\t\t * @param {Number} position - 选择的索引位置\n\t\t\t */\n\t\t\tonSchoolClick(position) {\n\t\t\t\tthis.schoolIndex = position;\n\t\t\t\tthis.userInfo.school = this.schoolList[position].choiceItemContent;\n\t\t\t\tthis.saveUserInfo();\n\t\t\t\t// 更新对话上下文\n\t\t\t\tthis.updateContextInfo();\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 专业选择事件处理\n\t\t\t * @param {Number} position - 选择的索引位置\n\t\t\t */\n\t\t\tonMajorClick(position) {\n\t\t\t\tthis.majorIndex = position;\n\t\t\t\tthis.userInfo.major = this.majorList[position].choiceItemContent;\n\t\t\t\tthis.saveUserInfo();\n\t\t\t\t// 更新对话上下文\n\t\t\t\tthis.updateContextInfo();\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 处理学校搜索输入\n\t\t\t * @param {String} keyword - 搜索关键词\n\t\t\t */\n\t\t\tonSchoolSearch(keyword) {\n\t\t\t\tuni.__f__('log','at pages/AI/AI.uvue:307','学校搜索:', keyword);\n\t\t\t\t// 这里可以实现动态学校搜索逻辑，例如从服务器获取匹配的学校\n\t\t\t\t// 简单实现：如果需要从服务器获取，可以在这里添加API调用\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 切换对话模式\n\t\t\t * @param {String} mode - 对话模式\n\t\t\t */\n\t\t\tswitchMode(mode) {\n\t\t\t\tif (this.currentMode === mode) return;\n\t\t\t\t\n\t\t\t\tthis.currentMode = mode;\n\t\t\t\t\n\t\t\t\t// 更新对话上下文\n\t\t\t\tthis.updateContextInfo();\n\t\t\t\t\n\t\t\t\t// 添加系统消息\n\t\t\t\tlet modeName = '通用';\n\t\t\t\tif (mode === CHAT_MODE.SCHOOL) {\n\t\t\t\t\tmodeName = '择校';\n\t\t\t\t} else if (mode === CHAT_MODE.CAREER) {\n\t\t\t\t\tmodeName = '职业规划';\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tthis.addSystemMessage(`已切换到${modeName}模式`);\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 更新对话上下文信息\n\t\t\t */\n\t\t\tupdateContextInfo() {\n\t\t\t\tthis.contextInfo = {\n\t\t\t\t\tmode: this.currentMode,\n\t\t\t\t\tuserSchool: this.userInfo.school || '',\n\t\t\t\t\tuserMajor: this.userInfo.major || ''\n\t\t\t\t};\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 添加系统消息\n\t\t\t * @param {String} content - 消息内容\n\t\t\t */\n\t\t\taddSystemMessage(content) {\n\t\t\t\tthis.messages.push({\n\t\t\t\t\ttype: MESSAGE_TYPE.SYSTEM,\n\t\t\t\t\tcontent: content,\n\t\t\t\t\tstatus: MESSAGE_STATUS.SENT\n\t\t\t\t});\n\t\t\t\tthis.scrollToBottom();\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 发送消息\n\t\t\t */\n\t\t\tasync sendMessage() {\n\t\t\t\tif (!this.inputValue.trim() || this.isProcessing) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// 获取输入内容并清空输入框\n\t\t\t\tconst messageContent = this.inputValue.trim();\n\t\t\t\tthis.inputValue = '';\n\t\t\t\t\n\t\t\t\t// 添加用户消息\n\t\t\t\tconst userMessageIndex = this.messages.length;\n\t\t\t\tthis.messages.push({\n\t\t\t\t\ttype: MESSAGE_TYPE.USER,\n\t\t\t\t\tcontent: messageContent,\n\t\t\t\t\tstatus: MESSAGE_STATUS.SENT\n\t\t\t\t});\n\t\t\t\t\n\t\t\t\t// 添加AI消息（初始为加载状态）\n\t\t\t\tconst aiMessageIndex = this.messages.length;\n\t\t\t\tthis.messages.push({\n\t\t\t\t\ttype: MESSAGE_TYPE.AI,\n\t\t\t\t\tcontent: '',\n\t\t\t\t\tstatus: MESSAGE_STATUS.SENDING,\n\t\t\t\t\tstreaming: true\n\t\t\t\t});\n\t\t\t\t\n\t\t\t\tthis.scrollToBottom();\n\t\t\t\tthis.isProcessing = true;\n\t\t\t\t\n\t\t\t\ttry {\n\t\t\t\t\t// 创建上下文\n\t\t\t\t\tthis.updateContextInfo();\n\t\t\t\t\t\n\t\t\t\t\t// 准备请求参数\n\t\t\t\t\tconst params = {\n\t\t\t\t\t\tmessage: messageContent,\n\t\t\t\t\t\tcontext: this.contextInfo,\n\t\t\t\t\t\thistory: this.getMessageHistory()\n\t\t\t\t\t};\n\t\t\t\t\t\n\t\t\t\t\t// 创建请求控制器（用于中断请求）\n\t\t\t\t\tthis.abortCurrentRequest(); // 中断之前的请求\n\t\t\t\t\tconst controller = new AbortController();\n\t\t\t\t\tthis.currentController = controller;\n\t\t\t\t\t\n\t\t\t\t\t// 发送请求并处理流式响应\n\t\t\t\t\tawait this.sendStreamRequest(params, aiMessageIndex, controller.signal);\n\t\t\t\t\t\n\t\t\t\t\t// 请求完成后更新状态\n\t\t\t\t\tthis.updateMessageStatus(aiMessageIndex, MESSAGE_STATUS.SENT);\n\t\t\t\t\tthis.messages[aiMessageIndex].streaming = false;\n\t\t\t\t\t\n\t\t\t\t} catch (error) {\n\t\t\t\t\tuni.__f__('error','at pages/AI/AI.uvue:415','发送消息失败:', error);\n\t\t\t\t\t\n\t\t\t\t\t// 检查是否是用户主动取消的请求\n\t\t\t\t\tif (error.name === 'AbortError') {\n\t\t\t\t\t\tuni.__f__('log','at pages/AI/AI.uvue:419','请求被用户取消');\n\t\t\t\t\t\t// 用户取消请求时，移除最后的AI消息（通常是不完整的）\n\t\t\t\t\t\tthis.messages.splice(aiMessageIndex, 1);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// 其他错误，更新消息状态为错误\n\t\t\t\t\t\tthis.updateMessageStatus(aiMessageIndex, MESSAGE_STATUS.ERROR);\n\t\t\t\t\t\tthis.messages[aiMessageIndex].streaming = false;\n\t\t\t\t\t\tthis.messages[aiMessageIndex].content = error.message || '获取回复失败，请重试';\n\t\t\t\t\t}\n\t\t\t\t} finally {\n\t\t\t\t\tthis.isProcessing = false;\n\t\t\t\t\tthis.currentController = null;\n\t\t\t\t}\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 发送流式请求并处理响应\n\t\t\t * @param {Object} params - 请求参数\n\t\t\t * @param {Number} messageIndex - 消息索引\n\t\t\t * @param {AbortSignal} signal - 中断信号\n\t\t\t */\n\t\t\tasync sendStreamRequest(params, messageIndex, signal) {\n\t\t\t\ttry {\n\t\t\t\t\tawait sendChatMessage(\n\t\t\t\t\t\tparams,\n\t\t\t\t\t\t(chunk) => {\n\t\t\t\t\t\t\t// 每收到一个数据块，就更新消息内容\n\t\t\t\t\t\t\tif (chunk && typeof chunk === 'string') {\n\t\t\t\t\t\t\t\tthis.messages[messageIndex].content += chunk;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tthis.scrollToBottom();\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsignal\n\t\t\t\t\t);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 重试发送失败的消息\n\t\t\t * @param {Number} index - 消息索引\n\t\t\t */\n\t\t\tretryMessage(index) {\n\t\t\t\t// 只能重试AI消息\n\t\t\t\tif (index < 1 || this.messages[index].type !== MESSAGE_TYPE.AI) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// 获取对应的用户消息\n\t\t\t\tconst userMessage = this.messages[index - 1];\n\t\t\t\tif (userMessage.type !== MESSAGE_TYPE.USER) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// 更新消息状态\n\t\t\t\tthis.updateMessageStatus(index, MESSAGE_STATUS.SENDING);\n\t\t\t\tthis.messages[index].content = '';\n\t\t\t\tthis.messages[index].streaming = true;\n\t\t\t\t\n\t\t\t\t// 重新发送消息\n\t\t\t\tthis.isProcessing = true;\n\t\t\t\t\n\t\t\t\t// 创建请求控制器\n\t\t\t\tthis.abortCurrentRequest();\n\t\t\t\tconst controller = new AbortController();\n\t\t\t\tthis.currentController = controller;\n\t\t\t\t\n\t\t\t\t// 准备请求参数\n\t\t\t\tconst params = {\n\t\t\t\t\tmessage: userMessage.content,\n\t\t\t\t\tcontext: this.contextInfo,\n\t\t\t\t\thistory: this.getMessageHistory(index - 1) // 获取到失败消息之前的历史\n\t\t\t\t};\n\t\t\t\t\n\t\t\t\t// 发送请求\n\t\t\t\tthis.sendStreamRequest(params, index, controller.signal)\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t// 请求成功\n\t\t\t\t\t\tthis.updateMessageStatus(index, MESSAGE_STATUS.SENT);\n\t\t\t\t\t\tthis.messages[index].streaming = false;\n\t\t\t\t\t})\n\t\t\t\t\t.catch((error) => {\n\t\t\t\t\t\tuni.__f__('error','at pages/AI/AI.uvue:502','重试发送消息失败:', error);\n\t\t\t\t\t\t\n\t\t\t\t\t\t// 检查是否是用户主动取消的请求\n\t\t\t\t\t\tif (error.name === 'AbortError') {\n\t\t\t\t\t\t\tuni.__f__('log','at pages/AI/AI.uvue:506','重试请求被用户取消');\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// 其他错误，更新消息状态为错误\n\t\t\t\t\t\t\tthis.updateMessageStatus(index, MESSAGE_STATUS.ERROR);\n\t\t\t\t\t\t\tthis.messages[index].content = error.message || '获取回复失败，请重试';\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t.finally(() => {\n\t\t\t\t\t\tthis.isProcessing = false;\n\t\t\t\t\t\tthis.currentController = null;\n\t\t\t\t\t});\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 中断当前请求\n\t\t\t */\n\t\t\tabortCurrentRequest() {\n\t\t\t\tif (this.currentController) {\n\t\t\t\t\tthis.currentController.abort();\n\t\t\t\t\tthis.currentController = null;\n\t\t\t\t}\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 更新消息状态\n\t\t\t * @param {Number} index - 消息索引\n\t\t\t * @param {String} status - 新状态\n\t\t\t */\n\t\t\tupdateMessageStatus(index, status) {\n\t\t\t\tif (index >= 0 && index < this.messages.length) {\n\t\t\t\t\tthis.messages[index].status = status;\n\t\t\t\t}\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 获取消息历史用于发送到API\n\t\t\t * @param {Number} [limit] - 可选，限制历史消息的数量\n\t\t\t * @returns {Array} 消息历史数组\n\t\t\t */\n\t\t\tgetMessageHistory(limit) {\n\t\t\t\t// 筛选出有效的对话消息（用户和AI的消息）\n\t\t\t\tlet history = this.messages.filter(msg => \n\t\t\t\t\tmsg.type === MESSAGE_TYPE.USER || \n\t\t\t\t\t(msg.type === MESSAGE_TYPE.AI && msg.status === MESSAGE_STATUS.SENT)\n\t\t\t\t);\n\t\t\t\t\n\t\t\t\t// 如果指定了limit，则只获取最近的limit条消息\n\t\t\t\tif (typeof limit === 'number' && limit >= 0 && limit < history.length) {\n\t\t\t\t\thistory = history.slice(0, limit);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t// 转换为API需要的格式\n\t\t\t\treturn history.map(msg => ({\n\t\t\t\t\trole: msg.type === MESSAGE_TYPE.USER ? 'user' : 'assistant',\n\t\t\t\t\tcontent: msg.content\n\t\t\t\t}));\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 滚动到底部\n\t\t\t */\n\t\t\tscrollToBottom() {\n\t\t\t\tif (!this.isAutoScrollEnabled) return;\n\t\t\t\t\n\t\t\t\tif (this.messages.length > 0) {\n\t\t\t\t\tthis.autoScrollId = 'msg-' + (this.messages.length - 1);\n\t\t\t\t}\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 处理滚动到顶部事件（加载更多历史消息）\n\t\t\t */\n\t\t\tonScrollToUpper(e) {\n\t\t\t\t// 如果需要加载更多历史消息，可以在这里实现\n\t\t\t\tuni.__f__('log','at pages/AI/AI.uvue:580','滚动到顶部');\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 处理滚动事件（用于控制是否启用自动滚动）\n\t\t\t */\n\t\t\tonScroll(e) {\n\t\t\t\t// 这里可以实现根据用户滚动位置决定是否启用自动滚动\n\t\t\t\t// 例如，当用户手动向上滚动时禁用自动滚动，当滚动到底部时再启用\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 显示提示\n\t\t\t * @param {String} message - 提示信息\n\t\t\t */\n\t\t\tshowToast(message) {\n\t\t\t\tuni.showToast({\n\t\t\t\t\ttitle: message,\n\t\t\t\t\ticon: 'none',\n\t\t\t\t\tduration: 2000\n\t\t\t\t});\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 显示加载提示\n\t\t\t * @param {String} [text] - 加载提示文本\n\t\t\t */\n\t\t\tshowLoading(text = '正在加载...') {\n\t\t\t\tthis.loadingText = text;\n\t\t\t\tthis.isFullLoading = true;\n\t\t\t},\n\t\t\t\n\t\t\t/**\n\t\t\t * @description 隐藏加载提示\n\t\t\t */\n\t\t\thideLoading() {\n\t\t\t\tthis.isFullLoading = false;\n\t\t\t}\n\t\t}\n\t}\n</script>\n\n<style>\n\t.page-container {\n\t\tposition: relative;\n\t\twidth: 100%;\n\t\theight: 100vh;\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t\tpadding: 20rpx;\n\t\tbox-sizing: border-box;\n\t\tbackground-color: #f5f5f5;\n\t}\n\t\n\t/* 筛选区域 */\n\t.filter-section {\n\t\twidth: 100%;\n\t\tpadding: 20rpx;\n\t\tbackground-color: #ffffff;\n\t\tborder-radius: 16rpx;\n\t\tmargin-bottom: 20rpx;\n\t\tbox-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);\n\t}\n\t\n\t.filter-row {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\twidth: 100%;\n\t\tmargin-bottom: 20rpx;\n\t}\n\t\n\t.filter-item {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\talign-items: center;\n\t\tmargin: 0 10rpx;\n\t}\n\t\n\t.filter-label {\n\t\tfont-size: 28rpx;\n\t\tcolor: #333;\n\t\twhite-space: nowrap;\n\t\tmargin-right: 10rpx;\n\t}\n\t\n\t.choice-wrapper {\n\t\tflex: 1;\n\t}\n\t\n\t.flex-1 {\n\t\tflex: 1;\n\t}\n\t\n\t/* 功能区域 */\n\t.function-section {\n\t\twidth: 100%;\n\t\tpadding: 15rpx;\n\t\tbackground-color: #ffffff;\n\t\tborder-radius: 16rpx;\n\t\tmargin-bottom: 20rpx;\n\t\tbox-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);\n\t}\n\t\n\t.function-list {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tjustify-content: space-around;\n\t}\n\t\n\t.function-item {\n\t\tpadding: 15rpx 30rpx;\n\t\tborder-radius: 30rpx;\n\t\tbackground-color: #f0f0f0;\n\t\ttransition: all 0.3s;\n\t}\n\t\n\t.function-item.active {\n\t\tbackground-color: #1E90FF;\n\t}\n\t\n\t.function-item-text {\n\t\tfont-size: 28rpx;\n\t\tcolor: #333;\n\t}\n\t\n\t.function-item.active .function-item-text {\n\t\tcolor: #ffffff;\n\t}\n\t\n\t/* 消息区域 */\n\t.message-section {\n\t\tflex: 1;\n\t\twidth: 100%;\n\t\tbackground-color: #ffffff;\n\t\tborder-radius: 16rpx;\n\t\tmargin-bottom: 20rpx;\n\t\toverflow: hidden;\n\t\tposition: relative;\n\t\tbox-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);\n\t}\n\t\n\t.message-scroll {\n\t\theight: 100%;\n\t\tpadding: 30rpx;\n\t}\n\t\n\t.empty-message {\n\t\theight: 100%;\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tjustify-content: center;\n\t}\n\t\n\t.empty-message text {\n\t\tcolor: #999;\n\t\tfont-size: 28rpx;\n\t}\n\t\n\t.message-list {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t}\n\t\n\t.message-item {\n\t\tmax-width: 90%;\n\t\tmargin-bottom: 30rpx;\n\t\tposition: relative;\n\t\tanimation: fadeIn 0.3s ease-in-out;\n\t}\n\t\n\t@keyframes fadeIn {\n\t\tfrom { opacity: 0; transform: translateY(10rpx); }\n\t\tto { opacity: 1; transform: translateY(0); }\n\t}\n\t\n\t.message-item.user {\n\t\talign-self: flex-end;\n\t}\n\t\n\t.message-item.ai {\n\t\talign-self: flex-start;\n\t}\n\t\n\t.message-item.system {\n\t\talign-self: center;\n\t\tmax-width: 70%;\n\t\tmargin: 10rpx 0 30rpx;\n\t}\n\t\n\t.message-content {\n\t\tpadding: 20rpx 30rpx;\n\t\tborder-radius: 16rpx;\n\t\tfont-size: 28rpx;\n\t\tline-height: 1.5;\n\t\tword-break: break-word;\n\t}\n\t\n\t.message-item.user .message-content {\n\t\tbackground-color: #1E90FF;\n\t\tcolor: #fff;\n\t\tborder-radius: 16rpx 0 16rpx 16rpx;\n\t}\n\t\n\t.message-item.ai .message-content {\n\t\tbackground-color: #f0f0f0;\n\t\tcolor: #333;\n\t\tborder-radius: 0 16rpx 16rpx 16rpx;\n\t}\n\t\n\t.message-item.system .message-content {\n\t\tbackground-color: rgba(0, 0, 0, 0.05);\n\t\tcolor: #666;\n\t\tborder-radius: 30rpx;\n\t\tfont-size: 24rpx;\n\t}\n\t\n\t.message-header {\n\t\tmargin-bottom: 10rpx;\n\t}\n\t\n\t.ai-title {\n\t\tfont-size: 24rpx;\n\t\tcolor: #666;\n\t\tpadding-left: 10rpx;\n\t}\n\t\n\t.message-status {\n\t\tmargin-top: 10rpx;\n\t\tfont-size: 24rpx;\n\t\tcolor: #999;\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\talign-items: center;\n\t}\n\t\n\t.sending-dots {\n\t\tanimation: dotsAnimation 1.5s infinite;\n\t}\n\t\n\t@keyframes dotsAnimation {\n\t\t0% { opacity: 0.3; }\n\t\t50% { opacity: 1; }\n\t\t100% { opacity: 0.3; }\n\t}\n\t\n\t.error-text {\n\t\tcolor: #ff4d4f;\n\t\tmargin-right: 10rpx;\n\t}\n\t\n\t.retry-btn {\n\t\tpadding: 5rpx 15rpx;\n\t\tbackground-color: #f0f0f0;\n\t\tborder-radius: 10rpx;\n\t}\n\t\n\t.retry-btn text {\n\t\tcolor: #1E90FF;\n\t\tfont-size: 22rpx;\n\t}\n\t\n\t.message-item.streaming .message-content {\n\t\tposition: relative;\n\t}\n\t\n\t.message-item.streaming .message-content::after {\n\t\tcontent: \"|\";\n\t\tdisplay: inline-block;\n\t\tcolor: #1E90FF;\n\t\tanimation: blink 1s step-end infinite;\n\t\tmargin-left: 2rpx;\n\t\tfont-weight: bold;\n\t}\n\t\n\t@keyframes blink {\n\t\t0%, 100% { opacity: 1; }\n\t\t50% { opacity: 0; }\n\t}\n\t\n\t/* 输入区域 */\n\t.input-section {\n\t\twidth: 100%;\n\t\theight: 100rpx;\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\talign-items: center;\n\t\tpadding: 0 10rpx;\n\t}\n\t\n\t.message-input {\n\t\tflex: 1;\n\t\theight: 80rpx;\n\t\tbackground-color: #ffffff;\n\t\tborder: 2rpx solid #ddd;\n\t\tborder-radius: 40rpx;\n\t\tpadding: 0 30rpx;\n\t\tmargin-right: 20rpx;\n\t\tfont-size: 28rpx;\n\t}\n\t\n\t.send-button {\n\t\twidth: 140rpx;\n\t\theight: 80rpx;\n\t\tbackground-color: #1E90FF;\n\t\tcolor: #fff;\n\t\tborder-radius: 40rpx;\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tjustify-content: center;\n\t\tborder: none;\n\t\tpadding: 0;\n\t}\n\t\n\t.send-button:disabled {\n\t\tbackground-color: #cccccc;\n\t\tcolor: #ffffff;\n\t}\n\t\n\t.send-button text {\n\t\tfont-size: 28rpx;\n\t}\n\t\n\t/* 加载遮罩 */\n\t.loading-mask {\n\t\tposition: fixed;\n\t\ttop: 0;\n\t\tleft: 0;\n\t\tright: 0;\n\t\tbottom: 0;\n\t\tbackground-color: rgba(0, 0, 0, 0.5);\n\t\tdisplay: flex;\n\t\tjustify-content: center;\n\t\talign-items: center;\n\t\tz-index: 999;\n\t}\n\t\n\t.loading-content {\n\t\tbackground-color: #ffffff;\n\t\tpadding: 30rpx 60rpx;\n\t\tborder-radius: 20rpx;\n\t\tbox-shadow: 0 4rpx 16rpx rgba(0, 0, 0, 0.15);\n\t}\n\t\n\t.loading-content text {\n\t\tfont-size: 28rpx;\n\t\tcolor: #333;\n\t}\n</style>\n","import MiniProgramPage from 'E:/yanshilu重新来过/前端yanshilu_1/pages/AI/AI.uvue'\nwx.createPage(MiniProgramPage)"],"mappings":"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","ignoreList":[]}