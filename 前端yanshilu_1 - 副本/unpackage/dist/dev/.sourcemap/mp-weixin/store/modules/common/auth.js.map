{"version":3,"file":"auth.js","sources":["store/modules/common/auth.js"],"sourcesContent":["/**\n * @description 认证模块 - 处理用户登录、注册、登出等认证相关功能\n */\nimport { services } from '../../services';\n\n/**\n * @description 解析JWT Token\n * @param {string} token - JWT Token字符串\n * @returns {Object|null} 解析后的payload部分\n */\nconst parseJwt = (token) => {\n  try {\n    const base64Url = token.split('.')[1];\n    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n    const jsonPayload = decodeURIComponent(\n      atob(base64)\n        .split('')\n        .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))\n        .join('')\n    );\n    return JSON.parse(jsonPayload);\n  } catch (error) {\n    console.error('解析JWT失败:', error);\n    return null;\n  }\n};\n\n/**\n * @description 检查Token是否过期\n * @param {string} token - JWT Token字符串\n * @returns {boolean} 是否已过期\n */\nconst isTokenExpired = (token) => {\n  if (!token) return true;\n  const payload = parseJwt(token);\n  if (!payload || !payload.exp) return true;\n  // exp是秒级时间戳，需转换为毫秒\n  return payload.exp * 1000 < Date.now();\n};\n\n/**\n * @description 检查Token是否即将过期（默认5分钟内）\n * @param {string} token - JWT Token字符串\n * @param {number} [timeThreshold=300000] - 到期前多少毫秒开始刷新（默认5分钟）\n * @returns {boolean} 是否即将过期\n */\nconst isTokenNearExpiry = (token, timeThreshold = 300000) => {\n  if (!token) return false;\n  const payload = parseJwt(token);\n  if (!payload || !payload.exp) return false;\n  // 检查是否在到期前timeThreshold毫秒内\n  return payload.exp * 1000 - Date.now() < timeThreshold && payload.exp * 1000 > Date.now();\n};\n\n// 刷新Token锁，防止重复刷新\nlet isRefreshing = false;\n// 等待刷新的请求队列\nlet refreshSubscribers = [];\n\n/**\n * @description 完成Token刷新后执行队列中的请求\n * @param {string} token - 新的Token\n */\nconst onRefreshed = (token) => {\n  refreshSubscribers.forEach(callback => callback(token));\n  refreshSubscribers = [];\n};\n\n/**\n * @description 添加请求到刷新队列\n * @param {Function} callback - 回调函数，接收新Token\n */\nconst subscribeTokenRefresh = (callback) => {\n  refreshSubscribers.push(callback);\n};\n\n// 初始状态\nconst state = {\n  token: uni.getStorageSync('token') || '',\n  refreshToken: uni.getStorageSync('refreshToken') || '',\n  userId: uni.getStorageSync('userId') || '',\n  role: uni.getStorageSync('role') || '',\n  loginLoading: false,\n  loginError: null,\n  tokenRefreshing: false,\n  lastTokenRefresh: uni.getStorageSync('lastTokenRefresh') || 0\n};\n\n// Getters\nconst getters = {\n  currentRole: state => state.role,\n  isTeacher: state => state.role === 'teacher',\n  isStudent: state => state.role === 'student',\n  userId: state => state.userId,\n  authToken: state => state.token,\n  refreshToken: state => state.refreshToken,\n  loginLoading: state => state.loginLoading,\n  loginError: state => state.loginError,\n  isTokenExpired: state => isTokenExpired(state.token),\n  isTokenRefreshing: state => state.tokenRefreshing\n};\n\n// 引入常量类型\nconst LOGIN_REQUEST = 'LOGIN_REQUEST';\nconst LOGIN_SUCCESS = 'LOGIN_SUCCESS';\nconst LOGIN_FAILURE = 'LOGIN_FAILURE';\nconst LOGOUT = 'LOGOUT';\nconst TOKEN_REFRESH_REQUEST = 'TOKEN_REFRESH_REQUEST';\nconst TOKEN_REFRESH_SUCCESS = 'TOKEN_REFRESH_SUCCESS';\nconst TOKEN_REFRESH_FAILURE = 'TOKEN_REFRESH_FAILURE';\n\n// Mutations\nconst mutations = {\n  [LOGIN_REQUEST](state) {\n    state.loginLoading = true;\n    state.loginError = null;\n  },\n  [LOGIN_SUCCESS](state, { token, refreshToken, userId, role }) {\n    state.token = token;\n    state.refreshToken = refreshToken || state.refreshToken;\n    state.userId = userId;\n    state.role = role;\n    state.loginLoading = false;\n    state.loginError = null;\n    state.lastTokenRefresh = Date.now();\n    \n    // 保存到本地存储\n    uni.setStorageSync('token', token);\n    uni.setStorageSync('refreshToken', refreshToken || state.refreshToken);\n    uni.setStorageSync('userId', userId);\n    uni.setStorageSync('role', role);\n    uni.setStorageSync('lastTokenRefresh', Date.now());\n  },\n  [LOGIN_FAILURE](state, error) {\n    state.loginLoading = false;\n    state.loginError = error;\n  },\n  [LOGOUT](state) {\n    state.token = '';\n    state.refreshToken = '';\n    state.userId = '';\n    state.role = '';\n    \n    // 清除本地存储\n    uni.removeStorageSync('token');\n    uni.removeStorageSync('refreshToken');\n    uni.removeStorageSync('userId');\n    uni.removeStorageSync('role');\n    uni.removeStorageSync('lastTokenRefresh');\n  },\n  [TOKEN_REFRESH_REQUEST](state) {\n    state.tokenRefreshing = true;\n  },\n  [TOKEN_REFRESH_SUCCESS](state, { token, refreshToken }) {\n    state.token = token;\n    if (refreshToken) state.refreshToken = refreshToken;\n    state.tokenRefreshing = false;\n    state.lastTokenRefresh = Date.now();\n    \n    // 更新本地存储\n    uni.setStorageSync('token', token);\n    if (refreshToken) uni.setStorageSync('refreshToken', refreshToken);\n    uni.setStorageSync('lastTokenRefresh', Date.now());\n  },\n  [TOKEN_REFRESH_FAILURE](state) {\n    state.tokenRefreshing = false;\n  }\n};\n\n// Actions\nconst actions = {\n  /**\n   * @description 用户登录\n   * @param {Object} context - Vuex上下文\n   * @param {Object} credentials - 登录凭证\n   * @returns {Promise<Object>} 登录结果\n   */\n  async login({ commit }, credentials) {\n    commit(LOGIN_REQUEST);\n    try {\n      const response = await services.auth.login(credentials);\n      const { token, refreshToken, userId, role } = response.data;\n      commit(LOGIN_SUCCESS, { token, refreshToken, userId, role });\n      return { success: true, data: response.data };\n    } catch (error) {\n      commit(LOGIN_FAILURE, error.response?.data?.message || '登录失败');\n      return { success: false, error };\n    }\n  },\n  \n  /**\n   * @description 用户登出\n   * @param {Object} context - Vuex上下文\n   */\n  logout({ commit }) {\n    // 可以在这里调用登出API\n    commit(LOGOUT);\n  },\n  \n  /**\n   * @description 刷新Token\n   * @param {Object} context - Vuex上下文\n   * @returns {Promise<Object>} 刷新结果\n   */\n  async refreshToken({ commit, state }) {\n    // 防止重复刷新\n    if (isRefreshing) {\n      return new Promise(resolve => {\n        subscribeTokenRefresh(token => {\n          resolve({ success: true, token });\n        });\n      });\n    }\n    \n    // 限制刷新频率（最小间隔1分钟）\n    const now = Date.now();\n    if (now - state.lastTokenRefresh < 60000) {\n      return { success: true, token: state.token };\n    }\n    \n    isRefreshing = true;\n    commit(TOKEN_REFRESH_REQUEST);\n    \n    try {\n      const response = await services.auth.refreshToken({ \n        refreshToken: state.refreshToken \n      });\n      \n      const { token, refreshToken } = response.data;\n      commit(TOKEN_REFRESH_SUCCESS, { token, refreshToken });\n      \n      // 执行队列中的请求\n      onRefreshed(token);\n      isRefreshing = false;\n      \n      return { success: true, token, refreshToken };\n    } catch (error) {\n      commit(TOKEN_REFRESH_FAILURE);\n      isRefreshing = false;\n      return { success: false, error };\n    }\n  },\n  \n  /**\n   * @description 初始化请求拦截器，添加认证Token\n   * @param {Object} context - Vuex上下文\n   * @param {Object} requestInstance - uni.request实例或自定义请求库实例\n   */\n  setupRequestInterceptor({ state, dispatch }, requestInstance) {\n    // 这里的实现取决于你使用的请求库\n    // 示例基于通用拦截器模式，需根据实际情况调整\n    \n    if (requestInstance && requestInstance.interceptors) {\n      // 请求拦截\n      requestInstance.interceptors.request.use(async (config) => {\n        // 检查Token是否过期或即将过期\n        if (state.token) {\n          if (isTokenExpired(state.token)) {\n            // Token已过期，尝试刷新\n            if (state.refreshToken) {\n              const { success, token } = await dispatch('refreshToken');\n              if (success) {\n                config.header = config.header || {};\n                config.header.Authorization = `Bearer ${token}`;\n              }\n            }\n          } else {\n            // Token有效，直接使用\n            config.header = config.header || {};\n            config.header.Authorization = `Bearer ${state.token}`;\n            \n            // 如果Token即将过期，后台刷新\n            if (isTokenNearExpiry(state.token)) {\n              dispatch('refreshToken');\n            }\n          }\n        }\n        return config;\n      });\n      \n      // 响应拦截\n      requestInstance.interceptors.response.use(\n        (response) => {\n          return response;\n        },\n        async (error) => {\n          const originalRequest = error.config;\n          \n          // 如果是401错误且未尝试过刷新Token\n          if (error.response && error.response.status === 401 && !originalRequest._retry) {\n            originalRequest._retry = true;\n            \n            // 尝试刷新Token\n            if (state.refreshToken) {\n              const { success, token } = await dispatch('refreshToken');\n              if (success) {\n                // 更新请求头并重试\n                originalRequest.header.Authorization = `Bearer ${token}`;\n                return requestInstance(originalRequest);\n              }\n            }\n            \n            // 刷新失败，登出\n            dispatch('logout');\n          }\n          \n          return Promise.reject(error);\n        }\n      );\n    }\n  }\n};\n\nexport default {\n  namespaced: true,\n  state,\n  getters,\n  actions,\n  mutations\n}; "],"names":["uni","state","services"],"mappings":"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"}