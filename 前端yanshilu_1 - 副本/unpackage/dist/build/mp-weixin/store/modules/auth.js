"use strict";const e=require("../../common/vendor.js"),s={login:s=>new Promise((n=>{setTimeout((()=>{const{username:r,role:t}=s,o={sub:`user_${Date.now()}`,name:r,role:t,iat:Math.floor(Date.now()/1e3),exp:Math.floor(Date.now()/1e3)+7200},a=e.gBase64.encode(JSON.stringify({alg:"HS256",typ:"JWT"})),c=e.gBase64.encode(JSON.stringify(o)),i=e.gBase64.encode("mock_signature"),d=`${a}.${c}.${i}`,u=`refresh_${a}.${e.gBase64.encode(JSON.stringify({...o,exp:Math.floor(Date.now()/1e3)+86400}))}.${i}`;n({success:!0,data:{token:d,refreshToken:u,expiresIn:7200,userInfo:{name:r,avatar:"https://example.com/avatar.png",tags:["标签1","标签2"],balance:"teacher"===t?1e3:null},role:t}})}),500)})),getUserInfo:e=>new Promise((s=>{setTimeout((()=>{const n=e.startsWith("teacher")?"teacher":"student";s({success:!0,data:{name:`${n}用户`,avatar:"https://example.com/avatar.png",tags:["标签1","标签2","标签3"],balance:"teacher"===n?1500:null,orders:{student:{pendingPayment:"student"===n?[{id:"s1",title:"待付款订单1"}]:[],pendingService:"student"===n?[{id:"s2",title:"待服务订单1"}]:[],completed:"student"===n?[{id:"s3",title:"已完成订单1"}]:[],cancelled:"student"===n?[{id:"s4",title:"已取消订单1"}]:[]},teacher:{pendingService:"teacher"===n?[{id:"t1",title:"待服务订单1"}]:[],completed:"teacher"===n?[{id:"t2",title:"已完成订单1"}]:[],cancelled:"teacher"===n?[{id:"t3",title:"已取消订单1"}]:[]}}}})}),600)})),refreshToken:e=>new Promise((e=>{setTimeout((()=>{e({success:!0,data:{token:`new_token_${Date.now()}`,refreshToken:`new_refresh_token_${Date.now()}`,expiresIn:7200}})}),300)}))},n={saveAuth(s){e.index.setStorageSync("token",s.token),e.index.setStorageSync("refreshToken",s.refreshToken),e.index.setStorageSync("tokenExpireTime",Date.now()+1e3*s.expiresIn),e.index.setStorageSync("isLoggedIn",!0),e.index.setStorageSync("role",s.role),e.index.setStorageSync("userBaseInfo",{name:s.userInfo.name,avatar:s.userInfo.avatar})},clearAuth(){e.index.removeStorageSync("token"),e.index.removeStorageSync("refreshToken"),e.index.removeStorageSync("tokenExpireTime"),e.index.removeStorageSync("isLoggedIn"),e.index.removeStorageSync("role"),e.index.removeStorageSync("userBaseInfo")},getToken:()=>e.index.getStorageSync("token")||null,getRefreshToken:()=>e.index.getStorageSync("refreshToken")||null,getTokenExpireTime:()=>e.index.getStorageSync("tokenExpireTime")||null},r={isRegistered:!1,role:e.index.getStorageSync("role")||null,isLoggedIn:e.index.getStorageSync("isLoggedIn")||!1,userInfo:{name:"",avatar:"",tags:[],balance:null,orders:{student:{pendingPayment:[],pendingService:[],completed:[],cancelled:[]},teacher:{pendingService:[],completed:[],cancelled:[]}}},token:n.getToken(),refreshToken:n.getRefreshToken(),tokenExpireTime:n.getTokenExpireTime()},t={async login({commit:e},n){try{const r=await s.login(n);if(r.success){const{token:s,refreshToken:n,expiresIn:t,userInfo:o,role:a}=r.data;return e("SET_LOGGED_IN",!0),e("SET_ROLE",a),e("SET_AUTH",{token:s,refreshToken:n,expiresIn:t,role:a,userInfo:o}),e("SET_USER_INFO",o),{success:!0,message:"登录成功"}}return{success:!1,message:"登录失败"}}catch(r){return console.error("登录失败:",r),{success:!1,message:r.message||"登录失败"}}},async getUserInfo({commit:e,state:n,dispatch:r}){n.tokenExpireTime&&n.tokenExpireTime-Date.now()<6e5&&await r("refreshToken");try{const r=await s.getUserInfo(n.token);return r.success?(e("SET_USER_INFO",r.data),{success:!0,data:r.data}):{success:!1,message:"获取用户信息失败"}}catch(t){return console.error("获取用户信息失败:",t),{success:!1,message:t.message||"获取用户信息失败"}}},async refreshToken({commit:e,state:n}){if(!n.refreshToken)return{success:!1,message:"无刷新令牌"};try{const r=await s.refreshToken(n.refreshToken);if(r.success){const{token:s,refreshToken:t,expiresIn:a}=r.data,c=o.decode(s);return e("SET_AUTH",{token:s,refreshToken:t,expiresIn:c?(1e3*c.exp-Date.now())/1e3:a,role:n.role,userInfo:n.userInfo}),{success:!0,message:"令牌刷新成功"}}return{success:!1,message:"令牌刷新失败"}}catch(r){return console.error("令牌刷新失败:",r),e("CLEAR_AUTH"),{success:!1,message:r.message||"令牌刷新失败"}}},logout:({commit:e})=>(e("CLEAR_AUTH"),{success:!0,message:"已退出登录"}),async checkLoginStatus({state:e,commit:s,dispatch:n}){if(!e.token)return s("CLEAR_AUTH"),{success:!1,message:"未登录"};const r=o.isValid(e.token);if(!r&&e.refreshToken){if(!(await n("refreshToken")).success)return s("CLEAR_AUTH"),{success:!1,message:"登录已过期"}}else if(!r)return s("CLEAR_AUTH"),{success:!1,message:"登录已过期"};return(await n("getUserInfo")).success?{success:!0,message:"登录状态有效"}:(s("CLEAR_AUTH"),{success:!1,message:"登录状态无效"})}},o={decode(s){try{return e.jwtDecode(s)}catch(n){return console.error("JWT解析失败:",n),null}},isValid(e){if(!e)return!1;try{const s=this.decode(e);if(!s)return!1;const n=Date.now()/1e3;return s.exp>n}catch(s){return!1}}},a={namespaced:!0,state:r,mutations:{SET_LOGGED_IN(e,s){e.isLoggedIn=s},SET_ROLE(e,s){e.role=s},SET_AUTH(e,s){e.token=s.token,e.refreshToken=s.refreshToken,e.tokenExpireTime=Date.now()+1e3*s.expiresIn,n.saveAuth({token:s.token,refreshToken:s.refreshToken,expiresIn:s.expiresIn,role:s.role,userInfo:s.userInfo})},SET_USER_INFO(e,s){e.userInfo=s},CLEAR_AUTH(e){e.isLoggedIn=!1,e.token=null,e.refreshToken=null,e.tokenExpireTime=null,e.userInfo={name:"",avatar:"",tags:[],balance:null,orders:{student:{pendingPayment:[],pendingService:[],completed:[],cancelled:[]},teacher:{pendingService:[],completed:[],cancelled:[]}}},n.clearAuth()},SET_REGISTERED(e,s){e.isRegistered=s}},actions:t,getters:{userRole:e=>e.role,isTeacher:e=>"teacher"===e.role,isStudent:e=>"student"===e.role,teacherBalance:e=>"teacher"===e.role?e.userInfo.balance:null,userName:e=>e.userInfo.name,userAvatar:e=>e.userInfo.avatar,userTags:e=>e.userInfo.tags,studentPendingPaymentOrders:e=>e.userInfo.orders.student.pendingPayment,studentPendingServiceOrders:e=>e.userInfo.orders.student.pendingService,studentCompletedOrders:e=>e.userInfo.orders.student.completed,studentCancelledOrders:e=>e.userInfo.orders.student.cancelled,teacherPendingServiceOrders:e=>e.userInfo.orders.teacher.pendingService,teacherCompletedOrders:e=>e.userInfo.orders.teacher.completed,teacherCancelledOrders:e=>e.userInfo.orders.teacher.cancelled}};exports.auth=a;
