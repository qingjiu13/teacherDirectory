{"code":"import { __awaiter } from \"tslib\";\nimport { defineComponent } from \"vue\";\nimport { Navigator, IndexRoutes } from '../../router/Router';\nimport { mapState, mapMutations, mapActions } from 'vuex';\nexport default defineComponent({\n    data() {\n        return {\n            hasLogin: false,\n            userInfo: new UTSJSONObject({\n                nickName: '',\n                avatarUrl: ''\n            }),\n            showAgreementModal: false,\n            showPrivacyModal: false,\n            // 新增授权相关数据\n            showAuthPopup: false,\n            authStep: 'avatar',\n            tempUserInfo: new UTSJSONObject({\n                nickName: '',\n                avatarUrl: '',\n                phoneNumber: ''\n            }),\n            wxLoginCode: '', // 存储微信登录的code\n        };\n    },\n    computed: Object.assign(Object.assign({}, mapState('user/baseInfo', ['isRegistered', 'id', 'avatar', 'name', 'phoneNumber'])), { \n        /**\n         * 根据当前授权步骤返回弹窗标题\n         * @returns {string} 弹窗标题\n         */\n        authPopupTitle() {\n            const titles = new UTSJSONObject({\n                'avatar': '选择头像',\n                'nickname': '设置昵称',\n                'phone': '绑定手机号'\n            });\n            return titles[this.authStep] || '微信授权';\n        } }),\n    onLoad() {\n        this.checkLoginStatus();\n    },\n    methods: Object.assign(Object.assign(Object.assign({}, mapMutations('user/baseInfo', ['SET_USER_INFO'])), mapActions('user/baseInfo', ['updateUserInfo'])), { \n        // 检查登录状态\n        checkLoginStatus() {\n            const token = uni.getStorageSync('token');\n            if (token && this.isRegistered) {\n                this.hasLogin = true;\n                // 从Vuex获取用户信息\n                this.userInfo = {\n                    nickName: this.name,\n                    avatarUrl: this.avatar\n                };\n            }\n        },\n        /**\n         * 微信登录方法 - 更新为新流程\n         * @returns {void}\n         */\n        onWxLogin() {\n            uni.showLoading({\n                title: '登录中...'\n            });\n            uni.login(new UTSJSONObject({\n                provider: 'weixin',\n                success: (res) => {\n                    uni.hideLoading();\n                    if (res.code) {\n                        // 保存code用于后续请求\n                        this.wxLoginCode = res.code;\n                        // 显示授权弹窗\n                        this.showAuthPopup = true;\n                        this.authStep = 'avatar';\n                    }\n                    else {\n                        uni.showToast({\n                            title: '微信登录失败，请重试',\n                            icon: 'none'\n                        });\n                    }\n                },\n                fail: (err) => {\n                    uni.__f__('error', 'at pages_AI_Login_Match/login/wechat_login.vue:230', '微信登录失败', err);\n                    uni.hideLoading();\n                    uni.showToast({\n                        title: '登录失败，请重试',\n                        icon: 'none'\n                    });\n                }\n            }));\n        },\n        /**\n         * 处理用户选择头像事件\n         * @param {Object} e - 微信返回的头像信息\n         */\n        onChooseAvatar(e = null) {\n            if (e.detail && e.detail.avatarUrl) {\n                this.tempUserInfo.avatarUrl = e.detail.avatarUrl;\n                // 同时更新顶部头像显示\n                this.userInfo.avatarUrl = e.detail.avatarUrl;\n                // 自动跳转到昵称步骤\n                this.goToNicknameStep();\n            }\n        },\n        /**\n         * 处理用户输入昵称事件\n         * @param {Object} e - 输入事件对象\n         */\n        onInputNickname(e = null) {\n            this.tempUserInfo.nickName = e.detail.value;\n            // 同时更新顶部昵称显示\n            this.userInfo.nickName = e.detail.value;\n        },\n        /**\n         * 进入昵称设置步骤\n         */\n        goToNicknameStep() {\n            this.authStep = 'nickname';\n        },\n        /**\n         * 进入手机号授权步骤\n         */\n        goToPhoneStep() {\n            this.authStep = 'phone';\n        },\n        /**\n         * 获取微信绑定手机号\n         * @param {Object} e - 微信返回的加密数据\n         */\n        getPhoneNumber(e = null) {\n            if (e.detail.errMsg === 'getPhoneNumber:ok') {\n                // 准备提交所有用户信息到后端\n                this.submitUserInfo(new UTSJSONObject({\n                    code: this.wxLoginCode,\n                    encryptedData: e.detail.encryptedData,\n                    iv: e.detail.iv,\n                    avatarUrl: this.tempUserInfo.avatarUrl,\n                    nickName: this.tempUserInfo.nickName\n                }));\n            }\n            else {\n                uni.showToast({\n                    title: '未授权手机号，请重试',\n                    icon: 'none'\n                });\n            }\n        },\n        /**\n         * 跳过手机号授权\n         */\n        skipPhoneAuth() {\n            // 只提交头像和昵称\n            this.submitUserInfo(new UTSJSONObject({\n                code: this.wxLoginCode,\n                avatarUrl: this.tempUserInfo.avatarUrl,\n                nickName: this.tempUserInfo.nickName\n            }));\n        },\n        /**\n         * 提交用户信息到后端\n         * @param {Object} data - 要提交的用户数据\n         */\n        submitUserInfo(data = null) {\n            return __awaiter(this, void 0, void 0, function* () {\n                uni.showLoading({\n                    title: '提交中...'\n                });\n                try {\n                    const result = yield uni.request({\n                        method: \"POST\",\n                        url: \"http://localhost:8080/users/auth/wechat/profile\",\n                        data: data\n                    });\n                    if (result.statusCode === 200 && result.data) {\n                        // 存储token到本地\n                        uni.setStorageSync('token', result.data.token);\n                        // 存储用户信息\n                        if (result.data.userId) {\n                            uni.setStorageSync('userId', result.data.userId);\n                            // 使用Vuex更新用户信息\n                            this.SET_USER_INFO(new UTSJSONObject({\n                                id: result.data.userId,\n                                isRegistered: 1,\n                                name: this.tempUserInfo.nickName,\n                                avatar: this.tempUserInfo.avatarUrl,\n                                phoneNumber: result.data.phoneNumber || ''\n                            }));\n                            // 更新本地显示的用户信息\n                            this.userInfo = {\n                                nickName: this.tempUserInfo.nickName,\n                                avatarUrl: this.tempUserInfo.avatarUrl\n                            };\n                        }\n                        uni.hideLoading();\n                        // 提示登录成功\n                        uni.showToast({\n                            title: '登录成功',\n                            icon: 'success',\n                            duration: 1500\n                        });\n                        // 设置登录状态并关闭弹窗\n                        this.hasLogin = true;\n                        this.showAuthPopup = false;\n                        // 延迟跳转\n                        setTimeout(() => {\n                            Navigator.redirectTo(IndexRoutes.INDEX);\n                        }, 1500);\n                    }\n                    else {\n                        uni.hideLoading();\n                        uni.showToast({\n                            title: '登录失败，请重试',\n                            icon: 'none'\n                        });\n                    }\n                }\n                catch (error) {\n                    uni.__f__('error', 'at pages_AI_Login_Match/login/wechat_login.vue:378', '提交用户信息失败', error);\n                    uni.hideLoading();\n                    uni.showToast({\n                        title: '登录失败，请重试',\n                        icon: 'none'\n                    });\n                }\n            });\n        },\n        /**\n         * 取消授权，关闭弹窗\n         */\n        cancelAuth() {\n            this.showAuthPopup = false;\n            this.wxLoginCode = '';\n            this.tempUserInfo = {\n                nickName: '',\n                avatarUrl: '',\n                phoneNumber: ''\n            };\n        },\n        /**\n         * 根据注册状态跳转到相应页面\n         * @returns {void}\n         */\n        goBack() {\n            Navigator.toIndex();\n        },\n        /**\n         * 显示用户协议弹窗\n         * @returns {void}\n         */\n        showAgreement() {\n            this.showAgreementModal = true;\n        },\n        /**\n         * 显示隐私政策弹窗\n         * @returns {void}\n         */\n        showPrivacy() {\n            this.showPrivacyModal = true;\n        },\n        /**\n         * 关闭弹窗\n         * @param {string} type - 要关闭的弹窗类型（'agreement'或'privacy'）\n         * @returns {void}\n         */\n        closeModal(type = null) {\n            if (type === 'agreement') {\n                this.showAgreementModal = false;\n            }\n            else if (type === 'privacy') {\n                this.showPrivacyModal = false;\n            }\n        } })\n});\n//# sourceMappingURL=E:/%E7%A0%94%E5%B8%88%E5%BD%95%E4%B8%8E%E5%85%B6%E4%BB%96%E4%BA%BA%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6/teacherDirectory/vue%E5%AE%9E%E7%8E%B0Lottie%E5%8A%A8%E7%94%BB%E4%BB%A3%E7%A0%81/pages_AI_Login_Match/login/wechat_login.vue?vue&type=script&lang.uts.js.map","references":["E:/研师录与其他人共享文件/teacherDirectory/vue实现Lottie动画代码/router/Router.js","E:/HBuilderX/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli-vite/node_modules/vuex/types/index.d.ts"],"uniExtApis":["uni.getStorageSync","uni.showLoading","uni.login","uni.hideLoading","uni.showToast","uni.__f__","uni.request","uni.setStorageSync"],"map":"{\"version\":3,\"file\":\"wechat_login.vue?vue&type=script&lang.uts.js\",\"sourceRoot\":\"\",\"sources\":[\"wechat_login.vue?vue&type=script&lang.uts\"],\"names\":[],\"mappings\":\"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\"}"}
