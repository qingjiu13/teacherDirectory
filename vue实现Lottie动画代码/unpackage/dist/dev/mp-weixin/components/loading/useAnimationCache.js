"use strict";const s=require("../../common/vendor.js"),m=new Map,e=s.ref({totalCached:0,totalLoaded:0,totalFailed:0,animations:[]}),d=s.ref(!1),u=l=>l.split("/").pop().split(".")[0],_=()=>{const l=a=>m.has(a),f=a=>m.get(a)||null,A=(a,i)=>{m.set(a,i);const t=e.value.animations.findIndex(n=>n.url===a);t===-1?e.value.animations.push({url:a,key:u(a),cached:!0,loadTime:Date.now()}):(e.value.animations[t].cached=!0,e.value.animations[t].loadTime=Date.now()),e.value.totalCached=m.size;try{const n=`lottie_${u(a)}`;s.index.setStorageSync(n,i),s.index.__f__("log","at components/loading/useAnimationCache.js:73","动画数据已保存到本地存储",n)}catch(n){s.index.__f__("error","at components/loading/useAnimationCache.js:75","保存到本地存储失败",n)}},g=a=>{const i=`lottie_${u(a)}`;try{const t=s.index.getStorageSync(i);if(t){m.set(a,t);const n=e.value.animations.findIndex(o=>o.url===a);return n===-1?e.value.animations.push({url:a,key:u(a),cached:!0,loadTime:Date.now(),fromStorage:!0}):(e.value.animations[n].cached=!0,e.value.animations[n].loadTime=Date.now(),e.value.animations[n].fromStorage=!0),e.value.totalCached=m.size,s.index.__f__("log","at components/loading/useAnimationCache.js:109","已从本地存储恢复动画数据到缓存",i),!0}}catch(t){s.index.__f__("error","at components/loading/useAnimationCache.js:113","从本地存储恢复失败",t)}return!1},v=async a=>{if(d.value)return s.index.__f__("log","at components/loading/useAnimationCache.js:125","已有加载任务正在进行"),null;d.value=!0;const i=Date.now(),t=e.value.animations.findIndex(n=>n.url===a);if(t===-1?e.value.animations.push({url:a,key:u(a),cached:!1,loading:!0,startTime:i}):(e.value.animations[t].loading=!0,e.value.animations[t].startTime=i),l(a)){s.index.__f__("log","at components/loading/useAnimationCache.js:149","从内存缓存获取动画数据");const n=e.value.animations.findIndex(o=>o.url===a);return n!==-1&&(e.value.animations[n].loading=!1,e.value.animations[n].loadedFromCache=!0,e.value.animations[n].loadTime=Date.now()-i),d.value=!1,f(a)}if(g(a)){s.index.__f__("log","at components/loading/useAnimationCache.js:165","从本地存储恢复动画数据");const n=e.value.animations.findIndex(o=>o.url===a);return n!==-1&&(e.value.animations[n].loading=!1,e.value.animations[n].loadedFromStorage=!0,e.value.animations[n].loadTime=Date.now()-i),e.value.totalLoaded++,d.value=!1,f(a)}s.index.__f__("log","at components/loading/useAnimationCache.js:181","从网络加载动画数据",a);try{const{data:n}=await s.index.request({url:a,method:"GET"});A(a,n);const o=e.value.animations.findIndex(c=>c.url===a);return o!==-1&&(e.value.animations[o].loading=!1,e.value.animations[o].loadedFromNetwork=!0,e.value.animations[o].loadTime=Date.now()-i),e.value.totalLoaded++,d.value=!1,n}catch(n){s.index.__f__("error","at components/loading/useAnimationCache.js:203","网络加载动画数据失败",n);const o=e.value.animations.findIndex(c=>c.url===a);return o!==-1&&(e.value.animations[o].loading=!1,e.value.animations[o].failed=!0,e.value.animations[o].error=n.message||"未知错误"),e.value.totalFailed++,d.value=!1,null}},p=a=>{const i=`lottie_${u(a)}`;try{const t=m.delete(a);if(s.index.removeStorageSync(i),t){const n=e.value.animations.findIndex(o=>o.url===a);n!==-1&&(e.value.animations[n].cached=!1,e.value.animations[n].cleared=!0,e.value.animations[n].clearTime=Date.now()),e.value.totalCached=m.size}return t}catch(t){return s.index.__f__("error","at components/loading/useAnimationCache.js:248","清除动画缓存失败",t),!1}};return{isAnimationCached:l,getAnimationFromCache:f,saveAnimationToCache:A,restoreAnimationFromStorage:g,loadAnimationData:v,clearAnimationCache:p,clearAllAnimationCache:()=>{try{return Array.from(m.keys()).forEach(i=>{p(i)}),s.index.__f__("log","at components/loading/useAnimationCache.js:266","已清除所有动画缓存"),!0}catch(a){return s.index.__f__("error","at components/loading/useAnimationCache.js:269","清除所有动画缓存失败",a),!1}},getAnimationStats:()=>({...e.value,timestamp:Date.now()}),preloadAnimations:async(a,i)=>{if(!a||!Array.isArray(a)||a.length===0)return{totalSuccess:0,totalFailed:0};const t=a.length;let n=0,o=0,c=0;const r={total:t,completed:n,success:o,failed:c,progress:0};for(const x of a)try{const h=await v(x);n++,h?o++:c++,r.completed=n,r.success=o,r.failed=c,r.progress=n/t*100,typeof i=="function"&&i(r)}catch(h){s.index.__f__("error","at components/loading/useAnimationCache.js:333",`预加载动画失败: ${x}`,h),n++,c++,r.completed=n,r.failed=c,r.progress=n/t*100,typeof i=="function"&&i(r)}return{totalSuccess:o,totalFailed:c,total:t}},isAllAnimationsLoaded:()=>e.value.animations.length===0?!0:e.value.animations.every(a=>a.cached&&!a.loading),globalStats:e}},C=()=>{const l=_();return{globalState:e,getGlobalStats:l.getAnimationStats,isAllAnimationsLoaded:l.isAllAnimationsLoaded,preloadAnimation:l.loadAnimationData,preloadAnimations:l.preloadAnimations,getAnimationFromCache:l.getAnimationFromCache,clearAnimationCache:l.clearAnimationCache,clearAllAnimationCache:l.clearAllAnimationCache}},y=async(l,f)=>{const{preloadAnimations:A}=_();return await A(l,f)};exports.preloadAnimations=y;exports.useAnimationCache=_;exports.useGlobalAnimationState=C;
//# sourceMappingURL=../../../.sourcemap/mp-weixin/components/loading/useAnimationCache.js.map
