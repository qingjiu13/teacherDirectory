"use strict";const t=require("../../../common/vendor.js"),m=require("../../common/enums.js"),g=require("../../common/emotion.js"),d=require("../../common/url.js"),r=require("../../common/messageType.js"),h=require("../../common/date.js"),l=()=>"../head-image/head-image.js",f=()=>"../long-press-menu/long-press-menu.js",S=()=>"../loading/loading.js",c=()=>"../chat-group-readed/chat-group-readed.js",I=t.defineComponent({name:"chat-message-item",components:{HeadImage:l,LongPressMenu:f,Loading:S,ChatGroupReaded:c},props:{headImage:{type:String,required:!0},showName:{type:String,required:!0},msgInfo:{type:Object,required:!0},groupMembers:{type:Array}},data(){return{audioPlayState:"STOP",innerAudioContext:null,menu:new UTSJSONObject({show:!1,style:""}),MESSAGE_TYPE:m.MESSAGE_TYPE,MESSAGE_STATUS:m.MESSAGE_STATUS}},beforeCreate(){this.$enums||(this.$enums=new UTSJSONObject({MESSAGE_TYPE:m.MESSAGE_TYPE,MESSAGE_STATUS:m.MESSAGE_STATUS})),this.$emo||(this.$emo=g.emoUtil),this.$date||(this.$date=h.dateUtil),this.$url||(this.$url=d.urlUtil)},methods:{getSafeImageUrl(e=null){try{if(!e)return"";const a=typeof e=="string"?e.trim():"";if(!a.startsWith("{"))return t.index.__f__("warn","at pagesChat/components/chat-message-item/chat-message-item.vue:173","内容不是JSON格式:",a.substring(0,10)+"..."),"";const n=UTS.JSON.parse(e);return n&&n.thumbUrl?n.thumbUrl:""}catch(a){return t.index.__f__("error","at pagesChat/components/chat-message-item/chat-message-item.vue:180","解析图片URL出错:",a),""}},getAudioDuration(e=null){try{if(!e)return'0"';const a=e.trim();if(!a.startsWith("{"))return t.index.__f__("warn","at pagesChat/components/chat-message-item/chat-message-item.vue:192","音频内容不是JSON格式:",a.substring(0,10)+"..."),'0"';const n=UTS.JSON.parse(e);return n&&n.duration?n.duration+'"':'0"'}catch(a){return t.index.__f__("error","at pagesChat/components/chat-message-item/chat-message-item.vue:199","解析音频时长出错:",a),'0"'}},onSendFail(){t.index.showToast({title:"该文件已发送失败，目前不支持自动重新发送，建议手动重新发送",icon:"none"})},onPlayAudio(){if(this.audioPlayState=="PLAYING")return this.stopPlayAudio(),null;try{if(!this.msgInfo.content)return t.index.showToast({title:"音频格式错误",icon:"none"}),null;let e=UTS.JSON.parse(this.msgInfo.content),a=e&&e.url?e.url:null;if(!a)return t.index.showToast({title:"音频地址错误",icon:"none"}),null;this.innerAudioContext=t.index.createInnerAudioContext(),this.innerAudioContext.src=a,this.innerAudioContext.autoplay=!0,this.innerAudioContext.onPlay(()=>{this.audioPlayState="PLAYING",this.$emit("audioStateChange","PLAYING",this.msgInfo)}),this.innerAudioContext.onEnded(()=>{this.audioPlayState="STOP",this.$emit("audioStateChange","STOP",this.msgInfo)}),this.innerAudioContext.onError((n=null)=>{this.audioPlayState="STOP",t.index.__f__("log","at pagesChat/components/chat-message-item/chat-message-item.vue:248",n.errMsg),t.index.__f__("log","at pagesChat/components/chat-message-item/chat-message-item.vue:249",n.errCode),this.$emit("audioStateChange","STOP",this.msgInfo)}),this.innerAudioContext.onStop(()=>{this.audioPlayState="STOP",this.$emit("audioStateChange","STOP",this.msgInfo)})}catch(e){t.index.__f__("error","at pagesChat/components/chat-message-item/chat-message-item.vue:257","播放音频出错:",e),t.index.showToast({title:"音频格式错误",icon:"none"})}},onSelectMenu(e=null){switch(e.key){case"COPY":this.$emit("copy",this.msgInfo);break;case"DELETE":this.$emit("delete",this.msgInfo);break;case"RECALL":this.$emit("recall",this.msgInfo);break;case"DOWNLOAD":this.$emit("download",this.msgInfo);break}},onShowFullImage(){try{if(!this.msgInfo.content)return t.index.showToast({title:"图片格式错误",icon:"none"}),null;let e=UTS.JSON.parse(this.msgInfo.content),a=e&&e.originUrl?e.originUrl:null;if(!a)return t.index.showToast({title:"图片地址错误",icon:"none"}),null;t.index.previewImage({urls:[a],current:a})}catch(e){t.index.__f__("error","at pagesChat/components/chat-message-item/chat-message-item.vue:308","预览图片出错:",e),t.index.showToast({title:"图片格式错误",icon:"none"})}},onShowReadedBox(){this.msgInfo.groupId&&this.$refs.chatGroupReaded.open()},stopPlayAudio(){this.innerAudioContext&&this.innerAudioContext.stop(),this.audioPlayState="STOP"},nodesText(){let e=this.msgInfo.selfSend?"white":"";try{if(!this.msgInfo||!this.msgInfo.content)return"";let a=this.$url?this.$url.replaceURLWithHTMLLinks(this.msgInfo.content,e):this.msgInfo.content;return this.$emo?this.$emo.transform(a,"emoji-normal"):a}catch(a){return t.index.__f__("error","at pagesChat/components/chat-message-item/chat-message-item.vue:335","处理消息内容出错:",a),this.msgInfo&&this.msgInfo.content?this.msgInfo.content:""}}},computed:{loading(){return this.msgInfo.loadStatus&&this.msgInfo.loadStatus==="loading"},loadFail(){return this.msgInfo.loadStatus&&this.msgInfo.loadStatus==="fail"},data(){try{return!this.msgInfo||!this.msgInfo.content?new UTSJSONObject({name:"无效内容",size:0}):UTS.JSON.parse(this.msgInfo.content)||new UTSJSONObject({name:"无效内容",size:0})}catch(e){return t.index.__f__("error","at pagesChat/components/chat-message-item/chat-message-item.vue:355","解析消息内容出错:",e),new UTSJSONObject({name:"无效内容",size:0})}},fileSize(){if(!this.data||typeof this.data.size>"u")return"0B";let e=this.data.size;return e>1024*1024?Math.round(e/1024/1024)+"M":e>1024?Math.round(e/1024)+"KB":e+"B"},menuItems(){let e=[];return this.msgInfo.type==this.MESSAGE_TYPE.TEXT&&e.push({key:"COPY",name:"复制",icon:"bars"}),this.msgInfo.selfSend&&this.msgInfo.id>0&&e.push({key:"RECALL",name:"撤回",icon:"refreshempty"}),e.push({key:"DELETE",name:"删除",icon:"trash",color:"#e64e4e"}),this.msgInfo.type==this.MESSAGE_TYPE.FILE&&e.push({key:"DOWNLOAD",name:"下载并打开",icon:"download"}),e},isAction(){try{return!this.msgInfo||typeof this.msgInfo.type>"u"?!1:r.isAction(this.msgInfo.type)}catch(e){return t.index.__f__("error","at pagesChat/components/chat-message-item/chat-message-item.vue:412","判断消息类型出错:",e),!1}},isNormal(){try{if(!this.msgInfo||typeof this.msgInfo.type>"u")return!1;const e=this.msgInfo.type;return r.isNormal(e)||r.isAction(e)}catch(e){return t.index.__f__("error","at pagesChat/components/chat-message-item/chat-message-item.vue:424","判断消息类型出错:",e),!1}}}});if(!Array){const e=t.resolveComponent("head-image"),a=t.resolveComponent("up-parse"),n=t.resolveComponent("long-press-menu"),u=t.resolveComponent("loading"),i=t.resolveComponent("uni-link"),s=t.resolveComponent("chat-group-readed");(e+a+n+u+i+s)()}const E=()=>"../../../uni_modules/uni-link/components/uni-link/uni-link.js";Math||E();function _(e,a,n,u,i,s){return t.e({a:n.msgInfo.type==e.$enums.MESSAGE_TYPE.TIP_TEXT},n.msgInfo.type==e.$enums.MESSAGE_TYPE.TIP_TEXT?{b:t.t(n.msgInfo.content)}:n.msgInfo.type==e.$enums.MESSAGE_TYPE.TIP_TIME?{d:t.t(e.$date.toTimeText(n.msgInfo.sendTime))}:s.isNormal?t.e({f:n.msgInfo.sendId,g:t.o(o=>e.$emit("longPressHead")),h:t.p({id:n.msgInfo.sendId,url:n.headImage,name:n.showName,size:"small"}),i:n.msgInfo.groupId&&!n.msgInfo.selfSend},n.msgInfo.groupId&&!n.msgInfo.selfSend?{j:t.t(n.showName)}:{},{k:n.msgInfo.type==e.$enums.MESSAGE_TYPE.TEXT},n.msgInfo.type==e.$enums.MESSAGE_TYPE.TEXT?t.e({l:e.$emo.containEmoji(n.msgInfo.content)},e.$emo.containEmoji(n.msgInfo.content)?{m:s.nodesText}:{n:t.p({showImgMenu:!1,content:s.nodesText})},{o:t.o(s.onSelectMenu),p:t.p({items:s.menuItems})}):{},{q:n.msgInfo.type==e.$enums.MESSAGE_TYPE.IMAGE},n.msgInfo.type==e.$enums.MESSAGE_TYPE.IMAGE?t.e({r:s.getSafeImageUrl(n.msgInfo.content),s:t.o(o=>s.onShowFullImage()),t:s.loading},s.loading?{}:{},{v:t.o(s.onSelectMenu),w:t.p({items:s.menuItems}),x:s.loadFail},s.loadFail?{y:t.o((...o)=>s.onSendFail&&s.onSendFail(...o))}:{}):{},{z:n.msgInfo.type==e.$enums.MESSAGE_TYPE.FILE},n.msgInfo.type==e.$enums.MESSAGE_TYPE.FILE?t.e({A:t.p({text:s.data.name,showUnderLine:"true",color:"#007BFF",href:s.data.url}),B:t.t(s.fileSize),C:s.loading},s.loading?{}:{},{D:t.o(s.onSelectMenu),E:t.p({items:s.menuItems}),F:s.loadFail},s.loadFail?{G:t.o((...o)=>s.onSendFail&&s.onSendFail(...o))}:{}):{},{H:n.msgInfo.type==e.$enums.MESSAGE_TYPE.AUDIO},n.msgInfo.type==e.$enums.MESSAGE_TYPE.AUDIO?t.e({I:t.t(s.getAudioDuration(n.msgInfo.content)),J:i.audioPlayState=="PAUSE"},i.audioPlayState=="PAUSE"?{}:{},{K:i.audioPlayState=="PLAYING"},i.audioPlayState=="PLAYING"?{}:{},{L:t.o(o=>s.onPlayAudio()),M:t.o(s.onSelectMenu),N:t.p({items:s.menuItems})}):{},{O:s.isAction},s.isAction?t.e({P:n.msgInfo.type==e.$enums.MESSAGE_TYPE.ACT_RT_VOICE},n.msgInfo.type==e.$enums.MESSAGE_TYPE.ACT_RT_VOICE?{}:{},{Q:n.msgInfo.type==e.$enums.MESSAGE_TYPE.ACT_RT_VIDEO},n.msgInfo.type==e.$enums.MESSAGE_TYPE.ACT_RT_VIDEO?{}:{},{R:t.t(n.msgInfo.content),S:t.o(o=>e.$emit("call")),T:t.o(s.onSelectMenu),U:t.p({items:s.menuItems})}):{},{V:!s.isAction},s.isAction?{}:t.e({W:n.msgInfo.selfSend&&!n.msgInfo.groupId&&n.msgInfo.status==e.$enums.MESSAGE_STATUS.READED},n.msgInfo.selfSend&&!n.msgInfo.groupId&&n.msgInfo.status==e.$enums.MESSAGE_STATUS.READED?{}:{},{X:n.msgInfo.selfSend&&!n.msgInfo.groupId&&n.msgInfo.status!=e.$enums.MESSAGE_STATUS.READED},n.msgInfo.selfSend&&!n.msgInfo.groupId&&n.msgInfo.status!=e.$enums.MESSAGE_STATUS.READED?{}:{}),{Y:n.msgInfo.receipt},n.msgInfo.receipt?t.e({Z:n.msgInfo.receiptOk},n.msgInfo.receiptOk?{}:{aa:t.t(n.msgInfo.readedCount)},{ab:t.o((...o)=>s.onShowReadedBox&&s.onShowReadedBox(...o))}):{},{ac:n.msgInfo.selfSend?1:""}):{},{c:n.msgInfo.type==e.$enums.MESSAGE_TYPE.TIP_TIME,e:s.isNormal,ad:t.sr("chatGroupReaded","33dfc56a-10"),ae:t.p({groupMembers:n.groupMembers,msgInfo:n.msgInfo}),af:t.sei(t.gei(e,""),"view")})}const T=t._export_sfc(I,[["render",_],["__scopeId","data-v-33dfc56a"]]);wx.createComponent(T);
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/pagesChat/components/chat-message-item/chat-message-item.js.map
