"use strict";const s=require("../common/vendor.js");require("./env.js");const m=require("./common/mockChatService.js"),c=require("./common/mockData.js"),p=require("./common/enums.js"),S=require("./common/messageType.js"),f=require("./common/emotion.js"),T=require("./common/url.js"),d=require("./main.js"),l=require("../common/assets.js"),I=()=>"../components/navigationTitleBar/header.js",x=()=>"./components/chat-message-item/chat-message-item.js",_=()=>"./components/chat-record/chat-record.js",C=()=>"./components/file-upload/file-upload.js",b=()=>"./components/image-upload/image-upload.js",U=()=>"./components/head-image/head-image.js",M=()=>"./components/chat-at-box/chat-at-box.js",y=()=>"./components/group-member-selector/group-member-selector.js",w=()=>"./components/group-rtc-join/group-rtc-join.js",O=()=>"./components/chat-item/chat-item.js",N=()=>"./components/loading/loading.js",v=()=>"./components/long-press-menu/long-press-menu.js",B=s.defineComponent({components:{Header:I,ChatMessageItem:x,ChatRecord:_,FileUpload:C,ImageUpload:b,ChatAtBox:M,HeadImage:U,GroupMemberSelector:y,GroupRtcJoin:w,ChatItem:O,Loading:N,LongPressMenu:v},data(){return{textContent:"",chat:new UTSJSONObject({}),userInfo:new UTSJSONObject({}),group:new UTSJSONObject({}),groupMembers:[],isReceipt:!1,scrollMsgIdx:0,chatTabBox:"none",showRecord:!1,chatMainHeight:0,keyboardHeight:290,windowHeight:1e3,initHeight:1e3,atUserIds:[],needScrollToBottom:!1,showMinIdx:0,reqQueue:[],isSending:!1,isShowKeyBoard:!1,isEmpty:!0,isFocus:!1,isReadOnly:!1,playingAudio:null,useMockData:!0,mockCurrentUser:null,chatStore:null,friendStore:null,configStore:null,userStore:null,groupStore:null,sendBarZIndex:2}},created(){this.$enums||(this.$enums=p.enums),this.$msgType||(this.$msgType=S.messageType),this.$emo||(this.$emo=f.emoUtil),this.$url||(this.$url=T.urlUtil);try{this.chatStore=d.getChatStore(),this.friendStore=d.getFriendStore(),this.configStore=d.getConfigStore(),this.userStore=d.getUserStore(),this.groupStore=d.getGroupStore(),!this.chatStore&&this.$&&(s.index.__f__("log","at pagesChat/chat-box.vue:257","chat-box.vue: 尝试从全局属性获取Store"),this.chatStore=this.$chatStore,this.friendStore=this.$friendStore,this.configStore=this.$configStore,this.userStore=this.$userStore,this.groupStore=this.$groupStore),s.index.__f__("log","at pagesChat/chat-box.vue:265","chat-box.vue: 获取Store成功:","chatStore=",!!this.chatStore,"friendStore=",!!this.friendStore)}catch(e){s.index.__f__("error","at pagesChat/chat-box.vue:270","chat-box.vue: 获取Store失败:",e)}this.mockCurrentUser=c.getMockCurrentUser(),this.useMockData&&(!this.chatStore||!this.chatStore.chats||this.chatStore.chats.length===0)&&(s.index.__f__("log","at pagesChat/chat-box.vue:278","chat-box.vue: 强制初始化模拟数据"),this.initMockData())},methods:{handleBack(){s.index.navigateBack()},onRecorderInput(){this.showRecord=!0,this.switchChatTabBox("none")},onKeyboardInput(){this.showRecord=!1,this.switchChatTabBox("none")},onSendRecord(e=null){if(this.isBanned)return this.showBannedTip(),null;let t=new UTSJSONObject({content:UTS.JSON.stringify(e),type:this.$enums.MESSAGE_TYPE.AUDIO,receipt:this.isReceipt});this.fillTargetId(t,this.chat.targetId),this.sendMessageRequest(t).then((i=null)=>{i.selfSend=!0,this.chatStore.insertMessage(i,this.chat),this.moveChatToTop(),this.scrollToBottom(),this.isReceipt=!1})},onRtCall(e=null){e.type==this.$enums.MESSAGE_TYPE.ACT_RT_VOICE?this.onPriviteVoice():e.type==this.$enums.MESSAGE_TYPE.ACT_RT_VIDEO&&this.onPriviteVideo()},onPriviteVideo(){const e=encodeURIComponent(UTS.JSON.stringify(this.friend));s.index.navigateTo({url:`/pages/chat/chat-private-video?mode=video&friend=${e}&isHost=true`})},onPriviteVoice(){const e=encodeURIComponent(UTS.JSON.stringify(this.friend));s.index.navigateTo({url:`/pages/chat/chat-private-video?mode=voice&friend=${e}&isHost=true`})},onGroupVideo(){let e=[this.mine.id];this.$refs.selBox.init(e,e,[]),this.$refs.selBox.open()},onInviteOk(e=null){if(e.length<2)return null;let t=[];e.forEach((a=null)=>{let h=UTS.arrayFind(this.groupMembers,r=>r.userId==a);t.push({id:h.userId,nickName:h.showNickName,headImage:h.headImage,isCamera:!1,isMicroPhone:!0})});const i=this.group.id,n=this.mine.id,o=encodeURIComponent(UTS.JSON.stringify(t));s.index.navigateTo({url:`/pages/chat/chat-group-video?groupId=${i}&isHost=true
						&inviterId=${n}&userInfos=${o}`})},moveChatToTop(){let e=this.chatStore.findChatIdx(this.chat);this.chatStore.moveTop(e)},switchReceipt(){this.isReceipt=!this.isReceipt},openAtBox(){this.$refs.atBox.init(this.atUserIds),this.$refs.atBox.open()},onAtComplete(e=null){this.atUserIds=e},onLongPressHead(e=null){!e.selfSend&&this.chat.type=="GROUP"&&this.atUserIds.indexOf(e.sendId)<0&&this.atUserIds.push(e.sendId)},headImage(e=null){if(!e)return"";try{if(this.chat&&this.chat.type=="GROUP"){let t=UTS.arrayFind(this.groupMembers,i=>i&&i.userId==e.sendId);return t?t.headImage:""}else return e.selfSend?this.mine&&this.mine.headImageThumb?this.mine.headImageThumb:"":this.chat&&this.chat.headImage?this.chat.headImage:""}catch(t){return s.index.__f__("error","at pagesChat/chat-box.vue:400","获取头像出错:",t),""}},showName(e=null){if(!e)return"";try{if(this.chat&&this.chat.type=="GROUP"){let t=UTS.arrayFind(this.groupMembers,i=>i&&i.userId==e.sendId);return t?t.showNickName:""}else return e.selfSend?this.mine&&this.mine.nickName?this.mine.nickName:"":this.chat&&this.chat.showName?this.chat.showName:""}catch(t){return s.index.__f__("error","at pagesChat/chat-box.vue:418","获取名称出错:",t),""}},sendTextMessage(){if(s.index.__f__("log","at pagesChat/chat-box.vue:423","键盘发送按钮被点击"),this.isBanned)return this.showBannedTip(),null;let e=this.textContent||"";if(s.index.__f__("log","at pagesChat/chat-box.vue:432","发送文本内容:",e),!e.trim()&&this.atUserIds.length==0)return s.index.showToast({title:"不能发送空白信息",icon:"none"});let t=this.isReceipt?"【回执消息】":"",i=this.createAtText();if(this.textContent="",this.isEmpty=!0,this.useMockData){const n=new UTSJSONObject({tmpId:"tmp_"+Date.now(),type:this.$enums.MESSAGE_TYPE.TEXT,content:t+this.html2Escape(e)+i,status:this.$enums.MESSAGE_STATUS.UNSEND});m.mockChatService.sendMessage(n,new UTSJSONObject({type:this.chat.type,targetId:this.chat.targetId})).then(()=>{this.scrollToBottom()}),this.atUserIds=[],this.isReceipt=!1}else{let n=new UTSJSONObject({content:t+this.html2Escape(e)+i,atUserIds:this.atUserIds,receipt:this.isReceipt,type:0});this.atUserIds=[],this.isReceipt=!1,this.fillTargetId(n,this.chat.targetId),this.sendMessageRequest(n).then((o=null)=>{o.selfSend=!0,this.chatStore.insertMessage(o,this.chat),this.moveChatToTop()}).finally(()=>{this.scrollToBottom()})}},createAtText(){let e="";return this.atUserIds.forEach(t=>{if(t==-1)e+=" @全体成员";else{let i=UTS.arrayFind(this.groupMembers,n=>n.userId==t);i&&(e+=` @${i.showNickName}`)}}),e},fillTargetId(e=null,t=null){this.chat.type=="GROUP"?e.groupId=t:e.recvId=t},scrollToBottom(){let e=this.messageSize;e>0&&this.scrollToMsgIdx(e-1)},scrollToMsgIdx(e=null){if(e==this.scrollMsgIdx&&e>0)return this.$nextTick(()=>{this.scrollMsgIdx=e-1,this.scrollToMsgIdx(e)}),null;this.$nextTick(()=>{this.scrollMsgIdx=e})},onShowEmoChatTab(){this.showRecord=!1,s.index.hideKeyboard(),setTimeout(()=>{this.switchChatTabBox("emo")},100)},onShowToolsChatTab(){this.showRecord=!1,s.index.hideKeyboard(),setTimeout(()=>{this.switchChatTabBox("tools")},100)},switchChatTabBox(e=null){this.chatTabBox=e,this.reCalChatMainHeight(),e!="tools"&&this.$refs.fileUpload&&this.$refs.fileUpload.hide()},selectEmoji(e=null){this.textContent=(this.textContent||"")+e,this.isEmpty=!1},onUploadImageBefore(e=null){if(this.isBanned)return this.showBannedTip(),null;let t=new UTSJSONObject({originUrl:e.path,thumbUrl:e.path}),i=new UTSJSONObject({id:0,tmpId:this.generateId(),fileId:e.uid,sendId:this.mine.id,content:UTS.JSON.stringify(t),sendTime:new Date().getTime(),selfSend:!0,type:this.$enums.MESSAGE_TYPE.IMAGE,readedCount:0,loadStatus:"loading",status:this.$enums.MESSAGE_STATUS.UNSEND});return this.fillTargetId(i,this.chat.targetId),this.chatStore.insertMessage(i,this.chat),this.moveChatToTop(),e.msgInfo=i,e.chat=this.chat,this.scrollToBottom(),!0},onUploadImageSuccess(e=null,t=null){let i=UTS.JSON.parse(UTS.JSON.stringify(e.msgInfo));i.content=UTS.JSON.stringify(t.data),i.receipt=this.isReceipt,this.sendMessageRequest(i).then((n=null)=>{i.loadStatus="ok",i.id=n.id,this.isReceipt=!1,this.chatStore.insertMessage(i,e.chat)})},onUploadImageFail(e=null,t=null){let i=UTS.JSON.parse(UTS.JSON.stringify(e.msgInfo));i.loadStatus="fail",this.chatStore.insertMessage(i,e.chat)},onUploadFileBefore(e=null){if(this.isBanned)return this.showBannedTip(),null;let t=new UTSJSONObject({name:e.name,size:e.size,url:e.path}),i=new UTSJSONObject({id:0,tmpId:this.generateId(),sendId:this.mine.id,content:UTS.JSON.stringify(t),sendTime:new Date().getTime(),selfSend:!0,type:this.$enums.MESSAGE_TYPE.FILE,readedCount:0,loadStatus:"loading",status:this.$enums.MESSAGE_STATUS.UNSEND});return this.fillTargetId(i,this.chat.targetId),this.chatStore.insertMessage(i,this.chat),this.moveChatToTop(),e.msgInfo=i,e.chat=this.chat,this.scrollToBottom(),!0},onUploadFileSuccess(e=null,t=null){let i=new UTSJSONObject({name:e.name,size:e.size,url:t.data}),n=UTS.JSON.parse(UTS.JSON.stringify(e.msgInfo));n.content=UTS.JSON.stringify(i),n.receipt=this.isReceipt,this.sendMessageRequest(n).then((o=null)=>{n.loadStatus="ok",n.id=o.id,this.isReceipt=!1,this.chatStore.insertMessage(n,e.chat)})},onUploadFileFail(e=null,t=null){let i=UTS.JSON.parse(UTS.JSON.stringify(e.msgInfo));i.loadStatus="fail",this.chatStore.insertMessage(i,e.chat)},onDeleteMessage(e=null){s.index.showModal(new UTSJSONObject({title:"删除消息",content:"确认删除消息?",success:t=>{t.cancel||(this.useMockData?m.mockChatService.deleteMessage(e,new UTSJSONObject({type:this.chat.type,targetId:this.chat.targetId})).then(()=>{s.index.showToast({title:"删除成功",icon:"none"})}):(this.chatStore.deleteMessage(e,this.chat),s.index.showToast({title:"删除成功",icon:"none"})))}}))},onRecallMessage(e=null){s.index.showModal(new UTSJSONObject({title:"撤回消息",content:"确认撤回消息?",success:t=>{if(!t.cancel)if(this.useMockData)m.mockChatService.recallMessage(e,new UTSJSONObject({type:this.chat.type,targetId:this.chat.targetId})).then(()=>{s.index.showToast({title:"撤回成功",icon:"none"})});else{let i=`/message/${this.chat.type.toLowerCase()}/recall/${e.id}`;this.$http(new UTSJSONObject({url:i,method:"DELETE"})).then((n=null)=>{n.selfSend=!0,this.chatStore.recallMessage(n,this.chat)})}}}))},onCopyMessage(e=null){s.index.setClipboardData({data:e.content,success:()=>{s.index.showToast({title:"复制成功"})},fail:()=>{s.index.showToast({title:"复制失败",icon:"none"})}})},onDownloadFile(e=null){let t=UTS.JSON.parse(e.content).url;s.index.downloadFile({url:t,success(i){if(i.statusCode===200){var n=encodeURI(i.tempFilePath);s.index.openDocument({filePath:n,showMenu:!0})}},fail(i){s.index.showToast({title:"文件下载失败",icon:"none"})}})},onScrollToTop(){if(this.showMinIdx==0)return s.index.__f__("log","at pagesChat/chat-box.vue:770","消息已滚动到顶部"),null;this.scrollToMsgIdx(this.showMinIdx),this.showMinIdx=this.showMinIdx>20?this.showMinIdx-20:0},onShowMore(){this.chat.type=="GROUP"?s.index.navigateTo({url:"/pages/group/group-info?id="+this.group.id}):s.index.navigateTo({url:"/pages/common/user-info?id="+this.userInfo.id})},onTextareaFocus(e=null){try{this.isFocus=!0,this.chatTabBox!=="none"?(s.index.hideKeyboard(),this.switchChatTabBox("none"),setTimeout(()=>{s.index.createSelectorQuery().in(this).select("#textInput").focus(),this.scrollToBottom(),this.reCalChatMainHeight()},200)):(this.scrollToBottom(),setTimeout(()=>{this.reCalChatMainHeight()},50))}catch(t){s.index.__f__("error","at pagesChat/chat-box.vue:819","输入框获取焦点错误:",t)}},onTextareaBlur(e=null){try{this.isFocus=!1,setTimeout(()=>{this.reCalChatMainHeight()},50)}catch(t){s.index.__f__("error","at pagesChat/chat-box.vue:830","输入框失去焦点错误:",t)}},onTextareaInput(e=null){try{this.textContent=e.detail.value,this.isEmpty=!this.textContent||this.textContent.trim()==="",setTimeout(()=>{this.reCalChatMainHeight(),this.isFocus&&this.scrollToBottom()},50)}catch(t){s.index.__f__("error","at pagesChat/chat-box.vue:850","处理文本输入错误:",t)}},onAudioStateChange(e=null,t=null){const i=this.$refs["message"+t.id][0];e=="PLAYING"&&i!=this.playingAudio&&(this.playingAudio&&this.playingAudio.stopPlayAudio(),this.playingAudio=i)},loadReaded(e=null){if(this.useMockData)return null;this.$http(new UTSJSONObject({url:`/message/private/maxReadedId?friendId=${e}`,method:"get"})).then((t=null)=>{this.chatStore.readedMessage(new UTSJSONObject({friendId:e,maxId:t}))})},readedMessage(){if(this.unreadCount==0)return null;if(this.useMockData)return this.chat&&(this.chat.unreadCount=0,this.scrollToBottom()),null;let e="";this.chat.type=="GROUP"?e=`/message/group/readed?groupId=${this.chat.targetId}`:e=`/message/private/readed?friendId=${this.chat.targetId}`,this.$http(new UTSJSONObject({url:e,method:"PUT"})).then(()=>{this.chatStore.resetUnreadCount(this.chat),this.scrollToBottom()})},loadGroup(e=null){if(this.useMockData){const t=c.getMockGroupById(e);return t&&(this.group=new UTSJSONObject({id:t.id,showGroupName:t.showGroupName,headImageThumb:t.headImageThumb,memberCount:t.memberCount,isBanned:!1,ownerId:1}),this.groupMembers=[],t.members.forEach((i=null)=>{const n=c.getMockUserById(i);n&&this.groupMembers.push({userId:n.id,showNickName:n.nickName,headImage:n.headImageThumb,quit:!1})})),null}this.$http(new UTSJSONObject({url:`/group/find/${e}`,method:"GET"})).then((t=null)=>{this.group=t,this.chatStore.updateChatFromGroup(t),this.groupStore.updateGroup(t)}),this.$http(new UTSJSONObject({url:`/group/members/${e}`,method:"GET"})).then((t=null)=>{this.groupMembers=t})},updateFriendInfo(){if(this.isFriend){let e=UTS.JSON.parse(UTS.JSON.stringify(this.friend));e.headImage=this.userInfo.headImageThumb,e.nickName=this.userInfo.nickName,e.showNickName=e.remarkNickName?e.remarkNickName:e.nickName,this.friendStore.updateFriend(e),this.chatStore.updateChatFromFriend(e)}else this.chatStore.updateChatFromUser(this.userInfo)},loadFriend(e=null){if(this.useMockData){const t=c.getMockUserById(e);return t&&(this.userInfo=new UTSJSONObject({id:t.id,nickName:t.nickName,headImageThumb:t.headImageThumb,state:t.state,isBanned:!1})),null}this.$http(new UTSJSONObject({url:`/user/find/${e}`,method:"GET"})).then((t=null)=>{this.userInfo=t,this.updateFriendInfo()})},rpxTopx(e=null){return s.index.getSystemInfoSync().windowWidth*e/750,Math.floor(e)},html2Escape(e=null){return e.replace(/[<>&"]/g,function(t=null){return new UTSJSONObject({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"})[t]})},sendMessageRequest(e=null){return new Promise((t,i)=>{this.reqQueue.push({msgInfo:e,resolve:t,reject:i}),this.processReqQueue()})},processReqQueue(){if(this.reqQueue.length&&!this.isSending){this.isSending=!0;const e=UTS.arrayShift(this.reqQueue);this.useMockData?m.mockChatService.sendMessage(e.msgInfo,new UTSJSONObject({type:this.chat.type,targetId:this.chat.targetId})).then((t=null)=>{e.resolve(t.message)}).catch((t=null)=>{e.reject(t)}).finally(()=>{this.isSending=!1,this.processReqQueue()}):this.$http(new UTSJSONObject({url:this.messageAction,method:"post",data:e.msgInfo})).then((t=null)=>{e.resolve(t)}).catch((t=null)=>{e.reject(t)}).finally(()=>{this.isSending=!1,this.processReqQueue()})}},reCalChatMainHeight(){setTimeout(()=>{try{let e=this.windowHeight;e-=50,this.chatTabBox==="emo"||this.chatTabBox==="tools"?(e-=this.keyboardHeight,this.sendBarZIndex=1001):this.sendBarZIndex=2,e-=s.index.getSystemInfoSync().statusBarHeight,this.chatMainHeight=e,this.chatTabBox!="none"&&this.scrollToBottom()}catch(e){s.index.__f__("error","at pagesChat/chat-box.vue:1093","重新计算聊天主窗口高度错误:",e)}},30)},listenKeyBoard(){s.index.onKeyboardHeightChange(this.keyBoardListener)},unListenKeyboard(){s.index.offKeyboardHeightChange(this.keyBoardListener)},keyBoardListener(e=null){this.isShowKeyBoard=e.height>0},resizeListener(){let e=0;window.visualViewport&&s.index.getSystemInfoSync().platform=="ios"&&(e=0),this.isShowKeyBoard=e>150},focusInListener(){this.isShowKeyBoard=!0},focusOutListener(){this.isShowKeyBoard=!1},showBannedTip(){let e=new UTSJSONObject({tmpId:this.generateId(),sendId:this.mine.id,sendTime:new Date().getTime(),type:this.$enums.MESSAGE_TYPE.TIP_TEXT});this.chat.type=="PRIVATE"?(e.recvId=this.mine.id,e.content="该用户已被管理员封禁,原因:"+this.userInfo.reason):(e.groupId=this.group.id,e.content="本群聊已被管理员封禁,原因:"+this.group.reason),this.chatStore.insertMessage(e,this.chat)},generateId(){return String(new Date().getTime())+String(Math.floor(Math.random()*1e3))},initMockData(){s.index.__f__("log","at pagesChat/chat-box.vue:1175","chat-box.vue: 开始初始化模拟数据");try{if(!this.chatStore)return s.index.__f__("error","at pagesChat/chat-box.vue:1178","chat-box.vue: chatStore不可用，初始化失败"),null;this.chatStore.initChats(new UTSJSONObject({chats:UTS.JSON.parse(UTS.JSON.stringify(c.mockChats)),privateMsgMaxId:5e3,groupMsgMaxId:6e3})),s.index.__f__("log","at pagesChat/chat-box.vue:1189","chat-box.vue: 模拟数据初始化成功，共",c.mockChats.length,"条会话")}catch(e){s.index.__f__("error","at pagesChat/chat-box.vue:1191","chat-box.vue: 初始化模拟数据失败",e)}}},computed:{mine(){return this.useMockData?this.mockCurrentUser||c.getMockCurrentUser():this.userStore.userInfo},friend(){return this.useMockData?null:this.friendStore.findFriend(this.userInfo.id)},title(){if(!this.chat)return"";let e=this.chat.showName;if(this.chat.type=="GROUP"){let t=this.groupMembers.filter(i=>!i.quit).length;e+=`(${t})`}return e},messageAction(){return`/message/${this.chat.type.toLowerCase()}/send`},messageSize(){return!this.chat||!this.chat.messages?0:this.chat.messages.length},unreadCount(){return!this.chat||!this.chat.unreadCount?0:this.chat.unreadCount},isBanned(){return this.chat.type=="PRIVATE"&&this.userInfo.isBanned||this.chat.type=="GROUP"&&this.group.isBanned},atUserItems(){let e=[];return this.atUserIds.forEach(t=>{if(t==-1)return e.push({id:-1,showNickName:"全体成员"}),null;let i=UTS.arrayFind(this.groupMembers,n=>n.userId==t);i&&e.push(i)}),e},memberSize(){return this.groupMembers.filter(e=>!e.quit).length}},watch:{messageSize:function(e=null,t=null){if(e>t){let i=getCurrentPages();i[i.length-1].route=="pages/chat/chat-box"?this.scrollToBottom():this.needScrollToBottom=!0}},unreadCount:{handler(e=null,t=null){e>0&&this.readedMessage()}}},onLoad(e){if(this.useMockData){this.mockCurrentUser=c.getMockCurrentUser();const t=e.chatIdx||0;try{s.index.__f__("log","at pagesChat/chat-box.vue:1293","chat-box.vue: 直接从mockChats获取聊天数据"),this.chat=UTS.JSON.parse(UTS.JSON.stringify(c.mockChats[t])),this.chat&&this.chat.messages&&this.chat.messages.forEach((n=null)=>{!n.sendId&&n.senderId&&(n.sendId=n.senderId)}),this.chatStore&&this.chatStore.initChats&&this.chatStore.initChats(new UTSJSONObject({chats:c.mockChats,privateMsgMaxId:5e3,groupMsgMaxId:6e3}));let i=this.messageSize;this.showMinIdx=i>20?i-20:0,this.readedMessage(),this.chat&&this.chat.type=="GROUP"?this.loadGroup(this.chat.targetId):this.chat&&this.loadFriend(this.chat.targetId)}catch(i){s.index.__f__("error","at pagesChat/chat-box.vue:1328","chat-box.vue: 加载聊天数据出错",i)}}else try{if(!this.chatStore||!this.chatStore.chats||!this.chatStore.chats.length)return s.index.__f__("error","at pagesChat/chat-box.vue:1335","chat-box.vue: chatStore或chats不存在"),null;this.chat=this.chatStore.chats[e.chatIdx];let t=this.messageSize;this.showMinIdx=t>20?t-20:0,this.readedMessage(),this.chat.type=="GROUP"?this.loadGroup(this.chat.targetId):(this.loadFriend(this.chat.targetId),this.loadReaded(this.chat.targetId)),this.chatStore.activeChat(e.chatIdx)}catch(t){s.index.__f__("error","at pagesChat/chat-box.vue:1360","chat-box.vue: 加载聊天数据出错",t)}this.isReceipt=!1,this.$nextTick(()=>{this.windowHeight=s.index.getSystemInfoSync().windowHeight,this.reCalChatMainHeight()})},onUnload(){},onShow(){this.needScrollToBottom&&(this.scrollToBottom(),this.needScrollToBottom=!1)}});if(!Array){const e=s.resolveComponent("Header"),t=s.resolveComponent("ChatMessageItem"),i=s.resolveComponent("HeadImage"),n=s.resolveComponent("ChatRecord"),o=s.resolveComponent("FileUpload"),a=s.resolveComponent("ImageUpload"),h=s.resolveComponent("ChatAtBox");(e+t+i+n+o+a+h)()}function k(e,t,i,n,o,a){return s.e({a:l._imports_0$2,b:l._imports_1$2,c:s.o(a.handleBack),d:s.p({title:"对话"}),e:o.chat},o.chat?{f:s.f(o.chat.messages,(h,r,u)=>s.e({a:r>=o.showMinIdx},r>=o.showMinIdx?{b:s.sr("message"+h.id,"2bded80f-1-"+u,{f:1}),c:"chat-item-"+r,d:"message"+h.id,e:s.o(g=>a.onRtCall(h),r),f:s.o(a.onRecallMessage,r),g:s.o(a.onDeleteMessage,r),h:s.o(a.onCopyMessage,r),i:s.o(g=>a.onLongPressHead(h),r),j:s.o(a.onDownloadFile,r),k:s.o(a.onAudioStateChange,r),l:"2bded80f-1-"+u,m:s.p({headImage:a.headImage(h)||"",showName:a.showName(h)||"未知",id:"chat-item-"+r,msgInfo:h||{},groupMembers:o.groupMembers||[]})}:{},{n:r}))}:{},{g:s.o((...h)=>a.onScrollToTop&&a.onScrollToTop(...h)),h:"chat-item-"+o.scrollMsgIdx,i:s.o(h=>a.switchChatTabBox("none")),j:o.atUserIds.length>0},o.atUserIds.length>0?s.e({k:o.atUserIds.length>0},o.atUserIds.length>0?{l:s.f(a.atUserItems,(h,r,u)=>({a:"2bded80f-2-"+u,b:s.p({name:h.showNickName,url:h.headImage,size:"minier"}),c:h.userId}))}:{},{m:s.o(h=>a.openAtBox())}):{},{n:o.showRecord},o.showRecord?{o:s.o(a.onSendRecord)}:s.e({p:s.sei("textInput","textarea"),q:o.isReceipt?"[回执消息]":"",r:o.isReadOnly,s:s.o((...h)=>a.onTextareaFocus&&a.onTextareaFocus(...h)),t:s.o((...h)=>a.onTextareaBlur&&a.onTextareaBlur(...h)),v:s.o([h=>o.textContent=h.detail.value,(...h)=>a.onTextareaInput&&a.onTextareaInput(...h)]),w:s.o((...h)=>a.sendTextMessage&&a.sendTextMessage(...h)),x:o.textContent,y:o.chat&&o.chat.type=="GROUP"},o.chat&&o.chat.type=="GROUP"?{z:s.o(h=>a.openAtBox())}:{},{A:o.isEmpty},o.isEmpty?{B:l._imports_2$2,C:s.o(h=>a.onShowToolsChatTab())}:{}),{D:o.sendBarZIndex,E:o.chatMainHeight+"px",F:o.chatTabBox=="tools"},o.chatTabBox=="tools"?s.e({G:l._imports_2$2,H:s.sr("fileUpload","2bded80f-4"),I:s.p({onBefore:a.onUploadFileBefore,onSuccess:a.onUploadFileSuccess,onError:a.onUploadFileFail}),J:l._imports_2$2,K:s.p({maxCount:9,sourceType:"album",onBefore:a.onUploadImageBefore,onSuccess:a.onUploadImageSuccess,onError:a.onUploadImageFail}),L:l._imports_2$2,M:s.p({sourceType:"camera",onBefore:a.onUploadImageBefore,onSuccess:a.onUploadImageSuccess,onError:a.onUploadImageFail}),N:o.chat.type=="GROUP"&&a.memberSize<=500},o.chat.type=="GROUP"&&a.memberSize<=500?{O:s.n(o.isReceipt?"active":""),P:s.o(h=>a.switchReceipt())}:{},{Q:o.keyboardHeight+"px"}):{},{R:o.chatTabBox==="emo"},o.chatTabBox==="emo"?{S:s.f(e.$emo.emoTextList,(h,r,u)=>({a:r,b:h,c:e.$emo.textToPath(h),d:s.o(g=>a.selectEmoji(h),r)})),T:o.keyboardHeight+"px"}:{},{U:s.sr("atBox","2bded80f-7"),V:s.o(a.onAtComplete),W:s.p({ownerId:o.group.ownerId,members:o.groupMembers})})}const R=s._export_sfc(B,[["render",k]]);wx.createPage(R);
//# sourceMappingURL=../../.sourcemap/mp-weixin/pagesChat/chat-box.js.map
