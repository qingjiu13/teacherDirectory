"use strict";const e=require("../common/vendor.js"),p=require("./env.js"),m=require("../store/user/JWT.js"),T=require("../utils/pollingManager.js"),_=require("../utils/websocketManager.js"),V=require("./common/date.js");Array||e.resolveComponent("u--textarea")();const Q=()=>"../uni_modules/uview-plus/components/u--textarea/u--textarea.js";Math||(Y+X+Q)();const X=()=>"./components/chat-message-item/chat-message-item.js",Y=()=>"../components/navigationTitleBar/header.js",Z=5*60*1e3,ee=e.defineComponent({__name:"chat-box",setup(L){const o=e.ref(null),d=e.ref(null),f=e.ref(""),C=e.ref(""),l=e.ref([]),S=e.ref(""),y=e.ref(0),O=e.ref(0),E=e.ref(0),M=e.ref(0),B=e.ref(44);e.ref(null);const x=e.ref(0),U=e.computed(()=>T.pollingManager.getStatus().isPolling),g=e.ref(!1);let v=null;const $=e.computed(()=>M.value-B.value-140-O.value);function k(){return`chat_messages_${d.value}_${o.value}`}function I(){try{const r=l.value.filter(c=>c.status==="confirmed"||c.isLocal).slice(-100),n=k();e.index.setStorageSync(n,r)}catch{}}function j(){const a=k(),s=e.index.getStorageSync(a)||[];s.length===0&&Number(o.value)===1?l.value.splice(0,l.value.length,{id:"welcome",senderId:1,receiverId:d.value,content:"您好，我是小助手，有什么可以帮到您？",messageType:1,createdAt:new Date().toISOString(),isSelf:!1,status:"confirmed",isLocal:!1}):l.value.splice(0,l.value.length,...s)}const R=(a=null)=>{setTimeout(()=>{b()},300)},H=()=>{O.value=0},D=()=>{e.index.onKeyboardHeightChange((a=null)=>{O.value=a.height||0,a.height>0&&setTimeout(()=>{b()},100)})};e.onLoad((a=null)=>e.__awaiter(this,void 0,void 0,function*(){const s=e.index.getSystemInfoSync();if(E.value=s.statusBarHeight||0,M.value=s.windowHeight,D(),e.index.__f__("log","at pagesChat/chat-box.vue:212","[调试] onLoad options:",a),!a.id)return e.index.__f__("error","at pagesChat/chat-box.vue:216","[调试] 错误：onLoad 未接收到 chatId 参数！"),e.index.showToast({title:"参数错误",icon:"none"}),setTimeout(()=>e.index.navigateBack(),1500),Promise.resolve(null);if(o.value=a.id,d.value=Number(m.getCurrentUserId()||1),f.value=a.title?decodeURIComponent(a.title):"",C.value=a.avatar||"/static/image/defaultAvatar/student-man.png",e.index.__f__("log","at pagesChat/chat-box.vue:227","[调试] onLoad chatId:",o.value,"selfId:",d.value,"chatId类型:",typeof o.value),!f.value){const n=UTS.arrayFind(l.value,c=>c.senderId&&c.senderId!==d.value&&c.nickname);n&&n.nickname&&(f.value=n.nickname)}f.value||(f.value="聊天"),l.value.splice(0,l.value.length);const r=m.getCurrentToken();if(e.index.__f__("log","at pagesChat/chat-box.vue:255","[调试] 页面加载，检查配置:",new UTSJSONObject({chatId:o.value,chatIdType:typeof o.value,selfId:d.value,hasToken:!!r,baseUrl:p.UNI_APP.BASE_URL,wsUrl:p.UNI_APP.WS_URL})),!r)return e.index.__f__("error","at pagesChat/chat-box.vue:265","[调试] 未找到token，无法建立连接"),e.index.showToast({title:"请先登录",icon:"none"}),Promise.resolve(null);j(),e.index.__f__("log","at pagesChat/chat-box.vue:272","[调试] onLoad 缓存消息:",UTS.JSON.parse(UTS.JSON.stringify(l.value))),o.value?yield W():e.index.__f__("error","at pagesChat/chat-box.vue:281","[调试] chatId 无效，跳过历史消息加载"),T.pollingManager.setCurrentPage("chat-box"),T.pollingManager.registerPollingCallback("chat-box",q),o.value?w():e.index.__f__("error","at pagesChat/chat-box.vue:294","[调试] chatId 无效，跳过 WebSocket 连接")})),e.onShow(()=>{e.index.__f__("log","at pagesChat/chat-box.vue:299","[调试] onShow - 页面显示"),T.pollingManager.setCurrentPage("chat-box"),g.value||(e.index.__f__("log","at pagesChat/chat-box.vue:305","[调试] onShow - WebSocket断开，尝试重连"),setTimeout(()=>{w()},1e3))}),e.onUnload(()=>{e.index.__f__("log","at pagesChat/chat-box.vue:313","[调试] onUnload - 页面卸载"),T.pollingManager.unregisterPollingCallback("chat-box"),P(),I()});const W=()=>e.__awaiter(this,void 0,void 0,function*(){try{if(!o.value)return Promise.resolve(null);j();const a=m.getCurrentToken();if(!a)return Promise.resolve(null);e.index.__f__("log","at pagesChat/chat-box.vue:340","[调试] 拉取历史消息参数:",new UTSJSONObject({targetUserId:o.value}));const s=yield e.index.request({url:`${p.UNI_APP.BASE_URL}/yanshilu/chatMessage/history/${o.value}`,method:"GET",data:new UTSJSONObject({chatId:o.value}),header:new UTSJSONObject({Authorization:`Bearer ${a}`})});let r=s[1]?s[1]:s;if(r&&r.statusCode===200&&r.data&&r.data.code===200){const i=(r.data.data||[]).map((t=null)=>new UTSJSONObject({id:t.id||t.chatMessageId,chatMessageId:t.chatMessageId,senderId:t.sendId||t.senderId,receiverId:t.receiverId,content:t.content,messageType:t.type||t.msgType,createdAt:t.sendTime||t.send_time,isSelf:(t.sendId||t.senderId)===d.value,status:"confirmed",isLocal:!1,avatar:t.avatar||t.senderPicture||t.headImage||"/static/image/defaultAvatar/student-man.png",nickname:t.nickname||t.senderName||t.nickName||`用户${t.senderId||t.sendId}`})).filter((t=null)=>t.senderId===d.value&&t.receiverId===Number(o.value)||t.senderId===Number(o.value)&&t.receiverId===d.value);if(l.value.splice(0,l.value.length,...i),I(),b(),!f.value){const t=i.find((u=null)=>u.senderId&&u.senderId!==d.value&&u.nickname);t&&t.nickname&&(f.value=t.nickname)}f.value||(f.value="聊天")}else e.index.__f__("log","at pagesChat/chat-box.vue:401","[调试] loadChatHistory 未通过判断，resData:",UTS.JSON.stringify(r))}catch{}}),J=()=>{if(!g.value||!v)return w(),setTimeout(()=>{g.value&&v&&J()},2e3),null;if(!S.value.trim()||!o.value)return null;let a=d.value,s=Number(o.value);const r=`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,n=S.value,c=new UTSJSONObject({id:r,senderId:a,receiverId:s,content:n,messageType:1,createdAt:new Date().toISOString(),isSelf:!0,status:"sending",isLocal:!0});l.value.push(c),b(),I(),S.value="";const i=new UTSJSONObject({category:"PRIVATE_CHAT",messageId:r,timestamp:Date.now(),payload:new UTSJSONObject({receiveUserId:s,content:n,messageType:1}),metadata:new UTSJSONObject({})});v.send(new UTSJSONObject({data:UTS.JSON.stringify(i),success:()=>{try{T.pollingManager.triggerPollingCallback&&T.pollingManager.triggerPollingCallback("chat-list-sessions")}catch(t){e.index.__f__("error","at pagesChat/chat-box.vue:480","[调试] 触发会话列表轮询失败",t)}},fail:(t=null)=>{e.index.showToast({title:"消息发送失败",icon:"none"})}}))};function P(){if(v){try{v.close()}catch{}v=null,g.value=!1,_.websocketManager.setConnectionStatus(!1)}}const w=()=>{if(v&&g.value)return null;P();const a=m.getCurrentToken()||"";if(!a)return e.index.__f__("error","at pagesChat/chat-box.vue:511","聊天需要认证，但未找到token"),e.index.showToast({title:"请先登录",icon:"none"}),_.websocketManager.setConnectionStatus(!1),null;if(!o.value)return e.index.__f__("error","at pagesChat/chat-box.vue:520","[调试] WebSocket连接失败：chatId 无效！"),e.index.showToast({title:"会话参数错误",icon:"none"}),_.websocketManager.setConnectionStatus(!1),null;const s=o.value,r=`${p.UNI_APP.WS_URL}/websocket/message?token=${encodeURIComponent(a)}&conversationId=${s}`;try{if(v=e.index.connectSocket({url:r,success:()=>{},fail:n=>{_.websocketManager.setConnectionStatus(!1)}}),!v)return _.websocketManager.setConnectionStatus(!1),null;v.onOpen(()=>{g.value=!0,_.websocketManager.setConnectionStatus(!0,s);const n=new UTSJSONObject({category:"CONNECTION",messageId:"init_"+Date.now(),timestamp:Date.now(),payload:new UTSJSONObject({type:"connect",conversationId:s})});try{v.send(new UTSJSONObject({data:UTS.JSON.stringify(n)}))}catch{}}),v.onClose((n=null)=>{g.value=!1,v=null,_.websocketManager.setConnectionStatus(!1)}),v.onError((n=null)=>{g.value=!1,v=null,_.websocketManager.setConnectionStatus(!1)}),v.onMessage((n=null)=>{var c,i;if(typeof n.data=="string"&&(n.data.trim().startsWith("{")||n.data.trim().startsWith("[")))try{const t=UTS.JSON.parse(n.data);if(t&&typeof t=="object"){if(t.category==="CONNECTION_ACK")return null;if(t.category==="MESSAGE_CONFIRM"){const u=(c=t.payload)===null||c===void 0?null:c.messageId;if(u){const h=l.value.findIndex(N=>N.id===u);h!==-1&&(l.value[h].status="confirmed",l.value[h].isLocal=!1,l.value[h].chatMessageId=t.payload.messageId,I())}return null}if(t.category==="MESSAGE_ERROR"){const u=t.messageId;if(u){const h=l.value.findIndex(N=>N.id===u);h!==-1&&(l.value[h].status="failed",I())}return e.index.showToast({title:((i=t.payload)===null||i===void 0?null:i.content)||"消息发送失败",icon:"none"}),null}if(t.category==="PRIVATE_CHAT"){const u=t.payload||new UTSJSONObject({});if(u.senderId===d.value&&u.receiveUserId===Number(o.value)||u.senderId===Number(o.value)&&u.receiveUserId===d.value){const h=new UTSJSONObject({id:t.messageId||`server_${Date.now()}`,senderId:u.senderId,receiverId:u.receiveUserId,content:u.content,messageType:u.messageType,createdAt:u.createdAt||new Date().toISOString(),isSelf:u.senderId===d.value,status:"received",isLocal:!1,chatMessageId:u.messageId});l.value.push(h),b(),I()}return null}}}catch{}})}catch{_.websocketManager.setConnectionStatus(!1)}},q=()=>e.__awaiter(this,void 0,void 0,function*(){try{if(!o.value)return Promise.resolve(null);const a=m.getCurrentToken();if(!a)return Promise.resolve(null);let s=d.value,r=Number(o.value);const n=yield new Promise((c,i)=>{e.index.request({url:`${p.UNI_APP.BASE_URL}/message/private/newMessages`,method:"GET",data:new UTSJSONObject({fromUserId:s,toUserId:r,lastMessageId:x.value,limit:20,chatId:o.value}),header:new UTSJSONObject({Authorization:`Bearer ${a}`}),success:t=>c(t),fail:t=>i(t)})});n.statusCode===200&&n.data.code===200&&((n.data.data||[]).forEach((i=null)=>{const t=new UTSJSONObject({id:`msg_${i.chatMessageId}`,chatMessageId:i.chatMessageId,senderId:i.senderId,receiverId:i.receiverId,content:i.content,messageType:i.msgType,createdAt:i.sendTime,isSelf:i.senderId===d.value,status:"received",isLocal:!1});(t.senderId===s&&t.receiverId===r||t.senderId===r&&t.receiverId===s)&&(UTS.arrayFind(l.value,h=>h.chatMessageId===i.chatMessageId)||(l.value.push(t),x.value=Math.max(x.value,i.chatMessageId)))}),b(),I())}catch{}}),F=()=>{e.index.navigateBack()},K=()=>{e.index.showToast({title:"更多功能开发中",icon:"none"})},b=()=>{setTimeout(()=>{y.value=y.value+9999},100)},z=()=>{e.index.showToast({title:"正在重新连接...",icon:"loading"}),w()},A=()=>{const a=new UTSJSONObject({chatId:o.value,selfId:d.value,isSocketOpen:g.value,isPolling:U.value,hasSocketTask:!!v,baseUrl:p.UNI_APP.BASE_URL,wsUrl:p.UNI_APP.WS_URL,hasToken:!!m.getCurrentToken()});e.index.showModal(new UTSJSONObject({title:"调试信息",content:UTS.JSON.stringify(a,null,2),showCancel:!1}))};e.watch(l,a=>{e.index.__f__("log","at pagesChat/chat-box.vue:795","[调试] 消息 senderId/selfId 类型和值:",a.map(s=>new UTSJSONObject({id:s.id,senderId:s.senderId,senderIdType:typeof s.senderId,selfId:d.value,selfIdType:typeof d.value,content:s.content})))});const G=e.computed(()=>{const a=[];let s=null;return l.value.forEach((r,n)=>{const c=new Date(r.createdAt||r.sendTime).getTime();(n===0||s&&c-s>Z)&&a.push({type:"time-tip",time:c,id:`time_${c}_${n}`}),a.push(Object.assign({type:"message"},r)),s=c}),a});return(a=null,s=null)=>e.e(new UTSJSONObject({a:e.o(F),b:e.p(new UTSJSONObject({title:f.value,avatar:C.value})),c:!g.value}),g.value?new UTSJSONObject({}):new UTSJSONObject({d:e.t(U.value?"轮询模式":"连接已断开"),e:e.t(U.value?"每5秒检查新消息":"无法实时接收消息"),f:e.o(z)}),new UTSJSONObject({g:e.f(G.value,(n=null,c=null,i=null)=>e.e(new UTSJSONObject({a:n.type==="time-tip"}),n.type==="time-tip"?new UTSJSONObject({b:e.t(e.unref(V.toTimeText)(n.time))}):new UTSJSONObject({c:"787963f2-1-"+i,d:e.p(new UTSJSONObject({message:n,"is-self":Number(n.senderId)===Number(d.value)})),e:e.n(new UTSJSONObject({self:Number(n.senderId)===Number(d.value)}))}),new UTSJSONObject({f:n.id}))),h:y.value,i:$.value+"px",j:e.o(R),k:e.o(H),l:e.o((n=null)=>S.value=n),m:e.p(new UTSJSONObject({placeholder:"请输入内容",showConfirmBar:!1,autoHeight:!0,adjustPosition:!1,border:"surround",maxlength:500,modelValue:S.value})),n:S.value.length>0}),S.value.length>0?new UTSJSONObject({o:e.o(J),p:e.o(A)}):new UTSJSONObject({q:e.o(K),r:e.o(A)}),new UTSJSONObject({s:O.value+"px",t:e.sei(e.gei(a,""),"view")}))}}),te=e._export_sfc(ee,[["__scopeId","data-v-787963f2"]]);wx.createPage(te);
//# sourceMappingURL=../../.sourcemap/mp-weixin/pagesChat/chat-box.js.map
