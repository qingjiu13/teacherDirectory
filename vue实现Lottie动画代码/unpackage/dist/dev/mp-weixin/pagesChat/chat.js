"use strict";const t=require("../common/vendor.js"),u=require("./common/mockChatService.js"),g=require("./common/mockData.js"),_=require("./main.js"),l=require("../common/assets.js"),d=()=>"../components/tab-bar/tab-bar.js",C=()=>"./components/chat-item/chat-item.js",p=()=>"./components/long-press-menu/long-press-menu.js",f=()=>"./components/loading/loading.js",v=t.defineComponent({components:{ChatItem:C,TabBar:d,LongPressMenu:p,Loading:f},data(){return{searchText:"",menu:new UTSJSONObject({show:!1,style:"",chatIdx:-1,isTouchMove:!1,items:[new UTSJSONObject({key:"DELETE",name:"删除该聊天",icon:"trash",color:"#e64e4e"}),new UTSJSONObject({key:"TOP",name:"置顶该聊天",icon:"arrow-up"})]}),chats:[],chatStore:null,useMockData:!0,isLoading:!1,hasError:!1,errorMessage:""}},created(){try{this.chatStore=_.getChatStore(),!this.chatStore&&this.$&&(this.chatStore=this.$chatStore),t.index.__f__("log","at pagesChat/chat.vue:113","获取chatStore成功:",!!this.chatStore)}catch(e){t.index.__f__("error","at pagesChat/chat.vue:115","获取chatStore失败:",e),this.chatStore={chats:[],removeChat:this.mockRemoveChat.bind(this),moveTop:this.mockMoveToTop.bind(this),isLoading:()=>this.isLoading}}},onLoad(){getApp().$vm&&(getApp().$vm.isInit=!0),this.loadChats(),t.index.__f__("log","at pagesChat/chat.vue:135","Chat页面已加载，chats数据长度：",this.chats.length)},methods:{loadChats(){this.isLoading=!0,t.index.__f__("log","at pagesChat/chat.vue:143","chat.vue: 开始加载聊天数据");try{this.chats=UTS.JSON.parse(UTS.JSON.stringify(g.mockChats)),t.index.__f__("log","at pagesChat/chat.vue:148","chat.vue: 直接从mockChats加载数据，共",this.chats.length,"条会话"),this.chatStore&&this.chatStore.initChats&&(this.chatStore.initChats(new UTSJSONObject({chats:this.chats,privateMsgMaxId:5e3,groupMsgMaxId:6e3})),t.index.__f__("log","at pagesChat/chat.vue:157","chat.vue: 数据已加载到chatStore")),this.chatStore||(this.chatStore={chats:this.chats,removeChat:this.mockRemoveChat.bind(this),moveTop:this.mockMoveToTop.bind(this),isLoading:()=>this.isLoading}),t.index.__f__("log","at pagesChat/chat.vue:170","chat.vue: 聊天数据加载完成，共加载",this.chats.length,"条聊天记录")}catch(e){t.index.__f__("error","at pagesChat/chat.vue:172","chat.vue: 加载聊天数据失败",e),this.handleError(e,"加载聊天数据失败"),this.createDefaultMockData()}finally{this.isLoading=!1,t.index.__f__("log","at pagesChat/chat.vue:178","chat.vue: 数据加载状态已更新 isLoading =",this.isLoading)}},createDefaultMockData(){const e=new Date().getTime();this.chats=[{targetId:1,type:"PRIVATE",showName:"张老师",headImage:"/static/image/defaultAvatar/student-man.png",lastContent:"你好，有什么问题需要咨询吗？",lastSendTime:e-10*60*1e3,unreadCount:0,messages:[],atMe:!1,atAll:!1},{targetId:2,type:"PRIVATE",showName:"李同学",headImage:"/static/image/defaultAvatar/student-woman.png",lastContent:"老师，我已完成作业",lastSendTime:e-30*60*1e3,unreadCount:1,messages:[],atMe:!1,atAll:!1},{targetId:101,type:"GROUP",showName:"高三一班班级群",headImage:"/static/image/defaultAvatar/teacher-man.png",lastContent:"请同学们注意查看群公告",lastSendTime:e-2*60*60*1e3,unreadCount:3,messages:[],atMe:!0,atAll:!1}],this.chatStore&&this.chatStore.initChats&&this.chatStore.initChats(new UTSJSONObject({chats:this.chats,privateMsgMaxId:1e3,groupMsgMaxId:2e3}))},mockRemoveChat(e=null){if(e>=0&&e<this.chats.length){const a=this.chats[e];try{u.mockChatService.deleteChat(new UTSJSONObject({type:a.type,targetId:a.targetId}))}catch(n){t.index.__f__("log","at pagesChat/chat.vue:252","删除会话时出错，直接从本地数组移除",n)}this.chats.splice(e,1)}},mockMoveToTop(e=null){if(e>0&&e<this.chats.length){const a=this.chats[e];this.chats.splice(e,1),this.chats.unshift(a),t.index.__f__("log","at pagesChat/chat.vue:272","会话已置顶")}},onSelectMenu(e=null,a=null){switch(e.key){case"DELETE":this.removeChat(a);break;case"TOP":this.moveToTop(a);break}this.menu.show=!1},removeChat(e=null){this.chatStore&&this.chatStore.removeChat?this.chatStore.removeChat(e):this.mockRemoveChat(e)},moveToTop(e=null){this.chatStore&&this.chatStore.moveTop?this.chatStore.moveTop(e):this.mockMoveToTop(e)},isShowChat(e=null){return e.delete?!1:!this.searchText||e.showName.includes(this.searchText)},onSearchInput(){t.index.__f__("log","at pagesChat/chat.vue:318","搜索关键词:",this.searchText)},loadMoreChats(){t.index.__f__("log","at pagesChat/chat.vue:325","加载更多聊天记录")},handleError(e=null,a=null){this.hasError=!0,this.errorMessage=a||"操作失败",t.index.__f__("error","at pagesChat/chat.vue:337",a,e),t.index.showToast({title:this.errorMessage,icon:"none",duration:2e3})}},computed:{loading(){return this.isLoading},initializing(){return!1},showChats(){return this.searchText?this.chats.filter(e=>{if(e.delete)return!1;const a=e.showName&&e.showName.toLowerCase().includes(this.searchText.toLowerCase()),n=e.lastContent&&e.lastContent.toLowerCase().includes(this.searchText.toLowerCase());return a||n}):this.chats.filter(e=>!e.delete)}}});if(!Array){const e=t.resolveComponent("uni-search-bar"),a=t.resolveComponent("Loading"),n=t.resolveComponent("ChatItem"),i=t.resolveComponent("LongPressMenu"),h=t.resolveComponent("tab-bar");(e+a+n+i+h)()}const S=()=>"../uni_modules/uni-search-bar/components/uni-search-bar/uni-search-bar.js",T=()=>"../components/tab-bar/tab-bar.js";Math||(S+T)();function b(e,a,n,i,h,s){return t.e({a:l._imports_0$2,b:l._imports_1$2,c:t.o(s.onSearchInput),d:t.o(o=>h.searchText=o),e:t.p({focus:!1,radius:"100",cancelButton:"none",placeholder:"搜索",modelValue:h.searchText}),f:s.loading},s.loading?{g:t.p({size:50,mask:!1})}:{},{h:!s.loading&&h.chats.length==0},!s.loading&&h.chats.length==0?{}:{},{i:!s.loading&&h.chats.length>0},!s.loading&&h.chats.length>0?t.e({j:t.f(s.showChats,(o,r,c)=>t.e({a:s.isShowChat(o)},s.isShowChat(o)?{b:"5ea78dde-3-"+c+","+("5ea78dde-2-"+c),c:t.p({chat:o,index:r,active:h.menu.chatIdx==r,chatStore:h.chatStore}),d:t.o(m=>s.onSelectMenu(m,r),r),e:"5ea78dde-2-"+c,f:t.p({items:h.menu.items})}:{},{g:r})),k:s.showChats.length===0&&h.searchText},s.showChats.length===0&&h.searchText?{l:t.t(h.searchText)}:{},{m:t.o((...o)=>s.loadMoreChats&&s.loadMoreChats(...o))}):{},{n:t.p({pageName:"message"})})}const M=t._export_sfc(v,[["render",b]]);wx.createPage(M);
//# sourceMappingURL=../../.sourcemap/mp-weixin/pagesChat/chat.js.map
