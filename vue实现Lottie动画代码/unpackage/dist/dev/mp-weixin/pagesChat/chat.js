"use strict";const e=require("../common/vendor.js"),h=require("../store/user/JWT.js"),_=require("../utils/pollingManager.js"),y=require("../store/global.js");Array||e.resolveComponent("uni-search-bar")();const O=()=>"../uni_modules/uni-search-bar/components/uni-search-bar/uni-search-bar.js";Math||(O+U+A)();const U=()=>"./components/chat-item/chat-item.js",A=()=>"./components/tab-bar/tab-bar.js",o=1,D=e.defineComponent({__name:"chat",setup(v,f){var p=f.expose;const C=()=>y.useGlobalStore().apiBaseUrl,u=e.ref(""),c=e.ref([]),g=e.computed(()=>u.value),I=()=>e.__awaiter(this,void 0,void 0,function*(){try{e.index.__f__("log","at pagesChat/chat.vue:67","[调试] 开始获取会话列表");const n=yield h.apiRequest(`${C()}/yanshilu/chatMessage/sessionList`,"GET",new UTSJSONObject({}),new UTSJSONObject({requireAuth:!0,showError:!1}));if(e.index.__f__("log","at pagesChat/chat.vue:80","[调试] apiRequest 响应:",n),!n.success)throw new Error(n.message||"获取会话列表失败");let t=[];const r=n.data;Array.isArray(r)?t=r:Array.isArray(r==null?null:r.rows)?t=r.rows:r&&Array.isArray(r.data)?t=r.data:r!=null&&r.rows&&(t=Object.values(r.rows)),Array.isArray(t)||(t=Object.values(t||{})),e.index.__f__("log","at pagesChat/chat.vue:107","[调试] sessionList 转换后:",t),t.forEach((a,l)=>{e.index.__f__("log","at pagesChat/chat.vue:111",`[调试] session item[${l}]:`,UTS.JSON.stringify(a))});const s=h.getCurrentUserId();if(e.index.__f__("log","at pagesChat/chat.vue:116","[调试] 当前用户ID:",s),e.index.__f__("log","at pagesChat/chat.vue:117","[调试] 当前用户ID类型:",typeof s),e.index.__f__("log","at pagesChat/chat.vue:118","[调试] ADMIN_ID:",o),e.index.__f__("log","at pagesChat/chat.vue:119","[调试] ADMIN_ID类型:",typeof o),e.index.__f__("log","at pagesChat/chat.vue:120","[调试] 是否相等:",s===o),s===o)e.index.__f__("log","at pagesChat/chat.vue:123","[调试] 进入客服端逻辑"),t.forEach(a=>{a.chatId=a.senderId===o?a.receiverId:a.senderId,a.showName=a.chat_user_nick_name||a.chatUserNickName||a.chat_user_user_name||a.chatUserUserName||"匿名用户",a.headImage=a.chat_user_avatar||a.senderPicture||a.receiverPicture||"/static/image/defaultAvatar/student-man.png",a.lastContent=a.content||"",a.lastSendTime=a.sendTime||"",a.id=a.chatMessageId}),c.value=t.filter(a=>a.chatId&&a.chatId!==o),e.index.__f__("log","at pagesChat/chat.vue:149","[调试] 客服端会话列表:",c.value);else{if(e.index.__f__("log","at pagesChat/chat.vue:151","[调试] 进入普通用户端逻辑"),e.index.__f__("log","at pagesChat/chat.vue:152","[调试] sessionList 数据:",t),e.index.__f__("log","at pagesChat/chat.vue:153","[调试] currentUserId:",s,"类型:",typeof s),e.index.__f__("log","at pagesChat/chat.vue:159","[调试] ADMIN_ID:",o,"类型:",typeof o),t&&t.length>0){const a=UTS.arrayFind(t,l=>{e.index.__f__("log","at pagesChat/chat.vue:165","[调试] 检查会话项:",l),e.index.__f__("log","at pagesChat/chat.vue:166","[调试] item.senderId:",l.senderId,"类型:",typeof l.senderId),e.index.__f__("log","at pagesChat/chat.vue:172","[调试] item.receiverId:",l.receiverId,"类型:",typeof l.receiverId);const d=l.senderId===o&&l.receiverId===s||l.senderId===s&&l.receiverId===o;return e.index.__f__("log","at pagesChat/chat.vue:181","[调试] 是否匹配:",d),d});e.index.__f__("log","at pagesChat/chat.vue:185","[调试] 找到的客服会话:",a),a?c.value=[{id:a.chatMessageId||1,chatId:o,showName:"小助手",headImage:"/static/image/defaultAvatar/kefu.png",lastContent:a.content||"您好，请问有什么可以帮您？",lastSendTime:a.sendTime||Date.now(),unreadCount:0}]:(e.index.__f__("log","at pagesChat/chat.vue:202","[调试] 未找到客服会话，创建默认会话"),c.value=[{id:1,chatId:o,showName:"小助手",headImage:"/static/image/defaultAvatar/kefu.png",lastContent:"您好，请问有什么可以帮您？",lastSendTime:Date.now(),unreadCount:0}])}else e.index.__f__("log","at pagesChat/chat.vue:217","[调试] sessionList为空，创建默认会话"),c.value=[{id:1,chatId:o,showName:"小助手",headImage:"/static/image/defaultAvatar/kefu.png",lastContent:"您好，请问有什么可以帮您？",lastSendTime:Date.now(),unreadCount:0}];e.index.__f__("log","at pagesChat/chat.vue:231","[调试] 普通用户端会话列表:",c.value)}S()}catch(n){e.index.__f__("error","at pagesChat/chat.vue:235","[调试] 获取会话失败:",n),e.index.showToast({title:n.message||"获取会话失败",icon:"none",duration:2e3}),h.getCurrentUserId(),c.value=[{id:1,chatId:o,showName:"小助手",headImage:"/static/image/defaultAvatar/kefu.png",lastContent:"您好，请问有什么可以帮您？",lastSendTime:Date.now(),unreadCount:0}],e.index.__f__("log","at pagesChat/chat.vue:258","[调试] 使用默认会话列表:",c.value)}}),w=()=>e.__awaiter(this,void 0,void 0,function*(){}),S=()=>{c.value.sort((n,t)=>n.showName==="小助手"?-1:t.showName==="小助手"?1:new Date(t.lastSendTime)-new Date(n.lastSendTime))};e.onMounted(()=>{I(),_.pollingManager.setCurrentPage("chat-list"),_.pollingManager.registerPollingCallback("chat-list-sessions",w)});const m=()=>{_.pollingManager.setCurrentPage("chat-list")},x=()=>{_.pollingManager.setCurrentPage("other")},b=()=>{_.pollingManager.unregisterPollingCallback("chat-list-sessions"),_.pollingManager.setCurrentPage("other")},i=e.computed(()=>{if(!u.value)return c.value;const n=u.value.toLowerCase();return c.value.filter(t=>t.showName&&t.showName.toLowerCase().includes(n)||t.lastContent&&t.lastContent.toLowerCase().includes(n))}),N=(n=null)=>{if(!n.chatId)return e.index.showToast({title:"会话ID无效",icon:"none"}),null;e.index.navigateTo({url:`/pagesChat/chat-box?id=${n.chatId}&title=${encodeURIComponent(n.showName)}&avatar=${encodeURIComponent(n.headImage)}`})},T=(n=null)=>{e.index.__f__("log","at pagesChat/chat.vue:346","[搜索] 搜索关键词:",n)};return p(new UTSJSONObject({onShow:m,onHide:x,onUnload:b})),(n=null,t=null)=>e.e(new UTSJSONObject({a:e.o(T),b:e.o((s=null)=>u.value=s),c:e.p(new UTSJSONObject({focus:!1,radius:"100",cancelButton:"none",placeholder:"搜索",modelValue:u.value})),d:i.value.length===0}),i.value.length===0?new UTSJSONObject({e:e.t(g.value?`没有找到与"${g.value}"相关的结果`:"暂无消息")}):new UTSJSONObject({f:e.f(i.value,(s=null,a=null,l=null)=>new UTSJSONObject({a:s.id,b:e.o((d=null)=>N(s),s.id),c:"7b2824d4-1-"+l,d:e.p(new UTSJSONObject({chat:s}))}))}),new UTSJSONObject({g:e.p(new UTSJSONObject({pageName:"message"})),h:e.sei(e.gei(n,""),"view")}))}}),M=e._export_sfc(D,[["__scopeId","data-v-7b2824d4"]]);wx.createPage(M);
//# sourceMappingURL=../../.sourcemap/mp-weixin/pagesChat/chat.js.map
