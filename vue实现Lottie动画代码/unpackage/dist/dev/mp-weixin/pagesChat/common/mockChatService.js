"use strict";const c=require("./mockData.js"),n=require("./enums.js");class o{constructor(){this.chatData=c.initMockChatData(),this.currentUser=c.getMockCurrentUser(),this.eventListeners={}}getChats(){return new Promise(e=>{setTimeout(()=>{e(this.chatData)},300)})}getMessages(e,s){return new Promise(a=>{const t=this.chatData.chats.find(r=>r.type===e&&r.targetId===s);setTimeout(()=>{a(t?t.messages:[])},300)})}sendMessage(e,s){return new Promise(a=>{var d,h,g,u;let t=this.chatData.chats.find(m=>m.type===s.type&&m.targetId===s.targetId);t||(t={targetId:s.targetId,type:s.type,showName:s.type==="PRIVATE"?(d=c.getMockUserById(s.targetId))==null?void 0:d.nickName:(h=c.getMockGroupById(s.targetId))==null?void 0:h.showGroupName,headImage:s.type==="PRIVATE"?(g=c.getMockUserById(s.targetId))==null?void 0:g.headImageThumb:(u=c.getMockGroupById(s.targetId))==null?void 0:u.headImageThumb,lastContent:"",lastSendTime:new Date().getTime(),unreadCount:0,messages:[],atMe:!1,atAll:!1,stored:!1},this.chatData.chats.unshift(t));const r=this.chatData.privateMsgMaxId+1;this.chatData.privateMsgMaxId=r,e.id=r,e.sendTime=new Date().getTime(),e.senderId=this.currentUser.id,e.sendNickName=this.currentUser.nickName,e.selfSend=!0,e.status=n.MESSAGE_STATUS.SENDED,t.lastContent=e.type===n.MESSAGE_TYPE.TEXT?e.content:e.type===n.MESSAGE_TYPE.IMAGE?"[图片]":"[文件]",t.lastSendTime=e.sendTime,t.sendNickName=e.sendNickName,t.messages.push(e);const i=this.chatData.chats.indexOf(t);i>0&&(this.chatData.chats.splice(i,1),this.chatData.chats.unshift(t)),this.triggerEvent("messageSent",{message:e,chatInfo:s}),setTimeout(()=>{a({success:!0,message:e})},300)})}deleteMessage(e,s){return new Promise(a=>{const t=this.chatData.chats.find(i=>i.type===s.type&&i.targetId===s.targetId);if(!t){a({success:!1,error:"会话不存在"});return}const r=t.messages.findIndex(i=>i.id===e.id||i.tmpId&&i.tmpId===e.tmpId);if(r!==-1){if(t.messages.splice(r,1),t.messages.length>0){const i=t.messages[t.messages.length-1];t.lastContent=i.type===n.MESSAGE_TYPE.TEXT?i.content:i.type===n.MESSAGE_TYPE.IMAGE?"[图片]":"[文件]",t.lastSendTime=i.sendTime}else t.lastContent="";this.triggerEvent("messageDeleted",{messageInfo:e,chatInfo:s}),setTimeout(()=>{a({success:!0})},300)}else a({success:!1,error:"消息不存在"})})}recallMessage(e,s){return new Promise(a=>{const t=this.chatData.chats.find(i=>i.type===s.type&&i.targetId===s.targetId);if(!t){a({success:!1,error:"会话不存在"});return}const r=t.messages.find(i=>i.id===e.id||i.tmpId&&i.tmpId===e.tmpId);if(r){const i=r.content;r.status=n.MESSAGE_STATUS.RECALL,r.content=`${r.selfSend?"你":r.sendNickName}撤回了一条消息`,r.type=n.MESSAGE_TYPE.TIP_TEXT,t.messages[t.messages.length-1].id===r.id&&(t.lastContent=r.content),this.triggerEvent("messageRecalled",{messageInfo:{...e,content:i},chatInfo:s}),setTimeout(()=>{a({success:!0})},300)}else a({success:!1,error:"消息不存在"})})}clearMessages(e){return new Promise(s=>{const a=this.chatData.chats.find(t=>t.type===e.type&&t.targetId===e.targetId);if(!a){s({success:!1,error:"会话不存在"});return}a.messages=[],a.lastContent="",a.unreadCount=0,this.triggerEvent("messagesCleared",{chatInfo:e}),setTimeout(()=>{s({success:!0})},300)})}deleteChat(e){return new Promise(s=>{const a=this.chatData.chats.findIndex(t=>t.type===e.type&&t.targetId===e.targetId);a!==-1?(this.chatData.chats.splice(a,1),this.triggerEvent("chatDeleted",{chatInfo:e}),setTimeout(()=>{s({success:!0})},300)):s({success:!1,error:"会话不存在"})})}addEventListener(e,s){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(s)}removeEventListener(e,s){this.eventListeners[e]&&(this.eventListeners[e]=this.eventListeners[e].filter(a=>a!==s))}triggerEvent(e,s){this.eventListeners[e]&&this.eventListeners[e].forEach(a=>{a(s)})}}const l=new o;exports.mockChatService=l;
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pagesChat/common/mockChatService.js.map
