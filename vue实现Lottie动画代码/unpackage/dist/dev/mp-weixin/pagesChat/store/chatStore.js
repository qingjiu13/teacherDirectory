"use strict";const n=require("../../common/vendor.js"),r=require("../common/enums.js"),S=require("./userStore.js"),u=require("../env.js");let h=[];const g=n.defineStore("chatStore",{state:()=>({chats:[],privateMsgMaxId:0,groupMsgMaxId:0,loadingPrivateMsg:!1,loadingGroupMsg:!1}),actions:{initChats(e){h=[],this.chats=[];for(let t of e.chats)t.stored=!1,u.UNI_APP.MAX_MESSAGE_SIZE>0&&t.messages.length>u.UNI_APP.MAX_MESSAGE_SIZE&&(t.messages=t.messages.slice(0,u.UNI_APP.MAX_MESSAGE_SIZE)),h.push(JSON.parse(JSON.stringify(t))),this.chats.length<15&&this.chats.push(t);this.privateMsgMaxId=e.privateMsgMaxId||0,this.groupMsgMaxId=e.groupMsgMaxId||0,h.forEach(t=>{t.messages.forEach(s=>{s.loadStatus=="loading"&&(s.loadStatus="fail")})})},openChat(e){let t=this.curChats,s=null;for(let a in t)if(t[a].type==e.type&&t[a].targetId===e.targetId){s=t[a],this.moveTop(a);break}s==null&&(s={targetId:e.targetId,type:e.type,showName:e.showName,headImage:e.headImage,lastContent:"",lastSendTime:new Date().getTime(),unreadCount:0,messages:[],atMe:!1,atAll:!1,stored:!1},t.unshift(s),this.saveToStorage())},activeChat(e){let t=this.curChats;e>=0&&(t[e].unreadCount=0)},resetUnreadCount(e){let t=this.curChats;for(let s in t)t[s].type==e.type&&t[s].targetId==e.targetId&&(t[s].unreadCount=0,t[s].atMe=!1,t[s].atAll=!1,t[s].stored=!1,this.saveToStorage())},readedMessage(e){let t=this.findChatByFriend(e.friendId);t&&(t.messages.forEach(s=>{s.id&&s.selfSend&&s.status<r.MESSAGE_STATUS.RECALL&&(!e.maxId||s.id<=e.maxId)&&(s.status=r.MESSAGE_STATUS.READED,t.stored=!1)}),t.stored||this.saveToStorage())},removeChat(e){let t=this.curChats;t[e].delete=!0,t[e].stored=!1,this.saveToStorage()},removePrivateChat(e){let t=this.curChats;for(let s in t)t[s].type=="PRIVATE"&&t[s].targetId==e&&this.removeChat(s)},removeGroupChat(e){let t=this.curChats;for(let s in t)t[s].type=="GROUP"&&t[s].targetId==e&&this.removeChat(s)},moveTop(e){if(this.isLoading())return;let t=this.curChats;if(e>0){let s=t[e];t.splice(e,1),t.unshift(s),s.lastSendTime=new Date().getTime(),s.stored=!1,this.saveToStorage()}},insertMessage(e,t){let s=t.type;e.id&&s=="PRIVATE"&&e.id>this.privateMsgMaxId&&(this.privateMsgMaxId=e.id),e.id&&s=="GROUP"&&e.id>this.groupMsgMaxId&&(this.groupMsgMaxId=e.id);let a=this.findChat(t),l=this.findMessage(a,e);if(l){Object.assign(l,e),a.stored=!1,this.saveToStorage();return}if(e.type==r.MESSAGE_TYPE.IMAGE?a.lastContent="[图片]":e.type==r.MESSAGE_TYPE.FILE?a.lastContent="[文件]":e.type==r.MESSAGE_TYPE.AUDIO?a.lastContent="[语音]":e.type==r.MESSAGE_TYPE.ACT_RT_VOICE?a.lastContent="[语音通话]":e.type==r.MESSAGE_TYPE.ACT_RT_VIDEO?a.lastContent="[视频通话]":(e.type==r.MESSAGE_TYPE.TEXT||e.type==r.MESSAGE_TYPE.RECALL||e.type==r.MESSAGE_TYPE.TIP_TEXT)&&(a.lastContent=e.content),a.lastSendTime=e.sendTime,a.sendNickName=e.sendNickName,!e.selfSend&&e.status!=r.MESSAGE_STATUS.READED&&e.status!=r.MESSAGE_STATUS.RECALL&&e.type!=r.MESSAGE_TYPE.TIP_TEXT&&a.unreadCount++,!e.selfSend&&a.type=="GROUP"&&e.atUserIds&&e.status!=r.MESSAGE_STATUS.READED){let o=S.useUserStore().userInfo.id;e.atUserIds.indexOf(o)>=0&&(a.atMe=!0),e.atUserIds.indexOf(-1)>=0&&(a.atAll=!0)}(!a.lastTimeTip||a.lastTimeTip<e.sendTime-600*1e3)&&(a.messages.push({sendTime:e.sendTime,type:r.MESSAGE_TYPE.TIP_TIME}),a.lastTimeTip=e.sendTime);let d=a.messages.length;if(e.id&&e.id>0){for(let i in a.messages)if(a.messages[i].id&&e.id<a.messages[i].id){d=i,n.index.__f__("log","at pagesChat/store/chatStore.js:219",`消息出现乱序,位置:${a.messages.length},修正至:${d}`);break}}d==a.messages.length?a.messages[d]=e:a.messages.splice(d,0,e),a.stored=!1,this.saveToStorage()},updateMessage(e,t){let s=this.findChat(t),a=this.findMessage(s,e);a&&(Object.assign(a,e),s.stored=!1,this.saveToStorage())},deleteMessage(e,t){let s=this.findChat(t);for(let a in s.messages){if(s.messages[a].id&&s.messages[a].id==e.id){s.messages.splice(a,1);break}if(s.messages[a].tmpId&&s.messages[a].tmpId==e.tmpId){s.messages.splice(a,1);break}}s.stored=!1,this.saveToStorage()},recallMessage(e,t){let s=this.findChat(t);if(!s)return;let a=e.content,l=e.selfSend?"你":s.type=="PRIVATE"?"对方":e.sendNickName;for(let d in s.messages){let i=s.messages[d];i.id&&i.id==a&&(i.status=r.MESSAGE_STATUS.RECALL,i.content=l+"撤回了一条消息",i.type=r.MESSAGE_TYPE.TIP_TEXT,s.lastContent=i.content,s.lastSendTime=e.sendTime,s.sendNickName="",!e.selfSend&&e.status!=r.MESSAGE_STATUS.READED&&s.unreadCount++),i.quoteMessage&&i.quoteMessage.id==e.id&&(i.quoteMessage.content="引用内容已撤回",i.quoteMessage.status=r.MESSAGE_STATUS.RECALL,i.quoteMessage.type=r.MESSAGE_TYPE.TIP_TEXT)}s.stored=!1,this.saveToStorage()},updateChatFromFriend(e){let t=this.findChatByFriend(e.id);t&&(t.headImage!=e.headImage||t.showName!=e.nickName)&&(t.headImage=e.headImage,t.showName=e.nickName,t.stored=!1,this.saveToStorage())},updateChatFromUser(e){let t=this.findChatByFriend(e.id);t&&(t.headImage!=e.headImageThumb||t.showName!=e.nickName)&&(t.headImage=e.headImageThumb,t.showName=e.nickName,t.stored=!1,this.saveToStorage())},updateChatFromGroup(e){let t=this.findChatByGroup(e.id);t&&(t.headImage!=e.headImageThumb||t.showName!=e.showGroupName)&&(t.headImage=e.headImageThumb,t.showName=e.showGroupName,t.stored=!1,this.saveToStorage())},setLoadingPrivateMsg(e){this.loadingPrivateMsg=e,this.isLoading()||this.refreshChats()},setLoadingGroupMsg(e){this.loadingGroupMsg=e,this.isLoading()||this.refreshChats()},refreshChats(){h&&(h.sort((e,t)=>t.lastSendTime-e.lastSendTime),this.chats=h,h=null,this.saveToStorage())},saveToStorage(e){if(this.isLoading())return;let a="chats-app-"+S.useUserStore().userInfo.id,l=[];this.chats.forEach(i=>{let o=`${a}-${i.type}-${i.targetId}`;i.stored||(i.delete?n.index.removeStorageSync(o):n.index.setStorageSync(o,i),i.stored=!0),i.delete||l.push(o)});let d={privateMsgMaxId:this.privateMsgMaxId,groupMsgMaxId:this.groupMsgMaxId,chatKeys:l};n.index.setStorageSync(a,d),this.chats=this.chats.filter(i=>!i.delete)},clear(e){h=[],this.chats=[],this.privateMsgMaxId=0,this.groupMsgMaxId=0,this.loadingPrivateMsg=!1,this.loadingGroupMsg=!1},loadChat(e){return new Promise((t,s)=>{let l=S.useUserStore().userInfo.id,d=n.index.getStorageSync("chats-app-"+l);d&&(d.chatKeys&&(new Date().getTime(),d.chats=[],d.chatKeys.forEach(i=>{let o=n.index.getStorageSync(i);o&&d.chats.push(o)})),this.initChats(d)),t()})}},getters:{isLoading:e=>()=>e.loadingPrivateMsg||e.loadingGroupMsg,curChats:e=>h&&e.isLoading()?h:e.chats,findChatIdx:e=>t=>{let s=e.curChats;for(let a in s)if(s[a].type==t.type&&s[a].targetId===t.targetId)return t=e.chats[a],a},findChat:e=>t=>{let s=e.curChats,a=e.findChatIdx(t);return s[a]},findChatByFriend:e=>t=>e.curChats.find(s=>s.type=="PRIVATE"&&s.targetId==t),findChatByGroup:e=>t=>e.curChats.find(s=>s.type=="GROUP"&&s.targetId==t),findMessage:e=>(t,s)=>{if(!t)return null;for(let a in t.messages)if(s.id&&t.messages[a].id==s.id||s.tmpId&&t.messages[a].tmpId&&t.messages[a].tmpId==s.tmpId)return t.messages[a]}}});exports.useChatStore=g;
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pagesChat/store/chatStore.js.map
