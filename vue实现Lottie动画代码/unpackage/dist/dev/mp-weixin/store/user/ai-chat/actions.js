"use strict";const _=require("../../../common/vendor.js"),u=require("../APIroute/AIchat_api/AIchat_api.js"),A=require("../APIroute/Login_api/Login_api.js"),S={setCurrentChat({commit:s},t){s("UPDATE_CURRENT_CONVERSATION",t)},async sendQuestion({commit:s,state:t},e){var r,a;try{const c={content:e.question,chatMode:((r=e.contextInfo)==null?void 0:r.mode)||t.aiChat.chatMode,conversationId:e.chatId||t.aiChat.activeConversation},n=await u.sendMessageToAI(c);if(n.success){s("UPDATE_CURRENT_CONVERSATION",n.conversationId);const o={id:`msg-${Date.now()}`,type:"user",content:e.question,timestamp:new Date().toISOString()},I={id:`msg-${Date.now()+1}`,type:"ai",content:n.aiResponse,timestamp:new Date().toISOString()},d=t.aiChat.conversations.find(i=>i.id===n.conversationId);if(d){const i={...d,messages:[...d.messages||[],o,I],updatedAt:new Date().toISOString()};s("UPDATE_CONVERSATION_DETAIL",i)}else{const i={id:n.conversationId,abstract:e.question.substring(0,30)+(e.question.length>30?"...":""),chatMode:t.aiChat.chatMode,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),messages:[o,I]};s("UPDATE_CONVERSATION_DETAIL",i)}}return{success:n.success,data:n.aiResponse,chatId:n.conversationId,message:n.message}}catch(c){return _.index.__f__("error","at store/user/ai-chat/actions.js:107","AI问答出错:",c),{success:!1,error:c.error||c,message:((a=c.error)==null?void 0:a.message)||"请求失败"}}},async loadChat({commit:s},t){var e;try{const r=await u.getConversationDetail(t);if(r.success){const a={id:t,messages:r.messages,updatedAt:new Date().toISOString()};s("UPDATE_CONVERSATION_DETAIL",a)}return{success:r.success,data:r.messages}}catch(r){return _.index.__f__("error","at store/user/ai-chat/actions.js:146","加载对话详情失败:",r),{success:!1,error:r.error||r,message:((e=r.error)==null?void 0:e.message)||"加载对话详情失败"}}},async saveChat({commit:s,state:t},e){var r,a;try{const c=t.aiChat.conversations.find(n=>n.id===e.id);if(c)s("UPDATE_CONVERSATION_DETAIL",{...c,...e,updatedAt:new Date().toISOString()});else{const n={id:e.id,abstract:e.title||"新对话",chatMode:e.chatMode||"general",createdAt:((r=e.createdAt)==null?void 0:r.toISOString())||new Date().toISOString(),updatedAt:((a=e.updatedAt)==null?void 0:a.toISOString())||new Date().toISOString(),messages:e.messages||[]};s("UPDATE_CONVERSATION_DETAIL",n)}return{success:!0}}catch(c){return _.index.__f__("error","at store/user/ai-chat/actions.js:193","保存对话失败:",c),{success:!1,message:"保存对话失败"}}},async deleteChat({commit:s,state:t},e){var r;try{const a=await u.deleteConversation(e);return a.success&&(s("DELETE_CONVERSATION",e),t.aiChat.activeConversation===e&&s("UPDATE_CURRENT_CONVERSATION",null)),{success:a.success,message:a.message||(a.success?"删除成功":"删除失败")}}catch(a){return _.index.__f__("error","at store/user/ai-chat/actions.js:227","删除对话失败:",a),{success:!1,error:a.error||a,message:((r=a.error)==null?void 0:r.message)||"删除对话失败"}}},async loadConversationHistory({commit:s}){var t;try{const e=await u.getConversationHistory();return e.success&&e.conversations&&s("SET_CONVERSATIONS",e.conversations),{success:e.success,data:e.conversations}}catch(e){return _.index.__f__("error","at store/user/ai-chat/actions.js:256","获取对话历史失败:",e),{success:!1,error:e.error||e,message:((t=e.error)==null?void 0:t.message)||"获取对话历史失败"}}},testAIQA({dispatch:s},t){return s("sendQuestion",t)},async searchAISchools({commit:s,rootState:t},{keyword:e}){const r=t.user.baseInfo.id;s("SET_AI_SCHOOL_LOADING",!0),s("SET_AI_SCHOOL_SEARCH_KEYWORD",e);const a={userId:r,keyword:e};return new Promise((c,n)=>{A.searchUndergraduateSchools(a).then(o=>{o&&o.data&&s("SET_AI_SCHOOL_OPTIONS",o.data),s("SET_AI_SCHOOL_LOADING",!1),c(o)}).catch(o=>{s("SET_AI_SCHOOL_LOADING",!1),n(o)})})},async searchAIMajors({commit:s,rootState:t},{keyword:e}){const r=t.user.baseInfo.id;s("SET_AI_MAJOR_SEARCH_KEYWORD",e);const a={userId:r,keyword:e};return new Promise((c,n)=>{A.searchUndergraduateMajors(a).then(o=>{o&&o.data&&s("SET_AI_MAJOR_OPTIONS",o.data),c(o)}).catch(o=>{n(o)})})},selectAISchool({commit:s},{id:t,name:e}){s("SET_AI_SELECTED_SCHOOL",{id:t,name:e})},selectAIMajor({commit:s},{id:t,name:e}){s("SET_AI_SELECTED_MAJOR",{id:t,name:e})}};exports.actions=S;
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/store/user/ai-chat/actions.js.map
