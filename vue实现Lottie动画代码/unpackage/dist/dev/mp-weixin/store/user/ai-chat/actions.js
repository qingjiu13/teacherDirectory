"use strict";const e=require("../../../common/vendor.js"),D=require("../JWT.js"),k=require("../../global.js"),w=()=>k.useGlobalStore().apiBaseUrl,b={setCurrentChat({commit:a},c){a("UPDATE_CURRENT_CONVERSATION",c)},async sendQuestion({commit:a,state:c,rootState:n},t){try{let o=null,r=null,_=null,E=!c.aiChat.activeConversation,d=null;if(c.aiChat.activeConversation){const s=c.aiChat.activeConversation;/^\d+$/.test(s)?d=parseInt(s,10):typeof s=="number"&&(d=s)}!E&&!t.skipUserMessage&&(o={id:`msg-user-${Date.now()}`,role:"user",content:t.content,timestamp:new Date().toISOString(),status:"sent"},a("ADD_MESSAGE_TO_CURRENT_CONVERSATION",o),e.index.__f__("log","at store/user/ai-chat/actions.js:71","✅ 已添加用户消息到历史对话:",o.id));const l={category:"DOU_BAO_CHAT",timestamp:new Date().getTime(),payload:{content:t.content,topic:c.aiChat.chatMode,school:n.user.schoolMajorRequest.undergraduateSchoolSearch.selectedSchool,major:n.user.schoolMajorRequest.undergraduateMajorSearch.selectedMajor,conversationId:d}};e.index.__f__("log","at store/user/ai-chat/actions.js:86","=== AI聊天发送数据 ==="),e.index.__f__("log","at store/user/ai-chat/actions.js:87","原始activeConversation:",c.aiChat.activeConversation),e.index.__f__("log","at store/user/ai-chat/actions.js:88","处理后的conversationId:",d),e.index.__f__("log","at store/user/ai-chat/actions.js:89","是否为新对话:",d===null?"是":"否"),e.index.__f__("log","at store/user/ai-chat/actions.js:90","是否跳过用户消息:",t.skipUserMessage),e.index.__f__("log","at store/user/ai-chat/actions.js:91","完整请求数据:",JSON.stringify(l,null,2)),e.index.__f__("log","at store/user/ai-chat/actions.js:92","==================");const u=`ws://v8e5bd5f.natappfree.cc/websocket/message?token=${D.getCurrentToken()}`;return await new Promise((s,T)=>{const x=e.index.connectSocket({url:u,success:()=>{e.index.__f__("log","at store/user/ai-chat/actions.js:104","WebSocket连接请求已发送")},fail:f=>{e.index.__f__("error","at store/user/ai-chat/actions.js:107","WebSocket连接失败:",f),T(new Error("WebSocket连接失败"))}});let A="",g=d,C=0,p=!1,v=!1;x.onOpen(()=>{e.index.__f__("log","at store/user/ai-chat/actions.js:121","WebSocket连接已建立"),x.send({data:JSON.stringify(l),success:()=>{e.index.__f__("log","at store/user/ai-chat/actions.js:126","数据发送成功")},fail:f=>{e.index.__f__("error","at store/user/ai-chat/actions.js:129","数据发送失败:",f),T(new Error("数据发送失败"))}})}),x.onMessage(f=>{var I,M,y,R,U;try{if(e.index.__f__("log","at store/user/ai-chat/actions.js:138","=== 流式消息 ==="),e.index.__f__("log","at store/user/ai-chat/actions.js:139","原始数据:",f.data),!f.data){e.index.__f__("warn","at store/user/ai-chat/actions.js:143","收到空消息");return}let i;if(typeof f.data=="string")try{i=JSON.parse(f.data)}catch{e.index.__f__("warn","at store/user/ai-chat/actions.js:154","消息不是有效的JSON格式，尝试直接使用:",f.data),i={content:f.data,message:f.data,category:"DOU_BAO_CHAT"}}else i=f.data;e.index.__f__("log","at store/user/ai-chat/actions.js:165","解析后数据:",JSON.stringify(i,null,2));const P=i.content||i.message||((I=i.payload)==null?void 0:I.content)||"";if(P==="连接成功"||P==="connected"||P==="connection established"){e.index.__f__("log","at store/user/ai-chat/actions.js:172","✅ 收到连接确认消息，开始接收流式数据...");return}if(i.category==="DOU_BAO_CHAT"){C++;let m=i.content||i.message||((M=i.payload)==null?void 0:M.content)||"";const N=i.conversationId||((y=i.payload)==null?void 0:y.conversationId);if(N&&!g&&(e.index.__f__("log","at store/user/ai-chat/actions.js:186","🆔 收到conversationId:",N,"来源:",i.conversationId?"data.conversationId":"data.payload.conversationId"),E&&N&&!v&&(e.index.__f__("log","at store/user/ai-chat/actions.js:190","🆔 收到新对话的conversationId，创建对话:",N),a("CREATE_CONVERSATION_FROM_BACKEND",{conversationId:N,abstract:t.content.substring(0,30)+(t.content.length>30?"...":""),messages:[]}),t.skipUserMessage||(o={id:`msg-user-${Date.now()}`,role:"user",content:t.content,timestamp:new Date().toISOString(),status:"sent"},a("ADD_MESSAGE_TO_CURRENT_CONVERSATION",o)),v=!0),g=N),r||(r=t.aiMessageId||`msg-ai-${Date.now()}`,_={id:r,role:"AI",content:"",timestamp:new Date().toISOString(),streaming:!0,status:"sending"},a("ADD_MESSAGE_TO_CURRENT_CONVERSATION",_),e.index.__f__("log","at store/user/ai-chat/actions.js:233","✅ 已创建AI消息:",r)),m===""||m===null||m===void 0){e.index.__f__("log","at store/user/ai-chat/actions.js:238","🏁 收到空字段，流式传输完成");const O=g||i.conversationId||((R=i.payload)==null?void 0:R.conversationId);O&&!g&&(g=O,e.index.__f__("log","at store/user/ai-chat/actions.js:244","🆔 在结束时更新conversationId:",g)),p=!0;const S=A.replace(/\n\s*\n\s*\n/g,`

`).trim();r&&a("UPDATE_MESSAGE_CONTENT",{messageId:r,content:S,streaming:!1,status:"sent"}),e.index.__f__("log","at store/user/ai-chat/actions.js:262","✅ 流式传输完成:",{content:S,conversationId:g,messageCount:C}),e.index.__f__("log","at store/user/ai-chat/actions.js:267","   - 最终内容长度:",S.length),e.index.__f__("log","at store/user/ai-chat/actions.js:268","   - 总消息片段数:",C),e.index.__f__("log","at store/user/ai-chat/actions.js:269","   - 会话ID:",g),t.onComplete&&t.onComplete({content:S,conversationId:g,messageCount:C}),s({success:!0,data:{content:S,message:S,conversationId:g,messageCount:C,isStreamComplete:!0}}),x.close();return}if(A+=m,e.index.__f__("log","at store/user/ai-chat/actions.js:301",`📝 流式片段 ${C}:`,m),e.index.__f__("log","at store/user/ai-chat/actions.js:302",`📄 累积内容长度: ${A.length}`),e.index.__f__("log","at store/user/ai-chat/actions.js:303",`🆔 会话ID: ${g}`),r&&a("UPDATE_MESSAGE_CONTENT",{messageId:r,content:A,streaming:!0,status:"sending"}),t.onMessage&&t.onMessage({content:m,fullContent:A,isComplete:!1,conversationId:g,messageCount:C}),i.isEnd||i.finished||i.complete||m.includes("[END]")||m.includes("[DONE]")){e.index.__f__("log","at store/user/ai-chat/actions.js:332","🏁 流式传输完成（其他结束标志）");const O=g||i.conversationId||((U=i.payload)==null?void 0:U.conversationId);O&&!g&&(g=O,e.index.__f__("log","at store/user/ai-chat/actions.js:338","🆔 在结束时更新conversationId（其他结束标志）:",g)),p=!0;const S=A.replace(/\n\s*\n\s*\n/g,`

`).trim();r&&a("UPDATE_MESSAGE_CONTENT",{messageId:r,content:S,streaming:!1,status:"sent"}),t.onComplete&&t.onComplete({content:S,conversationId:g,messageCount:C}),s({success:!0,data:{content:S,message:S,conversationId:g,messageCount:C,isStreamComplete:!0}}),x.close()}}else e.index.__f__("log","at store/user/ai-chat/actions.js:381","⚠️ 收到非DOU_BAO_CHAT类型消息:",i)}catch(i){e.index.__f__("error","at store/user/ai-chat/actions.js:385","❌ 解析WebSocket消息失败:",i),e.index.__f__("error","at store/user/ai-chat/actions.js:386","原始消息数据:",f.data),t.onError&&t.onError(new Error(`消息格式错误: ${i.message}`)),T(new Error(`消息格式错误: ${i.message}`))}}),x.onError(f=>{e.index.__f__("error","at store/user/ai-chat/actions.js:398","❌ WebSocket连接错误:",f),t.onError&&t.onError(new Error("WebSocket连接出现错误")),T(new Error("WebSocket连接出现错误"))}),x.onClose(f=>{if(e.index.__f__("log","at store/user/ai-chat/actions.js:407","🔌 WebSocket连接已关闭:",f.code,f.reason),!p&&A.length>0){e.index.__f__("log","at store/user/ai-chat/actions.js:411","⚠️ 连接提前关闭，但已接收到内容，认为传输完成");const I=A.replace(/\n\s*\n\s*\n/g,`

`).trim();r&&a("UPDATE_MESSAGE_CONTENT",{messageId:r,content:I,streaming:!1,status:"sent"}),t.onComplete&&t.onComplete({content:I,conversationId:g,messageCount:C}),s({success:!0,data:{content:I,message:I,conversationId:g,messageCount:C,isStreamComplete:!0}})}else if(!p){const I="连接意外关闭，未接收到完整响应";t.onError&&t.onError(new Error(I)),T(new Error(I))}})})}catch(o){throw e.index.__f__("error","at store/user/ai-chat/actions.js:458","❌ sendQuestion执行失败:",o),t.onError&&t.onError(o),o}},async loadChat({commit:a,state:c},n){try{const t=c.aiChat.conversations.find(_=>_.id==n),o=(t==null?void 0:t.chatMode)||"general";e.index.__f__("log","at store/user/ai-chat/actions.js:481","=== 强制加载对话详情（无缓存） ==="),e.index.__f__("log","at store/user/ai-chat/actions.js:482","对话ID:",n),e.index.__f__("log","at store/user/ai-chat/actions.js:483","对话模式:",o),e.index.__f__("log","at store/user/ai-chat/actions.js:484","对话信息:",t),e.index.__f__("log","at store/user/ai-chat/actions.js:485","===================================");const r=await D.apiRequest(`${w()}/yanshilu/aiChat/detail`,"POST",{id:parseInt(n),type:"DOU_BAO_CHAT",topic:o,timestamp:Date.now()});if(e.index.__f__("log","at store/user/ai-chat/actions.js:495","loadChat API响应:",r),r.success){const _=r.data;if(e.index.__f__("log","at store/user/ai-chat/actions.js:500","后端完整响应:",_),_.code!==200)throw new Error(_.msg||"后端返回错误");_.data&&_.data.length>0&&_.data[0].topic?a("UPDATE_CHAT_MODE",_.data[0].topic):o&&a("UPDATE_CHAT_MODE",o);const E=_.data||[];e.index.__f__("log","at store/user/ai-chat/actions.js:516","提取的消息数据:",E);const d=[];E.forEach((h,u)=>{h.question&&d.push({id:`msg-user-${h.id}-${u}`,role:"user",content:h.question,timestamp:h.createTime||h.updateTime||new Date().toISOString(),status:"sent"}),h.answer&&d.push({id:`msg-ai-${h.id}-${u}`,role:"AI",content:h.answer,timestamp:h.updateTime||h.createTime||new Date().toISOString(),status:"sent",streaming:!1})}),d.sort((h,u)=>{const j=new Date(h.timestamp).getTime(),s=new Date(u.timestamp).getTime();return j-s});const l={id:n,abstract:(t==null?void 0:t.abstract)||"无标题",chatMode:_.data&&_.data.length>0&&_.data[0].topic?_.data[0].topic:o,type:"DOU_BAO_CHAT",messages:d,createdAt:(t==null?void 0:t.createdAt)||Date.now(),updatedAt:(t==null?void 0:t.updatedAt)||Date.now(),lastFetchTime:Date.now()};return a("UPDATE_CONVERSATION_DETAIL",l),e.index.__f__("log","at store/user/ai-chat/actions.js:570","=== 对话详情强制加载成功 ==="),e.index.__f__("log","at store/user/ai-chat/actions.js:571","原始数据条数:",E.length),e.index.__f__("log","at store/user/ai-chat/actions.js:572","转换后消息数:",d.length),e.index.__f__("log","at store/user/ai-chat/actions.js:573","最新获取时间:",new Date(l.lastFetchTime).toLocaleString()),e.index.__f__("log","at store/user/ai-chat/actions.js:574","对话数据:",l),e.index.__f__("log","at store/user/ai-chat/actions.js:575","==============================="),{success:!0,data:l,conversation:l}}else throw new Error(r.message||"加载对话失败")}catch(t){return e.index.__f__("error","at store/user/ai-chat/actions.js:586","=== 强制加载对话详情失败 ==="),e.index.__f__("error","at store/user/ai-chat/actions.js:587","对话ID:",n),e.index.__f__("error","at store/user/ai-chat/actions.js:588","错误信息:",t),e.index.__f__("error","at store/user/ai-chat/actions.js:589","============================="),{success:!1,message:t.message||"加载对话详情失败"}}},async deleteChat({commit:a,state:c},n){try{const t=await D.apiRequest(`${w()}/yanshilu/aiChat/delete`,"POST",{id:n});if(t.success)return a("DELETE_CONVERSATION",n),c.aiChat.activeConversation===n&&a("UPDATE_CURRENT_CONVERSATION",null),{success:!0,message:"删除成功"};throw new Error(t.message||"删除失败")}catch(t){return e.index.__f__("error","at store/user/ai-chat/actions.js:626","删除对话失败:",t),{success:!1,message:t.message||"删除对话失败"}}},async loadConversationHistory({commit:a,state:c},n={}){var t,o,r,_,E,d;try{a("SET_PAGINATION_LOADING",!0);const l=n.pageNum||c.aiChat.pagination.pageNum,h=n.pageSize||c.aiChat.pagination.pageSize;n.pageNum&&a("SET_PAGE_NUM",n.pageNum),n.pageSize&&a("SET_PAGE_SIZE",n.pageSize);const u=await D.apiRequest(`${w()}/yanshilu/aiChat/list`,"POST",{pageSize:h,pageNum:l});if(e.index.__f__("log","at store/user/ai-chat/actions.js:662","response:",u),u.success&&((t=u.data)==null?void 0:t.code)===200){const j=u.data.rows||[];e.index.__f__("log","at store/user/ai-chat/actions.js:667","conversationsList:",j);const s=u.data.total||0;e.index.__f__("log","at store/user/ai-chat/actions.js:670","=== API响应数据解析 ==="),e.index.__f__("log","at store/user/ai-chat/actions.js:671","response.success:",u.success),e.index.__f__("log","at store/user/ai-chat/actions.js:672","response.data.code:",(o=u.data)==null?void 0:o.code),e.index.__f__("log","at store/user/ai-chat/actions.js:673","response.data.total:",(r=u.data)==null?void 0:r.total),e.index.__f__("log","at store/user/ai-chat/actions.js:674","response.data.rows.length:",(E=(_=u.data)==null?void 0:_.rows)==null?void 0:E.length),e.index.__f__("log","at store/user/ai-chat/actions.js:675","========================");const T=j.map(p=>({id:p.id,abstract:(p.title||"").replace(/[\r\n\t]/g," ").replace(/\s+/g," ").trim()||"无标题",chatMode:p.topic||"general",type:p.type,createdAt:p.createTime?new Date(p.createTime).getTime():Date.now(),updatedAt:p.updateTime?new Date(p.updateTime).getTime():Date.now(),createBy:p.createBy,updateBy:p.updateBy,remark:p.remark}));a("UPDATE_CONVERSATIONS_LIST",T);const x=Math.ceil(s/h),A=l<x,g=l>1,C={pageNum:l,pageSize:h,total:s,totalPages:x,hasNext:A,hasPrev:g,loading:!1};return a("UPDATE_PAGINATION",C),e.index.__f__("log","at store/user/ai-chat/actions.js:712","=== 对话历史加载成功 ==="),e.index.__f__("log","at store/user/ai-chat/actions.js:713","原始数据条数:",j.length),e.index.__f__("log","at store/user/ai-chat/actions.js:714","格式化后数据:",T),e.index.__f__("log","at store/user/ai-chat/actions.js:715","分页信息:",C),e.index.__f__("log","at store/user/ai-chat/actions.js:716","======================="),{success:!0,data:T,pagination:C,total:s}}else throw e.index.__f__("error","at store/user/ai-chat/actions.js:725","API响应失败:",u),new Error(u.message||((d=u.data)==null?void 0:d.msg)||"获取对话历史失败")}catch(l){return e.index.__f__("error","at store/user/ai-chat/actions.js:729","获取对话历史失败:",l),e.index.__f__("error","at store/user/ai-chat/actions.js:730","错误详情:",l.message),{success:!1,message:l.message||"获取对话历史失败"}}finally{a("SET_PAGINATION_LOADING",!1)}},async nextPage({state:a,dispatch:c,commit:n}){var t;if(a.aiChat.pagination.hasNext)try{const o=a.aiChat.pagination.pageNum+1;e.index.__f__("log","at store/user/ai-chat/actions.js:751","=== 加载下一页 ==="),e.index.__f__("log","at store/user/ai-chat/actions.js:752","当前页:",a.aiChat.pagination.pageNum),e.index.__f__("log","at store/user/ai-chat/actions.js:753","下一页:",o),e.index.__f__("log","at store/user/ai-chat/actions.js:754","================"),n("SET_PAGINATION_LOADING",!0);const r=await D.apiRequest(`${w()}/yanshilu/aiChat/list`,"POST",{pageSize:a.aiChat.pagination.pageSize,pageNum:o});if(r.success&&((t=r.data)==null?void 0:t.code)===200){const _=r.data.rows||[],E=r.data.total||0,d=_.map(s=>({id:s.id,abstract:(s.title||"").replace(/[\r\n\t]/g," ").replace(/\s+/g," ").trim()||"无标题",chatMode:s.topic||"general",type:s.type,createdAt:s.createTime?new Date(s.createTime).getTime():Date.now(),updatedAt:s.updateTime?new Date(s.updateTime).getTime():Date.now(),createBy:s.createBy,updateBy:s.updateBy,remark:s.remark}));d.sort((s,T)=>{const x=s.updatedAt||s.createdAt||0;return(T.updatedAt||T.createdAt||0)-x}),n("APPEND_CONVERSATIONS_LIST",d);const l=Math.ceil(E/a.aiChat.pagination.pageSize),h=o<l,u=o>1,j={pageNum:o,pageSize:a.aiChat.pagination.pageSize,total:E,totalPages:l,hasNext:h,hasPrev:u,loading:!1};return n("UPDATE_PAGINATION",j),e.index.__f__("log","at store/user/ai-chat/actions.js:811","=== 下一页加载成功 ==="),e.index.__f__("log","at store/user/ai-chat/actions.js:812","新增数据条数:",d.length),e.index.__f__("log","at store/user/ai-chat/actions.js:813","总数据条数:",a.aiChat.conversations.length),e.index.__f__("log","at store/user/ai-chat/actions.js:814","分页信息:",j),e.index.__f__("log","at store/user/ai-chat/actions.js:815","===================="),{success:!0,data:d,pagination:j,total:E}}else throw new Error(r.message||"加载下一页失败")}catch(o){return e.index.__f__("error","at store/user/ai-chat/actions.js:827","加载下一页失败:",o),{success:!1,message:o.message||"加载下一页失败"}}finally{n("SET_PAGINATION_LOADING",!1)}return{success:!1,message:"已经是最后一页"}},async prevPage({state:a,dispatch:c}){return a.aiChat.pagination.hasPrev?await c("loadConversationHistory",{pageNum:a.aiChat.pagination.pageNum-1}):{success:!1,message:"已经是第一页"}},async goToPage({state:a,dispatch:c},n){return n>=1&&n<=a.aiChat.pagination.totalPages?await c("loadConversationHistory",{pageNum:n}):{success:!1,message:"页码超出范围"}},async changePageSize({dispatch:a},c){return await a("loadConversationHistory",{pageNum:1,pageSize:c})},async refreshPage({state:a,dispatch:c}){return await c("loadConversationHistory",{pageNum:a.aiChat.pagination.pageNum,pageSize:a.aiChat.pagination.pageSize})}};exports.actions=b;
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/store/user/ai-chat/actions.js.map
