"use strict";const o=require("../../common/vendor.js"),m=require("../../router/Router.js"),T=(a,t)=>{let r=0;for(let n=0;n<a.length;n++){const l=a.charCodeAt(n);r=(r<<5)-r+l,r|=0}return btoa(r+t)},x=(a,t="yanshilu-jwt-secret")=>{try{const[r,n,l]=a.split("."),s=T(`${r}.${n}`,t);if(l!==s)return!1;const f=JSON.parse(atob(n)),u=Math.floor(Date.now()/1e3);return!(f.exp&&f.exp<u)}catch(r){return o.index.__f__("error","at store/user/JWT.js:88","JWT验证失败:",r),!1}},y=a=>{try{const[,t]=a.split(".");return JSON.parse(atob(t)).userId||null}catch(t){return o.index.__f__("error","at store/user/JWT.js:104","解析JWT令牌失败:",t),null}},C=()=>o.index.getStorageSync("user-token")||null,w=(a,t="GET",r={},n={})=>{const s={...{autoAddUserId:!0,requireAuth:!0,showError:!0,customHeader:{}},...n};return new Promise((f,u)=>{const i=C();if(s.requireAuth&&(!i||!x(i))){const e={success:!1,error:{code:401,message:"未登录或认证已过期，请重新登录"}};s.showError&&o.index.showToast({title:e.error.message,icon:"none",duration:2e3}),u(e);return}let h={...r};if(s.autoAddUserId&&i){const e=y(i);e&&(h=t.toUpperCase()==="GET"?{...h,userId:e}:{...h,userId:e})}const p={"Content-Type":"application/json",...s.customHeader};i&&(p.Authorization=`Bearer ${i}`),o.index.request({url:a,method:t.toUpperCase(),data:h,header:p,success:e=>{var c,g;if(e.statusCode===200&&e.data&&e.data.code===200)f({success:!0,data:e.data.data});else if(e.statusCode===401||e.statusCode===403){o.index.removeStorageSync("user-token"),o.index.removeStorageSync("userId");const d={success:!1,error:{statusCode:e.statusCode,message:((c=e.data)==null?void 0:c.msg)||(e.statusCode===401?"认证已过期，请重新登录":"无权访问")}};s.showError&&(o.index.showToast({title:d.error.message,icon:"none",duration:2e3}),setTimeout(()=>{m.Navigator.toLogin()},2e3)),u(d)}else{const d={success:!1,error:{statusCode:e.statusCode,message:((g=e.data)==null?void 0:g.msg)||"请求失败"}};s.showError&&o.index.showToast({title:d.error.message,icon:"none",duration:2e3}),u(d)}},fail:e=>{const c={success:!1,error:{message:e.errMsg||"网络请求失败"}};s.showError&&o.index.showToast({title:c.error.message,icon:"none",duration:2e3}),u(c)}})})};exports.apiRequest=w;
//# sourceMappingURL=../../../.sourcemap/mp-weixin/store/user/JWT.js.map
