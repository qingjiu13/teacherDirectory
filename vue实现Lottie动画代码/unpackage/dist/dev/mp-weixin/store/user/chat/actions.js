"use strict";const i=require("../../../common/vendor.js"),o={async initIM({commit:s,dispatch:a},{userId:e,token:t}){s("SET_CONNECTION_STATUS",{isConnected:!1,isConnecting:!0});try{await IMBox.init({appId:"your-app-id",userId:e,token:t}),IMBox.on("message",n=>{a("handleNewMessage",n)}),IMBox.on("connection-status-changed",n=>{s("SET_CONNECTION_STATUS",{isConnected:n==="connected",isConnecting:n==="connecting"})}),s("SET_CONNECTION_STATUS",{isConnected:!0,isConnecting:!1}),await a("loadSessions")}catch(n){throw s("SET_CONNECTION_ERROR",n),s("SET_CONNECTION_STATUS",{isConnected:!1,isConnecting:!1}),n}},async loadSessions({commit:s}){try{(await IMBox.getSessions()).forEach(e=>{s("ADD_OR_UPDATE_SESSION",{sessionId:e.sessionId,sessionType:e.type,targetId:e.targetId,title:e.title,avatar:e.avatar,lastMessage:e.lastMessage,unreadCount:e.unreadCount,lastMessageTime:e.lastMessageTime})})}catch(a){throw i.index.__f__("error","at store/user/chat/actions.js:61","加载会话列表失败:",a),a}},async handleNewMessage({commit:s,state:a},e){const{sessionId:t}=e;if(s("ADD_MESSAGE",{sessionId:t,message:e}),s("UPDATE_SESSION_LAST_MESSAGE",{sessionId:t,message:e}),a.currentSession.sessionId!==t||!a.currentSession.isActive){const n=a.sessions.byId[t];n&&s("ADD_OR_UPDATE_SESSION",{sessionId:t,unreadCount:(n.unreadCount||0)+1})}a.currentSession.sessionId===t&&a.currentSession.isActive&&await IMBox.markAsRead(t)},async sendMessage({commit:s,state:a},{sessionId:e,content:t,type:n="text"}){const r={id:`temp-${Date.now()}`,type:n,content:t,senderId:a.currentUser.userId,time:Math.floor(Date.now()/1e3),status:"sending",isSelf:!0};s("ADD_MESSAGE",{sessionId:e,message:r});try{const S=await IMBox.sendMessage({sessionId:e,type:n,content:t});return s("UPDATE_MESSAGE_STATUS",{sessionId:e,messageId:r.id,status:"sent"}),s("UPDATE_SESSION_LAST_MESSAGE",{sessionId:e,message:S}),S}catch(S){throw s("UPDATE_MESSAGE_STATUS",{sessionId:e,messageId:r.id,status:"failed"}),S}},async loadHistoryMessages({commit:s,state:a},{sessionId:e,lastMessageId:t}){var n;if(!((n=a.messages.bySessionId[e])!=null&&n.isLoading)){s("SET_MESSAGES_LOADING",{sessionId:e,isLoading:!0});try{const r=await IMBox.getHistoryMessages({sessionId:e,before:t,limit:20});r.length>0?s("PREPEND_MESSAGES",{sessionId:e,messages:r}):s("SET_NO_MORE_MESSAGES",{sessionId:e})}catch(r){throw i.index.__f__("error","at store/user/chat/actions.js:159","加载历史消息失败:",r),r}finally{s("SET_MESSAGES_LOADING",{sessionId:e,isLoading:!1})}}},async switchSession({commit:s,dispatch:a},e){const t=this.state.sessions.byId[e];s("SET_CURRENT_SESSION",{sessionId:e,targetId:t.targetId,sessionType:t.sessionType,isActive:!0,unreadCount:0}),s("ADD_OR_UPDATE_SESSION",{sessionId:e,unreadCount:0}),await IMBox.markAsRead(e),this.state.messages.bySessionId[e]||await a("loadHistoryMessages",{sessionId:e})}};exports.actions=o;
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/store/user/chat/actions.js.map
