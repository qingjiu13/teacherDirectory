"use strict";const o=require("../../../../common/vendor.js");class f{constructor(e){this.dom=null,this.files=new Map,this.debug=e.debug||!1,this.id=e.id,this.width=e.width,this.height=e.height,this.option=e.option,this.instantly=e.instantly,this.prohibited=e.prohibited,this.onchange=e.onchange,this.onprogress=e.onprogress,this.uploadHandle=this._uploadHandle,this.uploadHandle=this._uploadHandleWX}create(e){if(!this.dom)return this.dom}setData(){let[e,t=""]=arguments;typeof e=="object"?Object.assign(this.option,e):this._setValue(this.option,e,t),this.debug&&o.index.__f__("log","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:97",JSON.stringify(this.option))}async upload(e=""){if(!this.option.url)throw Error("未设置上传地址");if(e&&this.files.has(e))await this.uploadHandle(this.files.get(e));else for(let t of this.files.values())(t.type==="waiting"||t.type==="fail")&&await this.uploadHandle(t)}addFile(e,t){let i=e.name;if(this.debug&&o.index.__f__("log","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:135","文件名称",i,"大小",e.size),e){let l="",n=i.substring(i.lastIndexOf(".")+1).toLowerCase(),s=this.prohibited.formats.toLowerCase();if(l=e.path,s&&!s.includes(n))return this.toast(`不支持上传${n.toUpperCase()}格式文件`),!1;if(e.size>1024*1024*Math.abs(this.prohibited.size))return this.toast(`附件大小请勿超过${this.prohibited.size}M`),!1;try{if(!this.prohibited.distinct){let r=[...this.files.keys()].findIndex(a=>(a.substring(0,a.lastIndexOf("("))||a.substring(0,a.lastIndexOf(".")))==i.substring(0,i.lastIndexOf("."))&&a.substring(a.lastIndexOf(".")+1).toLowerCase()===n);r>-1&&(i=`${i.substring(0,i.lastIndexOf("."))}(${r+1}).${n}`)}}catch{}return this.files.set(i,{file:e,path:l,name:i,size:e.size,progress:0,type:"waiting"}),!0}}clear(e=""){return e?this.files.delete(e):this.files.clear(),this.onchange(this.files)}toast(e){o.index.showToast({title:e,icon:"none"})}chooseMessageFile(e,t){o.wx$1.chooseMessageFile({count:t,type:e,success:({tempFiles:i})=>{for(let l of i)this.addFile(l);this._uploadAfter()},fail:()=>{this.toast("打开失败")}})}_copyObject(e){return typeof e<"u"?JSON.parse(JSON.stringify(e)):e}_setValue(e,t,i){let l;typeof i=="object"?l=this._copyObject(i):l=i;let n=new RegExp("([\\w$]+)|\\[(:\\d)\\]","g");const s=t.match(n);for(let r=0;r<s.length-1;r++){let a=s[r];typeof e[a]!="object"&&(e[a]={}),e=e[a]}e[s[s.length-1]]=l,this.debug&&o.index.__f__("log","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:260","参数更新后",JSON.stringify(this.option))}_uploadAfter(){this.onchange(this.files),setTimeout(()=>{this.instantly&&this.upload()},1e3)}_overrideUrlLoading(){this.dom.overrideUrlLoading({mode:"reject"},e=>{let{retype:t,item:i,files:l,end:n}=this._getRequest(e.url),s=this;switch(t){case"updateOption":this.dom.evalJS(`vm.setData('${JSON.stringify(s.option)}')`);break;case"change":try{s.files=new Map([...s.files,...JSON.parse(unescape(l))])}catch{return o.index.__f__("error","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:284","出错了，请检查代码")}s.onchange(s.files);break;case"progress":try{i=JSON.parse(unescape(i))}catch{return o.index.__f__("error","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:292","出错了，请检查代码")}s._changeFilesItem(i,n);break}})}_getRequest(e){let t=new Object,i=e.indexOf("?");if(i!=-1){let n=e.substring(i+1).split("&");for(let s=0;s<n.length;s++)t[n[s].split("=")[0]]=unescape(n[s].split("=")[1])}return t}_changeFilesItem(e,t=!1){this.debug&&o.index.__f__("log","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:316","onprogress",JSON.stringify(e)),this.onprogress(e,t),this.files.set(e.name,e)}_uploadHandle(e){return e.type="loading",delete e.responseText,new Promise((t,i)=>{this.debug&&o.index.__f__("log","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:325","option",JSON.stringify(this.option));let{url:l,name:n,method:s="POST",header:r,formData:a}=this.option,p=new FormData;for(let d in a)p.append(d,a[d]);p.append(n,e.file);let u=new XMLHttpRequest;u.open(s,l,!0);for(let d in r)u.setRequestHeader(d,r[d]);u.upload.addEventListener("progress",d=>{if(d.lengthComputable){let h=Math.ceil(d.loaded*100/d.total);h<=100&&(e.progress=h,this._changeFilesItem(e))}},!1),u.ontimeout=()=>(o.index.__f__("error","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:353","请求超时"),e.type="fail",this._changeFilesItem(e,!0),t(!1)),u.onreadystatechange=d=>{if(u.readyState==4)return u.status==200?(this.debug&&o.index.__f__("log","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:362","上传完成："+u.responseText),e.responseText=u.responseText,e.type="success",this._changeFilesItem(e,!0),t(!0)):(u.status==0&&o.index.__f__("error","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:368","status = 0 :请检查请求头Content-Type与服务端是否匹配，服务端已正确开启跨域，并且nginx未拦截阻止请求"),o.index.__f__("error","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:370","--ERROR--：status = "+u.status),e.type="fail",this._changeFilesItem(e,!0),t(!1))},u.send(p)})}_uploadHandleWX(e){return e.type="loading",delete e.responseText,new Promise((t,i)=>{this.debug&&o.index.__f__("log","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:384","option",JSON.stringify(this.option));let l={filePath:e.file.path,...this.option};l.fail=({errMsg:s=""})=>(o.index.__f__("error","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:387","--ERROR--："+s),e.type="fail",this._changeFilesItem(e,!0),t(!1)),l.success=s=>s.statusCode==200?(this.debug&&o.index.__f__("log","at uni_modules/lsj-upload/components/lsj-upload/LsjFile.js:394","上传完成,微信端返回不一定是字符串，根据接口返回格式判断是否需要JSON.parse："+s.data),e.responseText=s.data,e.type="success",this._changeFilesItem(e,!0),t(!0)):(e.type="fail",this._changeFilesItem(e,!0),t(!1)),o.index.uploadFile(l).onProgressUpdate(({progress:s=0})=>{s<=100&&(e.progress=s,this._changeFilesItem(e))})})}}exports.LsjFile=f;
//# sourceMappingURL=../../../../../.sourcemap/mp-weixin/uni_modules/lsj-upload/components/lsj-upload/LsjFile.js.map
