"use strict";const t=require("../../common/vendor.js"),n=require("../../router/Router.js"),_=require("../../store/index.js"),i=require("../../common/assets.js"),u=()=>"../../components/tab-bar/tab-bar.js",d=t.defineComponent({components:{TabBar:u},data(){return{userData:new UTSJSONObject({}),isLoggedIn:_.store.getters["user/baseInfo/id"]!=="",isLoading:!1,isDebug:!0}},computed:Object.assign({},t.mapState("user/baseInfo",{storeId:(e=null)=>e.id,storeAvatar:(e=null)=>e.avatar,storeName:(e=null)=>e.name,storeGender:(e=null)=>e.gender,storeRole:(e=null)=>{var o;return((o=e.userInfo)===null||o===void 0?null:o.role)||"学生"},storeCertificate:(e=null)=>{var o;return((o=e.userInfo)===null||o===void 0?null:o.certificate)||0},storeCampusAmbassador:(e=null)=>e.campusAmbassador})),onLoad(){return t.__awaiter(this,void 0,void 0,function*(){t.index.__f__("log","at pages/mine/mine_common.vue:118","mine_common.vue onLoad开始执行");try{yield this.$nextTick(),this.initFromStore(),yield this.loadUserData(),t.index.__f__("log","at pages/mine/mine_common.vue:129","mine_common.vue onLoad执行完成，userData:",UTS.JSON.stringify(this.userData)),t.index.__f__("log","at pages/mine/mine_common.vue:130","store中的name值:",this.storeName)}catch(e){t.index.__f__("error","at pages/mine/mine_common.vue:132","onLoad错误:",e)}})},onShow(){return t.__awaiter(this,void 0,void 0,function*(){t.index.__f__("log","at pages/mine/mine_common.vue:137","mine_common.vue onShow开始执行");try{yield this.$nextTick(),t.index.__f__("log","at pages/mine/mine_common.vue:143","onShow检查store数据:",new UTSJSONObject({storeName:this.storeName,storeAvatar:this.storeAvatar})),this.initFromStore();const e=t.index.getStorageSync("userRole");e&&(yield this.updateUserRole(e)),!this.userData.name&&!this.storeName&&(t.index.__f__("log","at pages/mine/mine_common.vue:159","用户数据为空，尝试重新加载"),yield this.loadUserData()),t.index.__f__("log","at pages/mine/mine_common.vue:163","mine_common.vue onShow执行完成，userData:",UTS.JSON.stringify(this.userData))}catch(e){t.index.__f__("error","at pages/mine/mine_common.vue:165","onShow错误:",e)}})},methods:{initFromStore(){t.index.__f__("log","at pages/mine/mine_common.vue:174","initFromStore - 从store直接获取数据"),t.index.__f__("log","at pages/mine/mine_common.vue:175","store中的数据:",new UTSJSONObject({id:this.storeId,name:this.storeName,avatar:this.storeAvatar,role:this.storeRole})),this.storeName?(this.userData=new UTSJSONObject({id:this.storeId,avatar:this.storeAvatar,name:this.storeName,gender:this.storeGender}),this.isLoggedIn=!0,t.index.__f__("log","at pages/mine/mine_common.vue:191","从store初始化userData成功:",this.userData)):t.index.__f__("log","at pages/mine/mine_common.vue:193","store中没有用户数据")},updateUserRole(e=null){return t.__awaiter(this,void 0,void 0,function*(){try{t.index.__f__("log","at pages/mine/mine_common.vue:203","更新用户角色:",e),this.$store?(yield this.$store.dispatch("user/baseInfo/updateRole",e),t.index.__f__("log","at pages/mine/mine_common.vue:207","角色更新成功, 新角色:",this.storeRole)):(t.index.__f__("warn","at pages/mine/mine_common.vue:209","$store不可用，直接使用本地存储"),t.index.setStorageSync("userRole",e))}catch(o){t.index.__f__("error","at pages/mine/mine_common.vue:213","更新用户角色失败",o),t.index.setStorageSync("userRole",e)}})},loadUserData(){return t.__awaiter(this,void 0,void 0,function*(){t.index.__f__("log","at pages/mine/mine_common.vue:223","loadUserData 开始执行"),this.isLoading=!0;try{if(this.$store){t.index.__f__("log","at pages/mine/mine_common.vue:228","使用Vuex获取用户数据");const e=yield this.$store.dispatch("user/baseInfo/getUserInfo");t.index.__f__("log","at pages/mine/mine_common.vue:232","getUserInfo返回结果:",e),t.index.__f__("log","at pages/mine/mine_common.vue:235","store中的数据是否更新:",new UTSJSONObject({storeName:this.storeName})),this.initFromStore(),!this.userData.name&&e?(t.index.__f__("log","at pages/mine/mine_common.vue:244","使用API返回的结果更新userData"),this.userData=new UTSJSONObject({id:e.id||"",avatar:e.avatar||"",name:e.name||e.nickname||"",gender:e.gender||""}),this.isLoggedIn=!!this.userData.name,t.index.setStorageSync("userData",UTS.JSON.stringify(this.userData)),t.index.__f__("log","at pages/mine/mine_common.vue:255","更新userData成功:",this.userData)):this.userData.name||(t.index.__f__("log","at pages/mine/mine_common.vue:257","尝试从本地存储恢复数据"),this.recoverFromLocalStorage())}else t.index.__f__("warn","at pages/mine/mine_common.vue:261","$store不可用，从本地存储加载"),this.recoverFromLocalStorage()}catch(e){t.index.__f__("error","at pages/mine/mine_common.vue:265","加载用户数据失败",e),this.recoverFromLocalStorage()}finally{this.isLoading=!1,t.index.__f__("log","at pages/mine/mine_common.vue:269","loadUserData 执行完成, userData:",this.userData)}})},recoverFromLocalStorage(){t.index.__f__("log","at pages/mine/mine_common.vue:277","从本地存储恢复数据");const e=t.index.getStorageSync("userData");if(e)try{const o=UTS.JSON.parse(e);this.userData=new UTSJSONObject({id:o.id||"",avatar:o.avatar||"",name:o.name||"",gender:o.gender||""}),this.isLoggedIn=!!this.userData.name,t.index.__f__("log","at pages/mine/mine_common.vue:289","从userData恢复成功:",this.userData)}catch(o){t.index.__f__("error","at pages/mine/mine_common.vue:291","解析本地用户数据失败",o)}if(!this.userData.name){const o=t.index.getStorageSync("userBaseInfo");if(o)try{const s=UTS.JSON.parse(o);this.userData=new UTSJSONObject({id:s.id||"",avatar:s.avatar||"",name:s.name||"",gender:s.gender||""}),this.isLoggedIn=!!this.userData.name,t.index.__f__("log","at pages/mine/mine_common.vue:308","从userBaseInfo恢复成功:",this.userData)}catch(s){t.index.__f__("error","at pages/mine/mine_common.vue:310","解析userBaseInfo失败",s)}else t.index.__f__("log","at pages/mine/mine_common.vue:313","本地存储中没有用户数据")}},handleClick(){this.isLoggedIn?n.Navigator.toModify():n.Navigator.toWechatLogin()},navModify(){n.Navigator.toModify()},navigateTo(e=null){n.Navigator.navigateTo(e)},toOrderCommon(){n.Navigator.toOrderCommon()},toCourse(){n.Navigator.toCourse()},toQualification(){n.Navigator.toQualification()},toBill(){n.Navigator.toBill()},toSettings(){n.Navigator.toSettings()},toService(){n.Navigator.toService()},handleContactUs(){n.Navigator.toChat(1)}}});Array||t.resolveComponent("TabBar")();function l(e,o,s,c,m,a){return t.e({a:i._imports_0$1,b:e.storeCampusAmbassador&&e.storeRole==="老师"},e.storeCampusAmbassador&&e.storeRole==="老师"?{c:i._imports_1$1}:{},{d:m.userData.avatar||e.storeAvatar||"/static/image/defaultAvatar/teacher-man.png",e:t.o((...r)=>a.handleClick&&a.handleClick(...r)),f:t.t(m.userData.name||e.storeName||"登录"),g:t.o((...r)=>a.handleClick&&a.handleClick(...r)),h:i._imports_2,i:t.o((...r)=>a.navModify&&a.navModify(...r)),j:e.storeRole==="老师"},e.storeRole==="老师"?{k:i._imports_3}:{},{l:e.storeRole==="学生"},e.storeRole==="学生"?{m:i._imports_4}:{},{n:e.storeCertificate===1&&e.storeRole==="老师"},e.storeCertificate===1&&e.storeRole==="老师"?{o:i._imports_5}:{},{p:e.storeCertificate===0&&e.storeRole==="老师"},e.storeCertificate===0&&e.storeRole==="老师"?{q:i._imports_6}:{},{r:i._imports_7,s:t.o((...r)=>a.toOrderCommon&&a.toOrderCommon(...r)),t:i._imports_8,v:t.o((...r)=>a.toCourse&&a.toCourse(...r)),w:i._imports_9,x:t.o((...r)=>a.toBill&&a.toBill(...r)),y:i._imports_10,z:t.o((...r)=>a.handleContactUs&&a.handleContactUs(...r)),A:e.storeRole==="老师"},e.storeRole==="老师"?{B:i._imports_11,C:i._imports_12,D:t.o((...r)=>a.toService&&a.toService(...r))}:{},{E:e.storeRole==="老师"&&e.storeCertificate===0},e.storeRole==="老师"&&e.storeCertificate===0?{F:i._imports_13,G:i._imports_12,H:t.o((...r)=>a.toQualification&&a.toQualification(...r))}:{},{I:i._imports_14,J:i._imports_12,K:t.o((...r)=>a.toSettings&&a.toSettings(...r)),L:t.p({pageName:"mine"}),M:t.sei(t.gei(e,""),"view")})}const g=t._export_sfc(d,[["render",l]]);wx.createPage(g);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/mine/mine_common.js.map
