"use strict";const e=require("../../common/vendor.js"),r=require("../../router/Router.js"),m=require("../../store/index.js"),_=()=>"../../components/tab-bar/tab-bar.js",u=e.defineComponent({components:{TabBar:_},data(){return{userData:new UTSJSONObject({}),isLoggedIn:m.store.getters["user/baseInfo/id"]!=="",isLoading:!1,isDebug:!0}},computed:Object.assign({},e.mapState("user/baseInfo",{storeId:(a=null)=>a.id,storeAvatar:(a=null)=>a.avatar,storeName:(a=null)=>a.name,storeGender:(a=null)=>a.gender,storeRole:(a=null)=>{var t;return((t=a.userInfo)===null||t===void 0?null:t.role)||"学生"},storeCertificate:(a=null)=>a.certificate,storeCampusAmbassador:(a=null)=>a.campusAmbassador})),onLoad(){return e.__awaiter(this,void 0,void 0,function*(){e.index.__f__("log","at pages/mine/mine_common.vue:113","mine_common.vue onLoad开始执行");try{yield this.$nextTick(),this.initFromStore(),yield this.loadUserData(),e.index.__f__("log","at pages/mine/mine_common.vue:124","mine_common.vue onLoad执行完成，userData:",UTS.JSON.stringify(this.userData)),e.index.__f__("log","at pages/mine/mine_common.vue:125","store中的name值:",this.storeName)}catch(a){e.index.__f__("error","at pages/mine/mine_common.vue:127","onLoad错误:",a)}})},onShow(){return e.__awaiter(this,void 0,void 0,function*(){e.index.__f__("log","at pages/mine/mine_common.vue:132","mine_common.vue onShow开始执行");try{yield this.$nextTick(),e.index.__f__("log","at pages/mine/mine_common.vue:138","onShow检查store数据:",new UTSJSONObject({storeName:this.storeName,storeAvatar:this.storeAvatar})),this.initFromStore();const a=e.index.getStorageSync("userRole");a&&(yield this.updateUserRole(a)),!this.userData.name&&!this.storeName&&(e.index.__f__("log","at pages/mine/mine_common.vue:154","用户数据为空，尝试重新加载"),yield this.loadUserData()),e.index.__f__("log","at pages/mine/mine_common.vue:158","mine_common.vue onShow执行完成，userData:",UTS.JSON.stringify(this.userData))}catch(a){e.index.__f__("error","at pages/mine/mine_common.vue:160","onShow错误:",a)}})},methods:{initFromStore(){e.index.__f__("log","at pages/mine/mine_common.vue:169","initFromStore - 从store直接获取数据"),e.index.__f__("log","at pages/mine/mine_common.vue:170","store中的数据:",new UTSJSONObject({id:this.storeId,name:this.storeName,avatar:this.storeAvatar,role:this.storeRole})),this.storeName?(this.userData=new UTSJSONObject({id:this.storeId,avatar:this.storeAvatar,name:this.storeName,gender:this.storeGender}),this.isLoggedIn=!0,e.index.__f__("log","at pages/mine/mine_common.vue:186","从store初始化userData成功:",this.userData)):e.index.__f__("log","at pages/mine/mine_common.vue:188","store中没有用户数据")},updateUserRole(a=null){return e.__awaiter(this,void 0,void 0,function*(){try{e.index.__f__("log","at pages/mine/mine_common.vue:198","更新用户角色:",a),this.$store?(yield this.$store.dispatch("user/baseInfo/updateRole",a),e.index.__f__("log","at pages/mine/mine_common.vue:202","角色更新成功, 新角色:",this.storeRole)):(e.index.__f__("warn","at pages/mine/mine_common.vue:204","$store不可用，直接使用本地存储"),e.index.setStorageSync("userRole",a))}catch(t){e.index.__f__("error","at pages/mine/mine_common.vue:208","更新用户角色失败",t),e.index.setStorageSync("userRole",a)}})},loadUserData(){return e.__awaiter(this,void 0,void 0,function*(){e.index.__f__("log","at pages/mine/mine_common.vue:218","loadUserData 开始执行"),this.isLoading=!0;try{if(this.$store){e.index.__f__("log","at pages/mine/mine_common.vue:223","使用Vuex获取用户数据");const a=yield this.$store.dispatch("user/baseInfo/getUserInfo");e.index.__f__("log","at pages/mine/mine_common.vue:227","getUserInfo返回结果:",a),e.index.__f__("log","at pages/mine/mine_common.vue:230","store中的数据是否更新:",new UTSJSONObject({storeName:this.storeName})),this.initFromStore(),!this.userData.name&&a?(e.index.__f__("log","at pages/mine/mine_common.vue:239","使用API返回的结果更新userData"),this.userData=new UTSJSONObject({id:a.id||"",avatar:a.avatar||"",name:a.name||a.nickname||"",gender:a.gender||""}),this.isLoggedIn=!!this.userData.name,e.index.setStorageSync("userData",UTS.JSON.stringify(this.userData)),e.index.__f__("log","at pages/mine/mine_common.vue:250","更新userData成功:",this.userData)):this.userData.name||(e.index.__f__("log","at pages/mine/mine_common.vue:252","尝试从本地存储恢复数据"),this.recoverFromLocalStorage())}else e.index.__f__("warn","at pages/mine/mine_common.vue:256","$store不可用，从本地存储加载"),this.recoverFromLocalStorage()}catch(a){e.index.__f__("error","at pages/mine/mine_common.vue:260","加载用户数据失败",a),this.recoverFromLocalStorage()}finally{this.isLoading=!1,e.index.__f__("log","at pages/mine/mine_common.vue:264","loadUserData 执行完成, userData:",this.userData)}})},recoverFromLocalStorage(){e.index.__f__("log","at pages/mine/mine_common.vue:272","从本地存储恢复数据");const a=e.index.getStorageSync("userData");if(a)try{const t=UTS.JSON.parse(a);this.userData=new UTSJSONObject({id:t.id||"",avatar:t.avatar||"",name:t.name||"",gender:t.gender||""}),this.isLoggedIn=!!this.userData.name,e.index.__f__("log","at pages/mine/mine_common.vue:284","从userData恢复成功:",this.userData)}catch(t){e.index.__f__("error","at pages/mine/mine_common.vue:286","解析本地用户数据失败",t)}if(!this.userData.name){const t=e.index.getStorageSync("userBaseInfo");if(t)try{const i=UTS.JSON.parse(t);this.userData=new UTSJSONObject({id:i.id||"",avatar:i.avatar||"",name:i.name||"",gender:i.gender||""}),this.isLoggedIn=!!this.userData.name,e.index.__f__("log","at pages/mine/mine_common.vue:303","从userBaseInfo恢复成功:",this.userData)}catch(i){e.index.__f__("error","at pages/mine/mine_common.vue:305","解析userBaseInfo失败",i)}else e.index.__f__("log","at pages/mine/mine_common.vue:308","本地存储中没有用户数据")}},handleClick(){this.isLoggedIn?r.Navigator.toModify():r.Navigator.toWechatLogin()},navigateTo(a=null){r.Navigator.navigateTo(a)},toOrderCommon(){r.Navigator.toOrderCommon()},toCourse(){r.Navigator.toCourse()},toQualification(){r.Navigator.toQualification()},toWallet(){r.Navigator.toWallet()},toSettings(){r.Navigator.toSettings()},toService(){r.Navigator.toService()}}});Array||e.resolveComponent("TabBar")();function d(a,t,i,c,s,o){return e.e({a:s.userData.avatar||a.storeAvatar||"/static/image/defaultAvatar/teacher-man.png",b:e.o((...n)=>o.handleClick&&o.handleClick(...n)),c:e.t(s.userData.name||a.storeName||"登录"),d:e.o((...n)=>o.handleClick&&o.handleClick(...n)),e:a.storeRole==="老师"},a.storeRole==="老师"?e.e({f:e.t(a.storeCertificate===1?"已认证":"未认证"),g:a.storeCampusAmbassador},a.storeCampusAmbassador?{h:e.t("校园大使")}:{}):{},{i:a.storeRole==="老师"},a.storeRole==="老师"?{j:e.o((...n)=>o.toService&&o.toService(...n))}:{},{k:e.o((...n)=>o.toOrderCommon&&o.toOrderCommon(...n)),l:e.o((...n)=>o.toCourse&&o.toCourse(...n)),m:a.storeRole==="老师"},a.storeRole==="老师"?{n:e.o((...n)=>o.toQualification&&o.toQualification(...n))}:{},{o:a.storeRole==="老师"},a.storeRole==="老师"?{p:e.o((...n)=>o.toWallet&&o.toWallet(...n))}:{},{q:e.o((...n)=>o.toSettings&&o.toSettings(...n)),r:e.p({pageName:"mine"}),s:e.sei(e.gei(a,""),"view")})}const g=e._export_sfc(u,[["render",d]]);wx.createPage(g);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/mine/mine_common.js.map
