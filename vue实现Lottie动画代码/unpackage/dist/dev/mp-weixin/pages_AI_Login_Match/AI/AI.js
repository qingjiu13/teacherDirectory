"use strict";const t=require("../../common/vendor.js");require("../../store/index.js");const S=require("../../router/Router.js"),d=require("../../common/assets.js"),g=()=>"./ai-chat/HistorySidebar.js",f=()=>"./ai-chat/MessageList.js",I=()=>"./ai-chat/ModeSelector.js",_=()=>"./ai-chat/InputSection.js",C=()=>"../components/combobox/combobox.js",p=()=>"../../components/navigationTitleBar/header.js",M=()=>"../../components/loading/LoadingAnimation.js",h=new UTSJSONObject({USER:"user",AI:"AI",SYSTEM:"system"}),c=new UTSJSONObject({SENDING:"sending",SENT:"sent",ERROR:"error"}),l=new UTSJSONObject({GENERAL:"general",SCHOOL:"school",CAREER:"career"}),b=t.defineComponent({onPageScroll(){t.index.$emit("page-scroll")},components:{HistorySidebar:g,MessageList:f,ModeSelector:I,InputSection:_,ChoiceSelected:C,Header:p,LoadingAnimation:M},computed:Object.assign(Object.assign({},t.mapState("user/aiChat",new UTSJSONObject({storeHistorySummaries:(e=null)=>e.aiChat.historySummaries,storeHistoryChats:(e=null)=>e.aiChat.conversations,storeActiveConversation:(e=null)=>e.aiChat.activeConversation,storeChatMode:(e=null)=>e.aiChat.chatMode,storeUserInfo:(e=null)=>e.aiChat.userInfo,schoolSearchData:(e=null)=>e.aiChat.schoolSearch,majorSearchData:(e=null)=>e.aiChat.majorSearch}))),{currentSchool(){return this.schoolSearchData.selectedSchool||""},currentMajor(){return this.majorSearchData.selectedMajor||""},currentSchoolId(){return this.schoolSearchData.selectedSchoolId||null},currentMajorId(){return this.majorSearchData.selectedMajorId||null},schoolOptions(){return this.schoolSearchData.options.map((e=null)=>e.name)},majorOptions(){return this.majorSearchData.options.map((e=null)=>e.name)},currentModeName(){return new UTSJSONObject({[l.GENERAL]:"通用",[l.SCHOOL]:"择校",[l.CAREER]:"职业规划"})[this.currentMode]||"通用"},historySummaries(){return this.storeHistorySummaries},historyChats(){return this.storeHistoryChats||[]},activeConversation(){return this.storeActiveConversation},chatMode(){return this.storeChatMode},groupedHistorySummaries(){const e=new Date,o=[],a=[],n=[];return(this.historySummaries||[]).forEach((s=null)=>{const r=s.updatedAt||s.createdAt;if(!r)return null;const i=new Date(r),m=e.getTime()-i.getTime(),u=Math.floor(m/(24*60*60*1e3));i.getFullYear()===e.getFullYear()&&i.getMonth()===e.getMonth()&&i.getDate()===e.getDate()?o.push(s):u<7?a.push(s):u<30&&n.push(s)}),new UTSJSONObject({today:o,week:a,month:n})}}),data(){return{messages:[],isProcessing:!1,isLoading:!1,autoScrollId:"",currentMode:l.GENERAL,schoolIndex:-1,majorIndex:-1,searchTimers:new UTSJSONObject({school:null,major:null}),isAutoScrollEnabled:!0,currentController:null,contextInfo:new UTSJSONObject({}),sidebarVisible:!1,currentChatId:null}},watch:{storeActiveConversation:{handler(e=null){e&&typeof e=="object"&&e.chatId?(this.currentChatId=e.chatId,e.chatMode&&(this.currentMode=e.chatMode)):e&&(this.currentChatId=e)},immediate:!0},storeUserInfo:{handler(e=null){e&&this.setUserSelectionIndexes()},deep:!0,immediate:!0},schoolOptions:{handler(e=null){this.updateSchoolIndex(e)},immediate:!0},majorOptions:{handler(e=null){this.updateMajorIndex(e)},immediate:!0}},onLoad(){this.syncUserInfoFromVuex(),this.loadChatHistoryFromStorage()},onShow(){this.loadChatHistoryFromStorage(),this.syncUserInfoFromVuex()},onUnload(){this.abortCurrentRequest(),Object.values(this.searchTimers).forEach((e=null)=>{e&&clearTimeout(e)})},methods:{onPageClick(){this.closeAllDropdowns()},closeAllDropdowns(){["schoolDropdown","majorDropdown"].forEach(o=>{this.$refs&&this.$refs[o]&&this.$refs[o].closeDropdown&&this.$refs[o].closeDropdown()})},syncUserInfoFromVuex(){this.storeUserInfo&&this.setUserSelectionIndexes()},setUserSelectionIndexes(){if(!this.storeUserInfo)return null;this.updateSchoolIndex(this.schoolOptions),this.updateMajorIndex(this.majorOptions),this.updateContextInfo()},updateSchoolIndex(e=null){if(this.currentSchool&&e.length>0){const o=e.indexOf(this.currentSchool);this.schoolIndex=o!==-1?o:-1}else this.schoolIndex=-1},updateMajorIndex(e=null){if(this.currentMajor&&e.length>0){const o=e.indexOf(this.currentMajor);this.majorIndex=o!==-1?o:-1}else this.majorIndex=-1},handleSchoolSelect(e=null,o=null){this.schoolIndex=e;const a=this.schoolSearchData.options.find((n=null)=>n.name===o);a&&this.$store.dispatch("user/aiChat/selectAISchool",new UTSJSONObject({id:a.id,name:a.name})),this.updateContextInfo()},handleMajorSelect(e=null,o=null){this.majorIndex=e;const a=this.majorSearchData.options.find((n=null)=>n.name===o);a&&this.$store.dispatch("user/aiChat/selectAIMajor",new UTSJSONObject({id:a.id,name:a.name})),this.updateContextInfo()},handleSchoolSearch(e=null){this.searchTimers.school&&clearTimeout(this.searchTimers.school),this.searchTimers.school=setTimeout(()=>{this.performSchoolSearch(e)},500),t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:495",`学校搜索防抖设置: "${e}"`)},performSchoolSearch(e=null){return t.__awaiter(this,void 0,void 0,function*(){try{const o=yield this.$store.dispatch("user/aiChat/searchAISchools",new UTSJSONObject({keyword:e}));t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:508",`学校搜索完成: "${e}", 结果数: ${this.schoolOptions.length}`)}catch(o){t.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:510","学校搜索失败:",o),t.index.showToast({title:"学校搜索失败",icon:"none"})}})},handleMajorSearch(e=null){this.searchTimers.major&&clearTimeout(this.searchTimers.major),this.searchTimers.major=setTimeout(()=>{this.performMajorSearch(e)},500),t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:533",`专业搜索防抖设置: "${e}"`)},performMajorSearch(e=null){return t.__awaiter(this,void 0,void 0,function*(){try{const o=yield this.$store.dispatch("user/aiChat/searchAIMajors",new UTSJSONObject({keyword:e}));t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:546",`专业搜索完成: "${e}", 结果数: ${this.majorOptions.length}`)}catch(o){t.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:548","专业搜索失败:",o),t.index.showToast({title:"专业搜索失败",icon:"none"})}})},switchMode(e=null){if(this.currentMode===e)return null;this.currentMode=e,this.messages=[],this.currentChatId="chat_"+Date.now(),this.updateContextInfo(),this.$store.dispatch("user/aiChat/setCurrentChat",new UTSJSONObject({chatId:this.currentChatId,chatMode:this.currentMode})),this.closeSidebar()},updateContextInfo(){this.contextInfo=new UTSJSONObject({mode:this.currentMode,userSchoolId:this.currentSchoolId,userMajorId:this.currentMajorId})},startNewChat(){this.messages=[],this.currentChatId="chat_"+Date.now(),this.updateContextInfo(),this.$store.dispatch("user/aiChat/setCurrentChat",new UTSJSONObject({chatId:this.currentChatId,chatMode:this.currentMode})),this.closeSidebar()},handleMessage(e=null,o=null){var a;return t.__awaiter(this,void 0,void 0,function*(){if(!e||this.isProcessing)return Promise.resolve(null);let n=null;o===null?(this.messages.length,this.messages.push({role:h.USER,content:e,status:c.SENT}),n=this.messages.length,this.messages.push({role:h.AI,content:"",status:c.SENDING,streaming:!1})):(n=o,this.messages[n].content="",this.messages[n].status=c.SENDING,this.messages[n].streaming=!1),this.scrollToBottom(),this.isProcessing=!0;try{this.updateContextInfo(),this.currentChatId||(this.currentChatId="chat_"+Date.now(),this.$store.dispatch("user/aiChat/setCurrentChat",new UTSJSONObject({chatId:this.currentChatId,chatMode:this.currentMode})));const s=yield this.$store.dispatch("user/aiChat/testAIQA",new UTSJSONObject({question:e,contextInfo:this.contextInfo,chatId:this.currentChatId,chatMode:this.currentMode}));if(s.success)this.messages[n].content=s.data,this.messages[n].status=c.SENT,this.saveChatHistory();else{const r=((a=s.error)===null||a===void 0?null:a.message)||s.message||"获取回复失败，请稍后重试";this.messages[n].content=`抱歉，无法获取回复：${r}`,this.messages[n].status=c.ERROR,this.showToast(r,"none",3e3)}}catch(s){const r=s.message||"系统异常，请稍后再试";this.messages[n].content=`抱歉，发生了错误：${r}`,this.messages[n].status=c.ERROR,this.showToast(r,"none",3e3)}finally{this.isProcessing=!1,this.messages[n].streaming=!1,this.scrollToBottom()}})},sendMessage(e=null){this.handleMessage(e)},retryMessage(e=null){if(e<1||this.messages[e].role!==h.AI)return null;const o=this.messages[e-1];if(o.role!==h.USER)return null;this.handleMessage(o.content,e)},abortCurrentRequest(){this.currentController&&this.currentController.abort&&(this.currentController.abort(),this.currentController=null)},scrollToBottom(){if(!this.isAutoScrollEnabled)return null;this.messages.length>0&&(this.autoScrollId="msg-"+(this.messages.length-1))},onScroll(e=null){},showToast(e=null,o="none",a=2e3){t.index.showToast({title:e,icon:o,duration:a})},toggleLoading(e=!0){this.isLoading=e},toggleSidebar(){this.sidebarVisible=!this.sidebarVisible},closeSidebar(){this.sidebarVisible=!1},loadChatHistory(e=null){if(!e)return null;try{this.toggleLoading(!0);const a=(this.historyChats||[]).find((n=null)=>n.id===e);if(a){this.currentChatId=e,a.chatMode&&(this.currentMode=a.chatMode,this.updateContextInfo());const n=a.messages?a.messages.map((s=null)=>{let r=s.role||h.AI;return!s.role&&s.id&&(s.id.includes("msg-user")?r=h.USER:s.id.includes("msg-system")&&(r=h.SYSTEM)),new UTSJSONObject({role:r,content:s.content,status:c.SENT,streaming:!1})}):[];this.messages=n,this.closeSidebar(),this.$nextTick(()=>{this.scrollToBottom()}),this.toggleLoading(!1)}else this.$store.dispatch("user/aiChat/loadChat",e).then((n=null)=>{var s,r;if(n.success)this.currentChatId=e,n.data.chatMode&&(this.currentMode=n.data.chatMode,this.updateContextInfo()),this.messages=n.data.messages||[],this.closeSidebar(),this.$nextTick(()=>{this.scrollToBottom()});else{const i=((s=n.error)===null||s===void 0?null:s.message)||n.message||"加载对话失败";this.showToast(`加载失败: ${i}`,"none",3e3),((r=n.error)===null||r===void 0?null:r.statusCode)>=500&&this.startNewChat()}}).finally(()=>{this.toggleLoading(!1)})}catch(o){t.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:851","加载对话内容失败:",o),this.toggleLoading(!1),this.startNewChat()}},loadChatHistoryFromStorage(){const e=this.historyChats;if(e&&e.length>0){const o=e.map((a=null)=>new UTSJSONObject({id:a.id,title:a.abstract,abstract:a.abstract,chatMode:a.chatMode,createdAt:a.createdAt,updatedAt:a.updatedAt}));this.$store.commit("user/aiChat/SET_HISTORY_SUMMARIES",o)}},saveChatHistory(){if(!this.currentChatId||this.messages.length===0)return null;const e=UTS.arrayFind(this.messages,s=>s.role===h.USER),o=e?e.content.substring(0,20):"新对话",a=new UTSJSONObject({id:this.currentChatId,title:o+(o.length>=20?"...":""),abstract:o,chatMode:this.currentMode,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),messages:this.messages.map((s,r)=>new UTSJSONObject({id:`msg-${s.role===h.USER?"user":"ai"}-${this.currentChatId}-${r}`,role:s.role,content:s.content,timestamp:new Date().toISOString()}))});this.$store.commit("user/aiChat/ADD_CONVERSATION",a);const n=new UTSJSONObject({id:a.id,title:a.title,abstract:a.abstract,chatMode:a.chatMode,createdAt:a.createdAt,updatedAt:a.updatedAt});this.$store.commit("user/aiChat/ADD_HISTORY_SUMMARY",n)},deleteChatHistory(e=null){if(!e)return null;t.index.showModal(new UTSJSONObject({title:"确认删除",content:"确定要删除这条对话记录吗？",success:o=>{if(o.confirm){t.index.showLoading({title:"正在删除...",mask:!0});try{this.$store.commit("user/aiChat/REMOVE_CONVERSATION",e),this.$store.commit("user/aiChat/REMOVE_HISTORY_SUMMARY",e),t.index.hideLoading(),this.currentChatId===e&&this.startNewChat(),this.showToast("删除成功")}catch(a){t.index.hideLoading(),this.showToast("删除失败: "+(a.message||"系统错误"),"none",3e3)}}}}))},handleBack(){S.Navigator.toIndex()}}});if(!Array){const e=t.resolveComponent("loading-animation"),o=t.resolveComponent("Header"),a=t.resolveComponent("history-sidebar"),n=t.resolveComponent("mode-selector"),s=t.resolveComponent("ChoiceSelected"),r=t.resolveComponent("message-list"),i=t.resolveComponent("input-section");(e+o+a+n+s+r+i)()}const j=()=>"./ai-chat/HistorySidebar2.js",O=()=>"./ai-chat/ModeSelector2.js",T=()=>"./ai-chat/MessageList2.js";Math||(j+O+T)();function A(e,o,a,n,s,r){return t.e({a:s.isLoading},s.isLoading?{b:t.p({src:"https://lottie.host/1f64310d-d1a9-44c9-ac77-3c29ae849559/c3yfKGAzCm.json",width:"150rpx",height:"150rpx",showText:!0,text:"加载中..."})}:{},{c:s.sidebarVisible},s.sidebarVisible?{d:t.o((...i)=>r.closeSidebar&&r.closeSidebar(...i)),e:s.sidebarVisible?.5:0}:{},{f:t.o(r.handleBack),g:t.p({title:"AI助手"}),h:t.o(r.loadChatHistory),i:t.o(r.deleteChatHistory),j:t.p({visible:s.sidebarVisible,"grouped-history":r.groupedHistorySummaries,"current-chat-id":s.currentChatId}),k:d._imports_0$1,l:t.o((...i)=>r.toggleSidebar&&r.toggleSidebar(...i)),m:t.o(r.switchMode),n:t.p({"current-mode":s.currentMode,inNav:!0}),o:d._imports_1$1,p:t.o((...i)=>r.startNewChat&&r.startNewChat(...i)),q:t.sr("schoolDropdown","47a7b0ce-4"),r:t.o(r.handleSchoolSelect),s:t.o(r.handleSchoolSearch),t:t.p({componentType:"undergraduate",choiceIndex:s.schoolIndex,choiceList:r.schoolOptions,defaultText:"请选择学校",mode:"search",searchPlaceholder:"输入学校名称"}),v:t.sr("majorDropdown","47a7b0ce-5"),w:t.o(r.handleMajorSelect),x:t.o(r.handleMajorSearch),y:t.p({componentType:"undergraduate",choiceIndex:s.majorIndex,choiceList:r.majorOptions,defaultText:"请选择专业",mode:"search",searchPlaceholder:"输入专业名称"}),z:t.sr("messageList","47a7b0ce-6"),A:t.o(r.retryMessage),B:t.o(i=>s.autoScrollId=i),C:t.p({messages:s.messages,"auto-scroll-id":s.autoScrollId}),D:t.o(r.sendMessage),E:t.p({"is-processing":s.isProcessing}),F:t.o((...i)=>r.onScroll&&r.onScroll(...i)),G:t.o((...i)=>r.onPageClick&&r.onPageClick(...i))})}const x=t._export_sfc(b,[["render",A]]);wx.createPage(x);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages_AI_Login_Match/AI/AI.js.map
