"use strict";const e=require("../../common/vendor.js"),d=require("../../store/index.js"),m=require("../../本科专业.js"),S=require("../components/combobox/undergraduate.js"),_=require("../../router/Router.js"),g=require("../../common/assets.js"),C=()=>"./ai-chat/HistorySidebar.js",I=()=>"./ai-chat/MessageList.js",M=()=>"./ai-chat/ModeSelector.js",b=()=>"./ai-chat/InputSection.js",j=()=>"../components/combobox/combobox.js",A=()=>"../../components/navigationTitleBar/header.js",h=new UTSJSONObject({USER:"user",AI:"AI",SYSTEM:"system"}),c=new UTSJSONObject({SENDING:"sending",SENT:"sent",ERROR:"error"}),l=new UTSJSONObject({GENERAL:"general",SCHOOL:"school",CAREER:"career"}),O=e.defineComponent({onPageScroll(){e.index.$emit("page-scroll")},components:{HistorySidebar:C,MessageList:I,ModeSelector:M,InputSection:b,ChoiceSelected:j,Header:A},computed:Object.assign(Object.assign({},e.mapState("user/aiChat",new UTSJSONObject({storeHistorySummaries:(t=null)=>t.aiChat.historySummaries,storeHistoryChats:(t=null)=>t.aiChat.conversations,storeActiveConversation:(t=null)=>t.aiChat.activeConversation,storeChatMode:(t=null)=>t.aiChat.chatMode,storeUserInfo:(t=null)=>t.aiChat.userInfo}))),{currentSchool(){return this.schoolIndex>=0?this.schoolList[this.schoolIndex]:""},currentMajor(){return this.majorIndex>=0?this.majorList[this.majorIndex]:""},currentModeName(){return new UTSJSONObject({[l.GENERAL]:"通用",[l.SCHOOL]:"择校",[l.CAREER]:"职业规划"})[this.currentMode]||"通用"},historySummaries(){return this.storeHistorySummaries},historyChats(){return this.storeHistoryChats||[]},activeConversation(){return this.storeActiveConversation},chatMode(){return this.storeChatMode},filteredSchoolList(){return this.schoolStore?this.schoolStore.getters.filteredData(this.schoolStore.state):[]},filteredMajorList(){return this.majorStore?this.majorStore.getters.filteredData(this.majorStore.state):[]},groupedHistorySummaries(){const t=new Date,o=[],i=[],a=[];return(this.historySummaries||[]).forEach((s=null)=>{const r=s.updatedAt||s.createdAt;if(!r)return null;const n=new Date(r),f=t.getTime()-n.getTime(),u=Math.floor(f/(24*60*60*1e3));n.getFullYear()===t.getFullYear()&&n.getMonth()===t.getMonth()&&n.getDate()===t.getDate()?o.push(s):u<7?i.push(s):u<30&&a.push(s)}),new UTSJSONObject({today:o,week:i,month:a})}}),data(){return{messages:[],isProcessing:!1,isFullLoading:!1,loadingText:"正在加载...",autoScrollId:"",currentMode:l.GENERAL,schoolIndex:-1,majorIndex:-1,schoolList:[],majorList:[],schoolStore:null,majorStore:null,isAutoScrollEnabled:!0,currentController:null,contextInfo:new UTSJSONObject({}),sidebarVisible:!1,currentChatId:null}},watch:{storeActiveConversation:{handler(t=null){t&&typeof t=="object"&&t.chatId?(this.currentChatId=t.chatId,t.chatMode&&(this.currentMode=t.chatMode)):t&&(this.currentChatId=t)},immediate:!0},storeUserInfo:{handler(t=null){t&&this.setUserSelectionIndexes()},deep:!0,immediate:!0}},onLoad(){this.loadUniversityData(),this.syncUserInfoFromVuex(),this.loadChatHistoryFromStorage()},onShow(){this.loadChatHistoryFromStorage(),this.syncUserInfoFromVuex()},onUnload(){this.abortCurrentRequest()},methods:{initSchoolAndMajorSearch(){this.schoolStore=S.createDataModule(m.schoolData),this.majorStore=S.createDataModule(m.majorData),this.schoolStore.actions.initSearch(new UTSJSONObject({commit:(t=null,o=null)=>{this.schoolStore.mutations[t](this.schoolStore.state,o)}})),this.majorStore.actions.initSearch(new UTSJSONObject({commit:(t=null,o=null)=>{this.majorStore.mutations[t](this.majorStore.state,o)}})),this.schoolList=this.schoolStore.getters.filteredData(this.schoolStore.state),this.majorList=this.majorStore.getters.filteredData(this.majorStore.state)},loadUniversityData(){try{this.initSchoolAndMajorSearch(),e.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:379","加载大学数据成功")}catch(t){e.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:381","加载数据失败:",t),e.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:382","错误详情:",t.message,t.stack);const o=["北京大学","清华大学","复旦大学"];this.schoolList=o,e.index.showToast({title:"加载大学数据失败，使用默认列表",icon:"none"})}},onPageClick(){this.closeAllDropdowns()},closeAllDropdowns(){["schoolDropdown","majorDropdown"].forEach(o=>{this.$refs&&this.$refs[o]&&this.$refs[o].closeDropdown&&this.$refs[o].closeDropdown()})},syncUserInfoFromVuex(){this.storeUserInfo&&this.setUserSelectionIndexes()},setUserSelectionIndexes(){if(!this.storeUserInfo)return null;if(this.storeUserInfo.school&&this.schoolList.length>0){const t=this.schoolList.indexOf(this.storeUserInfo.school);t!==-1&&(this.schoolIndex=t)}if(this.storeUserInfo.major&&this.majorList.length>0){const t=this.majorList.indexOf(this.storeUserInfo.major);t!==-1&&(this.majorIndex=t)}this.updateContextInfo()},handleSchoolSelect(t=null,o=null){this.schoolIndex=t,d.store.commit("user/aiChat/UPDATE_USER_SCHOOL",o),this.updateContextInfo()},handleMajorSelect(t=null,o=null){this.majorIndex=t,d.store.commit("user/aiChat/UPDATE_USER_MAJOR",o),this.updateContextInfo()},handleSchoolSearch(t=null){this.schoolStore.actions.updateFilterKeyword(new UTSJSONObject({commit:(o=null,i=null)=>{this.schoolStore.mutations[o](this.schoolStore.state,i)}}),t),this.schoolList=this.schoolStore.getters.filteredData(this.schoolStore.state),e.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:496",`学校搜索: "${t}", 结果数: ${this.schoolList.length}`)},handleMajorSearch(t=null){this.majorStore.actions.updateFilterKeyword(new UTSJSONObject({commit:(o=null,i=null)=>{this.majorStore.mutations[o](this.majorStore.state,i)}}),t),this.majorList=this.majorStore.getters.filteredData(this.majorStore.state),e.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:515",`专业搜索: "${t}", 结果数: ${this.majorList.length}`)},switchMode(t=null){if(this.currentMode===t)return null;this.currentMode=t,this.messages=[],this.currentChatId="chat_"+Date.now(),this.updateContextInfo(),this.$store.dispatch("user/aiChat/setCurrentChat",new UTSJSONObject({chatId:this.currentChatId,chatMode:this.currentMode})),this.closeSidebar()},updateContextInfo(){this.contextInfo=new UTSJSONObject({mode:this.currentMode,userSchool:this.currentSchool,userMajor:this.currentMajor})},startNewChat(){this.messages=[],this.currentChatId="chat_"+Date.now(),this.updateContextInfo(),this.$store.dispatch("user/aiChat/setCurrentChat",new UTSJSONObject({chatId:this.currentChatId,chatMode:this.currentMode})),this.closeSidebar()},handleMessage(t=null,o=null){var i;return e.__awaiter(this,void 0,void 0,function*(){if(!t||this.isProcessing)return Promise.resolve(null);let a=null;o===null?(this.messages.length,this.messages.push({role:h.USER,content:t,status:c.SENT}),a=this.messages.length,this.messages.push({role:h.AI,content:"",status:c.SENDING,streaming:!1})):(a=o,this.messages[a].content="",this.messages[a].status=c.SENDING,this.messages[a].streaming=!1),this.scrollToBottom(),this.isProcessing=!0;try{this.updateContextInfo(),this.currentChatId||(this.currentChatId="chat_"+Date.now(),this.$store.dispatch("user/aiChat/setCurrentChat",new UTSJSONObject({chatId:this.currentChatId,chatMode:this.currentMode})));const s=yield this.$store.dispatch("user/aiChat/testAIQA",new UTSJSONObject({question:t,contextInfo:this.contextInfo,chatId:this.currentChatId,chatMode:this.currentMode}));if(s.success)this.messages[a].content=s.data,this.messages[a].status=c.SENT,this.saveChatHistory();else{const r=((i=s.error)===null||i===void 0?null:i.message)||s.message||"获取回复失败，请稍后重试";this.messages[a].content=`抱歉，无法获取回复：${r}`,this.messages[a].status=c.ERROR,this.showToast(r,"none",3e3)}}catch(s){const r=s.message||"系统异常，请稍后再试";this.messages[a].content=`抱歉，发生了错误：${r}`,this.messages[a].status=c.ERROR,this.showToast(r,"none",3e3)}finally{this.isProcessing=!1,this.messages[a].streaming=!1,this.scrollToBottom()}})},sendMessage(t=null){this.handleMessage(t)},retryMessage(t=null){if(t<1||this.messages[t].role!==h.AI)return null;const o=this.messages[t-1];if(o.role!==h.USER)return null;this.handleMessage(o.content,t)},abortCurrentRequest(){this.currentController&&this.currentController.abort&&(this.currentController.abort(),this.currentController=null)},scrollToBottom(){if(!this.isAutoScrollEnabled)return null;this.messages.length>0&&(this.autoScrollId="msg-"+(this.messages.length-1))},onScroll(t=null){},showToast(t=null,o="none",i=2e3){e.index.showToast({title:t,icon:o,duration:i})},toggleLoading(t="正在加载..."){t===!1?this.isFullLoading=!1:(this.loadingText=t,this.isFullLoading=!0)},toggleSidebar(){this.sidebarVisible=!this.sidebarVisible},closeSidebar(){this.sidebarVisible=!1},loadChatHistory(t=null){if(!t)return null;try{this.toggleLoading("正在加载对话内容...");const i=(this.historyChats||[]).find((a=null)=>a.id===t);if(i){this.currentChatId=t,i.chatMode&&(this.currentMode=i.chatMode,this.updateContextInfo());const a=i.messages?i.messages.map((s=null)=>{let r=s.role||h.AI;return!s.role&&s.id&&(s.id.includes("msg-user")?r=h.USER:s.id.includes("msg-system")&&(r=h.SYSTEM)),new UTSJSONObject({role:r,content:s.content,status:c.SENT,streaming:!1})}):[];this.messages=a,this.closeSidebar(),this.$nextTick(()=>{this.scrollToBottom()}),this.toggleLoading(!1)}else this.$store.dispatch("user/aiChat/loadChat",t).then((a=null)=>{var s,r;if(a.success)this.currentChatId=t,a.data.chatMode&&(this.currentMode=a.data.chatMode,this.updateContextInfo()),this.messages=a.data.messages||[],this.closeSidebar(),this.$nextTick(()=>{this.scrollToBottom()});else{const n=((s=a.error)===null||s===void 0?null:s.message)||a.message||"加载对话失败";this.showToast(`加载失败: ${n}`,"none",3e3),((r=a.error)===null||r===void 0?null:r.statusCode)>=500&&this.startNewChat()}}).finally(()=>{this.toggleLoading(!1)})}catch(o){e.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:818","加载对话内容失败:",o),this.toggleLoading(!1),this.startNewChat()}},loadChatHistoryFromStorage(){const t=this.historyChats;if(t&&t.length>0){const o=t.map((i=null)=>new UTSJSONObject({id:i.id,title:i.abstract,abstract:i.abstract,chatMode:i.chatMode,createdAt:i.createdAt,updatedAt:i.updatedAt}));this.$store.commit("user/aiChat/SET_HISTORY_SUMMARIES",o)}},saveChatHistory(){if(!this.currentChatId||this.messages.length===0)return null;const t=UTS.arrayFind(this.messages,s=>s.role===h.USER),o=t?t.content.substring(0,20):"新对话",i=new UTSJSONObject({id:this.currentChatId,title:o+(o.length>=20?"...":""),abstract:o,chatMode:this.currentMode,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),messages:this.messages.map((s,r)=>new UTSJSONObject({id:`msg-${s.role===h.USER?"user":"ai"}-${this.currentChatId}-${r}`,role:s.role,content:s.content,timestamp:new Date().toISOString()}))});this.$store.commit("user/aiChat/ADD_CONVERSATION",i);const a=new UTSJSONObject({id:i.id,title:i.title,abstract:i.abstract,chatMode:i.chatMode,createdAt:i.createdAt,updatedAt:i.updatedAt});this.$store.commit("user/aiChat/ADD_HISTORY_SUMMARY",a)},deleteChatHistory(t=null){if(!t)return null;e.index.showModal(new UTSJSONObject({title:"确认删除",content:"确定要删除这条对话记录吗？",success:o=>{if(o.confirm){e.index.showLoading({title:"正在删除...",mask:!0});try{this.$store.commit("user/aiChat/REMOVE_CONVERSATION",t),this.$store.commit("user/aiChat/REMOVE_HISTORY_SUMMARY",t),e.index.hideLoading(),this.currentChatId===t&&this.startNewChat(),this.showToast("删除成功")}catch(i){e.index.hideLoading(),this.showToast("删除失败: "+(i.message||"系统错误"),"none",3e3)}}}}))},handleBack(){_.Navigator.toIndex()}}});if(!Array){const t=e.resolveComponent("Header"),o=e.resolveComponent("history-sidebar"),i=e.resolveComponent("mode-selector"),a=e.resolveComponent("ChoiceSelected"),s=e.resolveComponent("message-list"),r=e.resolveComponent("input-section");(t+o+i+a+s+r)()}const T=()=>"./ai-chat/HistorySidebar2.js",p=()=>"./ai-chat/ModeSelector2.js",x=()=>"./ai-chat/MessageList2.js";Math||(T+p+x)();function y(t,o,i,a,s,r){return e.e({a:s.sidebarVisible},s.sidebarVisible?{b:e.o((...n)=>r.closeSidebar&&r.closeSidebar(...n)),c:s.sidebarVisible?.5:0}:{},{d:e.o(r.handleBack),e:e.p({title:"AI助手"}),f:e.o(r.loadChatHistory),g:e.o(r.deleteChatHistory),h:e.p({visible:s.sidebarVisible,"grouped-history":r.groupedHistorySummaries,"current-chat-id":s.currentChatId}),i:g._imports_0$1,j:e.o((...n)=>r.toggleSidebar&&r.toggleSidebar(...n)),k:e.o(r.switchMode),l:e.p({"current-mode":s.currentMode,inNav:!0}),m:g._imports_1$1,n:e.o((...n)=>r.startNewChat&&r.startNewChat(...n)),o:e.sr("schoolDropdown","47a7b0ce-3"),p:e.o(r.handleSchoolSelect),q:e.o(r.handleSchoolSearch),r:e.p({componentType:"undergraduate",choiceIndex:s.schoolIndex,choiceList:s.schoolList,defaultText:"请选择学校",mode:"search",searchPlaceholder:"输入学校名称"}),s:e.sr("majorDropdown","47a7b0ce-4"),t:e.o(r.handleMajorSelect),v:e.o(r.handleMajorSearch),w:e.p({componentType:"undergraduate",choiceIndex:s.majorIndex,choiceList:s.majorList,defaultText:"请选择专业",mode:"search",searchPlaceholder:"输入专业名称"}),x:e.sr("messageList","47a7b0ce-5"),y:e.o(r.retryMessage),z:e.o(n=>s.autoScrollId=n),A:e.p({messages:s.messages,"auto-scroll-id":s.autoScrollId}),B:e.o(r.sendMessage),C:e.p({"is-processing":s.isProcessing}),D:e.o((...n)=>r.onScroll&&r.onScroll(...n)),E:s.isFullLoading},s.isFullLoading?{F:e.t(s.loadingText)}:{},{G:e.sei(e.gei(t,""),"view"),H:e.o((...n)=>r.onPageClick&&r.onPageClick(...n))})}const w=e._export_sfc(O,[["render",y]]);wx.createPage(w);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages_AI_Login_Match/AI/AI.js.map
