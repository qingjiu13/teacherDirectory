"use strict";const t=require("../../common/vendor.js");require("../../store/index.js");const _=require("../../router/Router.js"),l=require("../../common/assets.js"),g=()=>"./ai-chat/HistorySidebar.js",m=()=>"./ai-chat/MessageList.js",I=()=>"./ai-chat/ModeSelector.js",S=()=>"./ai-chat/InputSection.js",M=()=>"../components/combobox/combobox.js",A=()=>"../../components/navigationTitleBar/header.js",C=()=>"../../components/loading/LoadingAnimation.js",d=new UTSJSONObject({USER:"user",AI:"AI",SYSTEM:"system"});new UTSJSONObject({SENDING:"sending",SENT:"sent",ERROR:"error"});const c=new UTSJSONObject({GENERAL:"general",SCHOOL:"school",CAREER:"career"}),f=t.defineComponent({onPageScroll(){t.index.$emit("page-scroll")},components:{HistorySidebar:g,MessageList:m,ModeSelector:I,InputSection:S,ChoiceSelected:M,Header:A,LoadingAnimation:C},computed:Object.assign(Object.assign({},t.mapState("user/aiChat",new UTSJSONObject({storeHistorySummaries:(e=null)=>e.aiChat.conversations.map((o=null)=>new UTSJSONObject({id:o.id,abstract:o.abstract,chatMode:o.chatMode,createdAt:o.createdAt,updatedAt:o.updatedAt})),storeHistoryChats:(e=null)=>e.aiChat.conversations,storeActiveConversation:(e=null)=>e.aiChat.activeConversation,storeChatMode:(e=null)=>e.aiChat.chatMode,storePagination:(e=null)=>e.aiChat.pagination}))),{currentMessages(){return this.$store.getters["user/aiChat/currentMessages"]||[]},currentSchool(){return this.$store.getters["user/schoolMajorRequest/selectedUndergraduateSchool"].name||""},currentMajor(){return this.$store.getters["user/schoolMajorRequest/selectedUndergraduateMajor"].name||""},currentSchoolId(){return this.$store.getters["user/schoolMajorRequest/selectedUndergraduateSchool"].id||null},currentMajorId(){return this.$store.getters["user/schoolMajorRequest/selectedUndergraduateMajor"].id||null},schoolOptions(){return this.$store.getters["user/schoolMajorRequest/undergraduateSchoolOptions"]},majorOptions(){return this.$store.getters["user/schoolMajorRequest/undergraduateMajorOptions"]},schoolSearchStatus(){return this.$store.getters["user/schoolMajorRequest/undergraduateSchoolSearchStatus"]},majorSearchStatus(){return this.$store.getters["user/schoolMajorRequest/undergraduateMajorSearchStatus"]},currentModeName(){return new UTSJSONObject({[c.GENERAL]:"通用",[c.SCHOOL]:"择校",[c.CAREER]:"就业"})[this.currentMode]||"通用"},historySummaries(){return this.storeHistorySummaries},historyChats(){return this.storeHistoryChats||[]},activeConversation(){return this.storeActiveConversation},chatMode(){return this.storeChatMode},pagination(){return this.storePagination},groupedHistorySummaries(){const e=new Date,o=[],n=[],i=[];return(this.historySummaries||[]).forEach((s=null)=>{const r=s.updatedAt||s.createdAt;if(!r)return null;const a=new Date(r),u=e.getTime()-a.getTime(),h=Math.floor(u/(24*60*60*1e3));a.getFullYear()===e.getFullYear()&&a.getMonth()===e.getMonth()&&a.getDate()===e.getDate()?o.push(s):h<7?n.push(s):h<30&&i.push(s)}),new UTSJSONObject({today:o,week:n,month:i})}}),data(){return{isProcessing:!1,isLoading:!1,autoScrollId:"",currentMode:c.GENERAL,schoolIndex:-1,majorIndex:-1,searchTimers:new UTSJSONObject({school:null,major:null}),isAutoScrollEnabled:!0,currentController:null,contextInfo:new UTSJSONObject({}),sidebarVisible:!1,currentChatId:null}},watch:{storeActiveConversation:{handler(e=null){e&&typeof e=="object"&&e.chatId?(this.currentChatId=e.chatId,e.chatMode&&(this.currentMode=e.chatMode)):e&&(this.currentChatId=e)},immediate:!0},schoolOptions:{handler(e=null){this.updateSchoolIndex(e)},immediate:!0},majorOptions:{handler(e=null){this.updateMajorIndex(e)},immediate:!0},currentSchool:{handler(){this.updateSchoolIndex(this.schoolOptions)},immediate:!0},currentMajor:{handler(){this.updateMajorIndex(this.majorOptions)},immediate:!0}},onLoad(){this.updateSelectionIndexes(),this.loadConversationHistoryData()},onShow(){this.updateSelectionIndexes()},onUnload(){this.abortCurrentRequest(),Object.values(this.searchTimers).forEach((e=null)=>{e&&clearTimeout(e)})},methods:Object.assign(Object.assign({},t.mapActions(new UTSJSONObject({setCurrentChat:"user/aiChat/setCurrentChat",sendQuestion:"user/aiChat/sendQuestion",loadChat:"user/aiChat/loadChat",deleteChat:"user/aiChat/deleteChat",loadConversationHistory:"user/aiChat/loadConversationHistory",searchUndergraduateSchools:"user/schoolMajorRequest/searchUndergraduateSchools",searchUndergraduateMajors:"user/schoolMajorRequest/searchUndergraduateMajors",selectUndergraduateSchool:"user/schoolMajorRequest/selectUndergraduateSchool",selectUndergraduateMajor:"user/schoolMajorRequest/selectUndergraduateMajor"}))),{onPageClick(){this.closeAllDropdowns()},closeAllDropdowns(){["schoolDropdown","majorDropdown"].forEach(o=>{this.$refs&&this.$refs[o]&&this.$refs[o].closeDropdown&&this.$refs[o].closeDropdown()})},updateSelectionIndexes(){if(this.currentSchool&&this.schoolOptions.length>0){const e=this.schoolOptions.findIndex((o=null)=>(o.name||o.schoolName)===this.currentSchool);this.schoolIndex=e!==-1?e:-1}else this.schoolIndex=-1;if(this.currentMajor&&this.majorOptions.length>0){const e=this.majorOptions.findIndex((o=null)=>(o.name||o.professionalName)===this.currentMajor);this.majorIndex=e!==-1?e:-1}else this.majorIndex=-1;this.updateContextInfo()},updateSchoolIndex(e=null){if(this.currentSchool&&e.length>0){const o=e.findIndex((n=null)=>(n.name||n.schoolName)===this.currentSchool);this.schoolIndex=o!==-1?o:-1}else this.schoolIndex=-1},updateMajorIndex(e=null){if(this.currentMajor&&e.length>0){const o=e.findIndex((n=null)=>(n.name||n.professionalName)===this.currentMajor);this.majorIndex=o!==-1?o:-1}else this.majorIndex=-1},handleSchoolSelect(e=null,o=null){this.schoolIndex=e,o&&(o.id||o.schoolId)&&this.selectUndergraduateSchool(new UTSJSONObject({id:o.id||o.schoolId,name:o.name||o.schoolName})),this.updateContextInfo()},handleMajorSelect(e=null,o=null){this.majorIndex=e,o&&(o.id||o.professionalId)&&this.selectUndergraduateMajor(new UTSJSONObject({id:o.id||o.professionalId,name:o.name||o.professionalName})),this.updateContextInfo()},handleSchoolSearch(e=null){this.searchTimers.school&&clearTimeout(this.searchTimers.school),this.searchTimers.school=setTimeout(()=>{this.performSchoolSearch(e)},500)},performSchoolSearch(e=null){return t.__awaiter(this,void 0,void 0,function*(){try{yield this.searchUndergraduateSchools(new UTSJSONObject({keyword:e}))}catch(o){t.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:553","学校搜索失败:",o),this.showToast("学校搜索失败","none")}})},handleMajorSearch(e=null){this.searchTimers.major&&clearTimeout(this.searchTimers.major),this.searchTimers.major=setTimeout(()=>{this.performMajorSearch(e)},500)},performMajorSearch(e=null){return t.__awaiter(this,void 0,void 0,function*(){try{yield this.searchUndergraduateMajors(new UTSJSONObject({keyword:e}))}catch(o){t.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:582","专业搜索失败:",o),this.showToast("专业搜索失败","none")}})},switchMode(e=null){if(this.currentMode===e)return null;this.currentMode=e,this.startNewChat()},updateContextInfo(){this.contextInfo=new UTSJSONObject({mode:this.currentMode,userSchoolId:this.currentSchoolId,userMajorId:this.currentMajorId})},startNewChat(){t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:613","=== 开始新对话 ==="),t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:614","当前模式:",this.currentMode),this.currentChatId=null,this.updateContextInfo(),this.$store.commit("user/aiChat/UPDATE_CURRENT_CONVERSATION",null),this.$store.commit("user/aiChat/CREATE_NEW_CONVERSATION",new UTSJSONObject({chatMode:this.currentMode})),t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:627","新对话已准备就绪，等待用户发送消息"),t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:628","===============")},handleProcessingStart(){this.isProcessing=!0},handleProcessingEnd(){this.isProcessing=!1,this.scrollToBottom()},handleMessageSent(e=null){t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:651","消息发送完成:",e),e.conversationId&&(this.currentChatId=e.conversationId,this.$store.commit("user/aiChat/UPDATE_CURRENT_CONVERSATION",e.conversationId))},handleStreamMessage(e=null){e.conversationId&&!this.currentChatId&&(this.currentChatId=e.conversationId,this.$store.commit("user/aiChat/UPDATE_CURRENT_CONVERSATION",e.conversationId)),this.scrollToBottom()},handleStreamComplete(e=null){t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:679","流式传输完成:",e),e.conversationId&&e.conversationId!==this.currentChatId&&(this.currentChatId=e.conversationId,this.$store.commit("user/aiChat/UPDATE_CURRENT_CONVERSATION",e.conversationId),t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:685","✅ 已更新当前对话ID为:",e.conversationId)),this.scrollToBottom()},handleStreamError(e=null){t.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:695","流式传输错误:",e),this.showToast(e.message||"发送失败","none")},retryMessage(e=null){const o=this.currentMessages;if(e<1||!o[e]||o[e].role!==d.AI)return null;const n=o[e-1];if(!n||n.role!==d.USER)return null;this.$store.commit("user/aiChat/UPDATE_MESSAGE_CONTENT",new UTSJSONObject({messageId:o[e].id,content:"",streaming:!0,status:"sending"})),this.isProcessing=!0,this.$store.dispatch("user/aiChat/sendQuestion",new UTSJSONObject({content:n.content,skipUserMessage:!0,aiMessageId:o[e].id,onMessage:(i=null)=>{this.handleStreamMessage(i)},onComplete:(i=null)=>{this.handleStreamComplete(i)},onError:(i=null)=>{this.handleStreamError(i)}})).finally(()=>{this.isProcessing=!1})},abortCurrentRequest(){this.currentController&&this.currentController.abort&&(this.currentController.abort(),this.currentController=null)},scrollToBottom(){if(!this.isAutoScrollEnabled)return null;const e=this.currentMessages;e.length>0&&(this.autoScrollId="msg-"+(e.length-1))},onScroll(e=null){},showToast(e=null,o="none",n=2e3){t.index.showToast({title:e,icon:o,duration:n})},toggleLoading(e=!0){this.isLoading=e},toggleSidebar(){this.sidebarVisible=!this.sidebarVisible},closeSidebar(){this.sidebarVisible=!1},loadConversationHistoryData(){return t.__awaiter(this,void 0,void 0,function*(){try{const e=yield this.loadConversationHistory();e.success?t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:809","对话历史加载成功"):t.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:811","对话历史加载失败:",e.message)}catch(e){t.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:814","加载对话历史异常:",e)}})},handleLoadChat(e=null){return t.__awaiter(this,void 0,void 0,function*(){if(!e.success)return this.showToast(e.message||"加载聊天失败","none"),Promise.resolve(null);try{t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:829","=== 加载旧对话 ==="),t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:830","加载的chatId:",e.chatId),this.toggleLoading(!0),this.currentChatId=e.chatId,this.$store.commit("user/aiChat/UPDATE_CURRENT_CONVERSATION",e.chatId),t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:838","对话ID已设置为:",e.chatId),e.data&&e.data.chatMode&&(this.currentMode=e.data.chatMode,this.updateContextInfo()),this.closeSidebar(),this.$nextTick(()=>{this.scrollToBottom()}),t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:855","旧对话加载完成"),t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:856","当前活跃对话ID:",this.$store.state.user.aiChat.activeConversation),t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:857","当前消息数量:",this.currentMessages.length),t.index.__f__("log","at pages_AI_Login_Match/AI/AI.vue:858","===============")}catch(o){t.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:861","处理加载聊天失败:",o),this.showToast("加载聊天失败","none")}finally{this.toggleLoading(!1)}})},handleDeleteChat(e=null){e.success?this.currentChatId===e.chatId&&this.startNewChat():this.showToast(e.message||"删除失败","none")},handleLoadMore(e=null){e.success||this.showToast(e.message||"加载更多失败","none")},handleRefresh(e=null){e.success||this.showToast(e.message||"刷新失败","none")},handleBack(){_.Navigator.toIndex()},handleSchoolLoadMore(){return t.__awaiter(this,void 0,void 0,function*(){try{const e=this.$store.state.user.schoolMajorRequest.undergraduateSchoolSearch.searchKeyword||"";yield this.searchUndergraduateSchools(new UTSJSONObject({keyword:e,loadMore:!0}))}catch(e){t.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:921","加载更多学校失败:",e),this.showToast("加载更多学校失败","none")}})},handleMajorLoadMore(){return t.__awaiter(this,void 0,void 0,function*(){try{const e=this.$store.state.user.schoolMajorRequest.undergraduateMajorSearch.searchKeyword||"";yield this.searchUndergraduateMajors(new UTSJSONObject({keyword:e,loadMore:!0}))}catch(e){t.index.__f__("error","at pages_AI_Login_Match/AI/AI.vue:937","加载更多专业失败:",e),this.showToast("加载更多专业失败","none")}})}})});if(!Array){const e=t.resolveComponent("loading-animation"),o=t.resolveComponent("Header"),n=t.resolveComponent("history-sidebar"),i=t.resolveComponent("mode-selector"),s=t.resolveComponent("ChoiceSelected"),r=t.resolveComponent("message-list"),a=t.resolveComponent("input-section");(e+o+n+i+s+r+a)()}const j=()=>"./ai-chat/HistorySidebar2.js",p=()=>"./ai-chat/ModeSelector2.js",T=()=>"./ai-chat/MessageList2.js";Math||(j+p+T)();function O(e,o,n,i,s,r){return t.e({a:s.isLoading},s.isLoading?{b:t.p({src:"https://lottie.host/1f64310d-d1a9-44c9-ac77-3c29ae849559/c3yfKGAzCm.json",width:"150rpx",height:"150rpx",showText:!0,text:"加载中..."})}:{},{c:s.sidebarVisible},s.sidebarVisible?{d:t.o((...a)=>r.closeSidebar&&r.closeSidebar(...a)),e:s.sidebarVisible?.5:0}:{},{f:t.o(r.handleBack),g:t.p({title:"AI助手"}),h:t.o(r.handleLoadChat),i:t.o(r.handleDeleteChat),j:t.o(r.handleLoadMore),k:t.o(r.handleRefresh),l:t.p({visible:s.sidebarVisible,"grouped-history":r.groupedHistorySummaries,"current-chat-id":s.currentChatId,pagination:r.pagination}),m:l._imports_0$1,n:t.o((...a)=>r.toggleSidebar&&r.toggleSidebar(...a)),o:t.o(r.switchMode),p:t.p({"current-mode":s.currentMode,inNav:!0}),q:l._imports_1$1,r:t.o((...a)=>r.startNewChat&&r.startNewChat(...a)),s:t.sr("schoolDropdown","47a7b0ce-4"),t:t.o(r.handleSchoolSelect),v:t.o(r.handleSchoolSearch),w:t.o(r.handleSchoolLoadMore),x:t.p({componentType:"undergraduate",choiceIndex:s.schoolIndex,choiceList:r.schoolOptions,defaultText:"请选择学校",mode:"search",searchPlaceholder:"输入学校名称",isLoadingMore:r.schoolSearchStatus.isLoading,hasMoreData:r.schoolSearchStatus.hasMore}),y:t.sr("majorDropdown","47a7b0ce-5"),z:t.o(r.handleMajorSelect),A:t.o(r.handleMajorSearch),B:t.o(r.handleMajorLoadMore),C:t.p({componentType:"undergraduate",choiceIndex:s.majorIndex,choiceList:r.majorOptions,defaultText:"请选择专业",mode:"search",searchPlaceholder:"输入专业名称",isLoadingMore:r.majorSearchStatus.isLoading,hasMoreData:r.majorSearchStatus.hasMore}),D:t.sr("messageList","47a7b0ce-6"),E:t.o(r.retryMessage),F:t.o(a=>s.autoScrollId=a),G:t.p({messages:r.currentMessages,"auto-scroll-id":s.autoScrollId}),H:t.o(r.handleProcessingStart),I:t.o(r.handleProcessingEnd),J:t.o(r.handleMessageSent),K:t.o(r.handleStreamMessage),L:t.o(r.handleStreamComplete),M:t.o(r.handleStreamError),N:t.p({"is-processing":s.isProcessing}),O:t.o((...a)=>r.onScroll&&r.onScroll(...a)),P:t.o((...a)=>r.onPageClick&&r.onPageClick(...a))})}const v=t._export_sfc(f,[["render",O]]);wx.createPage(v);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages_AI_Login_Match/AI/AI.js.map
