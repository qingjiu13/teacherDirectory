"use strict";const e=require("../../common/vendor.js"),r=require("../../router/Router.js"),s=require("../../common/assets.js"),h=e.defineComponent({data(){return{hasLogin:!1,userInfo:new UTSJSONObject({nickName:"",avatarUrl:""}),showAgreementModal:!1,showPrivacyModal:!1,showAuthPopup:!1,authStep:"avatar",tempUserInfo:new UTSJSONObject({nickName:"",avatarUrl:"",phoneNumber:""}),wxLoginCode:""}},computed:Object.assign(Object.assign({},e.mapState("user/baseInfo",["isRegistered","id","avatar","name","phoneNumber"])),{authPopupTitle(){return new UTSJSONObject({avatar:"选择头像",nickname:"设置昵称",phone:"绑定手机号"})[this.authStep]||"微信授权"}}),onLoad(){this.checkLoginStatus()},methods:Object.assign(Object.assign(Object.assign({},e.mapMutations("user/baseInfo",["SET_USER_INFO"])),e.mapActions("user/baseInfo",["updateUserInfo"])),{checkLoginStatus(){e.index.getStorageSync("token")&&this.isRegistered&&(this.hasLogin=!0,this.userInfo={nickName:this.name,avatarUrl:this.avatar})},onWxLogin(){e.index.showLoading({title:"登录中..."}),e.index.login(new UTSJSONObject({provider:"weixin",success:o=>{e.index.hideLoading(),o.code?(this.wxLoginCode=o.code,this.showAuthPopup=!0,this.authStep="avatar"):e.index.showToast({title:"微信登录失败，请重试",icon:"none"})},fail:o=>{e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:230","微信登录失败",o),e.index.hideLoading(),e.index.showToast({title:"登录失败，请重试",icon:"none"})}}))},onChooseAvatar(o=null){o.detail&&o.detail.avatarUrl&&(this.tempUserInfo.avatarUrl=o.detail.avatarUrl,this.userInfo.avatarUrl=o.detail.avatarUrl,this.goToNicknameStep())},onInputNickname(o=null){this.tempUserInfo.nickName=o.detail.value,this.userInfo.nickName=o.detail.value},goToNicknameStep(){this.authStep="nickname"},goToPhoneStep(){this.authStep="phone"},getPhoneNumber(o=null){o.detail.errMsg==="getPhoneNumber:ok"?this.submitUserInfo(new UTSJSONObject({code:this.wxLoginCode,encryptedData:o.detail.encryptedData,iv:o.detail.iv,avatarUrl:this.tempUserInfo.avatarUrl,nickName:this.tempUserInfo.nickName})):e.index.showToast({title:"未授权手机号，请重试",icon:"none"})},skipPhoneAuth(){this.submitUserInfo(new UTSJSONObject({code:this.wxLoginCode,avatarUrl:this.tempUserInfo.avatarUrl,nickName:this.tempUserInfo.nickName}))},submitUserInfo(o=null){return e.__awaiter(this,void 0,void 0,function*(){e.index.showLoading({title:"提交中..."});try{const i=yield e.index.request({method:"POST",url:"http://localhost:8080/users/auth/wechat/profile",data:o});i.statusCode===200&&i.data?(e.index.setStorageSync("token",i.data.token),i.data.userId&&(e.index.setStorageSync("userId",i.data.userId),this.SET_USER_INFO(new UTSJSONObject({id:i.data.userId,isRegistered:1,name:this.tempUserInfo.nickName,avatar:this.tempUserInfo.avatarUrl,phoneNumber:i.data.phoneNumber||""})),this.userInfo={nickName:this.tempUserInfo.nickName,avatarUrl:this.tempUserInfo.avatarUrl}),e.index.hideLoading(),e.index.showToast({title:"登录成功",icon:"success",duration:1500}),this.hasLogin=!0,this.showAuthPopup=!1,setTimeout(()=>{r.Navigator.redirectTo(r.IndexRoutes.INDEX)},1500)):(e.index.hideLoading(),e.index.showToast({title:"登录失败，请重试",icon:"none"}))}catch(i){e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:378","提交用户信息失败",i),e.index.hideLoading(),e.index.showToast({title:"登录失败，请重试",icon:"none"})}})},cancelAuth(){this.showAuthPopup=!1,this.wxLoginCode="",this.tempUserInfo={nickName:"",avatarUrl:"",phoneNumber:""}},goBack(){r.Navigator.toIndex()},showAgreement(){this.showAgreementModal=!0},showPrivacy(){this.showPrivacyModal=!0},closeModal(o=null){o==="agreement"?this.showAgreementModal=!1:o==="privacy"&&(this.showPrivacyModal=!1)}})});function c(o,i,l,m,n,t){return e.e({a:s._imports_0$3,b:e.o((...a)=>t.goBack&&t.goBack(...a)),c:s._imports_1$3,d:s._imports_2,e:n.userInfo.avatarUrl||"/static/image/defaultAvatar/teacher-man.png",f:n.userInfo.nickName},n.userInfo.nickName?{g:e.t(n.userInfo.nickName)}:{},{h:!n.hasLogin},n.hasLogin?{k:e.o((...a)=>o.toHome&&o.toHome(...a))}:{i:s._imports_3,j:e.o((...a)=>t.onWxLogin&&t.onWxLogin(...a))},{l:e.o((...a)=>t.showAgreement&&t.showAgreement(...a)),m:e.o((...a)=>t.showPrivacy&&t.showPrivacy(...a)),n:n.showAgreementModal},n.showAgreementModal?{o:e.o(a=>t.closeModal("agreement")),p:e.o(()=>{}),q:e.o(a=>t.closeModal("agreement"))}:{},{r:n.showPrivacyModal},n.showPrivacyModal?{s:e.o(a=>t.closeModal("privacy")),t:e.o(()=>{}),v:e.o(a=>t.closeModal("privacy"))}:{},{w:e.o((...a)=>t.cancelAuth&&t.cancelAuth(...a)),x:e.t(t.authPopupTitle),y:e.o((...a)=>t.cancelAuth&&t.cancelAuth(...a)),z:n.authStep==="avatar"},n.authStep==="avatar"?{A:e.o((...a)=>t.onChooseAvatar&&t.onChooseAvatar(...a)),B:e.o((...a)=>t.goToNicknameStep&&t.goToNicknameStep(...a))}:{},{C:n.authStep==="nickname"},n.authStep==="nickname"?{D:n.tempUserInfo.nickName,E:e.o((...a)=>t.onInputNickname&&t.onInputNickname(...a)),F:e.o((...a)=>t.goToPhoneStep&&t.goToPhoneStep(...a)),G:!n.tempUserInfo.nickName}:{},{H:n.authStep==="phone"},n.authStep==="phone"?{I:e.o((...a)=>t.getPhoneNumber&&t.getPhoneNumber(...a)),J:e.o((...a)=>t.skipPhoneAuth&&t.skipPhoneAuth(...a))}:{},{K:n.showAuthPopup?1:""})}const u=e._export_sfc(h,[["render",c],["__scopeId","data-v-921e8418"]]);wx.createPage(u);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages_AI_Login_Match/login/wechat_login.js.map
