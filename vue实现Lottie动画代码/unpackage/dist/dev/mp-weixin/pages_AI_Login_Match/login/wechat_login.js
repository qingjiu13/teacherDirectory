"use strict";const e=require("../../common/vendor.js"),d=require("../../router/Router.js"),g=require("./randomNickName.js"),u=require("../../store/global.js"),_=require("../../store/user/JWT.js"),c=require("../../common/assets.js"),l=()=>u.useGlobalStore().apiBaseUrl,m=e.defineComponent({data(){return{openid:"",loginstate:"",showPhoneModal:!1,showAgreementModal:!1,showPrivacyModal:!1,showAvatarModal:!1,showNicknameModal:!1,currentNickname:"",editingNickname:"",currentAvatar:"",nicknameWidth:0,avatarList:[],maskedPhoneNumber:""}},onLoad(){this.initializeUserInfo(),this.checkLoginState(),this.loadDefaultAvatarList()},mounted(){this.$nextTick(()=>{this.calculateNicknameWidth()})},watch:{currentNickname(){this.$nextTick(()=>{this.calculateNicknameWidth()})}},methods:{initializeUserInfo(){e.index.getStorage({key:"currentNickname",success:t=>{this.currentNickname=t.data},fail:()=>{this.currentNickname=g.generateRandomNickName(),e.index.setStorage({key:"currentNickname",data:this.currentNickname})}}),e.index.getStorage({key:"currentAvatar",success:t=>{this.currentAvatar=t.data},fail:()=>{}})},loadDefaultAvatarList(){var t;return e.__awaiter(this,void 0,void 0,function*(){try{const a=yield _.apiRequest(`${l()}/common/defaultAvatarList`,"GET",new UTSJSONObject({}),new UTSJSONObject({requireAuth:!1}));e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:257","获取默认头像列表:",a),this.avatarList=a.data.data,!this.currentAvatar&&this.avatarList.length>0&&(this.currentAvatar=this.avatarList[0],e.index.setStorage({key:"currentAvatar",data:this.currentAvatar}))}catch(a){e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:269","获取默认头像列表失败:",a),!this.currentAvatar&&((t=this.avatarList)===null||t===void 0?null:t.length)>0&&(this.currentAvatar=this.avatarList[0],e.index.setStorage({key:"currentAvatar",data:this.currentAvatar}))}})},checkLoginState(){e.index.getStorage({key:"loginstate",success:t=>{this.loginstate=t.data},fail:()=>{e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:294","未登录")}})},calculateNicknameWidth(){e.index.createSelectorQuery().in(this).select(".nickname").boundingClientRect((a=null)=>{a&&(this.nicknameWidth=a.width)}).exec()},hidePhoneModal(){this.showPhoneModal=!1},getPhoneNumber(t=null){return e.__awaiter(this,void 0,void 0,function*(){if(e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:326","微信手机号授权回调:",t),t.detail.errMsg!=="getPhoneNumber:ok")return e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:330","用户拒绝授权或授权失败:",t.detail.errMsg),this.handleAuthorizationFailed(t.detail.errMsg),Promise.resolve(null);if(!t.detail.code)return e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:337","未获取到授权code"),e.index.showToast({title:"获取授权信息失败",icon:"none"}),Promise.resolve(null);yield this.performLogin(t.detail.code)})},handleAuthorizationFailed(t=null){let a="授权失败",o="登录需要您的授权，请重新点击按钮进行授权。";t.includes("deny")||t.includes("cancel")?(a="授权被取消",o="您取消了手机号授权，无法完成登录。请重新点击按钮进行授权。"):t.includes("fail")&&(a="授权失败",o="授权过程中出现问题，请检查网络连接后重试。"),e.index.showModal(new UTSJSONObject({title:a,content:o,confirmText:"知道了",showCancel:!1,success:s=>{s.confirm&&e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:373","用户确认授权失败提示")}}))},performLogin(t=null){return e.__awaiter(this,void 0,void 0,function*(){try{e.index.showLoading({title:"登录中...",mask:!0});const a=yield this.getWechatLoginCode();e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:393","获取到微信登录code:",a);const o=new UTSJSONObject({phoneCode:t,wechatCode:a,avatar:this.currentAvatar,nickname:this.currentNickname});e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:403","发送登录请求数据:",o);const s=yield this.sendLoginRequest(o);yield this.handleLoginResponse(s)}catch(a){this.handleLoginError(a)}})},sendLoginRequest(t=null){return e.__awaiter(this,void 0,void 0,function*(){const a=yield _.apiRequest(`${l()}/auth/wechat/phoneLogin`,"POST",t,new UTSJSONObject({requireAuth:!1,showError:!1,timeout:1e4}));return e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:429","登录响应:",a),a})},handleLoginResponse(t=null){return e.__awaiter(this,void 0,void 0,function*(){if(t.success&&t.data&&t.data.token)yield this.handleLoginSuccess(t.data);else{const a=t.message||t.msg||"登录失败，请重试";throw new Error(a)}})},handleLoginSuccess(t=null){return e.__awaiter(this,void 0,void 0,function*(){try{this.$store.commit("user/baseInfo/SET_JWT_TOKEN",t.token),t.userInfo&&this.$store.commit("user/baseInfo/SET_USER_INFO",t.userInfo),this.$store.commit("user/baseInfo/SET_LOGIN_STATUS",1),this.loginstate=1,yield this.saveLoginStateToStorage(),e.index.hideLoading(),e.index.showToast({title:"登录成功",icon:"success",duration:1500}),e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:479","登录成功，JWT token已存储:",t.token),setTimeout(()=>{this.toHome()},1500)}catch(a){throw e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:487","处理登录成功数据时出错:",a),new Error("登录成功但数据处理失败")}})},saveLoginStateToStorage(){return e.__awaiter(this,void 0,void 0,function*(){return new Promise((t,a)=>{e.index.setStorage({key:"loginstate",data:1,success:()=>{e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:501","登录状态已保存到本地存储"),t()},fail:o=>{e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:505","保存登录状态失败:",o),a(o)}})})})},handleLoginError(t=null){e.index.hideLoading(),e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:518","登录过程中发生错误:",t);let a="登录失败，请重试";t.message&&(t.message.includes("网络")?a="网络连接失败，请检查网络后重试":t.message.includes("超时")?a="登录超时，请重试":t.message.includes("服务器")?a="服务器繁忙，请稍后重试":a=t.message),e.index.showModal(new UTSJSONObject({title:"登录失败",content:a,confirmText:"重试",cancelText:"取消",success:o=>{o.confirm&&e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:542","用户选择重试登录")}}))},getWechatLoginCode(){return new Promise((t,a)=>{e.index.login(new UTSJSONObject({provider:"weixin",success:o=>{o.code?t(o.code):a(new Error("获取微信登录code失败"))},fail:o=>{e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:565","uni.login失败:",o),a(new Error("获取微信登录code失败"))}}))})},useOtherPhone(){e.index.showToast({title:"暂不支持其它号码",icon:"none"})},changeAvatar(){this.showAvatarModal=!0},hideAvatarModal(){this.showAvatarModal=!1},selectAvatar(t=null){this.currentAvatar=t,e.index.setStorage({key:"currentAvatar",data:t}),this.hideAvatarModal(),e.index.showToast({title:"头像已更换",icon:"success"})},editNickname(){this.editingNickname=this.currentNickname,this.showNicknameModal=!0},hideNicknameModal(){this.showNicknameModal=!1,this.editingNickname=""},confirmNickname(){if(!this.editingNickname.trim())return e.index.showToast({title:"昵称不能为空",icon:"none"}),null;this.currentNickname=this.editingNickname.trim(),e.index.setStorage({key:"currentNickname",data:this.currentNickname}),this.hideNicknameModal(),e.index.showToast({title:"昵称已修改",icon:"success"})},toHome(){d.Navigator.toIndex()},goBack(){d.Navigator.toIndex()},showAgreement(){this.showAgreementModal=!0},showPrivacy(){this.showPrivacyModal=!0},closeModal(t=null){t==="agreement"?this.showAgreementModal=!1:t==="privacy"&&(this.showPrivacyModal=!1)},uploadAvatarFile(t=null){return new Promise((a,o)=>{e.index.uploadFile({url:`${l()}/common/uploadAvatarFile`,filePath:t,name:"avatar",header:new UTSJSONObject({"content-type":"multipart/form-data"}),formData:new UTSJSONObject({type:"avatar",timestamp:Date.now()}),success:s=>{try{const r=UTS.JSON.parse(s.data);r.code===200?a({url:r.data.url,fileName:r.data.fileName,newFileName:r.data.newFileName,originalFilename:r.data.originalFilename,message:r.msg||"上传成功"}):o(new Error(r.msg||"上传头像失败"))}catch{o(new Error("服务器响应格式错误"))}},fail:s=>{o(new Error("上传头像网络请求失败"))}})})},selectCustomAvatar(){e.index.chooseImage(new UTSJSONObject({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:t=>e.__awaiter(this,void 0,void 0,function*(){const a=t.tempFilePaths[0];e.index.showLoading({title:"上传头像中..."});try{const o=yield this.uploadAvatarFile(a);this.currentAvatar=o.url,e.index.setStorage({key:"currentAvatar",data:o.url}),e.index.hideLoading(),this.hideAvatarModal(),e.index.showToast({title:"头像已更换",icon:"success"})}catch(o){e.index.hideLoading(),e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:773","上传头像失败:",o),e.index.showToast({title:o.message||"上传头像失败",icon:"none"})}}),fail:t=>{e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:781","选择图片失败:",t),e.index.showToast({title:"选择图片失败",icon:"none"})}}))}}});if(!Array){const t=e.resolveComponent("path"),a=e.resolveComponent("svg");(t+a)()}function v(t,a,o,s,r,n){return e.e({a:c._imports_0$2,b:c._imports_1$2,c:c._imports_0$3,d:e.o((...i)=>n.goBack&&n.goBack(...i)),e:r.currentAvatar,f:e.o((...i)=>n.changeAvatar&&n.changeAvatar(...i)),g:e.t(r.currentNickname),h:r.nicknameWidth+"px",i:c._imports_3$1,j:e.o((...i)=>n.editNickname&&n.editNickname(...i)),k:!r.loginstate},r.loginstate?{m:e.o((...i)=>n.toHome&&n.toHome(...i))}:{l:e.o((...i)=>n.getPhoneNumber&&n.getPhoneNumber(...i))},{n:e.o((...i)=>n.showAgreement&&n.showAgreement(...i)),o:e.o((...i)=>n.showPrivacy&&n.showPrivacy(...i)),p:r.showAgreementModal},r.showAgreementModal?{q:e.o(i=>n.closeModal("agreement")),r:e.o(()=>{}),s:e.o(i=>n.closeModal("agreement"))}:{},{t:r.showPrivacyModal},r.showPrivacyModal?{v:e.o(i=>n.closeModal("privacy")),w:e.o(()=>{}),x:e.o(i=>n.closeModal("privacy"))}:{},{y:r.showAvatarModal},r.showAvatarModal?{z:e.f(r.avatarList,(i,h,f)=>({a:i,b:h,c:e.o(A=>n.selectAvatar(i),h)})),A:e.p({d:"M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.11 3.89 23 5 23H19C20.11 23 21 22.11 21 21V9H21ZM15 3L19 7H15V3ZM5 5H13V9H19V21H5V5ZM12 10L10.5 12.5L9 11L6 15H18L15 11L12 10Z",fill:"#999"}),B:e.p({width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"}),C:e.o((...i)=>n.selectCustomAvatar&&n.selectCustomAvatar(...i)),D:e.o((...i)=>n.hideAvatarModal&&n.hideAvatarModal(...i)),E:e.o(()=>{}),F:e.o((...i)=>n.hideAvatarModal&&n.hideAvatarModal(...i))}:{},{G:r.showNicknameModal},r.showNicknameModal?{H:r.editingNickname,I:e.o(i=>r.editingNickname=i.detail.value),J:e.o((...i)=>n.hideNicknameModal&&n.hideNicknameModal(...i)),K:e.o((...i)=>n.confirmNickname&&n.confirmNickname(...i)),L:e.o(()=>{}),M:e.o((...i)=>n.hideNicknameModal&&n.hideNicknameModal(...i))}:{})}const w=e._export_sfc(m,[["render",v]]);wx.createPage(w);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages_AI_Login_Match/login/wechat_login.js.map
