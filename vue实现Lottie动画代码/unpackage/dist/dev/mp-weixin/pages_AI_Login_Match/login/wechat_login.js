"use strict";const e=require("../../common/vendor.js"),l=require("../../router/Router.js"),c=require("../../common/assets.js"),r=e.defineComponent({data(){return{openid:"",userEntity:null,terminal:"",osVersion:"",phoneNumber:"",userInfo:null,loginstate:"",showModal:!1,showAgreementModal:!1,showPrivacyModal:!1}},onLoad(){e.index.getStorage({key:"openid",success:o=>{this.openid=o.data},fail:()=>{this.getcode()}}),e.index.getStorage({key:"userEntity",success:o=>{this.userEntity=o.data},fail:()=>{e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:161","fail1")}}),e.index.getStorage({key:"loginstate",success:o=>{this.loginstate=o.data},fail:()=>{e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:172","fail2")}}),e.index.getStorage({key:"userinfo",success:o=>{this.userInfo=o.data}})},methods:{onGotUserInfo(o=null){e.index.showModal(new UTSJSONObject({title:"授权提示",content:"应用需要获取您的昵称、头像、地区及性别等信息",success:n=>{n.confirm?this.getUserProfileInfo():n.cancel&&e.index.showToast({title:"您取消了授权",icon:"none"})}}))},getUserProfileInfo(){e.index.showLoading({title:"加载中..."}),e.index.getUserProfile(new UTSJSONObject({desc:"用于完善会员资料",lang:"zh_CN",success:(o=null)=>{if(e.index.hideLoading(),o.userInfo){const n=o.userInfo;e.index.setStorage({key:"userinfo",data:n}),this.userInfo=n,e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:237","获取用户信息成功",n),e.index.showToast({title:"授权成功",icon:"success",duration:1500}),setTimeout(()=>{this.showDialogBtn()},1500)}},fail:(o=null)=>{e.index.hideLoading(),e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:254","获取用户信息失败",o),e.index.showToast({title:"获取信息失败",icon:"none"})}}))},getcode(){e.index.login(new UTSJSONObject({provider:"weixin",success:o=>{o.code&&e.index.request({url:"登录接口",method:"POST",data:new UTSJSONObject({account:"1514382701",jscode:o.code}),header:new UTSJSONObject({"content-type":"application/json"}),success:n=>{n.data.r=="T"&&(e.index.setStorage({key:"openid",data:n.data.openid}),e.index.setStorage({key:"sessionkey",data:n.data.sessionkey}),this.openid=n.data.openid)}})}}))},showDialogBtn(){this.showModal=!0},hideModal(){this.showModal=!1},onshow(o=null,n=null,i=null){e.index.getSystemInfo(new UTSJSONObject({success:d=>{this.terminal=d.model,this.osVersion=d.system}})),e.index.request({url:"登录接口",method:"POST",header:new UTSJSONObject({"content-type":"application/json"}),data:new UTSJSONObject({username:i,parentuser:"xudeihai",wximg:n.avatarUrl,nickname:n.nickName,identity:"",terminal:this.terminal,osVersion:this.osVersion,logintype:"10",openid:this.openid}),success:d=>{d.data.r=="T"&&(this.userEntity=d.data.d,e.index.setStorage({key:"userEntity",data:d.data.d}),this.loginstate="1",e.index.setStorage({key:"loginstate",data:"1"}),e.index.setStorage({key:"userinfo",data:n}),e.index.showToast({title:"登录成功",icon:"success",duration:1500}),setTimeout(()=>{this.toHome()},1500))},fail(d){e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:378",d),e.index.showToast({title:"登录失败",icon:"none"})}})},getPhoneNumber(o=null){if(this.hideModal(),o.detail.errMsg!=="getPhoneNumber:ok")return e.index.showToast({title:"未授权手机号",icon:"none"}),null;e.index.showLoading({title:"处理中..."}),e.index.checkSession(new UTSJSONObject({success:()=>{this.requestPhoneNumber(o)},fail:()=>{e.index.login(new UTSJSONObject({provider:"weixin",success:n=>{e.index.request({url:"自己的登录接口",data:new UTSJSONObject({account:"1514382701",jscode:n.code}),method:"POST",header:new UTSJSONObject({"content-type":"application/json"}),success:i=>{i.data.r=="T"?(e.index.setStorage({key:"openid",data:i.data.openid}),e.index.setStorage({key:"sessionkey",data:i.data.sessionkey}),this.decryptPhoneNumber(o,i.data.sessionkey)):(e.index.hideLoading(),e.index.showToast({title:"登录失败",icon:"none"}))},fail:()=>{e.index.hideLoading(),e.index.showToast({title:"网络请求失败",icon:"none"})}})},fail:()=>{e.index.hideLoading(),e.index.showToast({title:"登录失败",icon:"none"})}}))}}))},requestPhoneNumber(o=null){e.index.login(new UTSJSONObject({provider:"weixin",success:n=>{e.index.request({url:"自己的登录接口",data:new UTSJSONObject({account:"1514382701",jscode:n.code}),method:"POST",header:new UTSJSONObject({"content-type":"application/json"}),success:i=>{i.data.r=="T"?(e.index.setStorage({key:"openid",data:i.data.openid}),e.index.setStorage({key:"sessionkey",data:i.data.sessionkey}),e.index.setStorageSync("sessionkey",i.data.sessionkey),this.decryptPhoneNumber(o,e.index.getStorageSync("sessionkey"))):(e.index.hideLoading(),e.index.showToast({title:"登录失败",icon:"none"}))},fail:()=>{e.index.hideLoading(),e.index.showToast({title:"网络请求失败",icon:"none"})}})},fail:()=>{e.index.hideLoading(),e.index.showToast({title:"登录失败",icon:"none"})}}))},decryptPhoneNumber(o=null,n=null){e.index.request({url:"自己的解密接口",data:new UTSJSONObject({encryptedData:o.detail.encryptedData,iv:o.detail.iv,code:n}),method:"post",header:new UTSJSONObject({"content-type":"application/json"}),success:i=>{e.index.hideLoading(),i.data.r=="T"?(this.onshow(this.openid,this.userInfo,i.data.d.phoneNumber),e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:547","登录成功"),e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:548",i.data.d.phoneNumber)):(e.index.__f__("log","at pages_AI_Login_Match/login/wechat_login.vue:550",i),e.index.showToast({title:"获取手机号失败",icon:"none"}))},fail:()=>{e.index.hideLoading(),e.index.showToast({title:"网络请求失败",icon:"none"})}})},toHome(){l.Navigator.toIndex()},goBack(){l.Navigator.toIndex()},showAgreement(){this.showAgreementModal=!0},showPrivacy(){this.showPrivacyModal=!0},closeModal(o=null){o==="agreement"?this.showAgreementModal=!1:o==="privacy"&&(this.showPrivacyModal=!1)}}});function h(o,n,i,d,a,t){return e.e({a:c._imports_0$2,b:c._imports_1$2,c:c._imports_0$3,d:e.o((...s)=>t.goBack&&t.goBack(...s)),e:a.userInfo&&a.userInfo.avatarUrl?a.userInfo.avatarUrl:"/static/image/defaultAvatar/teacher-man.png",f:a.userInfo&&a.userInfo.nickName},a.userInfo&&a.userInfo.nickName?{g:e.t(a.userInfo.nickName)}:{},{h:!a.loginstate},a.loginstate?{k:e.o((...s)=>t.toHome&&t.toHome(...s))}:{i:c._imports_3$1,j:e.o((...s)=>t.onGotUserInfo&&t.onGotUserInfo(...s))},{l:e.o((...s)=>t.showAgreement&&t.showAgreement(...s)),m:e.o((...s)=>t.showPrivacy&&t.showPrivacy(...s)),n:a.showAgreementModal},a.showAgreementModal?{o:e.o(s=>t.closeModal("agreement")),p:e.o(()=>{}),q:e.o(s=>t.closeModal("agreement"))}:{},{r:a.showPrivacyModal},a.showPrivacyModal?{s:e.o(s=>t.closeModal("privacy")),t:e.o(()=>{}),v:e.o(s=>t.closeModal("privacy"))}:{},{w:a.showModal},a.showModal?{x:e.o((...s)=>t.getPhoneNumber&&t.getPhoneNumber(...s)),y:e.o((...s)=>t.hideModal&&t.hideModal(...s))}:{})}const g=e._export_sfc(r,[["render",h]]);wx.createPage(g);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages_AI_Login_Match/login/wechat_login.js.map
