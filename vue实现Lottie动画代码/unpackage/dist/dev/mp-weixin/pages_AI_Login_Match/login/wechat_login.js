"use strict";const e=require("../../common/vendor.js"),s=require("../../router/Router.js"),r=require("../../common/assets.js"),h=e.defineComponent({data(){return{hasLogin:!1,userInfo:new UTSJSONObject({nickName:"",avatarUrl:""}),showAgreementModal:!1,showPrivacyModal:!1,showAuthPopup:!1,authStep:"avatar",tempUserInfo:new UTSJSONObject({nickName:"",avatarUrl:"",phoneNumber:""}),wxLoginCode:""}},computed:Object.assign(Object.assign({},e.mapState("user/baseInfo",["isRegistered","id","avatar","name","phoneNumber"])),{authPopupTitle(){return new UTSJSONObject({avatar:"选择头像",nickname:"设置昵称",phone:"绑定手机号"})[this.authStep]||"微信授权"}}),onLoad(){this.checkLoginStatus()},methods:Object.assign(Object.assign(Object.assign({},e.mapMutations("user/baseInfo",["SET_USER_INFO"])),e.mapActions("user/baseInfo",["updateUserInfo"])),{checkLoginStatus(){e.index.getStorageSync("token")&&this.isRegistered&&(this.hasLogin=!0,this.userInfo={nickName:this.name,avatarUrl:this.avatar})},onWxLogin(){e.index.showLoading({title:"登录中..."}),e.index.login(new UTSJSONObject({provider:"weixin",success:n=>{e.index.hideLoading(),n.code?(this.wxLoginCode=n.code,this.showAuthPopup=!0,this.authStep="avatar"):e.index.showToast({title:"微信登录失败，请重试",icon:"none"})},fail:n=>{e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:222","微信登录失败",n),e.index.hideLoading(),e.index.showToast({title:"登录失败，请重试",icon:"none"})}}))},onChooseAvatar(n=null){n.detail&&n.detail.avatarUrl&&(this.tempUserInfo.avatarUrl=n.detail.avatarUrl,this.userInfo.avatarUrl=n.detail.avatarUrl,this.goToNicknameStep())},onInputNickname(n=null){this.tempUserInfo.nickName=n.detail.value,this.userInfo.nickName=n.detail.value},goToNicknameStep(){this.authStep="nickname"},goToPhoneStep(){this.authStep="phone"},getPhoneNumber(n=null){n.detail.errMsg==="getPhoneNumber:ok"?this.submitUserInfo(new UTSJSONObject({code:this.wxLoginCode,encryptedData:n.detail.encryptedData,iv:n.detail.iv,avatarUrl:this.tempUserInfo.avatarUrl,nickName:this.tempUserInfo.nickName})):e.index.showToast({title:"未授权手机号，请重试",icon:"none"})},skipPhoneAuth(){this.submitUserInfo(new UTSJSONObject({code:this.wxLoginCode,avatarUrl:this.tempUserInfo.avatarUrl,nickName:this.tempUserInfo.nickName}))},submitUserInfo(n=null){return e.__awaiter(this,void 0,void 0,function*(){e.index.showLoading({title:"提交中..."});try{const i=yield e.index.request({method:"POST",url:"http://localhost:8080/users/auth/wechat/profile",data:n});i.statusCode===200&&i.data?(e.index.setStorageSync("token",i.data.token),i.data.userId&&(e.index.setStorageSync("userId",i.data.userId),this.SET_USER_INFO(new UTSJSONObject({id:i.data.userId,isRegistered:1,name:this.tempUserInfo.nickName,avatar:this.tempUserInfo.avatarUrl,phoneNumber:i.data.phoneNumber||""})),this.userInfo={nickName:this.tempUserInfo.nickName,avatarUrl:this.tempUserInfo.avatarUrl}),e.index.hideLoading(),e.index.showToast({title:"登录成功",icon:"success",duration:1500}),this.hasLogin=!0,this.showAuthPopup=!1,setTimeout(()=>{s.Navigator.redirectTo(s.IndexRoutes.INDEX)},1500)):(e.index.hideLoading(),e.index.showToast({title:"登录失败，请重试",icon:"none"}))}catch(i){e.index.__f__("error","at pages_AI_Login_Match/login/wechat_login.vue:370","提交用户信息失败",i),e.index.hideLoading(),e.index.showToast({title:"登录失败，请重试",icon:"none"})}})},cancelAuth(){this.showAuthPopup=!1,this.wxLoginCode="",this.tempUserInfo={nickName:"",avatarUrl:"",phoneNumber:""}},toHome(){s.Navigator.redirectTo(s.IndexRoutes.INDEX)},showAgreement(){this.showAgreementModal=!0},showPrivacy(){this.showPrivacyModal=!0},closeModal(n=null){n==="agreement"?this.showAgreementModal=!1:n==="privacy"&&(this.showPrivacyModal=!1)}})});function c(n,i,l,m,o,t){return e.e({a:r._imports_0$3,b:o.userInfo.avatarUrl||"/static/image/defaultAvatar/teacher-man.png",c:o.userInfo.nickName},o.userInfo.nickName?{d:e.t(o.userInfo.nickName)}:{},{e:!o.hasLogin},o.hasLogin?{h:e.o((...a)=>t.toHome&&t.toHome(...a))}:{f:r._imports_1$3,g:e.o((...a)=>t.onWxLogin&&t.onWxLogin(...a))},{i:e.o((...a)=>t.showAgreement&&t.showAgreement(...a)),j:e.o((...a)=>t.showPrivacy&&t.showPrivacy(...a)),k:o.showAgreementModal},o.showAgreementModal?{l:e.o(a=>t.closeModal("agreement")),m:e.o(()=>{}),n:e.o(a=>t.closeModal("agreement"))}:{},{o:o.showPrivacyModal},o.showPrivacyModal?{p:e.o(a=>t.closeModal("privacy")),q:e.o(()=>{}),r:e.o(a=>t.closeModal("privacy"))}:{},{s:e.o((...a)=>t.cancelAuth&&t.cancelAuth(...a)),t:e.t(t.authPopupTitle),v:e.o((...a)=>t.cancelAuth&&t.cancelAuth(...a)),w:o.authStep==="avatar"},o.authStep==="avatar"?{x:e.o((...a)=>t.onChooseAvatar&&t.onChooseAvatar(...a)),y:e.o((...a)=>t.goToNicknameStep&&t.goToNicknameStep(...a))}:{},{z:o.authStep==="nickname"},o.authStep==="nickname"?{A:o.tempUserInfo.nickName,B:e.o((...a)=>t.onInputNickname&&t.onInputNickname(...a)),C:e.o((...a)=>t.goToPhoneStep&&t.goToPhoneStep(...a)),D:!o.tempUserInfo.nickName}:{},{E:o.authStep==="phone"},o.authStep==="phone"?{F:e.o((...a)=>t.getPhoneNumber&&t.getPhoneNumber(...a)),G:e.o((...a)=>t.skipPhoneAuth&&t.skipPhoneAuth(...a))}:{},{H:o.showAuthPopup?1:"",I:e.sei(e.gei(n,""),"view")})}const u=e._export_sfc(h,[["render",c],["__scopeId","data-v-921e8418"]]);wx.createPage(u);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages_AI_Login_Match/login/wechat_login.js.map
