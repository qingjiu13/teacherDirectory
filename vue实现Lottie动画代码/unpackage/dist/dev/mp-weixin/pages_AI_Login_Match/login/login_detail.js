"use strict";const t=require("../../common/vendor.js"),u=require("../../router/Router.js"),s=require("../../components/combobox/graduate_school_major.js"),c=require("../../components/combobox/undergraduate.js"),d=require("../../本科专业.js"),h=require("../../common/assets.js"),g=()=>"../../components/combobox/combobox.js",_=()=>"../../components/navigationTitleBar/header.js",S=t.defineComponent({onPageScroll(){t.index.$emit("page-scroll")},components:{ChoiceSelected:g,Header:_},onLoad(){this.loadUniversityData(),this.initSchoolAndMajorSearch(),this.initUserInfo()},data(){return{formData:new UTSJSONObject({nickname:"",avatar:"/static/image/defaultAvatar/teacher-man.png",schoolIndex:-1,majorIndex:-1,targetSchoolIndex:-1,targetMajorIndex:-1,gradeIndex:-1,targetSchool:"",targetMajor:""}),schoolList:[],majorList:[],targetSchoolList:[],targetMajorList:[],allGradeList:["大一","大二","大三","大四","研一","研二","研三"],showAgreementModal:!1,pendingUserInfo:null,graduateStore:null,schoolStore:null,majorStore:null,token:"",userId:""}},computed:Object.assign(Object.assign({},t.mapState("user/baseInfo",new UTSJSONObject({userRole:(e=null)=>e.userInfo.role,userSchool:(e=null)=>e.userInfo.school,userMajor:(e=null)=>e.userInfo.major,userTargetSchool:(e=null)=>e.userInfo.targetSchool,userTargetMajor:(e=null)=>e.userInfo.targetMajor,userStudentGrade:(e=null)=>e.userInfo.studentGrade,userTeacherGrade:(e=null)=>e.userInfo.teacherGrade}))),{gradeList(){return this.userRole==="老师"?this.allGradeList.filter(e=>e.includes("研")):this.allGradeList.filter(e=>e.includes("大"))},filteredTargetSchoolList(){return this.graduateStore?s.GraduateStore.getters.filteredSchoolList(this.graduateStore):[]},filteredTargetMajorList(){return this.graduateStore?s.GraduateStore.getters.filteredMajorList(this.graduateStore):[]},filteredSchoolList(){return this.schoolStore?this.schoolStore.getters.filteredData(this.schoolStore.state):[]}}),methods:Object.assign(Object.assign({},t.mapMutations("user/baseInfo",["UPDATE_USER_INFO","SET_USER_INFO"])),{handleBack(){u.Navigator.toLogin()},initUserInfo(){if(this.token=t.index.getStorageSync("token")||"",this.userId=t.index.getStorageSync("userId")||"",!this.token)return t.index.showToast({title:"请先登录",icon:"none"}),null;const e=t.index.getStorageSync("nickname")||"",o=t.index.getStorageSync("avatar")||"";e&&(this.formData.nickname=e),o&&(this.formData.avatar=o),this.fetchUserProfile()},fetchUserProfile(){if(!this.token||!this.userId)return null;t.index.request({url:`http://localhost:8080/users/profile/${this.userId}`,method:"GET",header:new UTSJSONObject({Authorization:`Bearer ${this.token}`}),success:e=>{if(e.statusCode===200&&e.data){const o=e.data;o.nickname&&(this.formData.nickname=o.nickname,t.index.setStorageSync("nickname",o.nickname)),o.avatar&&(this.formData.avatar=o.avatar,t.index.setStorageSync("avatar",o.avatar)),this.SET_USER_INFO(new UTSJSONObject({id:o.id||this.userId,name:o.nickname||this.formData.nickname,avatar:o.avatar||this.formData.avatar,isRegistered:1})),t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:343","用户信息已更新")}},fail:e=>{t.index.__f__("error","at pages_AI_Login_Match/login/login_detail.vue:347","获取用户信息失败",e)}})},uploadAvatar(){t.index.chooseImage(new UTSJSONObject({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{const o=e.tempFilePaths;t.index.showLoading({title:"上传中..."}),this.formData.avatar=o[0],setTimeout(()=>{t.index.hideLoading(),t.index.showToast({title:"头像已更新",icon:"success"}),t.index.setStorageSync("avatar",o[0])},1e3)}}))},initSchoolAndMajorSearch(){this.schoolStore=c.createDataModule(d.schoolData),this.majorStore=c.createDataModule(d.majorData),this.schoolStore.actions.initSearch(new UTSJSONObject({commit:(e=null,o=null)=>{this.schoolStore.mutations[e](this.schoolStore.state,o)}})),this.majorStore.actions.initSearch(new UTSJSONObject({commit:(e=null,o=null)=>{this.majorStore.mutations[e](this.majorStore.state,o)}})),this.schoolList=this.schoolStore.getters.filteredData(this.schoolStore.state),this.majorList=this.majorStore.getters.filteredData(this.majorStore.state)},handleSchoolSelect(e=null,o=null){this.formData.schoolIndex=e},handleMajorSelect(e=null,o=null){this.formData.majorIndex=e},handleTargetSchoolSelect(e=null,o=null){this.formData.targetSchoolIndex=e,this.formData.targetSchool=o,s.GraduateStore.actions.selectSchool(new UTSJSONObject({commit:(a=null,n=null)=>{s.GraduateStore.mutations[a](this.graduateStore,n)}}),o),this.resetMajorSelection()},handleTargetMajorSelect(e=null,o=null){this.formData.targetMajorIndex=e,this.formData.targetMajor=o},handleGradeSelect(e=null){this.formData.gradeIndex=e},handleSchoolSearch(e=null){this.schoolStore.actions.updateFilterKeyword(new UTSJSONObject({commit:(o=null,a=null)=>{this.schoolStore.mutations[o](this.schoolStore.state,a)}}),e),this.schoolList=this.schoolStore.getters.filteredData(this.schoolStore.state),t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:485",`学校搜索: "${e}", 结果数: ${this.schoolList.length}`)},handleMajorSearch(e=null){this.majorStore.actions.updateFilterKeyword(new UTSJSONObject({commit:(o=null,a=null)=>{this.majorStore.mutations[o](this.majorStore.state,a)}}),e),this.majorList=this.majorStore.getters.filteredData(this.majorStore.state),t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:504",`专业搜索: "${e}", 结果数: ${this.majorList.length}`)},handleTargetSchoolSearch(e=null){if(t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:512","处理学校搜索:",e),!e||e.trim()===""){const a=Object.keys(this.graduateStore.schools).slice(0,50);return this.targetSchoolList=a,t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:518","关键词为空，显示前50所学校"),null}this.graduateStore.schoolFuse||(t.index.__f__("warn","at pages_AI_Login_Match/login/login_detail.vue:524","Fuse搜索引擎未初始化，强制重新初始化中..."),s.GraduateStore.actions.reinitializeSearch(new UTSJSONObject({commit:(a=null,n=null)=>{s.GraduateStore.mutations[a](this.graduateStore,n)},state:this.graduateStore}))),s.GraduateStore.mutations.setSchoolKeyword(this.graduateStore,e);const o=s.GraduateStore.getters.filteredSchoolList(this.graduateStore);t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:539","过滤后的学校列表:",o),this.targetSchoolList=o,this.$nextTick(()=>{t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:547",`最终显示学校数量: ${o.length}`),this.$refs.targetSchoolDropdown&&this.$refs.targetSchoolDropdown.$forceUpdate()})},handleTargetMajorSearch(e=null){if(t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:561","处理专业搜索:",e),!this.graduateStore.selectedSchool)return t.index.__f__("warn","at pages_AI_Login_Match/login/login_detail.vue:565","未选择学校，专业搜索无效"),null;if(!e||e.trim()===""){const a=this.graduateStore.schools[this.graduateStore.selectedSchool]||[];return this.targetMajorList=a.slice(0,20),t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:573","关键词为空，显示前20个专业"),null}this.graduateStore.majorFuse||(t.index.__f__("warn","at pages_AI_Login_Match/login/login_detail.vue:579","专业搜索引擎未初始化，重新初始化中..."),s.GraduateStore.mutations.setSelectedSchool(this.graduateStore,this.graduateStore.selectedSchool)),s.GraduateStore.mutations.setMajorKeyword(this.graduateStore,e);const o=s.GraduateStore.getters.filteredMajorList(this.graduateStore);t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:589","过滤后的专业列表:",o),this.targetMajorList=o,this.$nextTick(()=>{t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:597",`最终显示专业数量: ${o.length}`),this.$refs.targetMajorDropdown&&this.$refs.targetMajorDropdown.$forceUpdate()})},closeAllDropdowns(){["schoolDropdown","majorDropdown","targetSchoolDropdown","targetMajorDropdown"].forEach(o=>{this.$refs&&this.$refs[o]&&this.$refs[o].closeDropdown&&this.$refs[o].closeDropdown()})},loadUniversityData(){try{this.initGraduateData(),t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:626","成功加载学校数据")}catch(e){t.index.__f__("error","at pages_AI_Login_Match/login/login_detail.vue:628","加载大学数据失败:",e);const o=["北京大学","清华大学","复旦大学"];this.schoolList=o,this.targetSchoolList=o,t.index.showToast({title:"加载大学数据失败，使用默认列表",icon:"none"})}},closeModal(){this.showAgreementModal=!1,this.pendingUserInfo=null},confirmAgreement(){this.pendingUserInfo&&(this.UPDATE_USER_INFO(this.pendingUserInfo),this.submitToBackend(this.pendingUserInfo),t.index.setStorageSync("nickname",this.pendingUserInfo.userInfo.nickname),t.index.setStorageSync("avatar",this.pendingUserInfo.userInfo.avatar),t.index.showToast({title:"信息保存成功",icon:"success"}),this.showAgreementModal=!1,setTimeout(()=>{u.Navigator.toMine()},1500))},skipForm(){u.Navigator.toIndex()},submitForm(){try{if(!this.formData.nickname.trim())return t.index.showToast({title:"请输入昵称",icon:"none"}),null;const e=this.userRole,o=new UTSJSONObject({id:this.userId||t.index.getStorageSync("userId"),name:this.formData.nickname,avatar:this.formData.avatar,isRegistered:1,userInfo:new UTSJSONObject({certificate:this.$store.state.user.baseInfo.userInfo.certificate,role:e,school:this.formData.schoolIndex>=0?this.schoolList[this.formData.schoolIndex]:this.userSchool,major:this.formData.majorIndex>=0?this.majorList[this.formData.majorIndex]:this.userMajor,studentGrade:e==="学生"&&this.formData.gradeIndex>=0?this.gradeList[this.formData.gradeIndex]:this.userStudentGrade,teacherGrade:e==="老师"&&this.formData.gradeIndex>=0?this.gradeList[this.formData.gradeIndex]:this.userTeacherGrade,teacherScore:this.$store.state.user.baseInfo.userInfo.teacherScore,nickname:this.formData.nickname,avatar:this.formData.avatar})});if(e==="学生"&&(o.userInfo.targetSchool=this.formData.targetSchool||this.userTargetSchool,o.userInfo.targetMajor=this.formData.targetMajor||this.userTargetMajor),e==="老师")return this.pendingUserInfo=o,this.showAgreementModal=!0,null;this.UPDATE_USER_INFO(o),this.submitToBackend(o),t.index.setStorageSync("nickname",this.formData.nickname),t.index.setStorageSync("avatar",this.formData.avatar),t.index.showToast({title:"信息保存成功",icon:"success"}),setTimeout(()=>{u.Navigator.toIndex()},1500)}catch(e){t.index.__f__("error","at pages_AI_Login_Match/login/login_detail.vue:763","提交表单时出错:",e),t.index.showToast({title:"保存失败，请重试",icon:"none"})}},submitToBackend(e=null){if(!this.token)return t.index.__f__("error","at pages_AI_Login_Match/login/login_detail.vue:778","没有token，无法提交用户信息"),null;t.index.showLoading({title:"提交中..."});const o=new UTSJSONObject({id:e.id,nickname:e.userInfo.nickname,name:e.name,avatar:e.avatar,school:e.userInfo.school,major:e.userInfo.major,grade:e.userInfo.role==="学生"?e.userInfo.studentGrade:e.userInfo.teacherGrade});e.userInfo.role==="学生"&&(o.targetSchool=e.userInfo.targetSchool,o.targetMajor=e.userInfo.targetMajor),t.index.request({url:"http://localhost:8080/users/profile/update",method:"POST",header:new UTSJSONObject({Authorization:`Bearer ${this.token}`,"Content-Type":"application/json"}),data:o,success:a=>{if(t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:814","用户信息提交成功",a),t.index.hideLoading(),a.data&&a.data.user){const n=a.data.user,i=new UTSJSONObject({id:n.id||e.id,name:n.name||e.name,avatar:n.avatar||e.avatar});this.UPDATE_USER_INFO(i),t.index.setStorageSync("userId",i.id),t.index.setStorageSync("nickname",i.name),t.index.setStorageSync("avatar",i.avatar)}},fail:a=>{t.index.__f__("error","at pages_AI_Login_Match/login/login_detail.vue:838","用户信息提交失败",a),t.index.hideLoading(),t.index.showToast({title:"网络异常，信息已本地保存",icon:"none"})}})},validateForm(){return!0},initGraduateData(){try{if(this.graduateStore=UTS.JSON.parse(UTS.JSON.stringify(s.GraduateStore.state)),!this.graduateStore.schools)throw t.index.__f__("error","at pages_AI_Login_Match/login/login_detail.vue:867","研究生学校数据不完整"),new Error("学校数据结构不完整");s.GraduateStore.mutations.initSchoolFuse(this.graduateStore),t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:873","Fuse引擎初始化状态:",!!this.graduateStore.schoolFuse),this.graduateStore.schoolFuse?t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:877","Fuse配置验证:",new UTSJSONObject({keys:this.graduateStore.schoolFuse._docs[0]?Object.keys(this.graduateStore.schoolFuse._docs[0]):"未知",ignoreLocation:this.graduateStore.schoolFuse.options.ignoreLocation,threshold:this.graduateStore.schoolFuse.options.threshold})):t.index.__f__("error","at pages_AI_Login_Match/login/login_detail.vue:883","Fuse.js搜索引擎初始化失败");const e=Object.keys(this.graduateStore.schools).slice(0,50);return this.targetSchoolList=e,t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:890","初始化考研数据成功"),!0}catch(e){t.index.__f__("error","at pages_AI_Login_Match/login/login_detail.vue:893","初始化考研数据失败:",e);const o=["北京大学","清华大学","复旦大学"];return this.targetSchoolList=o,!1}},handleSchoolChange(e=null){if(t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:907","学校变更事件:",e),!e)return this.resetMajorSelection(),null;s.GraduateStore.actions.selectSchool(new UTSJSONObject({commit:(o=null,a=null)=>{s.GraduateStore.mutations[o](this.graduateStore,a)}}),e),this.graduateStore.schools[e]?(this.targetMajorList=this.graduateStore.schools[e].slice(0,30),t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:925",`已加载 ${e} 的专业列表，共 ${this.targetMajorList.length} 个`)):(this.resetMajorSelection(),t.index.__f__("warn","at pages_AI_Login_Match/login/login_detail.vue:928",`${e} 没有关联的专业数据`))},resetMajorSelection(){this.formData.targetMajorIndex=-1,this.formData.targetMajor=""}}),onShow(){this.graduateStore&&(s.GraduateStore.actions.reinitializeSearch(new UTSJSONObject({commit:(e=null,o=null)=>{s.GraduateStore.mutations[e](this.graduateStore,o)},state:this.graduateStore})),t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:952","Fuse引擎强制重新初始化完成，状态:",!!this.graduateStore.schoolFuse),this.graduateStore.schoolFuse&&t.index.__f__("log","at pages_AI_Login_Match/login/login_detail.vue:956","重新初始化后的Fuse配置:",new UTSJSONObject({threshold:this.graduateStore.schoolFuse.options.threshold,ignoreLocation:this.graduateStore.schoolFuse.options.ignoreLocation,items:this.graduateStore.schoolFuse._docs.length}))),this.schoolStore&&this.majorStore&&this.initSchoolAndMajorSearch()}});if(!Array){const e=t.resolveComponent("Header"),o=t.resolveComponent("ChoiceSelected"),a=t.resolveComponent("template");(e+o+a)()}function m(e,o,a,n,i,r){return t.e({a:t.o(r.handleBack),b:t.p({title:"登录详情"}),c:h._imports_0$4,d:h._imports_1$4,e:e.userRole==="学生"},e.userRole==="学生"?{f:t.sr("schoolDropdown","221f0539-1"),g:t.o(r.handleSchoolSelect),h:t.o(r.handleSchoolSearch),i:t.p({componentType:"undergraduate",choiceIndex:i.formData.schoolIndex,choiceList:i.schoolList,defaultText:"请选择学校",mode:"search",searchPlaceholder:"输入学校名称"}),j:t.sr("majorDropdown","221f0539-2"),k:t.o(r.handleMajorSelect),l:t.o(r.handleMajorSearch),m:t.p({componentType:"undergraduate",choiceIndex:i.formData.majorIndex,choiceList:i.majorList,defaultText:"请选择专业",mode:"search",searchPlaceholder:"输入专业名称"})}:{},{n:t.o(r.handleGradeSelect),o:t.p({choiceIndex:i.formData.gradeIndex,choiceList:r.gradeList,defaultText:"请选择年级",mode:"select"}),p:t.t(e.userRole==="学生"?"目标学校":"就读学校"),q:t.sr("targetSchoolDropdown","221f0539-4"),r:t.o(r.handleTargetSchoolSelect),s:t.o(r.handleTargetSchoolSearch),t:t.o(r.handleSchoolChange),v:t.p({componentType:"graduateSchool",choiceIndex:i.formData.targetSchoolIndex,choiceList:i.targetSchoolList,defaultText:e.userRole==="学生"?"请选择目标学校":"请选择学校",mode:"search",searchPlaceholder:e.userRole==="学生"?"输入目标学校名称":"输入学校名称",enablePagination:!0,pageSize:10}),w:t.t(e.userRole==="学生"?"目标专业":"就读专业"),x:t.sr("targetMajorDropdown","221f0539-5"),y:t.o(r.handleTargetMajorSelect),z:t.o(r.handleTargetMajorSearch),A:t.o(r.resetMajorSelection),B:t.p({componentType:"graduateMajor",choiceIndex:i.formData.targetMajorIndex,choiceList:i.targetMajorList,parentValue:i.formData.targetSchool,isLinkage:!0,defaultText:i.formData.targetSchool?"请选择专业":"请先选择学校",mode:"search",searchPlaceholder:i.formData.targetSchool?e.userRole==="学生"?"请选择目标专业":"请选择专业":"请先选择学校",enablePagination:!0,pageSize:10}),C:h._imports_2$1,D:t.o((...l)=>r.skipForm&&r.skipForm(...l)),E:h._imports_3$2,F:t.o((...l)=>r.submitForm&&r.submitForm(...l)),G:i.showAgreementModal},i.showAgreementModal?{H:t.o((...l)=>r.confirmAgreement&&r.confirmAgreement(...l)),I:t.o(()=>{}),J:t.o((...l)=>r.closeModal&&r.closeModal(...l))}:{})}const f=t._export_sfc(S,[["render",m],["__scopeId","data-v-221f0539"]]);wx.createPage(f);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages_AI_Login_Match/login/login_detail.js.map
