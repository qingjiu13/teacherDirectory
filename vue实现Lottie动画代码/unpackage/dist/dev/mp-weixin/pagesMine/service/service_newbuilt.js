"use strict";const t=require("../../common/vendor.js"),l=require("../../router/Router.js"),u=()=>"../components/combobox/combobox.js",h=()=>"../../components/navigationTitleBar/header.js",a=t.defineComponent({components:{"choice-selected":u,Header:h},data(){return{hasEdited:!1,mode:"add",serviceId:"",coverUrls:[],avatarUrl:"",selectedServiceType:"",selectedServiceTypeIndex:-1,serviceTypes:["一对一课程","一对多课程","学习资料"],coursequantity:"",showServiceTypeDropdown:!1,duration:"",description:"",price:"",files:[],showDuration:!1,showAttachment:!1,originalService:null,serviceName:"",selectedHoursIndex:-1,hourOptions:["1","2","4","6","8","10","12","24","48","60","120"],selectedMinutesIndex:-1,minuteOptions:["0","15","30","45"],selectedMultiHoursIndex:-1,selectedMultiMinutesIndex:-1,multiServiceName:"",selectedPersonCountIndex:-1,personCountOptions:["2","4","6","8","10","15","20","30"],statusBarHeight:0}},onLoad(e){t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:206","==============================="),t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:207","service_newbuilt onLoad:",e),this.setStatusBarHeight(),e&&e.mode?(this.mode=e.mode,t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:215","当前模式:",this.mode),e.mode==="edit"&&e.id&&(this.serviceId=e.id,t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:220","编辑服务ID:",this.serviceId),getApp().globalData&&getApp().globalData.editingService?t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:224","全局状态中存在编辑服务数据:",getApp().globalData.editingService):t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:226","全局状态中不存在编辑服务数据"),this.loadEditingService())):(t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:233","未检测到模式参数，默认为新建模式"),this.mode="add"),this.updateFormFields(),t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:239","===============================")},onUnload(){t.index.$off("serviceEdited",this.handleServiceEdited),getApp().globalData&&(getApp().globalData.editingService=null)},methods:{setStatusBarHeight(){const e=t.index.getSystemInfoSync();this.statusBarHeight=e.statusBarHeight,typeof document<"u"&&document.documentElement&&document.documentElement.style.setProperty("--status-bar-height",`${this.statusBarHeight}px`)},chooseAvatar(){t.index.chooseImage(new UTSJSONObject({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{this.avatarUrl=e.tempFilePaths[0]}}))},chooseCover(){const e=9-this.coverUrls.length;if(e<=0)return t.index.showToast({title:"最多只能上传9张图片",icon:"none"}),null;t.index.chooseImage(new UTSJSONObject({count:e,sizeType:["compressed"],sourceType:["album","camera"],success:i=>{this.coverUrls=[...this.coverUrls,...i.tempFilePaths],this.hasEdited=!0}}))},deleteCover(e=null){this.coverUrls.splice(e,1),this.hasEdited=!0},loadEditingService(){try{if(t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:300","开始加载编辑服务数据..."),t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:301","服务ID:",this.serviceId),getApp().globalData&&getApp().globalData.editingService){const i=getApp().globalData.editingService;if(t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:306","从全局数据获取到编辑服务:",i),i.id.toString()===this.serviceId.toString())return t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:310","ID匹配，使用全局数据"),this.originalService=i,this.fillFormWithServiceData(this.originalService),t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:315","表单填充完成"),null;t.index.__f__("warn","at pagesMine/service/service_newbuilt.vue:318","全局数据中的服务ID不匹配")}else t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:321","全局数据中不存在编辑服务数据");const e=t.index.getStorageSync("services");if(e){const i=UTS.JSON.parse(e);t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:328","从本地存储获取到服务列表，共",i.length,"条记录");const n=i.find((o=null)=>o.id.toString()===this.serviceId.toString());n?(t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:333","在本地存储中找到匹配的服务:",n),this.originalService=n,this.fillFormWithServiceData(n),t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:338","表单填充完成")):(t.index.__f__("error","at pagesMine/service/service_newbuilt.vue:340","在本地存储中找不到匹配的服务"),t.index.showToast({title:"找不到服务数据",icon:"none"}),setTimeout(()=>{t.index.navigateBack()},1500))}else t.index.__f__("error","at pagesMine/service/service_newbuilt.vue:352","本地存储中不存在服务数据"),t.index.showToast({title:"找不到服务数据",icon:"none"}),setTimeout(()=>{t.index.navigateBack()},1500)}catch(e){t.index.__f__("error","at pagesMine/service/service_newbuilt.vue:364","加载服务数据失败:",e),t.index.showToast({title:"加载数据失败",icon:"none"})}},fillFormWithServiceData(e=null){if(this.coverUrls=e.imageUrls||(e.imageUrl?[e.imageUrl]:[]),e.type&&e.type.typename?(this.selectedServiceType=e.type.typename,this.selectedServiceTypeIndex=this.serviceTypes.findIndex(i=>i===e.type.typename)):(this.selectedServiceType=e.name||"",this.selectedServiceTypeIndex=this.serviceTypes.findIndex(i=>i===e.name)),this.price=e.price?e.price.replace(/[¥￥]/g,""):"",this.description=e.description||"",this.selectedServiceType==="一对一课程"){if(this.serviceName=e.serviceName||e.name||"",e.totalDuration){const i=e.totalDuration.match(/(\d+)小时(\d+)分钟/);i&&(this.selectedHoursIndex=this.hourOptions.findIndex(n=>n===i[1]),this.selectedMinutesIndex=this.minuteOptions.findIndex(n=>n===i[2]))}else if(e.type&&e.type.fulllength){const i=e.type.hours||"",n=e.type.minutes||"",o=i.match(/(\d+)/),s=n.match(/(\d+)/);o&&(this.selectedHoursIndex=this.hourOptions.findIndex(r=>r===o[1])),s&&(this.selectedMinutesIndex=this.minuteOptions.findIndex(r=>r===s[1]))}}else if(this.selectedServiceType==="一对多课程"){if(this.multiServiceName=e.serviceName||e.name||"",e.totalDuration){const i=e.totalDuration.match(/(\d+)小时(\d+)分钟/);i&&(this.selectedMultiHoursIndex=this.hourOptions.findIndex(n=>n===i[1]),this.selectedMultiMinutesIndex=this.minuteOptions.findIndex(n=>n===i[2]))}else if(e.type&&e.type.fulllength){const i=e.type.hours||"",n=e.type.minutes||"",o=i.match(/(\d+)/),s=n.match(/(\d+)/);o&&(this.selectedMultiHoursIndex=this.hourOptions.findIndex(r=>r===o[1])),s&&(this.selectedMultiMinutesIndex=this.minuteOptions.findIndex(r=>r===s[1]))}e.personCount?this.selectedPersonCountIndex=this.personCountOptions.findIndex(i=>i===e.personCount.toString()):e.type&&e.type.studentnum&&(this.selectedPersonCountIndex=this.personCountOptions.findIndex(i=>parseInt(i)===e.type.studentnum))}else this.selectedServiceType==="学习资料"&&(this.coursequantity=e.coursequantity||e.name||"");this.updateFormFields()},goBack(){this.hasEdited?t.index.showModal(new UTSJSONObject({title:"提示",content:"是否保存已编辑的内容？",cancelText:"不保存",confirmText:"保存",success:e=>{e.confirm?this.submitForm():l.Navigator.toService()}})):l.Navigator.toService()},handleServiceTypeSelect(e=null){this.selectedServiceTypeIndex=e,this.selectedServiceType=this.serviceTypes[e],this.selectedServiceType==="一对一课程"?(this.selectedHoursIndex=-1,this.selectedMinutesIndex=-1,this.serviceName=""):this.selectedServiceType==="一对多课程"?(this.selectedMultiHoursIndex=-1,this.selectedMultiMinutesIndex=-1,this.multiServiceName="",this.selectedPersonCountIndex=-1):this.selectedServiceType==="学习资料"&&(this.coursequantity=""),this.updateFormFields(),this.hasEdited=!0},handleHoursSelect(e=null){this.selectedHoursIndex=e,this.hasEdited=!0},handleMinutesSelect(e=null){this.selectedMinutesIndex=e,this.hasEdited=!0},handleMultiHoursSelect(e=null){this.selectedMultiHoursIndex=e,this.hasEdited=!0},handleMultiMinutesSelect(e=null){this.selectedMultiMinutesIndex=e,this.hasEdited=!0},handlePersonCountSelect(e=null){this.selectedPersonCountIndex=e,this.hasEdited=!0},updateFormFields(){this.selectedServiceType==="学习资料"?(this.showDuration=!1,this.showAttachment=!0):(this.showDuration=!0,this.showAttachment=this.selectedServiceType==="学习资料")},chooseFile(){t.index.chooseImage(new UTSJSONObject({count:1,success:e=>{this.files=e.tempFilePaths,this.hasEdited=!0}}))},submitForm(){if(t.index.showLoading({title:"提交中..."}),this.coverUrls.length===0)return t.index.showToast({title:"请上传封面图片",icon:"none"}),t.index.hideLoading(),null;if(!this.selectedServiceType)return t.index.showToast({title:"请选择服务类型",icon:"none"}),t.index.hideLoading(),null;if(this.selectedServiceType==="一对一课程"){if(this.selectedHoursIndex===-1||this.selectedMinutesIndex===-1)return t.index.showToast({title:"请选择课程时长",icon:"none"}),t.index.hideLoading(),null;if(!this.serviceName)return t.index.showToast({title:"请填写服务名称",icon:"none"}),t.index.hideLoading(),null}else if(this.selectedServiceType==="一对多课程"){if(this.selectedMultiHoursIndex===-1||this.selectedMultiMinutesIndex===-1)return t.index.showToast({title:"请选择课程时长",icon:"none"}),t.index.hideLoading(),null;if(!this.multiServiceName)return t.index.showToast({title:"请填写服务名称",icon:"none"}),t.index.hideLoading(),null;if(this.selectedPersonCountIndex===-1)return t.index.showToast({title:"请选择课程人数",icon:"none"}),t.index.hideLoading(),null}else if(this.selectedServiceType==="学习资料"&&!this.coursequantity)return t.index.showToast({title:"请填写服务名称",icon:"none"}),t.index.hideLoading(),null;if(!this.price)return t.index.showToast({title:"请填写服务价格",icon:"none"}),t.index.hideLoading(),null;let e=new UTSJSONObject({});this.mode==="edit"&&this.originalService?e=new UTSJSONObject(Object.assign(Object.assign({},this.originalService),{name:this.selectedServiceType,price:this.price.startsWith("¥")?this.price:"¥"+this.price,description:this.description||`这是一个${this.selectedServiceType}服务`,imageUrls:this.coverUrls,imageUrl:this.coverUrls[0]||""})):e=new UTSJSONObject({id:Date.now().toString(),name:this.selectedServiceType,price:this.price.startsWith("¥")?this.price:"¥"+this.price,description:this.description||`这是一个${this.selectedServiceType}服务`,checked:!1,imageUrls:this.coverUrls,imageUrl:this.coverUrls[0]||"",createTime:new Date().toISOString().split("T")[0],updateTime:new Date().toISOString().split("T")[0],status:"active"}),this.selectedServiceType==="一对一课程"?(e.serviceName=this.serviceName,e.totalDuration=`${this.hourOptions[this.selectedHoursIndex]}小时${this.minuteOptions[this.selectedMinutesIndex]}分钟`,e.type=new UTSJSONObject({typename:"一对一课程",fulllength:new UTSJSONObject({hours:`${this.hourOptions[this.selectedHoursIndex]}小时`,minutes:`${this.minuteOptions[this.selectedMinutesIndex]}分钟`})})):this.selectedServiceType==="一对多课程"?(e.serviceName=this.multiServiceName,e.totalDuration=`${this.hourOptions[this.selectedMultiHoursIndex]}小时${this.minuteOptions[this.selectedMultiMinutesIndex]}分钟`,e.personCount=this.personCountOptions[this.selectedPersonCountIndex],e.type=new UTSJSONObject({typename:"一对多课程",fulllength:new UTSJSONObject({hours:`${this.hourOptions[this.selectedMultiHoursIndex]}小时`,minutes:`${this.minuteOptions[this.selectedMultiMinutesIndex]}分钟`}),studentnum:parseInt(this.personCountOptions[this.selectedPersonCountIndex])})):this.selectedServiceType==="学习资料"&&(e.coursequantity=this.coursequantity,e.serviceName=this.coursequantity,e.type=new UTSJSONObject({typename:"学习资料",fileLink:"https://www.baidu.com"})),e.updateTime=new Date().toISOString().split("T")[0],this.mode==="edit"?this.updateExistingService(e):this.addNewService(e)},addNewService(e=null){try{const i=t.index.getStorageSync("services");let n=[];i&&(n=UTS.JSON.parse(i));const o=n.findIndex(s=>s.id===e.id);o!==-1?n[o]=e:n.push(e),t.index.setStorageSync("services",UTS.JSON.stringify(n)),getApp().globalData=getApp().globalData||new UTSJSONObject({}),getApp().globalData.newServiceAdded=!0,getApp().globalData.newService=e,t.index.hideLoading(),t.index.showToast({title:"提交成功",icon:"success"}),this.hasEdited=!1,setTimeout(()=>{l.Navigator.toService()},1500)}catch(i){t.index.__f__("error","at pagesMine/service/service_newbuilt.vue:769","保存服务失败",i),t.index.hideLoading(),t.index.showToast({title:"保存失败，请重试",icon:"none"})}},updateExistingService(e=null){try{const i=t.index.getStorageSync("services");let n=[];i&&(n=UTS.JSON.parse(i));const o=n.findIndex(s=>s.id==this.serviceId);o!==-1?n[o]=e:n.push(e),t.index.setStorageSync("services",UTS.JSON.stringify(n)),getApp().globalData=getApp().globalData||new UTSJSONObject({}),getApp().globalData.serviceEdited=!0,getApp().globalData.editedService=e,t.index.hideLoading(),t.index.showToast({title:"更新成功",icon:"success"}),this.hasEdited=!1,setTimeout(()=>{l.Navigator.toService()},1500)}catch(i){t.index.__f__("error","at pagesMine/service/service_newbuilt.vue:821","更新服务失败",i),t.index.hideLoading(),t.index.showToast({title:"更新失败，请重试",icon:"none"})}},handleServiceEdited(e=null){t.index.__f__("log","at pagesMine/service/service_newbuilt.vue:830","Service edited",e)},trackChanges(){this.hasEdited=!0}},computed:{serviceNameModel:new UTSJSONObject({get(){return this.selectedServiceType==="一对多课程"?this.multiServiceName:this.serviceName},set(e=null){this.selectedServiceType==="一对多课程"?this.multiServiceName=e:this.serviceName=e,this.trackChanges()}})}});if(!Array){const e=t.resolveComponent("Header"),i=t.resolveComponent("choice-selected");(e+i)()}const p=()=>"../components/combobox/combobox2.js";Math||p();function v(e,i,n,o,s,r){return t.e({a:t.o(r.goBack),b:t.p({title:s.mode==="edit"?"修改信息":"新建服务"}),c:r.serviceNameModel,d:t.o(c=>r.serviceNameModel=c.detail.value),e:t.o(r.handleServiceTypeSelect),f:t.p({choiceIndex:s.selectedServiceTypeIndex,choiceList:s.serviceTypes,defaultText:"请选择服务类型"}),g:t.o(c=>s.selectedServiceType==="一对多课程"?r.handleMultiHoursSelect(c):r.handleHoursSelect(c)),h:t.p({choiceIndex:s.selectedServiceType==="一对多课程"?s.selectedMultiHoursIndex:s.selectedHoursIndex,choiceList:s.hourOptions,defaultText:"小时"}),i:t.o(c=>s.selectedServiceType==="一对多课程"?r.handleMultiMinutesSelect(c):r.handleMinutesSelect(c)),j:t.p({choiceIndex:s.selectedServiceType==="一对多课程"?s.selectedMultiMinutesIndex:s.selectedMinutesIndex,choiceList:s.minuteOptions,defaultText:"分钟"}),k:s.selectedServiceType==="一对多课程"},s.selectedServiceType==="一对多课程"?{l:t.o(r.handlePersonCountSelect),m:t.p({choiceIndex:s.selectedPersonCountIndex,choiceList:s.personCountOptions,defaultText:"请选择课程人数"})}:{},{n:t.o([c=>s.price=c.detail.value,(...c)=>r.trackChanges&&r.trackChanges(...c)]),o:s.price,p:t.o([c=>s.description=c.detail.value,(...c)=>r.trackChanges&&r.trackChanges(...c)]),q:s.description,r:t.o((...c)=>r.chooseCover&&r.chooseCover(...c)),s:s.showAttachment},s.showAttachment?{t:t.o((...c)=>r.chooseFile&&r.chooseFile(...c))}:{},{v:s.coverUrls.length>0},s.coverUrls.length>0?{w:t.f(s.coverUrls,(c,d,m)=>({a:c,b:t.o(S=>r.deleteCover(d),d),c:d}))}:{},{x:t.o((...c)=>r.submitForm&&r.submitForm(...c)),y:t.sei(t.gei(e,""),"view")})}const g=t._export_sfc(a,[["render",v]]);wx.createPage(g);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pagesMine/service/service_newbuilt.js.map
