"use strict";const e=require("../../common/vendor.js"),d=()=>"../../components/top-navbar/top-navbar.js",h=()=>"../../components/navigationTitleBar/header.js",g=e.defineComponent({components:{topNavbar:d,Header:h},data(){return{currentTab:0,teacherCurrentTab:0,timeSlots:[new UTSJSONObject({period:"上午",slots:["08:00-09:00","09:00-10:00","10:00-11:00","11:00-12:00"]}),new UTSJSONObject({period:"下午",slots:["13:00-14:00","14:00-15:00","15:00-16:00","16:00-17:00"]}),new UTSJSONObject({period:"晚上",slots:["18:00-19:00","19:00-20:00","20:00-21:00"]})],selectedTimeSlot:"",selectedTimePeriod:"",pendingCourses:[new UTSJSONObject({id:1,name:"考研政治精讲班",teacher:"王老师",time:"2023-12-15 14:00",price:399,image:"/static/images/default_avatar.png",description:"系统讲解考研政治马原、毛中特、思修法基、当代世界经济与政治重点内容。"}),new UTSJSONObject({id:2,name:"考研数学基础班",teacher:"李老师",time:"2023-12-16 10:00",price:499,image:"/static/images/default_avatar.png",description:"覆盖高等数学、线性代数、概率论与数理统计核心知识点，夯实数学基础。"}),new UTSJSONObject({id:3,name:"考研英语词汇班",teacher:"张老师",time:"2023-12-17 15:00",price:349,image:"/static/images/default_avatar.png",description:"掌握考研英语必备5500词汇，提高阅读理解和写作能力。"}),new UTSJSONObject({id:4,name:"计算机专业课辅导",teacher:"陈老师",time:"2023-12-18 19:00",price:549,image:"/static/images/default_avatar.png",description:"针对计算机专业考生，讲解数据结构、操作系统、计算机网络等核心科目。"})],reservedCourses:[new UTSJSONObject({id:5,name:"考研专业课强化班",teacher:"赵老师",price:599,reservedTime:"2023-12-18 14:00",image:"/static/images/default_avatar.png",description:"针对专业课考试，深入讲解重点难点，提供真题分析和解题技巧。"}),new UTSJSONObject({id:6,name:"考研政治冲刺班",teacher:"孙老师",price:449,reservedTime:"2023-12-19 10:00",image:"/static/images/default_avatar.png",description:"考前政治热点分析，提供答题模板和背诵要点，助力考研政治高分。"})],completedCourses:[new UTSJSONObject({id:7,name:"考研英语写作班",teacher:"黄老师",price:399,completedTime:"2023-12-10 15:00",image:"/static/images/default_avatar.png",replayUrl:"https://meeting.tencent.com/v2/cloud-record/share?id=5fcc0283-6d70-4b56-8710-5ef9318c475b&from=3"}),new UTSJSONObject({id:8,name:"考研复试指导课",teacher:"周老师",price:499,completedTime:"2023-12-15 09:00",image:"/static/images/default_avatar.png",replayUrl:"https://meeting.tencent.com/v2/cloud-record/share?id=7e9f8d62-34a1-4b12-9f80-5c31d9b52ec8&from=3"})],currentCourseIndex:null,selectedDate:null,userRole:"student",userName:"",userData:new UTSJSONObject({}),isLoggedIn:!1,teacherPendingCourses:[],teacherActiveCourses:[],teacherCompletedCourses:[]}},onLoad(t){e.index.__f__("log","at pagesMine/course/course.vue:321","课程页面 onLoad",t),this.loadUserData();const s=getApp().globalData,r=e.index.getStorageSync("userRole");s&&s.userRole?(this.userRole=s.userRole,e.index.__f__("log","at pagesMine/course/course.vue:333","使用全局角色状态:",this.userRole)):r&&(this.userRole=r,s&&(s.userRole=this.userRole),e.index.__f__("log","at pagesMine/course/course.vue:342","使用存储的角色:",this.userRole)),this.loadCourseData()},onShow(){e.index.__f__("log","at pagesMine/course/course.vue:349","课程页面 onShow, 当前角色:",this.userRole);const t=getApp().globalData;if(t&&t.userRole&&t.userRole!==this.userRole){e.index.__f__("log","at pagesMine/course/course.vue:354","全局角色变更:",t.userRole);const r=this.userRole;this.userRole=t.userRole,r!==this.userRole&&(this.resetRoleRelatedState(),e.index.setStorageSync("userRole",this.userRole),this.loadCourseData())}const s=e.index.getStorageSync("userRole");if(s&&s!==this.userRole){e.index.__f__("log","at pagesMine/course/course.vue:369","存储角色与当前不一致, 存储:",s,"当前:",this.userRole);const r=this.userRole;this.userRole=s,t&&(t.userRole=this.userRole),r!==this.userRole&&(this.resetRoleRelatedState(),this.loadCourseData())}},onUnload(){e.index.__f__("log","at pagesMine/course/course.vue:387","课程页面 onUnload, 保存当前角色:",this.userRole),e.index.setStorageSync("userRole",this.userRole);const t=getApp().globalData;t&&(t.userRole=this.userRole)},methods:{goBack(){e.index.navigateBack()},loadUserData(){const t=e.index.getStorageSync("token");if(this.isLoggedIn=!!t,this.isLoggedIn){const s=e.index.getStorageSync("userInfo");if(s)try{this.userData=typeof s=="string"?UTS.JSON.parse(s):s,this.userName=this.userData.nickname||"用户";const r=this.userRole;if(this.userData.role){this.userRole=this.userData.role,e.index.__f__("log","at pagesMine/course/course.vue:426","从用户数据中设置角色:",this.userRole),e.index.setStorageSync("userRole",this.userData.role);const c=getApp().globalData;c&&(c.userRole=this.userRole),r!==this.userRole&&this.resetRoleRelatedState()}}catch(r){e.index.__f__("error","at pagesMine/course/course.vue:443","解析用户信息失败:",r)}}else this.userData=new UTSJSONObject({}),this.userName="",e.index.__f__("log","at pagesMine/course/course.vue:452","未登录，保持当前角色:",this.userRole)},resetRoleRelatedState(){e.index.__f__("log","at pagesMine/course/course.vue:458","重置角色相关状态"),this.userRole==="student"?this.currentTab=0:this.teacherCurrentTab=0,this.selectedDate=null,this.selectedTimeSlot="",this.selectedTimePeriod=""},onTabChange(t=null){e.index.__f__("log","at pagesMine/course/course.vue:471","学生模式标签切换:",t),this.currentTab=t,t===0&&(this.selectedTimeSlot="",this.selectedTimePeriod="")},resetDateSelection(){this.selectedDate=null,this.selectedTimeSlot="",this.selectedTimePeriod=""},handleReserve(t=null){this.currentCourseIndex=t,this.selectedDate?this.showTimeSelectionDialog():this.$refs.calendar.open()},onCalendarConfirm(t=null){this.selectedDate=t.fulldate,this.$nextTick(()=>{this.showTimeSelectionDialog()})},showTimeSelectionDialog(){const t=this.timeSlots.map(s=>s.period);e.index.showActionSheet({itemList:t,success:s=>{this.selectedTimePeriod=t[s.tapIndex];const r=this.timeSlots[s.tapIndex];setTimeout(()=>{e.index.showActionSheet({itemList:r.slots,success:c=>{this.selectedTimeSlot=r.slots[c.tapIndex],this.confirmReservation()}})},300)}})},confirmReservation(){const t=this.pendingCourses[this.currentCourseIndex];e.index.showModal(new UTSJSONObject({title:"确认预约",content:`课程：${t.name}
日期：${this.selectedDate}
时间：${this.selectedTimeSlot}`,success:s=>{s.confirm&&(this.reservedCourses.push(Object.assign(Object.assign({},t),{reservedTime:`${this.selectedDate} ${this.selectedTimeSlot}`})),this.pendingCourses.splice(this.currentCourseIndex,1),e.index.showToast({title:"预约成功",icon:"success",duration:2e3}),this.currentCourseIndex=null,this.selectedDate=null,this.selectedTimeSlot="",this.selectedTimePeriod="")}}))},completeClass(t=null){const s=this.teacherActiveCourses[t],r=new Date,c=new Date(s.classTime.replace(/-/g,"/"));if(r<c)return e.index.showModal(new UTSJSONObject({title:"无法确认下课",content:"只能在课程预约时间之后才能确认下课",showCancel:!1})),null;e.index.showModal(new UTSJSONObject({title:"添加课程回放",editable:!0,placeholderText:"请输入课程回放链接 (可选)",success:a=>{let o="";a.confirm&&a.content&&(o=a.content),e.index.showModal(new UTSJSONObject({title:"确认下课",content:`确定完成${s.studentName}的${s.name}课程吗？`,success:n=>{n.confirm&&(this.teacherCompletedCourses.push(Object.assign(Object.assign({},s),{completedTime:new Date().toISOString().split("T")[0],replayUrl:o})),this.teacherActiveCourses.splice(t,1),e.index.showToast({title:"课程已完成",icon:"success",duration:2e3}))}}))}}))},modifyReservationTime(t=null){this.currentCourseIndex=t,this.selectedDate?this.showTimeSelectionDialog():this.$refs.calendar.open()},viewFeedback(t=null){t.replayUrl?e.index.showModal(new UTSJSONObject({title:"查看回放",content:"是否跳转到课程回放网页？",success:s=>{s.confirm&&this.openExternalLink(t.replayUrl)}})):e.index.navigateTo({url:`/pages/mine/order/appraise/appraise?courseId=${t.id}&courseName=${t.name}&teacherName=${t.teacher}&price=${t.price}`})},getToday(){const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`},getNextMonth(){const t=new Date,s=new Date(t);return s.setMonth(t.getMonth()+1),`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`},loadCourseData(){e.index.__f__("log","at pagesMine/course/course.vue:683","加载课程数据，当前角色:",this.userRole),this.userRole==="teacher"?(e.index.__f__("log","at pagesMine/course/course.vue:687","加载老师课程数据"),this.initTeacherData(),this.teacherCurrentTab=0):(e.index.__f__("log","at pagesMine/course/course.vue:693","加载学生课程数据"),this.initStudentData(),this.currentTab=0)},onTeacherTabChange(t=null){e.index.__f__("log","at pagesMine/course/course.vue:704","老师模式标签切换:",t),this.teacherCurrentTab=t,t===0?e.index.__f__("log","at pagesMine/course/course.vue:710","切换到老师-待接受课程标签"):t===1?e.index.__f__("log","at pagesMine/course/course.vue:713","切换到老师-进行中课程标签"):t===2&&e.index.__f__("log","at pagesMine/course/course.vue:716","切换到老师-已完成课程标签")},initTeacherData(){e.index.__f__("log","at pagesMine/course/course.vue:722","初始化教师数据"),this.teacherPendingCourses=[{id:101,name:"考研政治精讲班",studentName:"张同学",price:399,image:"/static/images/default_avatar.png"},{id:102,name:"考研数学基础班",studentName:"李同学",price:499,image:"/static/images/default_avatar.png"}],this.teacherActiveCourses=[{id:103,name:"考研英语词汇班",studentName:"王同学",price:349,classTime:"2023-12-20 15:00",image:"/static/images/default_avatar.png"}],this.teacherCompletedCourses=[{id:104,name:"计算机专业课辅导",studentName:"赵同学",price:549,completedTime:"2023-12-10",image:"/static/images/default_avatar.png",replayUrl:"https://meeting.tencent.com/v2/cloud-record/share?id=9a0c7f38-5e12-4d1d-a53e-94ed126aa3bb&from=3"}]},teacherReserve(t=null){this.currentCourseIndex=t,this.$refs.teacherCalendar.open()},onTeacherCalendarConfirm(t=null){this.selectedDate=t.fulldate,this.$nextTick(()=>{this.showTeacherTimeSelectionDialog()})},showTeacherTimeSelectionDialog(){const t=this.timeSlots.map(s=>s.period);e.index.showActionSheet({itemList:t,success:s=>{this.selectedTimePeriod=t[s.tapIndex];const r=this.timeSlots[s.tapIndex];setTimeout(()=>{e.index.showActionSheet({itemList:r.slots,success:c=>{this.selectedTimeSlot=r.slots[c.tapIndex],this.confirmTeacherReservation()}})},300)}})},confirmTeacherReservation(){const t=this.teacherPendingCourses[this.currentCourseIndex];e.index.showModal(new UTSJSONObject({title:"确认发起预约",content:`课程：${t.name}
学生：${t.studentName}
日期：${this.selectedDate}
时间：${this.selectedTimeSlot}`,success:s=>{s.confirm&&(this.sendReservationToStudent(t),this.teacherPendingCourses.splice(this.currentCourseIndex,1),e.index.showToast({title:"预约已发送",icon:"success",duration:2e3}),this.currentCourseIndex=null,this.selectedDate=null,this.selectedTimeSlot="",this.selectedTimePeriod="")}}))},sendReservationToStudent(t=null){e.index.__f__("log","at pagesMine/course/course.vue:846","发送预约信息到学生:",t.studentName);const s=getApp().globalData||new UTSJSONObject({});s.studentReservations||(s.studentReservations=[]),s.studentReservations.push(new UTSJSONObject({id:Date.now(),name:t.name,teacher:"我",time:`${this.selectedDate} ${this.selectedTimeSlot}`,price:t.price,image:t.image||"/static/images/default_avatar.png",description:`由老师发起的预约：${t.name}`,studentName:t.studentName})),this.teacherActiveCourses.push(Object.assign(Object.assign({},t),{classTime:`${this.selectedDate} ${this.selectedTimeSlot}`}))},viewClassFeedback(t=null){t.replayUrl?e.index.showModal(new UTSJSONObject({title:"查看回放",content:"是否跳转到课程回放网页？",success:s=>{s.confirm&&this.openExternalLink(t.replayUrl)}})):e.index.showModal(new UTSJSONObject({title:"学生评价",content:`${t.studentName}对本课程的评价：
非常棒的课程，讲解清晰，收获很多！`,showCancel:!1}))},getRandomFutureTime(){const t=new Date,s=new Date(t.getTime()+(1+Math.floor(Math.random()*7))*24*60*60*1e3),r=s.getFullYear(),c=String(s.getMonth()+1).padStart(2,"0"),a=String(s.getDate()).padStart(2,"0"),o=["09","10","14","15","16","19","20"][Math.floor(Math.random()*7)],n=["00","30"][Math.floor(Math.random()*2)];return`${r}-${c}-${a} ${o}:${n}`},openExternalLink(t=null){e.index.navigateTo({url:`/pages/webview/webview?url=${encodeURIComponent(t)}`}),e.index.__f__("log","at pagesMine/course/course.vue:932","跳转到外部链接:",t)},confirmClassEnd(t=null){const s=this.reservedCourses[t],r=new Date,c=new Date(s.reservedTime.replace(/-/g,"/"));if(r<c)return e.index.showModal(new UTSJSONObject({title:"无法确认下课",content:"只能在课程预约时间之后才能确认下课",showCancel:!1})),null;e.index.showModal(new UTSJSONObject({title:"确认下课",content:"确定要确认下课吗？",success:a=>{a.confirm&&(this.completedCourses.push(Object.assign(Object.assign({},s),{completedTime:new Date().toISOString().split("T")[0]})),this.reservedCourses.splice(t,1),e.index.showToast({title:"已确认下课",icon:"success",duration:2e3}))}}))},initStudentData(){e.index.__f__("log","at pagesMine/course/course.vue:979","初始化学生数据");const t=getApp().globalData||new UTSJSONObject({});t.studentReservations&&t.studentReservations.length>0&&(e.index.__f__("log","at pagesMine/course/course.vue:987","发现老师发起的预约:",t.studentReservations.length),t.studentReservations.forEach((s=null)=>{this.pendingCourses.some(c=>c.id===s.id)||this.pendingCourses.unshift({id:s.id,name:s.name,teacher:s.teacher,time:s.time,price:s.price,image:s.image,description:s.description,isTeacherReservation:!0})}),t.studentReservations=[])},acceptReservation(t=null){const s=this.pendingCourses[t];e.index.showModal(new UTSJSONObject({title:"接受预约",content:`确认接受${s.teacher}的预约吗？
课程：${s.name}
时间：${s.time}`,success:r=>{r.confirm&&(this.reservedCourses.push(Object.assign(Object.assign({},s),{reservedTime:s.time})),this.pendingCourses.splice(t,1),e.index.showToast({title:"已接受预约",icon:"success",duration:2e3}))}}))}}});if(!Array){const t=e.resolveComponent("uni-calendar"),s=e.resolveComponent("top-navbar");(t+s)()}const m=()=>"../../uni_modules/uni-calendar/components/uni-calendar/uni-calendar.js",p=()=>"../../components/top-navbar/top-navbar2.js";Math||(m+p)();function f(t,s,r,c,a,o){return e.e({a:a.userRole==="student"?"我的课程":"教师课程",b:e.o((...n)=>o.goBack&&o.goBack(...n)),c:a.userRole==="student"},a.userRole==="student"?e.e({d:a.selectedDate},a.selectedDate?{e:e.t(a.selectedDate),f:e.o((...n)=>o.resetDateSelection&&o.resetDateSelection(...n))}:{},{g:e.f(a.pendingCourses,(n,i,u)=>e.e({a:e.t(n.name),b:e.t(n.teacher),c:e.t(n.time),d:n.isTeacherReservation},n.isTeacherReservation?{e:e.t(n.time)}:{},{f:n.isTeacherReservation},n.isTeacherReservation?{g:e.o(l=>o.acceptReservation(i),i)}:{h:e.o(l=>o.handleReserve(i),i)},{i})),h:a.pendingCourses.length===0},a.pendingCourses.length===0?{}:{},{i:e.sr("calendar","77c0ede1-1,77c0ede1-0"),j:e.o(o.onCalendarConfirm),k:e.p({insert:!1,"start-date":o.getToday(),"end-date":o.getNextMonth()}),l:e.f(a.reservedCourses,(n,i,u)=>({a:e.t(n.name),b:e.t(n.teacher),c:e.t(n.reservedTime),d:e.o(l=>o.confirmClassEnd(i),i),e:e.o(l=>o.modifyReservationTime(i),i),f:i})),m:a.reservedCourses.length===0},a.reservedCourses.length===0?{}:{},{n:e.f(a.completedCourses,(n,i,u)=>e.e({a:e.t(n.name),b:e.t(n.teacher),c:e.t(n.reservedTime||"无数据"),d:e.t(n.completedTime),e:n.rating},n.rating?{f:e.f(5,(l,_,S)=>({a:e.t(l<=n.rating?"★":"☆"),b:l}))}:{},{g:e.o(l=>o.viewFeedback(n),i),h:i})),o:a.completedCourses.length===0},a.completedCourses.length===0?{}:{},{p:e.o(o.onTabChange),q:e.p({navHeight:60,userRole:a.userRole})}):e.e({r:e.f(a.teacherPendingCourses,(n,i,u)=>e.e({a:e.t(n.name),b:e.t(n.studentName||"暂无"),c:n.time},n.time?{d:e.t(n.time)}:{},{e:e.o(l=>o.teacherReserve(i),i),f:i})),s:a.teacherPendingCourses.length===0},a.teacherPendingCourses.length===0?{}:{},{t:e.sr("teacherCalendar","77c0ede1-3,77c0ede1-2"),v:e.o(o.onTeacherCalendarConfirm),w:e.p({insert:!1,"start-date":o.getToday(),"end-date":o.getNextMonth()}),x:e.f(a.teacherActiveCourses,(n,i,u)=>({a:e.t(n.name),b:e.t(n.studentName||"暂无"),c:e.t(n.classTime),d:e.o(l=>o.completeClass(i),i),e:e.o(l=>t.rescheduleClass(i),i),f:i})),y:a.teacherActiveCourses.length===0},a.teacherActiveCourses.length===0?{}:{},{z:e.f(a.teacherCompletedCourses,(n,i,u)=>e.e({a:e.t(n.name),b:e.t(n.studentName||"暂无"),c:n.classTime},n.classTime?{d:e.t(n.classTime)}:{},{e:e.t(n.completedTime),f:e.o(l=>o.viewClassFeedback(n),i),g:i})),A:a.teacherCompletedCourses.length===0},a.teacherCompletedCourses.length===0?{}:{},{B:e.o(o.onTeacherTabChange),C:e.p({navHeight:60,userRole:a.userRole})}),{D:e.sei(e.gei(t,""),"view")})}const T=e._export_sfc(g,[["render",f]]);wx.createPage(T);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pagesMine/course/course.js.map
