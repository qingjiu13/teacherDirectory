"use strict";const t=require("../../common/vendor.js"),r=require("../../router/Router.js"),_=require("../../store/index.js"),n=require("../../common/assets.js"),u=()=>"../../components/tab-bar/tab-bar.js",d=()=>"../../components/loading/LoadingAnimation.js",l=t.defineComponent({components:{TabBar:u,LoadingAnimation:d},data(){return{userData:new UTSJSONObject({}),isLoggedIn:_.store.getters["user/baseInfo/id"]!=="",isLoading:!1,isDebug:!0}},computed:Object.assign({},t.mapState("user/baseInfo",{storeId:(e=null)=>e.id,storeAvatar:(e=null)=>e.avatar,storeName:(e=null)=>e.name,storeGender:(e=null)=>e.gender,storeRole:(e=null)=>{var o;return((o=e.userInfo)===null||o===void 0?null:o.role)||"学生"},storeCertificate:(e=null)=>{var o;return((o=e.userInfo)===null||o===void 0?null:o.certificate)||0},storeCampusAmbassador:(e=null)=>e.campusAmbassador})),onLoad(){return t.__awaiter(this,void 0,void 0,function*(){t.index.__f__("log","at pagesMine/mine/mine_common.vue:129","mine_common.vue onLoad开始执行");try{yield this.$nextTick(),this.initFromStore(),yield this.loadUserData(),t.index.__f__("log","at pagesMine/mine/mine_common.vue:140","mine_common.vue onLoad执行完成，userData:",UTS.JSON.stringify(this.userData)),t.index.__f__("log","at pagesMine/mine/mine_common.vue:141","store中的name值:",this.storeName)}catch(e){t.index.__f__("error","at pagesMine/mine/mine_common.vue:143","onLoad错误:",e)}})},onShow(){return t.__awaiter(this,void 0,void 0,function*(){t.index.__f__("log","at pagesMine/mine/mine_common.vue:148","mine_common.vue onShow开始执行");try{yield this.$nextTick(),t.index.__f__("log","at pagesMine/mine/mine_common.vue:154","onShow检查store数据:",new UTSJSONObject({storeName:this.storeName,storeAvatar:this.storeAvatar})),this.initFromStore();const e=t.index.getStorageSync("userRole");e&&(yield this.updateUserRole(e)),!this.userData.name&&!this.storeName&&(t.index.__f__("log","at pagesMine/mine/mine_common.vue:170","用户数据为空，尝试重新加载"),yield this.loadUserData()),t.index.__f__("log","at pagesMine/mine/mine_common.vue:174","mine_common.vue onShow执行完成，userData:",UTS.JSON.stringify(this.userData))}catch(e){t.index.__f__("error","at pagesMine/mine/mine_common.vue:176","onShow错误:",e)}})},methods:{initFromStore(){t.index.__f__("log","at pagesMine/mine/mine_common.vue:185","initFromStore - 从store直接获取数据"),t.index.__f__("log","at pagesMine/mine/mine_common.vue:186","store中的数据:",new UTSJSONObject({id:this.storeId,name:this.storeName,avatar:this.storeAvatar,role:this.storeRole})),this.storeName?(this.userData=new UTSJSONObject({id:this.storeId,avatar:this.storeAvatar,name:this.storeName,gender:this.storeGender}),this.isLoggedIn=!0,t.index.__f__("log","at pagesMine/mine/mine_common.vue:202","从store初始化userData成功:",this.userData)):t.index.__f__("log","at pagesMine/mine/mine_common.vue:204","store中没有用户数据")},updateUserRole(e=null){return t.__awaiter(this,void 0,void 0,function*(){try{t.index.__f__("log","at pagesMine/mine/mine_common.vue:214","更新用户角色:",e),this.$store?(yield this.$store.dispatch("user/baseInfo/updateRole",e),t.index.__f__("log","at pagesMine/mine/mine_common.vue:218","角色更新成功, 新角色:",this.storeRole)):(t.index.__f__("warn","at pagesMine/mine/mine_common.vue:220","$store不可用，直接使用本地存储"),t.index.setStorageSync("userRole",e))}catch(o){t.index.__f__("error","at pagesMine/mine/mine_common.vue:224","更新用户角色失败",o),t.index.setStorageSync("userRole",e)}})},loadUserData(){return t.__awaiter(this,void 0,void 0,function*(){t.index.__f__("log","at pagesMine/mine/mine_common.vue:234","loadUserData 开始执行"),this.isLoading=!0;try{if(this.$store){t.index.__f__("log","at pagesMine/mine/mine_common.vue:239","使用Vuex获取用户数据");const e=yield this.$store.dispatch("user/baseInfo/getUserInfo");t.index.__f__("log","at pagesMine/mine/mine_common.vue:243","getUserInfo返回结果:",e),t.index.__f__("log","at pagesMine/mine/mine_common.vue:246","store中的数据是否更新:",new UTSJSONObject({storeName:this.storeName})),this.initFromStore(),!this.userData.name&&e?(t.index.__f__("log","at pagesMine/mine/mine_common.vue:255","使用API返回的结果更新userData"),this.userData=new UTSJSONObject({id:e.id||"",avatar:e.avatar||"",name:e.name||e.nickname||"",gender:e.gender||""}),this.isLoggedIn=!!this.userData.name,t.index.setStorageSync("userData",UTS.JSON.stringify(this.userData)),t.index.__f__("log","at pagesMine/mine/mine_common.vue:266","更新userData成功:",this.userData)):this.userData.name||(t.index.__f__("log","at pagesMine/mine/mine_common.vue:268","尝试从本地存储恢复数据"),this.recoverFromLocalStorage())}else t.index.__f__("warn","at pagesMine/mine/mine_common.vue:272","$store不可用，从本地存储加载"),this.recoverFromLocalStorage()}catch(e){t.index.__f__("error","at pagesMine/mine/mine_common.vue:276","加载用户数据失败",e),this.recoverFromLocalStorage()}finally{this.isLoading=!1,t.index.__f__("log","at pagesMine/mine/mine_common.vue:280","loadUserData 执行完成, userData:",this.userData)}})},recoverFromLocalStorage(){t.index.__f__("log","at pagesMine/mine/mine_common.vue:288","从本地存储恢复数据");const e=t.index.getStorageSync("userData");if(e)try{const o=UTS.JSON.parse(e);this.userData=new UTSJSONObject({id:o.id||"",avatar:o.avatar||"",name:o.name||"",gender:o.gender||""}),this.isLoggedIn=!!this.userData.name,t.index.__f__("log","at pagesMine/mine/mine_common.vue:300","从userData恢复成功:",this.userData)}catch(o){t.index.__f__("error","at pagesMine/mine/mine_common.vue:302","解析本地用户数据失败",o)}if(!this.userData.name){const o=t.index.getStorageSync("userBaseInfo");if(o)try{const s=UTS.JSON.parse(o);this.userData=new UTSJSONObject({id:s.id||"",avatar:s.avatar||"",name:s.name||"",gender:s.gender||""}),this.isLoggedIn=!!this.userData.name,t.index.__f__("log","at pagesMine/mine/mine_common.vue:319","从userBaseInfo恢复成功:",this.userData)}catch(s){t.index.__f__("error","at pagesMine/mine/mine_common.vue:321","解析userBaseInfo失败",s)}else t.index.__f__("log","at pagesMine/mine/mine_common.vue:324","本地存储中没有用户数据")}},handleClick(){this.isLoggedIn||r.Navigator.toWechatLogin()},navigateTo(e=null){r.Navigator.navigateTo(e)},toOrderCommon(){r.Navigator.toOrderCommon()},toCourse(){r.Navigator.toCourse()},toQualification(){r.Navigator.toQualification()},toBill(){r.Navigator.toBill()},toSettings(){r.Navigator.toSettings()},toService(){r.Navigator.toService()},handleContactUs(){r.Navigator.toChat(1)}}});if(!Array){const e=t.resolveComponent("loading-animation"),o=t.resolveComponent("TabBar");(e+o)()}function g(e,o,s,h,m,a){return t.e({a:m.isLoading},m.isLoading?{b:t.p({src:"https://lottie.host/1f64310d-d1a9-44c9-ac77-3c29ae849559/c3yfKGAzCm.json",width:"150rpx",height:"150rpx",showText:!0,text:"加载中..."})}:{},{c:n._imports_0$4,d:e.storeCampusAmbassador&&e.storeRole==="老师"},e.storeCampusAmbassador&&e.storeRole==="老师"?{e:n._imports_1$3}:{},{f:m.userData.avatar||e.storeAvatar||"/static/image/defaultAvatar/teacher-man.png",g:t.o((...i)=>a.handleClick&&a.handleClick(...i)),h:t.t(m.userData.name||e.storeName||"登录"),i:t.o((...i)=>a.handleClick&&a.handleClick(...i)),j:e.storeRole==="老师"},e.storeRole==="老师"?{k:n._imports_2$4}:{},{l:e.storeRole==="学生"},e.storeRole==="学生"?{m:n._imports_3$5}:{},{n:e.storeCertificate===1&&e.storeRole==="老师"},e.storeCertificate===1&&e.storeRole==="老师"?{o:n._imports_2$3}:{},{p:e.storeCertificate===0&&e.storeRole==="老师"},e.storeCertificate===0&&e.storeRole==="老师"?{q:n._imports_3$4}:{},{r:n._imports_6,s:t.o((...i)=>a.toOrderCommon&&a.toOrderCommon(...i)),t:n._imports_7,v:t.o((...i)=>a.toCourse&&a.toCourse(...i)),w:n._imports_8,x:t.o((...i)=>a.toBill&&a.toBill(...i)),y:n._imports_9,z:t.o((...i)=>a.handleContactUs&&a.handleContactUs(...i)),A:e.storeRole==="老师"},e.storeRole==="老师"?{B:n._imports_10,C:n._imports_11,D:t.o((...i)=>a.toService&&a.toService(...i))}:{},{E:e.storeRole==="老师"&&e.storeCertificate===0},e.storeRole==="老师"&&e.storeCertificate===0?{F:n._imports_12,G:n._imports_11,H:t.o((...i)=>a.toQualification&&a.toQualification(...i))}:{},{I:n._imports_13,J:n._imports_11,K:t.o((...i)=>a.toSettings&&a.toSettings(...i)),L:t.p({pageName:"mine"})})}const c=t._export_sfc(l,[["render",g]]);wx.createPage(c);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pagesMine/mine/mine_common.js.map
