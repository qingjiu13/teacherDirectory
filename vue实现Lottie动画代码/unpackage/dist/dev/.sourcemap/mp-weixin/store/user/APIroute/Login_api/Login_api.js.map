{"version":3,"file":"Login_api.js","sources":["store/user/APIroute/Login_api/Login_api.js"],"sourcesContent":["/**\r\n * @description 用户登录相关API函数\r\n * @module store/user/APIroute/Login_api\r\n */\r\n\r\nimport { \r\n  LOGIN_WETHER_SIGN_IN_URL, \r\n  LOGIN_URL, \r\n  LOGIN_SIGN_IN_URL \r\n} from '../../API.js';\r\n\r\n/**\r\n * @description 判断用户是否注册过\r\n * @param {Object} options - 请求选项\r\n * @param {string} options.code - 微信登录返回的临时code\r\n * @param {Function} options.success - 成功回调\r\n * @param {Function} options.fail - 失败回调\r\n * @param {Function} options.complete - 完成回调\r\n * @returns {Promise} - 如果不传回调函数，则返回Promise\r\n */\r\nexport const checkUserRegistration = (options = {}) => {\r\n  const { code, success, fail, complete } = options;\r\n  \r\n  // 参数验证\r\n  if (!code) {\r\n    const error = '缺少必要参数：code';\r\n    if (typeof fail === 'function') {\r\n      fail({ errMsg: error });\r\n    }\r\n    if (typeof complete === 'function') {\r\n      complete({ errMsg: error });\r\n    }\r\n    return Promise.reject(new Error(error));\r\n  }\r\n  \r\n  // 构建请求\r\n  const requestTask = uni.request({\r\n    url: LOGIN_WETHER_SIGN_IN_URL,\r\n    method: 'POST',\r\n    data: { code },\r\n    header: {\r\n      'content-type': 'application/json'\r\n    }\r\n  });\r\n  \r\n  // 如果传入了回调函数，使用回调处理结果\r\n  if (typeof success === 'function' || typeof fail === 'function' || typeof complete === 'function') {\r\n    requestTask.then(response => {\r\n      // 状态码检查\r\n      if (response.statusCode === 200) {\r\n        if (typeof success === 'function') {\r\n          success(response.data);\r\n        }\r\n      } else {\r\n        if (typeof fail === 'function') {\r\n          fail({\r\n            errMsg: '接口请求失败',\r\n            errCode: response.statusCode,\r\n            data: response.data\r\n          });\r\n        }\r\n      }\r\n    }).catch(error => {\r\n      if (typeof fail === 'function') {\r\n        fail({ errMsg: '网络请求失败', error });\r\n      }\r\n    }).finally(() => {\r\n      if (typeof complete === 'function') {\r\n        complete();\r\n      }\r\n    });\r\n    \r\n    return requestTask;\r\n  }\r\n  \r\n  // 如果没有回调函数，返回处理后的Promise\r\n  return requestTask.then(response => {\r\n    if (response.statusCode === 200) {\r\n      return response.data;\r\n    } else {\r\n      throw {\r\n        errMsg: '接口请求失败',\r\n        errCode: response.statusCode,\r\n        data: response.data\r\n      };\r\n    }\r\n  });\r\n};\r\n\r\n/**\r\n * @description 验证用户登录状态\r\n * @param {Object} options - 请求选项\r\n * @param {Function} options.success - 成功回调\r\n * @param {Function} options.fail - 失败回调\r\n * @param {Function} options.complete - 完成回调\r\n * @returns {Promise} - 如果不传回调函数，则返回Promise\r\n */\r\nexport const verifyLoginStatus = (options = {}) => {\r\n  const { success, fail, complete } = options;\r\n  \r\n  // 检查本地是否存在token\r\n  const token = uni.getStorageSync('token');\r\n  if (!token) {\r\n    const error = { errMsg: '未登录，本地不存在token' };\r\n    if (typeof fail === 'function') {\r\n      fail(error);\r\n    }\r\n    if (typeof complete === 'function') {\r\n      complete();\r\n    }\r\n    return Promise.reject(error);\r\n  }\r\n  \r\n  // 构建请求，携带token到后端验证\r\n  const requestTask = uni.request({\r\n    url: LOGIN_URL,\r\n    method: 'POST',\r\n    header: {\r\n      'content-type': 'application/json',\r\n      'Authorization': `Bearer ${token}`\r\n    }\r\n  });\r\n  \r\n  // 如果传入了回调函数，使用回调处理结果\r\n  if (typeof success === 'function' || typeof fail === 'function' || typeof complete === 'function') {\r\n    requestTask.then(response => {\r\n      if (response.statusCode === 200) {\r\n        if (typeof success === 'function') {\r\n          success(response.data);\r\n        }\r\n      } else {\r\n        // 401表示token无效或过期\r\n        if (response.statusCode === 401) {\r\n          // 清除本地无效token\r\n          uni.removeStorageSync('token');\r\n        }\r\n        \r\n        if (typeof fail === 'function') {\r\n          fail({\r\n            errMsg: '登录状态验证失败',\r\n            errCode: response.statusCode,\r\n            data: response.data\r\n          });\r\n        }\r\n      }\r\n    }).catch(error => {\r\n      if (typeof fail === 'function') {\r\n        fail({ errMsg: '网络请求失败', error });\r\n      }\r\n    }).finally(() => {\r\n      if (typeof complete === 'function') {\r\n        complete();\r\n      }\r\n    });\r\n    \r\n    return requestTask;\r\n  }\r\n  \r\n  // 如果没有回调函数，返回处理后的Promise\r\n  return requestTask.then(response => {\r\n    if (response.statusCode === 200) {\r\n      return response.data;\r\n    } else {\r\n      // 401表示token无效或过期\r\n      if (response.statusCode === 401) {\r\n        // 清除本地无效token\r\n        uni.removeStorageSync('token');\r\n      }\r\n      \r\n      throw {\r\n        errMsg: '登录状态验证失败',\r\n        errCode: response.statusCode,\r\n        data: response.data\r\n      };\r\n    }\r\n  });\r\n};\r\n\r\n/**\r\n * @description 新用户注册\r\n * @param {Object} options - 请求选项\r\n * @param {string} options.code - 微信登录临时code\r\n * @param {string} [options.encryptedData] - 微信加密数据\r\n * @param {string} [options.iv] - 加密算法的初始向量\r\n * @param {string} [options.avatarUrl] - 用户头像URL\r\n * @param {string} [options.nickName] - 用户昵称\r\n * @param {string} [options.gender] - 用户性别\r\n * @param {string} [options.school] - 用户学校\r\n * @param {string} [options.major] - 用户专业\r\n * @param {string} [options.targetSchool] - 目标学校\r\n * @param {string} [options.targetMajor] - 目标专业\r\n * @param {Function} options.success - 成功回调\r\n * @param {Function} options.fail - 失败回调\r\n * @param {Function} options.complete - 完成回调\r\n * @returns {Promise} - 如果不传回调函数，则返回Promise\r\n */\r\nexport const registerUser = (options = {}) => {\r\n  const { \r\n    code, \r\n    encryptedData, \r\n    iv, \r\n    avatarUrl, \r\n    nickName, \r\n    gender, \r\n    school, \r\n    major, \r\n    targetSchool, \r\n    targetMajor,\r\n    success, \r\n    fail, \r\n    complete \r\n  } = options;\r\n  \r\n  // 参数验证\r\n  if (!code) {\r\n    const error = '缺少必要参数：code';\r\n    if (typeof fail === 'function') {\r\n      fail({ errMsg: error });\r\n    }\r\n    if (typeof complete === 'function') {\r\n      complete();\r\n    }\r\n    return Promise.reject(new Error(error));\r\n  }\r\n  \r\n  // 构建请求数据\r\n  const requestData = {\r\n    code,\r\n    // 只添加有值的字段\r\n    ...(encryptedData && { encryptedData }),\r\n    ...(iv && { iv }),\r\n    ...(avatarUrl && { avatarUrl }),\r\n    ...(nickName && { nickName }),\r\n    ...(gender && { gender }),\r\n    ...(school && { school }),\r\n    ...(major && { major }),\r\n    ...(targetSchool && { targetSchool }),\r\n    ...(targetMajor && { targetMajor })\r\n  };\r\n  \r\n  // 发送注册请求\r\n  const requestTask = uni.request({\r\n    url: LOGIN_SIGN_IN_URL,\r\n    method: 'POST',\r\n    data: requestData,\r\n    header: {\r\n      'content-type': 'application/json'\r\n    }\r\n  });\r\n  \r\n  // 如果传入了回调函数，使用回调处理结果\r\n  if (typeof success === 'function' || typeof fail === 'function' || typeof complete === 'function') {\r\n    requestTask.then(response => {\r\n      if (response.statusCode === 200) {\r\n        // 注册成功，保存token\r\n        if (response.data && response.data.token) {\r\n          uni.setStorageSync('token', response.data.token);\r\n        }\r\n        \r\n        if (typeof success === 'function') {\r\n          success(response.data);\r\n        }\r\n      } else {\r\n        if (typeof fail === 'function') {\r\n          fail({\r\n            errMsg: '注册失败',\r\n            errCode: response.statusCode,\r\n            data: response.data\r\n          });\r\n        }\r\n      }\r\n    }).catch(error => {\r\n      if (typeof fail === 'function') {\r\n        fail({ errMsg: '网络请求失败', error });\r\n      }\r\n    }).finally(() => {\r\n      if (typeof complete === 'function') {\r\n        complete();\r\n      }\r\n    });\r\n    \r\n    return requestTask;\r\n  }\r\n  \r\n  // 如果没有回调函数，返回处理后的Promise\r\n  return requestTask.then(response => {\r\n    if (response.statusCode === 200) {\r\n      // 注册成功，保存token\r\n      if (response.data && response.data.token) {\r\n        uni.setStorageSync('token', response.data.token);\r\n      }\r\n      \r\n      return response.data;\r\n    } else {\r\n      throw {\r\n        errMsg: '注册失败',\r\n        errCode: response.statusCode,\r\n        data: response.data\r\n      };\r\n    }\r\n  });\r\n};\r\n\r\n// ===================== 学校和专业搜索相关API =====================\r\n\r\n/**\r\n * @description 搜索本科学校列表\r\n * @param {Object} params - 请求参数\r\n * @param {string} params.userId - 用户ID\r\n * @param {string} params.keyword - 搜索关键词\r\n * @returns {Promise} 返回学校搜索结果\r\n */\r\nexport const searchUndergraduateSchools = (params) => {\r\n  return new Promise((resolve, reject) => {\r\n    uni.request({\r\n      url: `${LOGIN_URL}/undergraduate/school/search`,\r\n      method: 'POST',\r\n      data: {\r\n        userId: params.userId,\r\n        keyword: params.keyword\r\n      },\r\n      success: (res) => {\r\n        if (res.statusCode === 200) {\r\n          resolve(res.data);\r\n        } else {\r\n          reject(res);\r\n        }\r\n      },\r\n      fail: (err) => {\r\n        reject(err);\r\n      }\r\n    });\r\n  });\r\n};\r\n\r\n/**\r\n * @description 搜索本科专业列表\r\n * @param {Object} params - 请求参数\r\n * @param {string} params.userId - 用户ID\r\n * @param {string} params.keyword - 搜索关键词\r\n * @returns {Promise} 返回专业搜索结果\r\n */\r\nexport const searchUndergraduateMajors = (params) => {\r\n  return new Promise((resolve, reject) => {\r\n    uni.request({\r\n      url: `${LOGIN_URL}/undergraduate/major/search`,\r\n      method: 'POST',\r\n      data: {\r\n        userId: params.userId,\r\n        keyword: params.keyword\r\n      },\r\n      success: (res) => {\r\n        if (res.statusCode === 200) {\r\n          resolve(res.data);\r\n        } else {\r\n          reject(res);\r\n        }\r\n      },\r\n      fail: (err) => {\r\n        reject(err);\r\n      }\r\n    });\r\n  });\r\n};\r\n\r\n/**\r\n * @description 搜索研究生学校列表\r\n * @param {Object} params - 请求参数\r\n * @param {string} params.userId - 用户ID\r\n * @param {string} params.keyword - 搜索关键词\r\n * @param {number} params.currentPage - 当前页码\r\n * @param {number} params.pageSize - 每页数量\r\n * @returns {Promise} 返回学校搜索结果\r\n */\r\nexport const searchGraduateSchools = (params) => {\r\n  return new Promise((resolve, reject) => {\r\n    uni.request({\r\n      url: `${LOGIN_URL}/graduate/school/search`,\r\n      method: 'POST',\r\n      data: {\r\n        userId: params.userId,\r\n        keyword: params.keyword,\r\n        currentPage: params.currentPage,\r\n        pageSize: params.pageSize\r\n      },\r\n      success: (res) => {\r\n        if (res.statusCode === 200) {\r\n          resolve(res.data);\r\n        } else {\r\n          reject(res);\r\n        }\r\n      },\r\n      fail: (err) => {\r\n        reject(err);\r\n      }\r\n    });\r\n  });\r\n};\r\n\r\n/**\r\n * @description 根据学校ID搜索研究生专业列表\r\n * @param {Object} params - 请求参数\r\n * @param {string} params.userId - 用户ID\r\n * @param {number} params.schoolId - 学校ID\r\n * @param {string} params.keyword - 搜索关键词\r\n * @returns {Promise} 返回专业搜索结果\r\n */\r\nexport const searchGraduateMajors = (params) => {\r\n  return new Promise((resolve, reject) => {\r\n    uni.request({\r\n      url: `${LOGIN_URL}/graduate/major/search`,\r\n      method: 'POST',\r\n      data: {\r\n        userId: params.userId,\r\n        schoolId: params.schoolId,\r\n        keyword: params.keyword\r\n      },\r\n      success: (res) => {\r\n        if (res.statusCode === 200) {\r\n          resolve(res.data);\r\n        } else {\r\n          reject(res);\r\n        }\r\n      },\r\n      fail: (err) => {\r\n        reject(err);\r\n      }\r\n    });\r\n  });\r\n};\r\n"],"names":["searchUndergraduateSchools","params","resolve","reject","uni","LOGIN_URL","res","err","searchUndergraduateMajors","searchGraduateSchools","searchGraduateMajors"],"mappings":"uFAwTaA,EAA8BC,GAClC,IAAI,QAAQ,CAACC,EAASC,IAAW,CACtCC,EAAAA,MAAI,QAAQ,CACV,IAAK,GAAGC,EAAS,SAAA,+BACjB,OAAQ,OACR,KAAM,CACJ,OAAQJ,EAAO,OACf,QAASA,EAAO,OACjB,EACD,QAAUK,GAAQ,CACZA,EAAI,aAAe,IACrBJ,EAAQI,EAAI,IAAI,EAEhBH,EAAOG,CAAG,CAEb,EACD,KAAOC,GAAQ,CACbJ,EAAOI,CAAG,CACX,CACP,CAAK,CACL,CAAG,EAUUC,EAA6BP,GACjC,IAAI,QAAQ,CAACC,EAASC,IAAW,CACtCC,EAAAA,MAAI,QAAQ,CACV,IAAK,GAAGC,EAAS,SAAA,8BACjB,OAAQ,OACR,KAAM,CACJ,OAAQJ,EAAO,OACf,QAASA,EAAO,OACjB,EACD,QAAUK,GAAQ,CACZA,EAAI,aAAe,IACrBJ,EAAQI,EAAI,IAAI,EAEhBH,EAAOG,CAAG,CAEb,EACD,KAAOC,GAAQ,CACbJ,EAAOI,CAAG,CACX,CACP,CAAK,CACL,CAAG,EAYUE,EAAyBR,GAC7B,IAAI,QAAQ,CAACC,EAASC,IAAW,CACtCC,EAAAA,MAAI,QAAQ,CACV,IAAK,GAAGC,EAAS,SAAA,0BACjB,OAAQ,OACR,KAAM,CACJ,OAAQJ,EAAO,OACf,QAASA,EAAO,QAChB,YAAaA,EAAO,YACpB,SAAUA,EAAO,QAClB,EACD,QAAUK,GAAQ,CACZA,EAAI,aAAe,IACrBJ,EAAQI,EAAI,IAAI,EAEhBH,EAAOG,CAAG,CAEb,EACD,KAAOC,GAAQ,CACbJ,EAAOI,CAAG,CACX,CACP,CAAK,CACL,CAAG,EAWUG,EAAwBT,GAC5B,IAAI,QAAQ,CAACC,EAASC,IAAW,CACtCC,EAAAA,MAAI,QAAQ,CACV,IAAK,GAAGC,EAAS,SAAA,yBACjB,OAAQ,OACR,KAAM,CACJ,OAAQJ,EAAO,OACf,SAAUA,EAAO,SACjB,QAASA,EAAO,OACjB,EACD,QAAUK,GAAQ,CACZA,EAAI,aAAe,IACrBJ,EAAQI,EAAI,IAAI,EAEhBH,EAAOG,CAAG,CAEb,EACD,KAAOC,GAAQ,CACbJ,EAAOI,CAAG,CACX,CACP,CAAK,CACL,CAAG"}