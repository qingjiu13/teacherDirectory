{"version":3,"file":"actions.js","sources":["store/user/ai-chat/actions.js"],"sourcesContent":["/**\r\n * ai-chat模块的actions\r\n * @module store/user/ai-chat/actions\r\n */\r\n\r\n// 导入真实API实现\r\nimport { \r\n    sendMessageToAI, \r\n    getConversationHistory, \r\n    getConversationDetail as fetchConversationDetail, \r\n    deleteConversation \r\n} from '../APIroute/AIchat_api.js';\r\n\r\nexport default {\r\n    /**\r\n     * 设置当前活跃的聊天会话\r\n     * @param {Object} context - Vuex上下文\r\n     * @param {string} chatId - 聊天会话ID\r\n     */\r\n    setCurrentChat({ commit }, chatId) {\r\n        commit('UPDATE_CURRENT_CONVERSATION', chatId);\r\n    },\r\n    \r\n    /**\r\n     * 发送问题到AI并获取回答\r\n     * @param {Object} context - Vuex上下文\r\n     * @param {Object} payload - 请求数据\r\n     * @param {string} payload.question - 用户问题\r\n     * @param {Object} payload.contextInfo - 上下文信息\r\n     * @param {string} payload.chatId - 对话ID\r\n     * @returns {Promise<Object>} 返回请求结果\r\n     */\r\n    async sendQuestion({ commit, state }, payload) {\r\n        try {\r\n            // 构建消息数据\r\n            const messageData = {\r\n                content: payload.question,\r\n                chatMode: payload.contextInfo?.mode || state.aiChat.chatMode,\r\n                conversationId: payload.chatId || state.aiChat.activeConversation\r\n            };\r\n            \r\n            // 调用真实API\r\n            const response = await sendMessageToAI(messageData);\r\n            \r\n            // 如果API调用成功\r\n            if (response.success) {\r\n                // 更新当前会话ID\r\n                commit('UPDATE_CURRENT_CONVERSATION', response.conversationId);\r\n                \r\n                // 在本地保存问答记录\r\n                const newMessage = {\r\n                    id: `msg-${Date.now()}`,\r\n                    type: 'user',\r\n                    content: payload.question,\r\n                    timestamp: new Date().toISOString()\r\n                };\r\n                \r\n                const aiResponse = {\r\n                    id: `msg-${Date.now() + 1}`,\r\n                    type: 'ai',\r\n                    content: response.aiResponse,\r\n                    timestamp: new Date().toISOString()\r\n                };\r\n                \r\n                // 查找当前对话\r\n                const currentChat = state.aiChat.conversations.find(\r\n                    conv => conv.id === response.conversationId\r\n                );\r\n                \r\n                if (currentChat) {\r\n                    // 更新现有对话\r\n                    const updatedChat = {\r\n                        ...currentChat,\r\n                        messages: [...(currentChat.messages || []), newMessage, aiResponse],\r\n                        updatedAt: new Date().toISOString()\r\n                    };\r\n                    \r\n                    commit('UPDATE_CONVERSATION_DETAIL', updatedChat);\r\n                } else {\r\n                    // 创建新对话\r\n                    const newChat = {\r\n                        id: response.conversationId,\r\n                        abstract: payload.question.substring(0, 30) + (payload.question.length > 30 ? '...' : ''),\r\n                        chatMode: state.aiChat.chatMode,\r\n                        createdAt: new Date().toISOString(),\r\n                        updatedAt: new Date().toISOString(),\r\n                        messages: [newMessage, aiResponse]\r\n                    };\r\n                    \r\n                    commit('UPDATE_CONVERSATION_DETAIL', newChat);\r\n                }\r\n            }\r\n            \r\n            return {\r\n                success: response.success,\r\n                data: response.aiResponse,\r\n                chatId: response.conversationId,\r\n                message: response.message\r\n            };\r\n        } catch (error) {\r\n            console.error('AI问答出错:', error);\r\n            return {\r\n                success: false,\r\n                error: error.error || error,\r\n                message: error.error?.message || '请求失败'\r\n            };\r\n        }\r\n    },\r\n\r\n    \r\n    /**\r\n     * 加载特定对话的完整内容\r\n     * @param {Object} context - Vuex上下文\r\n     * @param {string} conversationId - 对话ID\r\n     * @returns {Promise<Object>} 返回请求结果\r\n     */\r\n    async loadChat({ commit }, conversationId) {\r\n        try {\r\n            // 调用真实API获取会话详情\r\n            const response = await fetchConversationDetail(conversationId);\r\n            \r\n            if (response.success) {\r\n                // 构建会话数据结构\r\n                const conversationData = {\r\n                    id: conversationId,\r\n                    messages: response.messages,\r\n                    updatedAt: new Date().toISOString()\r\n                    // 其他会话详情字段...\r\n                };\r\n                \r\n                // 更新对话详情并设置为当前活跃对话\r\n                commit('UPDATE_CONVERSATION_DETAIL', conversationData);\r\n            }\r\n            \r\n            return {\r\n                success: response.success,\r\n                data: response.messages\r\n            };\r\n        } catch (error) {\r\n            console.error('加载对话详情失败:', error);\r\n            return {\r\n                success: false,\r\n                error: error.error || error,\r\n                message: error.error?.message || '加载对话详情失败'\r\n            };\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * 保存新的对话或更新现有对话\r\n     * @param {Object} context - Vuex上下文\r\n     * @param {Object} chatData - 对话数据\r\n     * @returns {Promise<Object>} 返回操作结果\r\n     */\r\n    async saveChat({ commit, state }, chatData) {\r\n        try {\r\n            // 这里可以添加API调用来保存对话到后端\r\n            // 但对于前端演示，我们只在本地更新\r\n            \r\n            const existingConversation = state.aiChat.conversations.find(\r\n                conv => conv.id === chatData.id\r\n            );\r\n            \r\n            if (existingConversation) {\r\n                // 更新已有对话\r\n                commit('UPDATE_CONVERSATION_DETAIL', {\r\n                    ...existingConversation,\r\n                    ...chatData,\r\n                    updatedAt: new Date().toISOString()\r\n                });\r\n            } else {\r\n                // 添加新对话\r\n                const newConversation = {\r\n                    id: chatData.id,\r\n                    abstract: chatData.title || '新对话',\r\n                    chatMode: chatData.chatMode || 'general',\r\n                    createdAt: chatData.createdAt?.toISOString() || new Date().toISOString(),\r\n                    updatedAt: chatData.updatedAt?.toISOString() || new Date().toISOString(),\r\n                    messages: chatData.messages || []\r\n                };\r\n                \r\n                commit('UPDATE_CONVERSATION_DETAIL', newConversation);\r\n            }\r\n            \r\n            return { success: true };\r\n        } catch (error) {\r\n            console.error('保存对话失败:', error);\r\n            return {\r\n                success: false,\r\n                message: '保存对话失败'\r\n            };\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * 删除指定的对话\r\n     * @param {Object} context - Vuex上下文\r\n     * @param {string} conversationId - 对话ID\r\n     * @returns {Promise<Object>} 返回操作结果\r\n     */\r\n    async deleteChat({ commit, state }, conversationId) {\r\n        try {\r\n            // 调用真实API从后端删除对话\r\n            const response = await deleteConversation(conversationId);\r\n            \r\n            if (response.success) {\r\n                // 从本地会话列表中移除\r\n                commit('DELETE_CONVERSATION', conversationId);\r\n                \r\n                // 如果删除的是当前活跃会话，则清空当前活跃会话\r\n                if (state.aiChat.activeConversation === conversationId) {\r\n                    commit('UPDATE_CURRENT_CONVERSATION', null);\r\n                }\r\n            }\r\n            \r\n            return { \r\n                success: response.success,\r\n                message: response.message || (response.success ? '删除成功' : '删除失败')\r\n            };\r\n        } catch (error) {\r\n            console.error('删除对话失败:', error);\r\n            return {\r\n                success: false,\r\n                error: error.error || error,\r\n                message: error.error?.message || '删除对话失败'\r\n            };\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * 获取对话历史列表\r\n     * @param {Object} context - Vuex上下文\r\n     * @returns {Promise<Object>} 返回请求结果\r\n     */\r\n    async loadConversationHistory({ commit }) {\r\n        try {\r\n            // 调用真实API获取对话历史\r\n            const response = await getConversationHistory();\r\n            \r\n            if (response.success && response.conversations) {\r\n                // 更新会话列表\r\n                commit('SET_CONVERSATIONS', response.conversations);\r\n            }\r\n            \r\n            return {\r\n                success: response.success,\r\n                data: response.conversations\r\n            };\r\n        } catch (error) {\r\n            console.error('获取对话历史失败:', error);\r\n            return {\r\n                success: false,\r\n                error: error.error || error,\r\n                message: error.error?.message || '获取对话历史失败'\r\n            };\r\n        }\r\n    }\r\n};"],"names":["sendMessageToAI","uni","fetchConversationDetail","deleteConversation","getConversationHistory"],"mappings":"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"}