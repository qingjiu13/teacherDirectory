{"version":3,"file":"friendStore.js","sources":["pagesChat/store/friendStore.js"],"sourcesContent":["import { defineStore } from 'pinia';\nimport http from '../common/request'\nimport { TERMINAL_TYPE } from '../common/enums.js'\n\nexport default defineStore('friendStore', {\n\tstate: () => {\n\t\treturn {\n\t\t\tfriends: [],\n\t\t\ttimer: null\n\t\t}\n\t},\n\tactions: {\n\t\tsetFriends(friends) {\n\t\t\tfriends.forEach((f) => {\n\t\t\t\tf.online = false;\n\t\t\t\tf.onlineWeb = false;\n\t\t\t\tf.onlineApp = false;\n\t\t\t})\n\t\t\tthis.friends = friends;\n\t\t},\n\t\tupdateFriend(friend) {\n\t\t\tlet f = this.findFriend(friend.id);\n\t\t\tlet copy = JSON.parse(JSON.stringify(f));\n\t\t\tObject.assign(f, friend);\n\t\t\tf.online = copy.online;\n\t\t\tf.onlineWeb = copy.onlineWeb;\n\t\t\tf.onlineApp = copy.onlineApp;\n\t\t},\n\t\tremoveFriend(id) {\n\t\t\tthis.friends.filter(f => f.id == id).forEach(f => f.deleted = true);\n\t\t},\n\t\taddFriend(friend) {\n\t\t\tif (this.friends.some((f) => f.id == friend.id)) {\n\t\t\t\tthis.updateFriend(friend)\n\t\t\t} else {\n\t\t\t\tthis.friends.unshift(friend);\n\t\t\t}\n\t\t},\n\t\tsetOnlineStatus(onlineTerminals) {\n\t\t\tthis.friends.forEach((f) => {\n\t\t\t\tlet userTerminal = onlineTerminals.find((o) => f.id == o.userId);\n\t\t\t\tif (userTerminal) {\n\t\t\t\t\tf.online = true;\n\t\t\t\t\tf.onlineWeb = userTerminal.terminals.indexOf(TERMINAL_TYPE.WEB) >= 0\n\t\t\t\t\tf.onlineApp = userTerminal.terminals.indexOf(TERMINAL_TYPE.APP) >= 0\n\t\t\t\t} else {\n\t\t\t\t\tf.online = false;\n\t\t\t\t\tf.onlineWeb = false;\n\t\t\t\t\tf.onlineApp = false;\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\trefreshOnlineStatus() {\n\t\t\tlet userIds = this.friends.filter((f) => !f.deleted).map((f) => f.id);\n\t\t\tif (userIds.length == 0) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\thttp({\n\t\t\t\turl: '/user/terminal/online?userIds=' + userIds.join(','),\n\t\t\t\tmethod: 'GET'\n\t\t\t}).then((onlineTerminals) => {\n\t\t\t\tthis.setOnlineStatus(onlineTerminals);\n\t\t\t})\n\t\t\t// 30s后重新拉取\n\t\t\tclearTimeout(this.timer);\n\t\t\tthis.timer = setTimeout(() => {\n\t\t\t\tthis.refreshOnlineStatus();\n\t\t\t}, 30000)\n\t\t},\n\t\tclear() {\n\t\t\tclearTimeout(this.timer);\n\t\t\tthis.friends = [];\n\t\t\tthis.timer = null;\n\t\t},\n\t\tloadFriend() {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\thttp({\n\t\t\t\t\turl: '/friend/list',\n\t\t\t\t\tmethod: 'GET'\n\t\t\t\t}).then((friends) => {\n\t\t\t\t\tthis.setFriends(friends);\n\t\t\t\t\tthis.refreshOnlineStatus();\n\t\t\t\t\tresolve()\n\t\t\t\t}).catch((res) => {\n\t\t\t\t\treject();\n\t\t\t\t})\n\t\t\t});\n\t\t}\n\t},\n\tgetters: {\n\t\tisFriend: (state) => (userId) => {\n\t\t\treturn state.friends.filter((f) => !f.deleted).some((f) => f.id == userId);\n\t\t},\n\t\tfindFriend: (state) => (id) => {\n\t\t\treturn state.friends.find((f) => f.id == id);\n\t\t}\n\t}\n})"],"names":["defineStore","friends","f","friend","copy","id","onlineTerminals","userTerminal","o","TERMINAL_TYPE","userIds","http","resolve","reject","res","state","userId"],"mappings":"yHAIeA,EAAAA,EAAAA,YAAY,cAAe,CACzC,MAAO,KACC,CACN,QAAS,CAAE,EACX,MAAO,IACP,GAEF,QAAS,CACR,WAAWC,EAAS,CACnBA,EAAQ,QAASC,GAAM,CACtBA,EAAE,OAAS,GACXA,EAAE,UAAY,GACdA,EAAE,UAAY,EAClB,CAAI,EACD,KAAK,QAAUD,CACf,EACD,aAAaE,EAAQ,CACpB,IAAID,EAAI,KAAK,WAAWC,EAAO,EAAE,EAC7BC,EAAO,KAAK,MAAM,KAAK,UAAUF,CAAC,CAAC,EACvC,OAAO,OAAOA,EAAGC,CAAM,EACvBD,EAAE,OAASE,EAAK,OAChBF,EAAE,UAAYE,EAAK,UACnBF,EAAE,UAAYE,EAAK,SACnB,EACD,aAAaC,EAAI,CAChB,KAAK,QAAQ,OAAOH,GAAKA,EAAE,IAAMG,CAAE,EAAE,QAAQH,GAAKA,EAAE,QAAU,EAAI,CAClE,EACD,UAAUC,EAAQ,CACb,KAAK,QAAQ,KAAMD,GAAMA,EAAE,IAAMC,EAAO,EAAE,EAC7C,KAAK,aAAaA,CAAM,EAExB,KAAK,QAAQ,QAAQA,CAAM,CAE5B,EACD,gBAAgBG,EAAiB,CAChC,KAAK,QAAQ,QAASJ,GAAM,CAC3B,IAAIK,EAAeD,EAAgB,KAAME,GAAMN,EAAE,IAAMM,EAAE,MAAM,EAC3DD,GACHL,EAAE,OAAS,GACXA,EAAE,UAAYK,EAAa,UAAU,QAAQE,EAAa,cAAC,GAAG,GAAK,EACnEP,EAAE,UAAYK,EAAa,UAAU,QAAQE,EAAa,cAAC,GAAG,GAAK,IAEnEP,EAAE,OAAS,GACXA,EAAE,UAAY,GACdA,EAAE,UAAY,GAEnB,CAAI,CACD,EACD,qBAAsB,CACrB,IAAIQ,EAAU,KAAK,QAAQ,OAAQR,GAAM,CAACA,EAAE,OAAO,EAAE,IAAKA,GAAMA,EAAE,EAAE,EAChEQ,EAAQ,QAAU,IAGtBC,UAAK,CACJ,IAAK,iCAAmCD,EAAQ,KAAK,GAAG,EACxD,OAAQ,KACZ,CAAI,EAAE,KAAMJ,GAAoB,CAC5B,KAAK,gBAAgBA,CAAe,CACxC,CAAI,EAED,aAAa,KAAK,KAAK,EACvB,KAAK,MAAQ,WAAW,IAAM,CAC7B,KAAK,oBAAmB,CACxB,EAAE,GAAK,EACR,EACD,OAAQ,CACP,aAAa,KAAK,KAAK,EACvB,KAAK,QAAU,GACf,KAAK,MAAQ,IACb,EACD,YAAa,CACZ,OAAO,IAAI,QAAQ,CAACM,EAASC,IAAW,CACvCF,UAAK,CACJ,IAAK,eACL,OAAQ,KACb,CAAK,EAAE,KAAMV,GAAY,CACpB,KAAK,WAAWA,CAAO,EACvB,KAAK,oBAAmB,EACxBW,EAAS,CACd,CAAK,EAAE,MAAOE,GAAQ,CACjBD,GACL,CAAK,CACL,CAAI,CACD,CACD,EACD,QAAS,CACR,SAAWE,GAAWC,GACdD,EAAM,QAAQ,OAAQb,GAAM,CAACA,EAAE,OAAO,EAAE,KAAMA,GAAMA,EAAE,IAAMc,CAAM,EAE1E,WAAaD,GAAWV,GAChBU,EAAM,QAAQ,KAAMb,GAAMA,EAAE,IAAMG,CAAE,CAE5C,CACF,CAAC"}